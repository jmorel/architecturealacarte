(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M;j=function(b,c,d,e){return new a(b,c,d,e)},"undefined"!=typeof module&&null!==module&&null!=module.exports&&(module.exports=j),"function"==typeof define&&define.amd?define([],function(){return j}):(H="undefined"!=typeof exports&&null!==exports?exports:this,H.chroma=j),j.color=function(b,c,d,e){return new a(b,c,d,e)},j.hsl=function(b,c,d,e){return new a(b,c,d,e,"hsl")},j.hsv=function(b,c,d,e){return new a(b,c,d,e,"hsv")},j.rgb=function(b,c,d,e){return new a(b,c,d,e,"rgb")},j.hex=function(b){return new a(b)},j.css=function(b){return new a(b)},j.lab=function(b,c,d){return new a(b,c,d,"lab")},j.lch=function(b,c,d){return new a(b,c,d,"lch")},j.hsi=function(b,c,d){return new a(b,c,d,"hsi")},j.gl=function(b,c,d,e){return new a(255*b,255*c,255*d,e,"gl")},j.interpolate=function(b,c,d,e){return null==b||null==c?"#000":("string"===I(b)&&(b=new a(b)),"string"===I(c)&&(c=new a(c)),b.interpolate(d,c,e))},j.mix=j.interpolate,j.contrast=function(b,c){var d,e;return"string"===I(b)&&(b=new a(b)),"string"===I(c)&&(c=new a(c)),d=b.luminance(),e=c.luminance(),d>e?(d+.05)/(e+.05):(e+.05)/(d+.05)},j.luminance=function(a){return j(a).luminance()},j._Color=a,a=function(){function a(){var a,b,c,d,e,f,g,h,i,j,l,m,n,s,u,v;for(e=this,c=[],j=0,l=arguments.length;l>j;j++)b=arguments[j],null!=b&&c.push(b);if(0===c.length)m=[255,0,255,1,"rgb"],g=m[0],h=m[1],i=m[2],a=m[3],d=m[4];else if("array"===I(c[0])){if(3===c[0].length)n=c[0],g=n[0],h=n[1],i=n[2],a=1;else{if(4!==c[0].length)throw"unknown input argument";s=c[0],g=s[0],h=s[1],i=s[2],a=s[3]}d=null!=(u=c[1])?u:"rgb"}else"string"===I(c[0])?(g=c[0],d="hex"):"object"===I(c[0])?(v=c[0]._rgb,g=v[0],h=v[1],i=v[2],a=v[3],d="rgb"):c.length>=3&&(g=c[0],h=c[1],i=c[2]);3===c.length?(d="rgb",a=1):4===c.length?"string"===I(c[3])?(d=c[3],a=1):"number"===I(c[3])&&(d="rgb",a=c[3]):5===c.length&&(a=c[3],d=c[4]),null==a&&(a=1),"rgb"===d?e._rgb=[g,h,i,a]:"gl"===d?e._rgb=[255*g,255*h,255*i,a]:"hsl"===d?(e._rgb=q(g,h,i),e._rgb[3]=a):"hsv"===d?(e._rgb=r(g,h,i),e._rgb[3]=a):"hex"===d?e._rgb=o(g):"lab"===d?(e._rgb=t(g,h,i),e._rgb[3]=a):"lch"===d?(e._rgb=w(g,h,i),e._rgb[3]=a):"hsi"===d&&(e._rgb=p(g,h,i),e._rgb[3]=a),f=k(e._rgb)}return a.prototype.rgb=function(){return this._rgb.slice(0,3)},a.prototype.rgba=function(){return this._rgb},a.prototype.hex=function(){return A(this._rgb)},a.prototype.toString=function(){return this.name()},a.prototype.hsl=function(){return C(this._rgb)},a.prototype.hsv=function(){return D(this._rgb)},a.prototype.lab=function(){return E(this._rgb)},a.prototype.lch=function(){return F(this._rgb)},a.prototype.hsi=function(){return B(this._rgb)},a.prototype.gl=function(){return[this._rgb[0]/255,this._rgb[1]/255,this._rgb[2]/255,this._rgb[3]]},a.prototype.luminance=function(){return y(this._rgb)},a.prototype.name=function(){var a,b;a=this.hex();for(b in j.colors)if(a===j.colors[b])return b;return a},a.prototype.alpha=function(a){return arguments.length?(this._rgb[3]=a,this):this._rgb[3]},a.prototype.css=function(a){var b,c,d,e;return null==a&&(a="rgb"),c=this,d=c._rgb,3===a.length&&d[3]<1&&(a+="a"),"rgb"===a?a+"("+d.slice(0,3).map(Math.round).join(",")+")":"rgba"===a?a+"("+d.slice(0,3).map(Math.round).join(",")+","+d[3]+")":"hsl"===a||"hsla"===a?(b=c.hsl(),e=function(a){return Math.round(100*a)/100},b[0]=e(b[0]),b[1]=e(100*b[1])+"%",b[2]=e(100*b[2])+"%",4===a.length&&(b[3]=d[3]),a+"("+b.join(",")+")"):void 0},a.prototype.interpolate=function(b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r;if(l=this,null==d&&(d="rgb"),"string"===I(c)&&(c=new a(c)),"hsl"===d||"hsv"===d||"lch"===d||"hsi"===d)"hsl"===d?(q=l.hsl(),r=c.hsl()):"hsv"===d?(q=l.hsv(),r=c.hsv()):"hsi"===d?(q=l.hsi(),r=c.hsi()):"lch"===d&&(q=l.lch(),r=c.lch()),"h"===d.substr(0,1)?(g=q[0],o=q[1],j=q[2],h=r[0],p=r[1],k=r[2]):(j=q[0],o=q[1],g=q[2],k=r[0],p=r[1],h=r[2]),isNaN(g)||isNaN(h)?isNaN(g)?isNaN(h)?f=Number.NaN:(f=h,1!==j&&0!==j||"hsv"===d||(n=p)):(f=g,1!==k&&0!==k||"hsv"===d||(n=o)):(e=h>g&&h-g>180?h-(g+360):g>h&&g-h>180?h+360-g:h-g,f=g+b*e),null==n&&(n=o+b*(p-o)),i=j+b*(k-j),m="h"===d.substr(0,1)?new a(f,n,i,d):new a(i,n,f,d);else if("rgb"===d)q=l._rgb,r=c._rgb,m=new a(q[0]+b*(r[0]-q[0]),q[1]+b*(r[1]-q[1]),q[2]+b*(r[2]-q[2]),d);else{if("lab"!==d)throw"color mode "+d+" is not supported";q=l.lab(),r=c.lab(),m=new a(q[0]+b*(r[0]-q[0]),q[1]+b*(r[1]-q[1]),q[2]+b*(r[2]-q[2]),d)}return m.alpha(l.alpha()+b*(c.alpha()-l.alpha())),m},a.prototype.premultiply=function(){var a,b;return b=this.rgb(),a=this.alpha(),j(b[0]*a,b[1]*a,b[2]*a,a)},a.prototype.darken=function(a){var b,c;return null==a&&(a=20),c=this,b=c.lch(),b[0]-=a,j.lch(b).alpha(c.alpha())},a.prototype.darker=function(a){return this.darken(a)},a.prototype.brighten=function(a){return null==a&&(a=20),this.darken(-a)},a.prototype.brighter=function(a){return this.brighten(a)},a.prototype.saturate=function(a){var b,c;return null==a&&(a=20),c=this,b=c.lch(),b[1]+=a,j.lch(b).alpha(c.alpha())},a.prototype.desaturate=function(a){return null==a&&(a=20),this.saturate(-a)},a}(),k=function(a){var b;for(b in a)3>b?(a[b]<0&&(a[b]=0),a[b]>255&&(a[b]=255)):3===b&&(a[b]<0&&(a[b]=0),a[b]>1&&(a[b]=1));return a},n=function(a){var b,c,d,e,f,g,h,i;if(a=a.toLowerCase(),null!=j.colors&&j.colors[a])return o(j.colors[a]);if(d=a.match(/rgb\(\s*(\-?\d+),\s*(\-?\d+)\s*,\s*(\-?\d+)\s*\)/)){for(e=d.slice(1,4),c=f=0;2>=f;c=++f)e[c]=+e[c];e[3]=1}else if(d=a.match(/rgba\(\s*(\-?\d+),\s*(\-?\d+)\s*,\s*(\-?\d+)\s*,\s*([01]|[01]?\.\d+)\)/))for(e=d.slice(1,5),c=g=0;3>=g;c=++g)e[c]=+e[c];else if(d=a.match(/rgb\(\s*(\-?\d+(?:\.\d+)?)%,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*\)/)){for(e=d.slice(1,4),c=h=0;2>=h;c=++h)e[c]=Math.round(2.55*e[c]);e[3]=1}else if(d=a.match(/rgba\(\s*(\-?\d+(?:\.\d+)?)%,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*([01]|[01]?\.\d+)\)/)){for(e=d.slice(1,5),c=i=0;2>=i;c=++i)e[c]=Math.round(2.55*e[c]);e[3]=+e[3]}else(d=a.match(/hsl\(\s*(\-?\d+(?:\.\d+)?),\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*\)/))?(b=d.slice(1,4),b[1]*=.01,b[2]*=.01,e=q(b),e[3]=1):(d=a.match(/hsla\(\s*(\-?\d+(?:\.\d+)?),\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*([01]|[01]?\.\d+)\)/))&&(b=d.slice(1,4),b[1]*=.01,b[2]*=.01,e=q(b),e[3]=+d[4]);return e},o=function(a){var b,c,d,e,f,g;if(a.match(/^#?([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/))return(4===a.length||7===a.length)&&(a=a.substr(1)),3===a.length&&(a=a.split(""),a=a[0]+a[0]+a[1]+a[1]+a[2]+a[2]),g=parseInt(a,16),e=g>>16,d=g>>8&255,c=255&g,[e,d,c,1];if(a.match(/^#?([A-Fa-f0-9]{8})$/))return 9===a.length&&(a=a.substr(1)),g=parseInt(a,16),e=g>>24&255,d=g>>16&255,c=g>>8&255,b=255&g,[e,d,c,b];if(f=n(a))return f;throw"unknown color: "+a},p=function(a,b,e){var f,g,h,i;return i=J(arguments),a=i[0],b=i[1],e=i[2],a/=360,1/3>a?(f=(1-b)/3,h=(1+b*m(d*a)/m(c-d*a))/3,g=1-(f+h)):2/3>a?(a-=1/3,h=(1-b)/3,g=(1+b*m(d*a)/m(c-d*a))/3,f=1-(h+g)):(a-=2/3,g=(1-b)/3,f=(1+b*m(d*a)/m(c-d*a))/3,h=1-(g+f)),h=x(e*h*3),g=x(e*g*3),f=x(e*f*3),[255*h,255*g,255*f]},q=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n;if(m=J(arguments),d=m[0],h=m[1],f=m[2],0===h)g=c=a=255*f;else{for(k=[0,0,0],b=[0,0,0],j=.5>f?f*(1+h):f+h-f*h,i=2*f-j,d/=360,k[0]=d+1/3,k[1]=d,k[2]=d-1/3,e=l=0;2>=l;e=++l)k[e]<0&&(k[e]+=1),k[e]>1&&(k[e]-=1),6*k[e]<1?b[e]=i+6*(j-i)*k[e]:2*k[e]<1?b[e]=j:3*k[e]<2?b[e]=i+(j-i)*(2/3-k[e])*6:b[e]=i;n=[Math.round(255*b[0]),Math.round(255*b[1]),Math.round(255*b[2])],g=n[0],c=n[1],a=n[2]}return[g,c,a]},r=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;if(l=J(arguments),d=l[0],i=l[1],k=l[2],k*=255,0===i)h=c=a=k;else switch(360===d&&(d=0),d>360&&(d-=360),0>d&&(d+=360),d/=60,e=Math.floor(d),b=d-e,f=k*(1-i),g=k*(1-i*b),j=k*(1-i*(1-b)),e){case 0:m=[k,j,f],h=m[0],c=m[1],a=m[2];break;case 1:n=[g,k,f],h=n[0],c=n[1],a=n[2];break;case 2:o=[f,k,j],h=o[0],c=o[1],a=o[2];break;case 3:p=[f,g,k],h=p[0],c=p[1],a=p[2];break;case 4:q=[j,f,k],h=q[0],c=q[1],a=q[2];break;case 5:r=[k,f,g],h=r[0],c=r[1],a=r[2]}return h=Math.round(h),c=Math.round(c),a=Math.round(a),[h,c,a]},b=18,e=.95047,f=1,g=1.08883,s=function(){var a,b,c,d,e,f;return f=J(arguments),e=f[0],a=f[1],b=f[2],c=Math.sqrt(a*a+b*b),d=Math.atan2(b,a)/Math.PI*180,[e,c,d]},t=function(a,b,c){var d,h,i,j,k,l,m;return void 0!==a&&3===a.length&&(l=a,a=l[0],b=l[1],c=l[2]),void 0!==a&&3===a.length&&(m=a,a=m[0],b=m[1],c=m[2]),j=(a+16)/116,i=j+b/500,k=j-c/200,i=u(i)*e,j=u(j)*f,k=u(k)*g,h=L(3.2404542*i-1.5371385*j-.4985314*k),d=L(-.969266*i+1.8760108*j+.041556*k),c=L(.0556434*i-.2040259*j+1.0572252*k),[x(h,0,255),x(d,0,255),x(c,0,255),1]},u=function(a){return a>.206893034?a*a*a:(a-4/29)/7.787037},L=function(a){return Math.round(255*(.00304>=a?12.92*a:1.055*Math.pow(a,1/2.4)-.055))},v=function(){var a,b,c,d;return d=J(arguments),c=d[0],a=d[1],b=d[2],b=b*Math.PI/180,[c,Math.cos(b)*a,Math.sin(b)*a]},w=function(a,b,c){var d,e,f,g,h,i,j;return i=v(a,b,c),d=i[0],e=i[1],f=i[2],j=t(d,e,f),h=j[0],g=j[1],f=j[2],[x(h,0,255),x(g,0,255),x(f,0,255)]},y=function(a,b,c){var d;return d=J(arguments),a=d[0],b=d[1],c=d[2],a=z(a),b=z(b),c=z(c),.2126*a+.7152*b+.0722*c},z=function(a){return a/=255,.03928>=a?a/12.92:Math.pow((a+.055)/1.055,2.4)},A=function(){var a,b,c,d,e,f;return f=J(arguments),c=f[0],b=f[1],a=f[2],e=c<<16|b<<8|a,d="000000"+e.toString(16),"#"+d.substr(d.length-6)},B=function(){var a,b,c,d,e,f,g,h,i;return i=J(arguments),g=i[0],c=i[1],b=i[2],a=2*Math.PI,g/=255,c/=255,b/=255,f=Math.min(g,c,b),e=(g+c+b)/3,h=1-f/e,0===h?d=0:(d=(g-c+(g-b))/2,d/=Math.sqrt((g-c)*(g-c)+(g-b)*(c-b)),d=Math.acos(d),b>c&&(d=a-d),d/=a),[360*d,h,e]},C=function(a,b,c){var d,e,f,g,h,i;return void 0!==a&&a.length>=3&&(i=a,a=i[0],b=i[1],c=i[2]),a/=255,b/=255,c/=255,g=Math.min(a,b,c),f=Math.max(a,b,c),e=(f+g)/2,f===g?(h=0,d=Number.NaN):h=.5>e?(f-g)/(f+g):(f-g)/(2-f-g),a===f?d=(b-c)/(f-g):b===f?d=2+(c-a)/(f-g):c===f&&(d=4+(a-b)/(f-g)),d*=60,0>d&&(d+=360),[d,h,e]},D=function(){var a,b,c,d,e,f,g,h,i,j;return j=J(arguments),g=j[0],c=j[1],a=j[2],f=Math.min(g,c,a),e=Math.max(g,c,a),b=e-f,i=e/255,0===e?(d=Number.NaN,h=0):(h=b/e,g===e&&(d=(c-a)/b),c===e&&(d=2+(a-g)/b),a===e&&(d=4+(g-c)/b),d*=60,0>d&&(d+=360)),[d,h,i]},E=function(){var a,b,c,d,h,i,j;return j=J(arguments),c=j[0],b=j[1],a=j[2],c=G(c),b=G(b),a=G(a),d=K((.4124564*c+.3575761*b+.1804375*a)/e),h=K((.2126729*c+.7151522*b+.072175*a)/f),i=K((.0193339*c+.119192*b+.9503041*a)/g),[116*h-16,500*(d-h),200*(h-i)]},G=function(a){return(a/=255)<=.04045?a/12.92:Math.pow((a+.055)/1.055,2.4)},K=function(a){return a>.008856?Math.pow(a,1/3):7.787037*a+4/29},F=function(){var a,b,c,d,e,f,g;return f=J(arguments),e=f[0],c=f[1],b=f[2],g=E(e,c,b),d=g[0],a=g[1],b=g[2],s(d,a,b)},j.scale=function(a,b){var c,d,e,f,g,h,i,k,l,m,n,o,p,q,r,s,t,u,v,w,x;return s="rgb",t=j("#ccc"),x=0,p=!1,o=[0,1],m=[],v=!1,w=[],r=0,q=1,n=!1,u=0,l={},h=function(a,b){var c,d,e,f,h,i,k;if(null==a&&(a=["#ddd","#222"]),null!=a&&"string"===I(a)&&null!=(null!=(h=j.brewer)?h[a]:void 0)&&(a=j.brewer[a]),"array"===I(a)){for(a=a.slice(0),c=e=0,i=a.length-1;i>=0?i>=e:e>=i;c=i>=0?++e:--e)d=a[c],"string"===I(d)&&(a[c]=j(d));if(null!=b)w=b;else for(w=[],c=f=0,k=a.length-1;k>=0?k>=f:f>=k;c=k>=0?++f:--f)w.push(c/(a.length-1))}return g(),m=a},i=function(a){return null==a&&(a=[]),o=a,r=a[0],q=a[a.length-1],g(),u=2===a.length?0:a.length-1},e=function(a){var b,c;if(null!=o){for(c=o.length-1,b=0;c>b&&a>=o[b];)b++;return b-1}return 0},k=function(a){return a},c=function(a){var b,c,d,f,g;return g=a,o.length>2&&(f=o.length-1,b=e(a),d=o[0]+(o[1]-o[0])*(0+.5*x),c=o[f-1]+(o[f]-o[f-1])*(1-.5*x),g=r+(o[b]+.5*(o[b+1]-o[b])-d)/(c-d)*(q-r)),g},f=function(a,b){var c,d,f,g,h,i,n,p,v;if(null==b&&(b=!1),isNaN(a))return t;if(b?n=a:o.length>2?(c=e(a),n=c/(u-1)):q!==r?(n=f=(a-r)/(q-r),n=Math.min(1,Math.max(0,n))):n=r,b||(n=k(n)),h=Math.floor(1e4*n),l[h])d=l[h];else{if("array"===I(m))for(g=p=0,v=w.length-1;v>=0?v>=p:p>=v;g=v>=0?++p:--p){if(i=w[g],i>=n){d=m[g];break}if(n>=i&&g===w.length-1){d=m[g];break}if(n>i&&n<w[g+1]){n=(n-i)/(w[g+1]-i),d=j.interpolate(m[g],m[g+1],n,s);break}}else"function"===I(m)&&(d=m(n));l[h]=d}return d},g=function(){return l={}},h(a,b),d=function(a){var b;return b=f(a),v&&b[v]?b[v]():b},d.domain=function(a,b,c,e){var f;return null==c&&(c="e"),arguments.length?(null!=b&&(f=j.analyze(a,e),a=0===b?[f.min,f.max]:j.limits(f,c,b)),i(a),d):o},d.mode=function(a){return arguments.length?(s=a,g(),d):s},d.range=function(a,b){return h(a,b),d},d.out=function(a){return v=a,d},d.spread=function(a){return arguments.length?(x=a,d):x},d.correctLightness=function(a){return arguments.length?(n=a,g(),k=n?function(a){var b,c,d,e,g,h,i,j,k;for(b=f(0,!0).lab()[0],c=f(1,!0).lab()[0],i=b>c,d=f(a,!0).lab()[0],g=b+(c-b)*a,e=d-g,j=0,k=1,h=20;Math.abs(e)>.01&&h-->0;)!function(){return i&&(e*=-1),0>e?(j=a,a+=.5*(k-a)):(k=a,a+=.5*(j-a)),d=f(a,!0).lab()[0],e=d-g}();return a}:function(a){return a},d):n},d.colors=function(b){var c,e,f,g,h,i;if(null==b&&(b="hex"),a=[],e=[],o.length>2)for(c=f=1,i=o.length;i>=1?i>f:f>i;c=i>=1?++f:--f)e.push(.5*(o[c-1]+o[c]));else e=o;for(g=0,h=e.length;h>g;g++)c=e[g],a.push(d(c)[b]());return a},d},null==(M=j.scales)&&(j.scales={}),j.scales.cool=function(){return j.scale([j.hsl(180,1,.9),j.hsl(250,.7,.4)])},j.scales.hot=function(){return j.scale(["#000","#f00","#ff0","#fff"],[0,.25,.75,1]).mode("rgb")},j.analyze=function(a,b,c){var d,e,f,g,h,i,k;if(f={min:Number.MAX_VALUE,max:-1*Number.MAX_VALUE,sum:0,values:[],count:0},null==c&&(c=function(){return!0}),d=function(a){null==a||isNaN(a)||(f.values.push(a),f.sum+=a,a<f.min&&(f.min=a),a>f.max&&(f.max=a),f.count+=1)},h=function(a,e){return c(a,e)?d(null!=b&&"function"===I(b)?b(a):null!=b&&"string"===I(b)||"number"===I(b)?a[b]:a):void 0},"array"===I(a))for(i=0,k=a.length;k>i;i++)g=a[i],h(g);else for(e in a)g=a[e],h(g,e);return f.domain=[f.min,f.max],f.limits=function(a,b){return j.limits(f,a,b)},f},j.limits=function(a,b,c){var d,e,f,g,h,i,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa,ga;if(null==b&&(b="equal"),null==c&&(c=7),"array"===I(a)&&(a=j.analyze(a)),q=a.min,o=a.max,A=a.sum,D=a.values.sort(function(a,b){return a-b}),n=[],"c"===b.substr(0,1)&&(n.push(q),n.push(o)),"e"===b.substr(0,1)){for(n.push(q),k=E=1,P=c-1;P>=1?P>=E:E>=P;k=P>=1?++E:--E)n.push(q+k/c*(o-q));n.push(o)}else if("l"===b.substr(0,1)){if(0>=q)throw"Logarithmic scales are only possible for values > 0";for(r=Math.LOG10E*Math.log(q),p=Math.LOG10E*Math.log(o),n.push(q),k=F=1,W=c-1;W>=1?W>=F:F>=W;k=W>=1?++F:--F)n.push(Math.pow(10,r+k/c*(p-r)));n.push(o)}else if("q"===b.substr(0,1)){for(n.push(q),k=G=1,X=c-1;X>=1?X>=G:G>=X;k=X>=1?++G:--G)w=D.length*k/c,x=Math.floor(w),x===w?n.push(D[x]):(y=w-x,n.push(D[x]*y+D[x+1]*(1-y)));n.push(o)}else if("k"===b.substr(0,1)){for(t=D.length,d=new Array(t),h=new Array(c),z=!0,u=0,f=null,f=[],f.push(q),k=H=1,Y=c-1;Y>=1?Y>=H:H>=Y;k=Y>=1?++H:--H)f.push(q+k/c*(o-q));for(f.push(o);z;){for(l=J=0,Z=c-1;Z>=0?Z>=J:J>=Z;l=Z>=0?++J:--J)h[l]=0;for(k=K=0,$=t-1;$>=0?$>=K:K>=$;k=$>=0?++K:--K){for(C=D[k],s=Number.MAX_VALUE,l=L=0,_=c-1;_>=0?_>=L:L>=_;l=_>=0?++L:--L)i=Math.abs(f[l]-C),s>i&&(s=i,e=l);h[e]++,d[k]=e}for(v=new Array(c),l=M=0,aa=c-1;aa>=0?aa>=M:M>=aa;l=aa>=0?++M:--M)v[l]=null;for(k=N=0,ba=t-1;ba>=0?ba>=N:N>=ba;k=ba>=0?++N:--N)g=d[k],null===v[g]?v[g]=D[k]:v[g]+=D[k];for(l=O=0,Q=c-1;Q>=0?Q>=O:O>=Q;l=Q>=0?++O:--O)v[l]*=1/h[l];for(z=!1,l=ca=0,R=c-1;R>=0?R>=ca:ca>=R;l=R>=0?++ca:--ca)if(v[l]!==f[k]){z=!0;break}f=v,u++,u>200&&(z=!1)}for(m={},l=da=0,S=c-1;S>=0?S>=da:da>=S;l=S>=0?++da:--da)m[l]=[];for(k=ea=0,T=t-1;T>=0?T>=ea:ea>=T;k=T>=0?++ea:--ea)g=d[k],m[g].push(D[k]);for(B=[],l=fa=0,U=c-1;U>=0?U>=fa:fa>=U;l=U>=0?++fa:--fa)B.push(m[l][0]),B.push(m[l][m[l].length-1]);for(B=B.sort(function(a,b){return a-b}),n.push(B[0]),k=ga=1,V=B.length-1;V>=ga;k=ga+=2)isNaN(B[k])||n.push(B[k])}return n},j.brewer=i={OrRd:["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"],PuBu:["#fff7fb","#ece7f2","#d0d1e6","#a6bddb","#74a9cf","#3690c0","#0570b0","#045a8d","#023858"],BuPu:["#f7fcfd","#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#8c6bb1","#88419d","#810f7c","#4d004b"],Oranges:["#fff5eb","#fee6ce","#fdd0a2","#fdae6b","#fd8d3c","#f16913","#d94801","#a63603","#7f2704"],BuGn:["#f7fcfd","#e5f5f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b"],YlOrBr:["#ffffe5","#fff7bc","#fee391","#fec44f","#fe9929","#ec7014","#cc4c02","#993404","#662506"],YlGn:["#ffffe5","#f7fcb9","#d9f0a3","#addd8e","#78c679","#41ab5d","#238443","#006837","#004529"],Reds:["#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#a50f15","#67000d"],RdPu:["#fff7f3","#fde0dd","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177","#49006a"],Greens:["#f7fcf5","#e5f5e0","#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#006d2c","#00441b"],YlGnBu:["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"],Purples:["#fcfbfd","#efedf5","#dadaeb","#bcbddc","#9e9ac8","#807dba","#6a51a3","#54278f","#3f007d"],GnBu:["#f7fcf0","#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"],Greys:["#ffffff","#f0f0f0","#d9d9d9","#bdbdbd","#969696","#737373","#525252","#252525","#000000"],YlOrRd:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"],PuRd:["#f7f4f9","#e7e1ef","#d4b9da","#c994c7","#df65b0","#e7298a","#ce1256","#980043","#67001f"],Blues:["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],PuBuGn:["#fff7fb","#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a","#016c59","#014636"],Spectral:["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#ffffbf","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2"],RdYlGn:["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"],RdBu:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac","#053061"],PiYG:["#8e0152","#c51b7d","#de77ae","#f1b6da","#fde0ef","#f7f7f7","#e6f5d0","#b8e186","#7fbc41","#4d9221","#276419"],PRGn:["#40004b","#762a83","#9970ab","#c2a5cf","#e7d4e8","#f7f7f7","#d9f0d3","#a6dba0","#5aae61","#1b7837","#00441b"],RdYlBu:["#a50026","#d73027","#f46d43","#fdae61","#fee090","#ffffbf","#e0f3f8","#abd9e9","#74add1","#4575b4","#313695"],BrBG:["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#f5f5f5","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"],RdGy:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#ffffff","#e0e0e0","#bababa","#878787","#4d4d4d","#1a1a1a"],PuOr:["#7f3b08","#b35806","#e08214","#fdb863","#fee0b6","#f7f7f7","#d8daeb","#b2abd2","#8073ac","#542788","#2d004b"],Set2:["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3"],Accent:["#7fc97f","#beaed4","#fdc086","#ffff99","#386cb0","#f0027f","#bf5b17","#666666"],Set1:["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"],Set3:["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"],Dark2:["#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#a6761d","#666666"],Paired:["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928"],Pastel2:["#b3e2cd","#fdcdac","#cbd5e8","#f4cae4","#e6f5c9","#fff2ae","#f1e2cc","#cccccc"],Pastel1:["#fbb4ae","#b3cde3","#ccebc5","#decbe4","#fed9a6","#ffffcc","#e5d8bd","#fddaec","#f2f2f2"]},j.colors=l={indigo:"#4b0082",gold:"#ffd700",hotpink:"#ff69b4",firebrick:"#b22222",indianred:"#cd5c5c",yellow:"#ffff00",mistyrose:"#ffe4e1",darkolivegreen:"#556b2f",olive:"#808000",darkseagreen:"#8fbc8f",pink:"#ffc0cb",tomato:"#ff6347",lightcoral:"#f08080",orangered:"#ff4500",navajowhite:"#ffdead",lime:"#00ff00",palegreen:"#98fb98",darkslategrey:"#2f4f4f",greenyellow:"#adff2f",burlywood:"#deb887",seashell:"#fff5ee",mediumspringgreen:"#00fa9a",fuchsia:"#ff00ff",papayawhip:"#ffefd5",blanchedalmond:"#ffebcd",chartreuse:"#7fff00",dimgray:"#696969",black:"#000000",peachpuff:"#ffdab9",springgreen:"#00ff7f",aquamarine:"#7fffd4",white:"#ffffff",orange:"#ffa500",lightsalmon:"#ffa07a",darkslategray:"#2f4f4f",brown:"#a52a2a",ivory:"#fffff0",dodgerblue:"#1e90ff",peru:"#cd853f",lawngreen:"#7cfc00",chocolate:"#d2691e",crimson:"#dc143c",forestgreen:"#228b22",darkgrey:"#a9a9a9",lightseagreen:"#20b2aa",cyan:"#00ffff",mintcream:"#f5fffa",silver:"#c0c0c0",antiquewhite:"#faebd7",mediumorchid:"#ba55d3",skyblue:"#87ceeb",gray:"#808080",darkturquoise:"#00ced1",goldenrod:"#daa520",darkgreen:"#006400",floralwhite:"#fffaf0",darkviolet:"#9400d3",darkgray:"#a9a9a9",moccasin:"#ffe4b5",saddlebrown:"#8b4513",grey:"#808080",darkslateblue:"#483d8b",lightskyblue:"#87cefa",lightpink:"#ffb6c1",mediumvioletred:"#c71585",slategrey:"#708090",red:"#ff0000",deeppink:"#ff1493",limegreen:"#32cd32",darkmagenta:"#8b008b",palegoldenrod:"#eee8aa",plum:"#dda0dd",turquoise:"#40e0d0",lightgrey:"#d3d3d3",lightgoldenrodyellow:"#fafad2",darkgoldenrod:"#b8860b",lavender:"#e6e6fa",maroon:"#800000",yellowgreen:"#9acd32",sandybrown:"#f4a460",thistle:"#d8bfd8",violet:"#ee82ee",navy:"#000080",magenta:"#ff00ff",dimgrey:"#696969",tan:"#d2b48c",rosybrown:"#bc8f8f",olivedrab:"#6b8e23",blue:"#0000ff",lightblue:"#add8e6",ghostwhite:"#f8f8ff",honeydew:"#f0fff0",cornflowerblue:"#6495ed",slateblue:"#6a5acd",linen:"#faf0e6",darkblue:"#00008b",powderblue:"#b0e0e6",seagreen:"#2e8b57",darkkhaki:"#bdb76b",snow:"#fffafa",sienna:"#a0522d",mediumblue:"#0000cd",royalblue:"#4169e1",lightcyan:"#e0ffff",green:"#008000",mediumpurple:"#9370db",midnightblue:"#191970",cornsilk:"#fff8dc",paleturquoise:"#afeeee",bisque:"#ffe4c4",slategray:"#708090",darkcyan:"#008b8b",khaki:"#f0e68c",wheat:"#f5deb3",teal:"#008080",darkorchid:"#9932cc",deepskyblue:"#00bfff",salmon:"#fa8072",darkred:"#8b0000",steelblue:"#4682b4",palevioletred:"#db7093",lightslategray:"#778899",aliceblue:"#f0f8ff",lightslategrey:"#778899",lightgreen:"#90ee90",orchid:"#da70d6",gainsboro:"#dcdcdc",mediumseagreen:"#3cb371",lightgray:"#d3d3d3",mediumturquoise:"#48d1cc",lemonchiffon:"#fffacd",cadetblue:"#5f9ea0",lightyellow:"#ffffe0",lavenderblush:"#fff0f5",coral:"#ff7f50",purple:"#800080",aqua:"#00ffff",whitesmoke:"#f5f5f5",mediumslateblue:"#7b68ee",darkorange:"#ff8c00",mediumaquamarine:"#66cdaa",darksalmon:"#e9967a",beige:"#f5f5dc",blueviolet:"#8a2be2",azure:"#f0ffff",lightsteelblue:"#b0c4de",oldlace:"#fdf5e6"},I=function(){var a,b,c,d,e;for(a={},e="Boolean Number String Function Array Date RegExp Undefined Null".split(" "),c=0,d=e.length;d>c;c++)b=e[c],a["[object "+b+"]"]=b.toLowerCase();return function(b){var c;return c=Object.prototype.toString.call(b),a[c]||"object"}}(),x=function(a,b,c){return null==b&&(b=0),null==c&&(c=1),b>a&&(a=b),a>c&&(a=c),a},J=function(a){return a.length>=3?a:a[0]},d=2*Math.PI,c=Math.PI/3,m=Math.cos,h=function(a){var b,c,d,e,f,g,i,k,l,m,n;return a=function(){var b,c,d;for(d=[],b=0,c=a.length;c>b;b++)e=a[b],d.push(j(e));return d}(),2===a.length?(l=function(){var b,c,d;for(d=[],b=0,c=a.length;c>b;b++)e=a[b],d.push(e.lab());return d}(),f=l[0],g=l[1],b=function(a){var b,c;return c=function(){var c,d;for(d=[],b=c=0;2>=c;b=++c)d.push(f[b]+a*(g[b]-f[b]));return d}(),j.lab.apply(j,c)}):3===a.length?(m=function(){var b,c,d;for(d=[],b=0,c=a.length;c>b;b++)e=a[b],d.push(e.lab());return d}(),f=m[0],g=m[1],i=m[2],b=function(a){var b,c;return c=function(){var c,d;for(d=[],b=c=0;2>=c;b=++c)d.push((1-a)*(1-a)*f[b]+2*(1-a)*a*g[b]+a*a*i[b]);return d}(),j.lab.apply(j,c)}):4===a.length?(n=function(){var b,c,d;for(d=[],b=0,c=a.length;c>b;b++)e=a[b],d.push(e.lab());return d}(),f=n[0],g=n[1],i=n[2],k=n[3],b=function(a){var b,c;return c=function(){var c,d;for(d=[],b=c=0;2>=c;b=++c)d.push((1-a)*(1-a)*(1-a)*f[b]+3*(1-a)*(1-a)*a*g[b]+3*(1-a)*a*a*i[b]+a*a*a*k[b]);return d}(),j.lab.apply(j,c)}):5===a.length&&(c=h(a.slice(0,3)),d=h(a.slice(2,5)),b=function(a){return.5>a?c(2*a):d(2*(a-.5))}),b},j.interpolate.bezier=h}).call(this),function(a){var b={},c=b.hasOwnProperty,d=function(a,b){var d;for(d in a)c.call(a,d)&&b(d,a[d])},e=function(a,b){return b?(d(b,function(b,c){a[b]=c}),a):a},f=/["'\\\b\f\n\r\t]/,g=/[ !#-&\(-\[\]-~]/,h=function(a,b){var c={es6:!1,json:!1},d=b&&b.json;b=e(c,b);var h,i,j,k,l=a,m=-1,n=l.length;for(h="";++m<n;){var o=l.charAt(m);if(b.es6&&(i=l.charCodeAt(m),i>=55296&&56319>=i&&n>m+1&&(j=l.charCodeAt(m+1),j>=56320&&57343>=j)))k=1024*(i-55296)+j-56320+65536,h+="\\u{"+k.toString(16).toUpperCase()+"}",m++;else if(g.test(o))h+=o;else if('"'!=o)if("'"!=o)if(f.test(o))h+=o;else{var p=o.charCodeAt(0),q=p.toString(16).toUpperCase(),r=q.length>2||d,s="\\"+(r?"u":"x")+("0000"+q).slice(r?-4:-2);h+=s}else h+=o;else h+=o}return h};h.version="0.5.0",a.jsesc=h}(this),function(a){var b=function(){"use strict";var a="s",c=function(a){var b=-a.getTimezoneOffset();return null!==b?b:0},d=function(a,b,c){var d=new Date;return void 0!==a&&d.setFullYear(a),d.setMonth(b),d.setDate(c),d},e=function(a){return c(d(a,0,2))},f=function(a){return c(d(a,5,2))},g=function(a){var b=a.getMonth()>7,d=b?f(a.getFullYear()):e(a.getFullYear()),g=c(a),h=0>d,i=d-g;return h||b?0!==i:0>i},h=function(){var b=e(),c=f(),d=b-c;return 0>d?b+",1":d>0?c+",1,"+a:b+",0"},i=function(){var a=h();return new b.TimeZone(b.olson.timezones[a])},j=function(a){var b=new Date(2010,6,15,1,0,0,0),c={"America/Denver":new Date(2011,2,13,3,0,0,0),"America/Mazatlan":new Date(2011,3,3,3,0,0,0),"America/Chicago":new Date(2011,2,13,3,0,0,0),"America/Mexico_City":new Date(2011,3,3,3,0,0,0),"America/Asuncion":new Date(2012,9,7,3,0,0,0),"America/Santiago":new Date(2012,9,3,3,0,0,0),"America/Campo_Grande":new Date(2012,9,21,5,0,0,0),"America/Montevideo":new Date(2011,9,2,3,0,0,0),"America/Sao_Paulo":new Date(2011,9,16,5,0,0,0),"America/Los_Angeles":new Date(2011,2,13,8,0,0,0),"America/Santa_Isabel":new Date(2011,3,5,8,0,0,0),"America/Havana":new Date(2012,2,10,2,0,0,0),"America/New_York":new Date(2012,2,10,7,0,0,0),"Europe/Helsinki":new Date(2013,2,31,5,0,0,0),"Pacific/Auckland":new Date(2011,8,26,7,0,0,0),"America/Halifax":new Date(2011,2,13,6,0,0,0),"America/Goose_Bay":new Date(2011,2,13,2,1,0,0),"America/Miquelon":new Date(2011,2,13,5,0,0,0),"America/Godthab":new Date(2011,2,27,1,0,0,0),"Europe/Moscow":b,"Asia/Amman":new Date(2013,2,29,1,0,0,0),"Asia/Beirut":new Date(2013,2,31,2,0,0,0),"Asia/Damascus":new Date(2013,3,6,2,0,0,0),"Asia/Jerusalem":new Date(2013,2,29,5,0,0,0),"Asia/Yekaterinburg":b,"Asia/Omsk":b,"Asia/Krasnoyarsk":b,"Asia/Irkutsk":b,"Asia/Yakutsk":b,"Asia/Vladivostok":b,"Asia/Baku":new Date(2013,2,31,4,0,0),"Asia/Yerevan":new Date(2013,2,31,3,0,0),"Asia/Kamchatka":b,"Asia/Gaza":new Date(2010,2,27,4,0,0),"Africa/Cairo":new Date(2010,4,1,3,0,0),"Europe/Minsk":b,"Pacific/Apia":new Date(2010,10,1,1,0,0,0),"Pacific/Fiji":new Date(2010,11,1,0,0,0),"Australia/Perth":new Date(2008,10,1,1,0,0,0)};return c[a]};return{determine:i,date_is_dst:g,dst_start_for:j}}();b.TimeZone=function(a){"use strict";var c={"America/Denver":["America/Denver","America/Mazatlan"],"America/Chicago":["America/Chicago","America/Mexico_City"],"America/Santiago":["America/Santiago","America/Asuncion","America/Campo_Grande"],"America/Montevideo":["America/Montevideo","America/Sao_Paulo"],"Asia/Beirut":["Asia/Amman","Asia/Jerusalem","Asia/Beirut","Europe/Helsinki","Asia/Damascus"],"Pacific/Auckland":["Pacific/Auckland","Pacific/Fiji"],"America/Los_Angeles":["America/Los_Angeles","America/Santa_Isabel"],"America/New_York":["America/Havana","America/New_York"],"America/Halifax":["America/Goose_Bay","America/Halifax"],"America/Godthab":["America/Miquelon","America/Godthab"],"Asia/Dubai":["Europe/Moscow"],"Asia/Dhaka":["Asia/Yekaterinburg"],"Asia/Jakarta":["Asia/Omsk"],"Asia/Shanghai":["Asia/Krasnoyarsk","Australia/Perth"],"Asia/Tokyo":["Asia/Irkutsk"],"Australia/Brisbane":["Asia/Yakutsk"],"Pacific/Noumea":["Asia/Vladivostok"],"Pacific/Tarawa":["Asia/Kamchatka","Pacific/Fiji"],"Pacific/Tongatapu":["Pacific/Apia"],"Asia/Baghdad":["Europe/Minsk"],"Asia/Baku":["Asia/Yerevan","Asia/Baku"],"Africa/Johannesburg":["Asia/Gaza","Africa/Cairo"]},d=a,e=function(){for(var a=c[d],e=a.length,f=0,g=a[0];e>f;f+=1)if(g=a[f],b.date_is_dst(b.dst_start_for(g)))return void(d=g)},f=function(){return"undefined"!=typeof c[d]};return f()&&e(),{name:function(){return d}}},b.olson={},b.olson.timezones={"-720,0":"Pacific/Majuro","-660,0":"Pacific/Pago_Pago","-600,1":"America/Adak","-600,0":"Pacific/Honolulu","-570,0":"Pacific/Marquesas","-540,0":"Pacific/Gambier","-540,1":"America/Anchorage","-480,1":"America/Los_Angeles","-480,0":"Pacific/Pitcairn","-420,0":"America/Phoenix","-420,1":"America/Denver","-360,0":"America/Guatemala","-360,1":"America/Chicago","-360,1,s":"Pacific/Easter","-300,0":"America/Bogota","-300,1":"America/New_York","-270,0":"America/Caracas","-240,1":"America/Halifax","-240,0":"America/Santo_Domingo","-240,1,s":"America/Santiago","-210,1":"America/St_Johns","-180,1":"America/Godthab","-180,0":"America/Argentina/Buenos_Aires","-180,1,s":"America/Montevideo","-120,0":"America/Noronha","-120,1":"America/Noronha","-60,1":"Atlantic/Azores","-60,0":"Atlantic/Cape_Verde","0,0":"UTC","0,1":"Europe/London","60,1":"Europe/Berlin","60,0":"Africa/Lagos","60,1,s":"Africa/Windhoek","120,1":"Asia/Beirut","120,0":"Africa/Johannesburg","180,0":"Asia/Baghdad","180,1":"Europe/Moscow","210,1":"Asia/Tehran","240,0":"Asia/Dubai","240,1":"Asia/Baku","270,0":"Asia/Kabul","300,1":"Asia/Yekaterinburg","300,0":"Asia/Karachi","330,0":"Asia/Kolkata","345,0":"Asia/Kathmandu","360,0":"Asia/Dhaka","360,1":"Asia/Omsk","390,0":"Asia/Rangoon","420,1":"Asia/Krasnoyarsk","420,0":"Asia/Jakarta","480,0":"Asia/Shanghai","480,1":"Asia/Irkutsk","525,0":"Australia/Eucla","525,1,s":"Australia/Eucla","540,1":"Asia/Yakutsk","540,0":"Asia/Tokyo","570,0":"Australia/Darwin","570,1,s":"Australia/Adelaide","600,0":"Australia/Brisbane","600,1":"Asia/Vladivostok","600,1,s":"Australia/Sydney","630,1,s":"Australia/Lord_Howe","660,1":"Asia/Kamchatka","660,0":"Pacific/Noumea","690,0":"Pacific/Norfolk","720,1,s":"Pacific/Auckland","720,0":"Pacific/Tarawa","765,1,s":"Pacific/Chatham","780,0":"Pacific/Tongatapu","780,1,s":"Pacific/Apia","840,0":"Pacific/Kiritimati"},"undefined"!=typeof exports?exports.jstz=b:a.jstz=b}(this),LazyLoad=function(a){function b(b,c){var d,e=a.createElement(b);for(d in c)c.hasOwnProperty(d)&&e.setAttribute(d,c[d]);return e}function c(a){var b,c,d=j[a];d&&(b=d.callback,c=d.urls,c.shift(),k=0,c.length||(b&&b.call(d.context,d.obj),j[a]=null,l[a].length&&e(a)))}function d(){var b=navigator.userAgent;h={async:a.createElement("script").async===!0},(h.webkit=/AppleWebKit\//.test(b))||(h.ie=/MSIE|Trident/.test(b))||(h.opera=/Opera/.test(b))||(h.gecko=/Gecko\//.test(b))||(h.unknown=!0)}function e(e,k,m,n,o){var p,q,r,s,t,u,v=function(){c(e)},w="css"===e,x=[];if(h||d(),k)if(k="string"==typeof k?[k]:k.concat(),w||h.async||h.gecko||h.opera)l[e].push({urls:k,callback:m,obj:n,context:o});else for(p=0,q=k.length;q>p;++p)l[e].push({urls:[k[p]],callback:p===q-1?m:null,obj:n,context:o});if(!j[e]&&(s=j[e]=l[e].shift())){for(i||(i=a.head||a.getElementsByTagName("head")[0]),t=s.urls.concat(),p=0,q=t.length;q>p;++p)u=t[p],w?r=h.gecko?b("style"):b("link",{href:u,rel:"stylesheet"}):(r=b("script",{src:u}),r.async=!1),r.className="lazyload",r.setAttribute("charset","utf-8"),h.ie&&!w&&"onreadystatechange"in r&&!("draggable"in r)?r.onreadystatechange=function(){/loaded|complete/.test(r.readyState)&&(r.onreadystatechange=null,v())}:w&&(h.gecko||h.webkit)?h.webkit?(s.urls[p]=r.href,g()):(r.innerHTML='@import "'+u+'";',f(r)):r.onload=r.onerror=v,x.push(r);for(p=0,q=x.length;q>p;++p)i.appendChild(x[p])}}function f(a){var b;try{b=!!a.sheet.cssRules}catch(d){return k+=1,void(200>k?setTimeout(function(){f(a)},50):b&&c("css"))}c("css")}function g(){var a,b=j.css;if(b){for(a=m.length;--a>=0;)if(m[a].href===b.urls[0]){c("css");break}k+=1,b&&(200>k?setTimeout(g,50):c("css"))}}var h,i,j={},k=0,l={css:[],js:[]},m=a.styleSheets;return{css:function(a,b,c,d){e("css",a,b,c,d)},js:function(a,b,c,d){e("js",a,b,c,d)}}}(this.document),window.Modernizr=function(a,b,c){
function d(a){o.cssText=a}function e(a,b){return typeof a===b}var f,g,h,i="2.8.3",j={},k=!0,l=b.documentElement,m="modernizr",n=b.createElement(m),o=n.style,p=({}.toString,{svg:"http://www.w3.org/2000/svg"}),q={},r=[],s=r.slice,t={}.hasOwnProperty;h=e(t,"undefined")||e(t.call,"undefined")?function(a,b){return b in a&&e(a.constructor.prototype[b],"undefined")}:function(a,b){return t.call(a,b)},Function.prototype.bind||(Function.prototype.bind=function(a){var b=this;if("function"!=typeof b)throw new TypeError;var c=s.call(arguments,1),d=function(){if(this instanceof d){var e=function(){};e.prototype=b.prototype;var f=new e,g=b.apply(f,c.concat(s.call(arguments)));return Object(g)===g?g:f}return b.apply(a,c.concat(s.call(arguments)))};return d}),q.geolocation=function(){return"geolocation"in navigator},q.svg=function(){return!!b.createElementNS&&!!b.createElementNS(p.svg,"svg").createSVGRect},q.inlinesvg=function(){var a=b.createElement("div");return a.innerHTML="<svg/>",(a.firstChild&&a.firstChild.namespaceURI)==p.svg};for(var u in q)h(q,u)&&(g=u.toLowerCase(),j[g]=q[u](),r.push((j[g]?"":"no-")+g));return j.addTest=function(a,b){if("object"==typeof a)for(var d in a)h(a,d)&&j.addTest(d,a[d]);else{if(a=a.toLowerCase(),j[a]!==c)return j;b="function"==typeof b?b():b,"undefined"!=typeof k&&k&&(l.className+=" "+(b?"":"no-")+a),j[a]=b}return j},d(""),n=f=null,function(a,b){function c(a,b){var c=a.createElement("p"),d=a.getElementsByTagName("head")[0]||a.documentElement;return c.innerHTML="x<style>"+b+"</style>",d.insertBefore(c.lastChild,d.firstChild)}function d(){var a=s.elements;return"string"==typeof a?a.split(" "):a}function e(a){var b=r[a[p]];return b||(b={},q++,a[p]=q,r[q]=b),b}function f(a,c,d){if(c||(c=b),k)return c.createElement(a);d||(d=e(c));var f;return f=d.cache[a]?d.cache[a].cloneNode():o.test(a)?(d.cache[a]=d.createElem(a)).cloneNode():d.createElem(a),!f.canHaveChildren||n.test(a)||f.tagUrn?f:d.frag.appendChild(f)}function g(a,c){if(a||(a=b),k)return a.createDocumentFragment();c=c||e(a);for(var f=c.frag.cloneNode(),g=0,h=d(),i=h.length;i>g;g++)f.createElement(h[g]);return f}function h(a,b){b.cache||(b.cache={},b.createElem=a.createElement,b.createFrag=a.createDocumentFragment,b.frag=b.createFrag()),a.createElement=function(c){return s.shivMethods?f(c,a,b):b.createElem(c)},a.createDocumentFragment=Function("h,f","return function(){var n=f.cloneNode(),c=n.createElement;h.shivMethods&&("+d().join().replace(/[\w\-]+/g,function(a){return b.createElem(a),b.frag.createElement(a),'c("'+a+'")'})+");return n}")(s,b.frag)}function i(a){a||(a=b);var d=e(a);return!s.shivCSS||j||d.hasCSS||(d.hasCSS=!!c(a,"article,aside,dialog,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}mark{background:#FF0;color:#000}template{display:none}")),k||h(a,d),a}var j,k,l="3.7.0",m=a.html5||{},n=/^<|^(?:button|map|select|textarea|object|iframe|option|optgroup)$/i,o=/^(?:a|b|code|div|fieldset|h1|h2|h3|h4|h5|h6|i|label|li|ol|p|q|span|strong|style|table|tbody|td|th|tr|ul)$/i,p="_html5shiv",q=0,r={};!function(){try{var a=b.createElement("a");a.innerHTML="<xyz></xyz>",j="hidden"in a,k=1==a.childNodes.length||function(){b.createElement("a");var a=b.createDocumentFragment();return"undefined"==typeof a.cloneNode||"undefined"==typeof a.createDocumentFragment||"undefined"==typeof a.createElement}()}catch(c){j=!0,k=!0}}();var s={elements:m.elements||"abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video",version:l,shivCSS:m.shivCSS!==!1,supportsUnknownElements:k,shivMethods:m.shivMethods!==!1,type:"default",shivDocument:i,createElement:f,createDocumentFragment:g};a.html5=s,i(b)}(this,b),j._version=i,l.className=l.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+(k?" js "+r.join(" "):""),j}(this,this.document),function(a,b,c){function d(a){return"[object Function]"==q.call(a)}function e(a){return"string"==typeof a}function f(){}function g(a){return!a||"loaded"==a||"complete"==a||"uninitialized"==a}function h(){var a=r.shift();s=1,a?a.t?o(function(){("c"==a.t?m.injectCss:m.injectJs)(a.s,0,a.a,a.x,a.e,1)},0):(a(),h()):s=0}function i(a,c,d,e,f,i,j){function k(b){if(!n&&g(l.readyState)&&(t.r=n=1,!s&&h(),l.onload=l.onreadystatechange=null,b)){"img"!=a&&o(function(){v.removeChild(l)},50);for(var d in A[c])A[c].hasOwnProperty(d)&&A[c][d].onload()}}var j=j||m.errorTimeout,l=b.createElement(a),n=0,q=0,t={t:d,s:c,e:f,a:i,x:j};1===A[c]&&(q=1,A[c]=[]),"object"==a?l.data=c:(l.src=c,l.type=a),l.width=l.height="0",l.onerror=l.onload=l.onreadystatechange=function(){k.call(this,q)},r.splice(e,0,t),"img"!=a&&(q||2===A[c]?(v.insertBefore(l,u?null:p),o(k,j)):A[c].push(l))}function j(a,b,c,d,f){return s=0,b=b||"j",e(a)?i("c"==b?x:w,a,b,this.i++,c,d,f):(r.splice(this.i++,0,a),1==r.length&&h()),this}function k(){var a=m;return a.loader={load:j,i:0},a}var l,m,n=b.documentElement,o=a.setTimeout,p=b.getElementsByTagName("script")[0],q={}.toString,r=[],s=0,t="MozAppearance"in n.style,u=t&&!!b.createRange().compareNode,v=u?n:p.parentNode,n=a.opera&&"[object Opera]"==q.call(a.opera),n=!!b.attachEvent&&!n,w=t?"object":n?"script":"img",x=n?"script":w,y=Array.isArray||function(a){return"[object Array]"==q.call(a)},z=[],A={},B={timeout:function(a,b){return b.length&&(a.timeout=b[0]),a}};m=function(a){function b(a){var b,c,d,a=a.split("!"),e=z.length,f=a.pop(),g=a.length,f={url:f,origUrl:f,prefixes:a};for(c=0;g>c;c++)d=a[c].split("="),(b=B[d.shift()])&&(f=b(f,d));for(c=0;e>c;c++)f=z[c](f);return f}function g(a,e,f,g,h){var i=b(a),j=i.autoCallback;i.url.split(".").pop().split("?").shift(),i.bypass||(e&&(e=d(e)?e:e[a]||e[g]||e[a.split("/").pop().split("?")[0]]),i.instead?i.instead(a,e,f,g,h):(A[i.url]?i.noexec=!0:A[i.url]=1,f.load(i.url,i.forceCSS||!i.forceJS&&"css"==i.url.split(".").pop().split("?").shift()?"c":c,i.noexec,i.attrs,i.timeout),(d(e)||d(j))&&f.load(function(){k(),e&&e(i.origUrl,h,g),j&&j(i.origUrl,h,g),A[i.url]=2})))}function h(a,b){function c(a,c){if(a){if(e(a))c||(l=function(){var a=[].slice.call(arguments);m.apply(this,a),n()}),g(a,l,b,0,j);else if(Object(a)===a)for(i in h=function(){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c}(),a)a.hasOwnProperty(i)&&(!c&&!--h&&(d(l)?l=function(){var a=[].slice.call(arguments);m.apply(this,a),n()}:l[i]=function(a){return function(){var b=[].slice.call(arguments);a&&a.apply(this,b),n()}}(m[i])),g(a[i],l,b,i,j))}else!c&&n()}var h,i,j=!!a.test,k=a.load||a.both,l=a.callback||f,m=l,n=a.complete||f;c(j?a.yep:a.nope,!!k),k&&c(k)}var i,j,l=this.yepnope.loader;if(e(a))g(a,0,l,0);else if(y(a))for(i=0;i<a.length;i++)j=a[i],e(j)?g(j,0,l,0):y(j)?m(j):Object(j)===j&&h(j,l);else Object(a)===a&&h(a,l)},m.addPrefix=function(a,b){B[a]=b},m.addFilter=function(a){z.push(a)},m.errorTimeout=1e4,null==b.readyState&&b.addEventListener&&(b.readyState="loading",b.addEventListener("DOMContentLoaded",l=function(){b.removeEventListener("DOMContentLoaded",l,0),b.readyState="complete"},0)),a.yepnope=k(),a.yepnope.executeStack=h,a.yepnope.injectJs=function(a,c,d,e,i,j){var k,l,n=b.createElement("script"),e=e||m.errorTimeout;n.src=a;for(l in d)n.setAttribute(l,d[l]);c=j?h:c||f,n.onreadystatechange=n.onload=function(){!k&&g(n.readyState)&&(k=1,c(),n.onload=n.onreadystatechange=null)},o(function(){k||(k=1,c(1))},e),i?n.onload():p.parentNode.insertBefore(n,p)},a.yepnope.injectCss=function(a,c,d,e,g,i){var j,e=b.createElement("link"),c=i?h:c||f;e.href=a,e.rel="stylesheet",e.type="text/css";for(j in d)e.setAttribute(j,d[j]);g||(p.parentNode.insertBefore(e,p),o(c,0))}}(this,document),Modernizr.load=function(){yepnope.apply(window,[].slice.call(arguments,0))},Modernizr.addTest("cors",!!(window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest)),function(a){function b(a,b,c){switch(arguments.length){case 2:return null!=a?a:b;case 3:return null!=a?a:null!=b?b:c;default:throw new Error("Implement me")}}function c(){return{empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1}}function d(a,b){function c(){pa.suppressDeprecationWarnings===!1&&"undefined"!=typeof console&&console.warn&&console.warn("Deprecation warning: "+a)}var d=!0;return j(function(){return d&&(c(),d=!1),b.apply(this,arguments)},b)}function e(a,b){return function(c){return m(a.call(this,c),b)}}function f(a,b){return function(c){return this.lang().ordinal(a.call(this,c),b)}}function g(){}function h(a){B(a),j(this,a)}function i(a){var b=u(a),c=b.year||0,d=b.quarter||0,e=b.month||0,f=b.week||0,g=b.day||0,h=b.hour||0,i=b.minute||0,j=b.second||0,k=b.millisecond||0;this._milliseconds=+k+1e3*j+6e4*i+36e5*h,this._days=+g+7*f,this._months=+e+3*d+12*c,this._data={},this._bubble()}function j(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return b.hasOwnProperty("toString")&&(a.toString=b.toString),b.hasOwnProperty("valueOf")&&(a.valueOf=b.valueOf),a}function k(a){var b,c={};for(b in a)a.hasOwnProperty(b)&&Da.hasOwnProperty(b)&&(c[b]=a[b]);return c}function l(a){return 0>a?Math.ceil(a):Math.floor(a)}function m(a,b,c){for(var d=""+Math.abs(a),e=a>=0;d.length<b;)d="0"+d;return(e?c?"+":"":"-")+d}function n(a,b){var c={milliseconds:0,months:0};return c.months=b.month()-a.month()+12*(b.year()-a.year()),a.clone().add(c.months,"M").isAfter(b)&&--c.months,c.milliseconds=+b-+a.clone().add(c.months,"M"),c}function o(a,b){var c;return b=E(b,a),a.isBefore(b)?c=n(a,b):(c=n(b,a),c.milliseconds=-c.milliseconds,c.months=-c.months),c}function p(a,b,c,d){var e=b._milliseconds,f=b._days,g=b._months;d=null==d?!0:d,e&&a._d.setTime(+a._d+e*c),f&&ja(a,"Date",ia(a,"Date")+f*c),g&&ha(a,ia(a,"Month")+g*c),d&&pa.updateOffset(a,f||g)}function q(a){return"[object Array]"===Object.prototype.toString.call(a)}function r(a){return"[object Date]"===Object.prototype.toString.call(a)||a instanceof Date}function s(a,b,c){var d,e=Math.min(a.length,b.length),f=Math.abs(a.length-b.length),g=0;for(d=0;e>d;d++)(c&&a[d]!==b[d]||!c&&w(a[d])!==w(b[d]))&&g++;return g+f}function t(a){if(a){var b=a.toLowerCase().replace(/(.)s$/,"$1");a=eb[a]||fb[b]||b}return a}function u(a){var b,c,d={};for(c in a)a.hasOwnProperty(c)&&(b=t(c),b&&(d[b]=a[c]));return d}function v(b){var c,d;if(0===b.indexOf("week"))c=7,d="day";else{if(0!==b.indexOf("month"))return;c=12,d="month"}pa[b]=function(e,f){var g,h,i=pa.fn._lang[b],j=[];if("number"==typeof e&&(f=e,e=a),h=function(a){var b=pa().utc().set(d,a);return i.call(pa.fn._lang,b,e||"")},null!=f)return h(f);for(g=0;c>g;g++)j.push(h(g));return j}}function w(a){var b=+a,c=0;return 0!==b&&isFinite(b)&&(c=b>=0?Math.floor(b):Math.ceil(b)),c}function x(a,b){return new Date(Date.UTC(a,b+1,0)).getUTCDate()}function y(a,b,c){return da(pa([a,11,31+b-c]),b,c).week}function z(a){return A(a)?366:365}function A(a){return a%4===0&&a%100!==0||a%400===0}function B(a){var b;a._a&&-2===a._pf.overflow&&(b=a._a[wa]<0||a._a[wa]>11?wa:a._a[xa]<1||a._a[xa]>x(a._a[va],a._a[wa])?xa:a._a[ya]<0||a._a[ya]>23?ya:a._a[za]<0||a._a[za]>59?za:a._a[Aa]<0||a._a[Aa]>59?Aa:a._a[Ba]<0||a._a[Ba]>999?Ba:-1,a._pf._overflowDayOfYear&&(va>b||b>xa)&&(b=xa),a._pf.overflow=b)}function C(a){return null==a._isValid&&(a._isValid=!isNaN(a._d.getTime())&&a._pf.overflow<0&&!a._pf.empty&&!a._pf.invalidMonth&&!a._pf.nullInput&&!a._pf.invalidFormat&&!a._pf.userInvalidated,a._strict&&(a._isValid=a._isValid&&0===a._pf.charsLeftOver&&0===a._pf.unusedTokens.length)),a._isValid}function D(a){return a?a.toLowerCase().replace("_","-"):a}function E(a,b){return b._isUTC?pa(a).zone(b._offset||0):pa(a).local()}function F(a,b){return b.abbr=a,Ca[a]||(Ca[a]=new g),Ca[a].set(b),Ca[a]}function G(a){delete Ca[a]}function H(a){var b,c,d,e,f=0,g=function(a){if(!Ca[a]&&Ea)try{require("./lang/"+a)}catch(b){}return Ca[a]};if(!a)return pa.fn._lang;if(!q(a)){if(c=g(a))return c;a=[a]}for(;f<a.length;){for(e=D(a[f]).split("-"),b=e.length,d=D(a[f+1]),d=d?d.split("-"):null;b>0;){if(c=g(e.slice(0,b).join("-")))return c;if(d&&d.length>=b&&s(e,d,!0)>=b-1)break;b--}f++}return pa.fn._lang}function I(a){return a.match(/\[[\s\S]/)?a.replace(/^\[|\]$/g,""):a.replace(/\\/g,"")}function J(a){var b,c,d=a.match(Ia);for(b=0,c=d.length;c>b;b++)kb[d[b]]?d[b]=kb[d[b]]:d[b]=I(d[b]);return function(e){var f="";for(b=0;c>b;b++)f+=d[b]instanceof Function?d[b].call(e,a):d[b];return f}}function K(a,b){return a.isValid()?(b=L(b,a.lang()),gb[b]||(gb[b]=J(b)),gb[b](a)):a.lang().invalidDate()}function L(a,b){function c(a){return b.longDateFormat(a)||a}var d=5;for(Ja.lastIndex=0;d>=0&&Ja.test(a);)a=a.replace(Ja,c),Ja.lastIndex=0,d-=1;return a}function M(a,b){var c,d=b._strict;switch(a){case"Q":return Ua;case"DDDD":return Wa;case"YYYY":case"GGGG":case"gggg":return d?Xa:Ma;case"Y":case"G":case"g":return Za;case"YYYYYY":case"YYYYY":case"GGGGG":case"ggggg":return d?Ya:Na;case"S":if(d)return Ua;case"SS":if(d)return Va;case"SSS":if(d)return Wa;case"DDD":return La;case"MMM":case"MMMM":case"dd":case"ddd":case"dddd":return Pa;case"a":case"A":return H(b._l)._meridiemParse;case"X":return Sa;case"Z":case"ZZ":return Qa;case"T":return Ra;case"SSSS":return Oa;case"MM":case"DD":case"YY":case"GG":case"gg":case"HH":case"hh":case"mm":case"ss":case"ww":case"WW":return d?Va:Ka;case"M":case"D":case"d":case"H":case"h":case"m":case"s":case"w":case"W":case"e":case"E":return Ka;case"Do":return Ta;default:return c=new RegExp(V(U(a.replace("\\","")),"i"))}}function N(a){a=a||"";var b=a.match(Qa)||[],c=b[b.length-1]||[],d=(c+"").match(cb)||["-",0,0],e=+(60*d[1])+w(d[2]);return"+"===d[0]?-e:e}function O(a,b,c){var d,e=c._a;switch(a){case"Q":null!=b&&(e[wa]=3*(w(b)-1));break;case"M":case"MM":null!=b&&(e[wa]=w(b)-1);break;case"MMM":case"MMMM":d=H(c._l).monthsParse(b),null!=d?e[wa]=d:c._pf.invalidMonth=b;break;case"D":case"DD":null!=b&&(e[xa]=w(b));break;case"Do":null!=b&&(e[xa]=w(parseInt(b,10)));break;case"DDD":case"DDDD":null!=b&&(c._dayOfYear=w(b));break;case"YY":e[va]=pa.parseTwoDigitYear(b);break;case"YYYY":case"YYYYY":case"YYYYYY":e[va]=w(b);break;case"a":case"A":c._isPm=H(c._l).isPM(b);break;case"H":case"HH":case"h":case"hh":e[ya]=w(b);break;case"m":case"mm":e[za]=w(b);break;case"s":case"ss":e[Aa]=w(b);break;case"S":case"SS":case"SSS":case"SSSS":e[Ba]=w(1e3*("0."+b));break;case"X":c._d=new Date(1e3*parseFloat(b));break;case"Z":case"ZZ":c._useUTC=!0,c._tzm=N(b);break;case"dd":case"ddd":case"dddd":d=H(c._l).weekdaysParse(b),null!=d?(c._w=c._w||{},c._w.d=d):c._pf.invalidWeekday=b;break;case"w":case"ww":case"W":case"WW":case"d":case"e":case"E":a=a.substr(0,1);case"gggg":case"GGGG":case"GGGGG":a=a.substr(0,2),b&&(c._w=c._w||{},c._w[a]=w(b));break;case"gg":case"GG":c._w=c._w||{},c._w[a]=pa.parseTwoDigitYear(b)}}function P(a){var c,d,e,f,g,h,i,j;c=a._w,null!=c.GG||null!=c.W||null!=c.E?(g=1,h=4,d=b(c.GG,a._a[va],da(pa(),1,4).year),e=b(c.W,1),f=b(c.E,1)):(j=H(a._l),g=j._week.dow,h=j._week.doy,d=b(c.gg,a._a[va],da(pa(),g,h).year),e=b(c.w,1),null!=c.d?(f=c.d,g>f&&++e):f=null!=c.e?c.e+g:g),i=ea(d,e,f,h,g),a._a[va]=i.year,a._dayOfYear=i.dayOfYear}function Q(a){var c,d,e,f,g=[];if(!a._d){for(e=S(a),a._w&&null==a._a[xa]&&null==a._a[wa]&&P(a),a._dayOfYear&&(f=b(a._a[va],e[va]),a._dayOfYear>z(f)&&(a._pf._overflowDayOfYear=!0),d=_(f,0,a._dayOfYear),a._a[wa]=d.getUTCMonth(),a._a[xa]=d.getUTCDate()),c=0;3>c&&null==a._a[c];++c)a._a[c]=g[c]=e[c];for(;7>c;c++)a._a[c]=g[c]=null==a._a[c]?2===c?1:0:a._a[c];a._d=(a._useUTC?_:$).apply(null,g),null!=a._tzm&&a._d.setUTCMinutes(a._d.getUTCMinutes()+a._tzm)}}function R(a){var b;a._d||(b=u(a._i),a._a=[b.year,b.month,b.day,b.hour,b.minute,b.second,b.millisecond],Q(a))}function S(a){var b=new Date;return a._useUTC?[b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate()]:[b.getFullYear(),b.getMonth(),b.getDate()]}function T(a){if(a._f===pa.ISO_8601)return void X(a);a._a=[],a._pf.empty=!0;var b,c,d,e,f,g=H(a._l),h=""+a._i,i=h.length,j=0;for(d=L(a._f,g).match(Ia)||[],b=0;b<d.length;b++)e=d[b],c=(h.match(M(e,a))||[])[0],c&&(f=h.substr(0,h.indexOf(c)),f.length>0&&a._pf.unusedInput.push(f),h=h.slice(h.indexOf(c)+c.length),j+=c.length),kb[e]?(c?a._pf.empty=!1:a._pf.unusedTokens.push(e),O(e,c,a)):a._strict&&!c&&a._pf.unusedTokens.push(e);a._pf.charsLeftOver=i-j,h.length>0&&a._pf.unusedInput.push(h),a._isPm&&a._a[ya]<12&&(a._a[ya]+=12),a._isPm===!1&&12===a._a[ya]&&(a._a[ya]=0),Q(a),B(a)}function U(a){return a.replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(a,b,c,d,e){return b||c||d||e})}function V(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function W(a){var b,d,e,f,g;if(0===a._f.length)return a._pf.invalidFormat=!0,void(a._d=new Date(NaN));for(f=0;f<a._f.length;f++)g=0,b=j({},a),b._pf=c(),b._f=a._f[f],T(b),C(b)&&(g+=b._pf.charsLeftOver,g+=10*b._pf.unusedTokens.length,b._pf.score=g,(null==e||e>g)&&(e=g,d=b));j(a,d||b)}function X(a){var b,c,d=a._i,e=$a.exec(d);if(e){for(a._pf.iso=!0,b=0,c=ab.length;c>b;b++)if(ab[b][1].exec(d)){a._f=ab[b][0]+(e[6]||" ");break}for(b=0,c=bb.length;c>b;b++)if(bb[b][1].exec(d)){a._f+=bb[b][0];break}d.match(Qa)&&(a._f+="Z"),T(a)}else a._isValid=!1}function Y(a){X(a),a._isValid===!1&&(delete a._isValid,pa.createFromInputFallback(a))}function Z(b){var c,d=b._i;d===a?b._d=new Date:r(d)?b._d=new Date(+d):null!==(c=Fa.exec(d))?b._d=new Date(+c[1]):"string"==typeof d?Y(b):q(d)?(b._a=d.slice(0),Q(b)):"object"==typeof d?R(b):"number"==typeof d?b._d=new Date(d):pa.createFromInputFallback(b)}function $(a,b,c,d,e,f,g){var h=new Date(a,b,c,d,e,f,g);return 1970>a&&h.setFullYear(a),h}function _(a){var b=new Date(Date.UTC.apply(null,arguments));return 1970>a&&b.setUTCFullYear(a),b}function aa(a,b){if("string"==typeof a)if(isNaN(a)){if(a=b.weekdaysParse(a),"number"!=typeof a)return null}else a=parseInt(a,10);return a}function ba(a,b,c,d,e){return e.relativeTime(b||1,!!c,a,d)}function ca(a,b,c){var d=pa.duration(a).abs(),e=ua(d.as("s")),f=ua(d.as("m")),g=ua(d.as("h")),h=ua(d.as("d")),i=ua(d.as("M")),j=ua(d.as("y")),k=e<hb.s&&["s",e]||1===f&&["m"]||f<hb.m&&["mm",f]||1===g&&["h"]||g<hb.h&&["hh",g]||1===h&&["d"]||h<hb.d&&["dd",h]||1===i&&["M"]||i<hb.M&&["MM",i]||1===j&&["y"]||["yy",j];return k[2]=b,k[3]=+a>0,k[4]=c,ba.apply({},k)}function da(a,b,c){var d,e=c-b,f=c-a.day();return f>e&&(f-=7),e-7>f&&(f+=7),d=pa(a).add("d",f),{week:Math.ceil(d.dayOfYear()/7),year:d.year()}}function ea(a,b,c,d,e){var f,g,h=_(a,0,1).getUTCDay();return h=0===h?7:h,c=null!=c?c:e,f=e-h+(h>d?7:0)-(e>h?7:0),g=7*(b-1)+(c-e)+f+1,{year:g>0?a:a-1,dayOfYear:g>0?g:z(a-1)+g}}function fa(b){var c=b._i,d=b._f;return null===c||d===a&&""===c?pa.invalid({nullInput:!0}):("string"==typeof c&&(b._i=c=H().preparse(c)),pa.isMoment(c)?(b=k(c),b._d=new Date(+c._d)):d?q(d)?W(b):T(b):Z(b),new h(b))}function ga(a,b){var c,d;if(1===b.length&&q(b[0])&&(b=b[0]),!b.length)return pa();for(c=b[0],d=1;d<b.length;++d)b[d][a](c)&&(c=b[d]);return c}function ha(a,b){var c;return"string"==typeof b&&(b=a.lang().monthsParse(b),"number"!=typeof b)?a:(c=Math.min(a.date(),x(a.year(),b)),a._d["set"+(a._isUTC?"UTC":"")+"Month"](b,c),a)}function ia(a,b){return a._d["get"+(a._isUTC?"UTC":"")+b]()}function ja(a,b,c){return"Month"===b?ha(a,c):a._d["set"+(a._isUTC?"UTC":"")+b](c)}function ka(a,b){return function(c){return null!=c?(ja(this,a,c),pa.updateOffset(this,b),this):ia(this,a)}}function la(a){return 400*a/146097}function ma(a){return 146097*a/400}function na(a){pa.duration.fn[a]=function(){return this._data[a]}}function oa(a){"undefined"==typeof ender&&(qa=ta.moment,a?ta.moment=d("Accessing Moment through the global scope is deprecated, and will be removed in an upcoming release.",pa):ta.moment=pa)}for(var pa,qa,ra,sa="2.7.0",ta="undefined"!=typeof global?global:this,ua=Math.round,va=0,wa=1,xa=2,ya=3,za=4,Aa=5,Ba=6,Ca={},Da={_isAMomentObject:null,_i:null,_f:null,_l:null,_strict:null,_tzm:null,_isUTC:null,_offset:null,_pf:null,_lang:null},Ea="undefined"!=typeof module&&module.exports,Fa=/^\/?Date\((\-?\d+)/i,Ga=/(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/,Ha=/^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/,Ia=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Q|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,4}|X|zz?|ZZ?|.)/g,Ja=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,Ka=/\d\d?/,La=/\d{1,3}/,Ma=/\d{1,4}/,Na=/[+\-]?\d{1,6}/,Oa=/\d+/,Pa=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,Qa=/Z|[\+\-]\d\d:?\d\d/gi,Ra=/T/i,Sa=/[\+\-]?\d+(\.\d{1,3})?/,Ta=/\d{1,2}/,Ua=/\d/,Va=/\d\d/,Wa=/\d{3}/,Xa=/\d{4}/,Ya=/[+-]?\d{6}/,Za=/[+-]?\d+/,$a=/^\s*(?:[+-]\d{6}|\d{4})-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,_a="YYYY-MM-DDTHH:mm:ssZ",ab=[["YYYYYY-MM-DD",/[+-]\d{6}-\d{2}-\d{2}/],["YYYY-MM-DD",/\d{4}-\d{2}-\d{2}/],["GGGG-[W]WW-E",/\d{4}-W\d{2}-\d/],["GGGG-[W]WW",/\d{4}-W\d{2}/],["YYYY-DDD",/\d{4}-\d{3}/]],bb=[["HH:mm:ss.SSSS",/(T| )\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],cb=/([\+\-]|\d\d)/gi,db=("Date|Hours|Minutes|Seconds|Milliseconds".split("|"),{Milliseconds:1,Seconds:1e3,Minutes:6e4,Hours:36e5,Days:864e5,Months:2592e6,Years:31536e6}),eb={ms:"millisecond",s:"second",m:"minute",h:"hour",d:"day",D:"date",w:"week",W:"isoWeek",M:"month",Q:"quarter",y:"year",DDD:"dayOfYear",e:"weekday",E:"isoWeekday",gg:"weekYear",GG:"isoWeekYear"},fb={dayofyear:"dayOfYear",isoweekday:"isoWeekday",isoweek:"isoWeek",weekyear:"weekYear",isoweekyear:"isoWeekYear"},gb={},hb={s:45,m:45,h:22,d:26,M:11},ib="DDD w W M D d".split(" "),jb="M D H h m s w W".split(" "),kb={M:function(){return this.month()+1},MMM:function(a){return this.lang().monthsShort(this,a)},MMMM:function(a){return this.lang().months(this,a)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(a){return this.lang().weekdaysMin(this,a)},ddd:function(a){return this.lang().weekdaysShort(this,a)},dddd:function(a){return this.lang().weekdays(this,a)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return m(this.year()%100,2)},YYYY:function(){return m(this.year(),4)},YYYYY:function(){return m(this.year(),5)},YYYYYY:function(){var a=this.year(),b=a>=0?"+":"-";return b+m(Math.abs(a),6)},gg:function(){return m(this.weekYear()%100,2)},gggg:function(){return m(this.weekYear(),4)},ggggg:function(){return m(this.weekYear(),5)},GG:function(){return m(this.isoWeekYear()%100,2)},GGGG:function(){return m(this.isoWeekYear(),4)},GGGGG:function(){return m(this.isoWeekYear(),5)},e:function(){return this.weekday()},E:function(){return this.isoWeekday()},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),!0)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),!1)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return w(this.milliseconds()/100)},SS:function(){return m(w(this.milliseconds()/10),2)},SSS:function(){return m(this.milliseconds(),3)},SSSS:function(){return m(this.milliseconds(),3)},Z:function(){var a=-this.zone(),b="+";return 0>a&&(a=-a,b="-"),b+m(w(a/60),2)+":"+m(w(a)%60,2)},ZZ:function(){var a=-this.zone(),b="+";return 0>a&&(a=-a,b="-"),b+m(w(a/60),2)+m(w(a)%60,2)},z:function(){return this.zoneAbbr()},zz:function(){return this.zoneName()},X:function(){return this.unix()},Q:function(){return this.quarter()}},lb=["months","monthsShort","weekdays","weekdaysShort","weekdaysMin"];ib.length;)ra=ib.pop(),kb[ra+"o"]=f(kb[ra],ra);for(;jb.length;)ra=jb.pop(),kb[ra+ra]=e(kb[ra],2);kb.DDDD=e(kb.DDD,3),j(g.prototype,{set:function(a){var b,c;for(c in a)b=a[c],"function"==typeof b?this[c]=b:this["_"+c]=b},_months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),months:function(a){return this._months[a.month()]},_monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),monthsShort:function(a){return this._monthsShort[a.month()]},monthsParse:function(a){var b,c,d;for(this._monthsParse||(this._monthsParse=[]),b=0;12>b;b++)if(this._monthsParse[b]||(c=pa.utc([2e3,b]),d="^"+this.months(c,"")+"|^"+this.monthsShort(c,""),this._monthsParse[b]=new RegExp(d.replace(".",""),"i")),this._monthsParse[b].test(a))return b},_weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdays:function(a){return this._weekdays[a.day()]},_weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysShort:function(a){return this._weekdaysShort[a.day()]},_weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),weekdaysMin:function(a){return this._weekdaysMin[a.day()]},weekdaysParse:function(a){var b,c,d;for(this._weekdaysParse||(this._weekdaysParse=[]),b=0;7>b;b++)if(this._weekdaysParse[b]||(c=pa([2e3,1]).day(b),d="^"+this.weekdays(c,"")+"|^"+this.weekdaysShort(c,"")+"|^"+this.weekdaysMin(c,""),this._weekdaysParse[b]=new RegExp(d.replace(".",""),"i")),this._weekdaysParse[b].test(a))return b},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(a){var b=this._longDateFormat[a];return!b&&this._longDateFormat[a.toUpperCase()]&&(b=this._longDateFormat[a.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(a){return a.slice(1)}),this._longDateFormat[a]=b),b},isPM:function(a){return"p"===(a+"").toLowerCase().charAt(0)},_meridiemParse:/[ap]\.?m?\.?/i,meridiem:function(a,b,c){return a>11?c?"pm":"PM":c?"am":"AM"},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},calendar:function(a,b){var c=this._calendar[a];return"function"==typeof c?c.apply(b):c},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(a,b,c,d){var e=this._relativeTime[c];return"function"==typeof e?e(a,b,c,d):e.replace(/%d/i,a)},pastFuture:function(a,b){var c=this._relativeTime[a>0?"future":"past"];return"function"==typeof c?c(b):c.replace(/%s/i,b)},ordinal:function(a){return this._ordinal.replace("%d",a)},_ordinal:"%d",preparse:function(a){return a},postformat:function(a){return a},week:function(a){return da(a,this._week.dow,this._week.doy).week},_week:{dow:0,doy:6},_invalidDate:"Invalid date",invalidDate:function(){return this._invalidDate}}),pa=function(b,d,e,f){var g;return"boolean"==typeof e&&(f=e,e=a),g={},g._isAMomentObject=!0,g._i=b,g._f=d,g._l=e,g._strict=f,g._isUTC=!1,g._pf=c(),fa(g)},pa.suppressDeprecationWarnings=!1,pa.createFromInputFallback=d("moment construction falls back to js Date. This is discouraged and will be removed in upcoming major release. Please refer to https://github.com/moment/moment/issues/1407 for more info.",function(a){a._d=new Date(a._i)}),pa.min=function(){var a=[].slice.call(arguments,0);return ga("isBefore",a)},pa.max=function(){var a=[].slice.call(arguments,0);return ga("isAfter",a)},pa.utc=function(b,d,e,f){var g;return"boolean"==typeof e&&(f=e,e=a),g={},g._isAMomentObject=!0,g._useUTC=!0,g._isUTC=!0,g._l=e,g._i=b,g._f=d,g._strict=f,g._pf=c(),fa(g).utc()},pa.unix=function(a){return pa(1e3*a)},pa.duration=function(a,b){var c,d,e,f,g=a,h=null;return pa.isDuration(a)?g={ms:a._milliseconds,d:a._days,M:a._months}:"number"==typeof a?(g={},b?g[b]=a:g.milliseconds=a):(h=Ga.exec(a))?(c="-"===h[1]?-1:1,g={y:0,d:w(h[xa])*c,h:w(h[ya])*c,m:w(h[za])*c,s:w(h[Aa])*c,ms:w(h[Ba])*c}):(h=Ha.exec(a))?(c="-"===h[1]?-1:1,e=function(a){var b=a&&parseFloat(a.replace(",","."));return(isNaN(b)?0:b)*c},g={y:e(h[2]),M:e(h[3]),d:e(h[4]),h:e(h[5]),m:e(h[6]),s:e(h[7]),w:e(h[8])}):"object"==typeof g&&("from"in g||"to"in g)&&(f=o(pa(g.from),pa(g.to)),g={},g.ms=f.milliseconds,g.M=f.months),d=new i(g),pa.isDuration(a)&&a.hasOwnProperty("_lang")&&(d._lang=a._lang),d},pa.version=sa,pa.defaultFormat=_a,pa.ISO_8601=function(){},pa.momentProperties=Da,pa.updateOffset=function(){},pa.relativeTimeThreshold=function(b,c){return hb[b]===a?!1:c===a?hb[b]:(hb[b]=c,!0)},pa.lang=function(a,b){var c;return a?(b?F(D(a),b):null===b?(G(a),a="en"):Ca[a]||H(a),c=pa.duration.fn._lang=pa.fn._lang=H(a),c._abbr):pa.fn._lang._abbr},pa.langData=function(a){return a&&a._lang&&a._lang._abbr&&(a=a._lang._abbr),H(a)},pa.isMoment=function(a){return a instanceof h||null!=a&&a.hasOwnProperty("_isAMomentObject")},pa.isDuration=function(a){return a instanceof i};for(ra=lb.length-1;ra>=0;--ra)v(lb[ra]);pa.normalizeUnits=function(a){return t(a)},pa.invalid=function(a){var b=pa.utc(NaN);return null!=a?j(b._pf,a):b._pf.userInvalidated=!0,b},pa.parseZone=function(){return pa.apply(null,arguments).parseZone()},pa.parseTwoDigitYear=function(a){return w(a)+(w(a)>68?1900:2e3)},j(pa.fn=h.prototype,{clone:function(){return pa(this)},valueOf:function(){return+this._d+6e4*(this._offset||0)},unix:function(){return Math.floor(+this/1e3)},toString:function(){return this.clone().lang("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._offset?new Date(+this):this._d},toISOString:function(){var a=pa(this).utc();return 0<a.year()&&a.year()<=9999?K(a,"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]"):K(a,"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]")},toArray:function(){var a=this;return[a.year(),a.month(),a.date(),a.hours(),a.minutes(),a.seconds(),a.milliseconds()]},isValid:function(){return C(this)},isDSTShifted:function(){return this._a?this.isValid()&&s(this._a,(this._isUTC?pa.utc(this._a):pa(this._a)).toArray())>0:!1},parsingFlags:function(){return j({},this._pf)},invalidAt:function(){return this._pf.overflow},utc:function(a){return this.zone(0,a)},local:function(a){return this._isUTC&&(this.zone(0,a),this._isUTC=!1,a&&this.add(this._d.getTimezoneOffset(),"m")),this},format:function(a){var b=K(this,a||pa.defaultFormat);return this.lang().postformat(b)},add:function(a,b){var c;return c="string"==typeof a&&"string"==typeof b?pa.duration(isNaN(+b)?+a:+b,isNaN(+b)?b:a):"string"==typeof a?pa.duration(+b,a):pa.duration(a,b),p(this,c,1),this},subtract:function(a,b){var c;return c="string"==typeof a&&"string"==typeof b?pa.duration(isNaN(+b)?+a:+b,isNaN(+b)?b:a):"string"==typeof a?pa.duration(+b,a):pa.duration(a,b),p(this,c,-1),this},diff:function(a,b,c){var d,e,f=E(a,this),g=6e4*(this.zone()-f.zone());return b=t(b),"year"===b||"month"===b?(d=432e5*(this.daysInMonth()+f.daysInMonth()),e=12*(this.year()-f.year())+(this.month()-f.month()),e+=(this-pa(this).startOf("month")-(f-pa(f).startOf("month")))/d,e-=6e4*(this.zone()-pa(this).startOf("month").zone()-(f.zone()-pa(f).startOf("month").zone()))/d,"year"===b&&(e/=12)):(d=this-f,e="second"===b?d/1e3:"minute"===b?d/6e4:"hour"===b?d/36e5:"day"===b?(d-g)/864e5:"week"===b?(d-g)/6048e5:d),c?e:l(e)},from:function(a,b){return pa.duration({to:this,from:a}).lang(this.lang()._abbr).humanize(!b)},fromNow:function(a){return this.from(pa(),a)},calendar:function(a){var b=a||pa(),c=E(b,this).startOf("day"),d=this.diff(c,"days",!0),e=-6>d?"sameElse":-1>d?"lastWeek":0>d?"lastDay":1>d?"sameDay":2>d?"nextDay":7>d?"nextWeek":"sameElse";return this.format(this.lang().calendar(e,this))},isLeapYear:function(){return A(this.year())},isDST:function(){return this.zone()<this.clone().month(0).zone()||this.zone()<this.clone().month(5).zone()},day:function(a){var b=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=a?(a=aa(a,this.lang()),this.add(a-b,"days")):b},month:ka("Month",!0),startOf:function(a){switch(a=t(a)){case"year":this.month(0);case"quarter":case"month":this.date(1);case"week":case"isoWeek":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}return"week"===a?this.weekday(0):"isoWeek"===a&&this.isoWeekday(1),"quarter"===a&&this.month(3*Math.floor(this.month()/3)),this},endOf:function(a){return a=t(a),this.startOf(a).add("isoWeek"===a?"week":a,1).subtract("ms",1);
},isAfter:function(a,b){return b="undefined"!=typeof b?b:"millisecond",+this.clone().startOf(b)>+pa(a).startOf(b)},isBefore:function(a,b){return b="undefined"!=typeof b?b:"millisecond",+this.clone().startOf(b)<+pa(a).startOf(b)},isSame:function(a,b){return b=b||"ms",+this.clone().startOf(b)===+E(a,this).startOf(b)},min:d("moment().min is deprecated, use moment.min instead. https://github.com/moment/moment/issues/1548",function(a){return a=pa.apply(null,arguments),this>a?this:a}),max:d("moment().max is deprecated, use moment.max instead. https://github.com/moment/moment/issues/1548",function(a){return a=pa.apply(null,arguments),a>this?this:a}),zone:function(a,b){var c,d=this._offset||0;return null==a?this._isUTC?d:this._d.getTimezoneOffset():("string"==typeof a&&(a=N(a)),Math.abs(a)<16&&(a=60*a),!this._isUTC&&b&&(c=this._d.getTimezoneOffset()),this._offset=a,this._isUTC=!0,null!=c&&this.subtract(c,"m"),d!==a&&(!b||this._changeInProgress?p(this,pa.duration(d-a,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,pa.updateOffset(this,!0),this._changeInProgress=null)),this)},zoneAbbr:function(){return this._isUTC?"UTC":""},zoneName:function(){return this._isUTC?"Coordinated Universal Time":""},parseZone:function(){return this._tzm?this.zone(this._tzm):"string"==typeof this._i&&this.zone(this._i),this},hasAlignedHourOffset:function(a){return a=a?pa(a).zone():0,(this.zone()-a)%60===0},daysInMonth:function(){return x(this.year(),this.month())},dayOfYear:function(a){var b=ua((pa(this).startOf("day")-pa(this).startOf("year"))/864e5)+1;return null==a?b:this.add("d",a-b)},quarter:function(a){return null==a?Math.ceil((this.month()+1)/3):this.month(3*(a-1)+this.month()%3)},weekYear:function(a){var b=da(this,this.lang()._week.dow,this.lang()._week.doy).year;return null==a?b:this.add("y",a-b)},isoWeekYear:function(a){var b=da(this,1,4).year;return null==a?b:this.add("y",a-b)},week:function(a){var b=this.lang().week(this);return null==a?b:this.add("d",7*(a-b))},isoWeek:function(a){var b=da(this,1,4).week;return null==a?b:this.add("d",7*(a-b))},weekday:function(a){var b=(this.day()+7-this.lang()._week.dow)%7;return null==a?b:this.add("d",a-b)},isoWeekday:function(a){return null==a?this.day()||7:this.day(this.day()%7?a:a-7)},isoWeeksInYear:function(){return y(this.year(),1,4)},weeksInYear:function(){var a=this._lang._week;return y(this.year(),a.dow,a.doy)},get:function(a){return a=t(a),this[a]()},set:function(a,b){return a=t(a),"function"==typeof this[a]&&this[a](b),this},lang:function(b){return b===a?this._lang:(this._lang=H(b),this)}}),pa.fn.millisecond=pa.fn.milliseconds=ka("Milliseconds",!1),pa.fn.second=pa.fn.seconds=ka("Seconds",!1),pa.fn.minute=pa.fn.minutes=ka("Minutes",!1),pa.fn.hour=pa.fn.hours=ka("Hours",!0),pa.fn.date=ka("Date",!0),pa.fn.dates=d("dates accessor is deprecated. Use date instead.",ka("Date",!0)),pa.fn.year=ka("FullYear",!0),pa.fn.years=d("years accessor is deprecated. Use year instead.",ka("FullYear",!0)),pa.fn.days=pa.fn.day,pa.fn.months=pa.fn.month,pa.fn.weeks=pa.fn.week,pa.fn.isoWeeks=pa.fn.isoWeek,pa.fn.quarters=pa.fn.quarter,pa.fn.toJSON=pa.fn.toISOString,j(pa.duration.fn=i.prototype,{_bubble:function(){var a,b,c,d=this._milliseconds,e=this._days,f=this._months,g=this._data,h=0;g.milliseconds=d%1e3,a=l(d/1e3),g.seconds=a%60,b=l(a/60),g.minutes=b%60,c=l(b/60),g.hours=c%24,e+=l(c/24),h=l(la(e)),e-=l(ma(h)),f+=l(e/30),e%=30,h+=l(f/12),f%=12,g.days=e,g.months=f,g.years=h},abs:function(){return this._milliseconds=Math.abs(this._milliseconds),this._days=Math.abs(this._days),this._months=Math.abs(this._months),this._data.milliseconds=Math.abs(this._data.milliseconds),this._data.seconds=Math.abs(this._data.seconds),this._data.minutes=Math.abs(this._data.minutes),this._data.hours=Math.abs(this._data.hours),this._data.months=Math.abs(this._data.months),this._data.years=Math.abs(this._data.years),this},weeks:function(){return l(this.days()/7)},valueOf:function(){return this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*w(this._months/12)},humanize:function(a){var b=ca(this,!a,this.lang());return a&&(b=this.lang().pastFuture(+this,b)),this.lang().postformat(b)},add:function(a,b){var c=pa.duration(a,b);return this._milliseconds+=c._milliseconds,this._days+=c._days,this._months+=c._months,this._bubble(),this},subtract:function(a,b){var c=pa.duration(a,b);return this._milliseconds-=c._milliseconds,this._days-=c._days,this._months-=c._months,this._bubble(),this},get:function(a){return a=t(a),this[a.toLowerCase()+"s"]()},as:function(a){var b,c;if(a=t(a),b=this._days+this._milliseconds/864e5,"month"===a||"year"===a)return c=this._months+12*la(b),"month"===a?c:c/12;switch(b+=ma(this._months/12),a){case"week":return b/7;case"day":return b;case"hour":return 24*b;case"minute":return 24*b*60;case"second":return 24*b*60*60;case"millisecond":return 24*b*60*60*1e3;default:throw new Error("Unknown unit "+a)}},lang:pa.fn.lang,toIsoString:function(){var a=Math.abs(this.years()),b=Math.abs(this.months()),c=Math.abs(this.days()),d=Math.abs(this.hours()),e=Math.abs(this.minutes()),f=Math.abs(this.seconds()+this.milliseconds()/1e3);return this.asSeconds()?(this.asSeconds()<0?"-":"")+"P"+(a?a+"Y":"")+(b?b+"M":"")+(c?c+"D":"")+(d||e||f?"T":"")+(d?d+"H":"")+(e?e+"M":"")+(f?f+"S":""):"P0D"}});for(ra in db)db.hasOwnProperty(ra)&&na(ra.toLowerCase());pa.duration.fn.asMilliseconds=function(){return this.as("ms")},pa.duration.fn.asSeconds=function(){return this.as("s")},pa.duration.fn.asMinutes=function(){return this.as("m")},pa.duration.fn.asHours=function(){return this.as("h")},pa.duration.fn.asDays=function(){return this.as("d")},pa.duration.fn.asWeeks=function(){return this.as("weeks")},pa.duration.fn.asMonths=function(){return this.as("M")},pa.duration.fn.asYears=function(){return this.as("y")},pa.lang("en",{ordinal:function(a){var b=a%10,c=1===w(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c}}),Ea?module.exports=pa:"function"==typeof define&&define.amd?(define("moment",function(a,b,c){return c.config&&c.config()&&c.config().noGlobal===!0&&(ta.moment=qa),pa}),oa(!0)):oa()}.call(this);var mod=angular.module("infinite-scroll",[]);mod.directive("infiniteScroll",["$rootScope","$window","$timeout",function(a,b,c){return{link:function(d,e,f){c(function(){b=angular.element(b);var g,h,i,j,k,l,m;return g=e.parents().filter(function(){return/(auto|scroll)/.test($.css(this,"overflow")+$.css(this,"overflow-y"))}).eq(0),0===g.length&&(g=b),null!=f.infiniteScrollSelf&&(g=e),k=0,null!=f.infiniteScrollDistance&&d.$watch(f.infiniteScrollDistance,function(a){return k=parseFloat(a,10)}),l=!0,h=!1,null!=f.infiniteScrollDisabled&&d.$watch(f.infiniteScrollDisabled,function(a){return l=!a,l&&h?(h=!1,j()):void 0}),m=g!==b?g.position().top:0,i=e.position().top-m,j=function(){var b,c,j,m;return e==g?(c=e[0].scrollHeight-e.scrollTop()-e.height(),m=c<=e[0].scrollHeight*k):(b=i+e.height(),j=g.height()+g.scrollTop(),c=b-j,m=c<=g.height()*k),m&&l?a.$$phase?d.$eval(f.infiniteScroll):d.$apply(f.infiniteScroll):m?h=!0:void 0},g.on("scroll",j),d.$on("$destroy",function(){return g.off("scroll",j)}),c(function(){return f.infiniteScrollImmediateCheck?d.$eval(f.infiniteScrollImmediateCheck)?j():void 0:j()},0)},0)}}}]),function(a){"use strict";function b(a){return a.replace(c,function(a,b,c,d){return d?c.toUpperCase():c}).replace(d,"Moz$1")}var c=/([\:\-\_]+(.))/g,d=/^moz([A-Z])/;a.module("translate",[],["$provide",function(b){b.factory("translate",["$log",function(b){var c={},d=!1,e=function(a,e){return a?(a=$.trim(a),a=a.replace(/<!--IE fix-->/g,""),a=a.replace(/ class="ng-binding"/g,""),c[e||"default"][a]?c[e||"default"][a]:(d&&b.warn('Missing localisation for "'+a+'"'),a)):""};return e.add=function(b,d){a.isUndefined(c[d||"default"])&&(c[d||"default"]={}),a.extend(c[d||"default"],b)},e.remove=function(a,b){return c[b||"default"][a]?(delete c[b||"default"][a],!0):!1},e.set=function(a,b){c[b||"default"]=a},e.logMissedHits=function(a){d=a},e}])}]),a.module("translate.directives",["translate"],["$compileProvider",function(c){c.directive("translate",["$compile","translate",function(c,d){return{priority:10,restrict:"ECMA",compile:function(e,f){var g=!1;if(f.translate){var h=f.translate.split(" ");a.forEach(h,function(a){e.attr(a,d(f[b(a)]))}),g=h.indexOf("innerHTML")>=0}else g=!0;return function(a,b,e){if(g){var f=d(b.html());b.empty().append(f)}try{c(b.contents())(a)}catch(h){}}}}}])}]),a.module("translate.filters",["translate"]).filter("translate",["translate",function(a){return function(b){return a(b)}}])}(angular),function(){"use strict";Array.prototype.indexOf||(Array.prototype.indexOf=function(a){var b=this.length>>>0,c=Number(arguments[1])||0;for(c=0>c?Math.ceil(c):Math.floor(c),0>c&&(c+=b);b>c;c++)if(c in this&&this[c]===a)return c;return-1}),Array.prototype.filter||(Array.prototype.filter=function(a){if(void 0===this||null===this)throw new TypeError;var b=Object(this),c=b.length>>>0;if("function"!=typeof a)throw new TypeError;for(var d=[],e=arguments.length>=2?arguments[1]:void 0,f=0;c>f;f++)if(f in b){var g=b[f];a.call(e,g,f,b)&&d.push(g)}return d}),Array.prototype.map||(Array.prototype.map=function(a,b){var c,d,e;if(null===this)throw new TypeError(" this is null or not defined");var f=Object(this),g=f.length>>>0;if("function"!=typeof a)throw new TypeError(a+" is not a function");for(arguments.length>1&&(c=b),d=new Array(g),e=0;g>e;){var h,i;e in f&&(h=f[e],i=a.call(c,h,e,f),d[e]=i),e++}return d}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),Object.keys||(Object.keys=function(){var a=Object.prototype.hasOwnProperty,b=!{toString:null}.propertyIsEnumerable("toString"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],d=c.length;return function(e){if("object"!=typeof e&&("function"!=typeof e||null===e))throw new TypeError("Object.keys called on non-object");var f,g,h=[];for(f in e)a.call(e,f)&&h.push(f);if(b)for(g=0;d>g;g++)a.call(e,c[g])&&h.push(c[g]);return h}}()),String.prototype.startsWith||(String.prototype.startsWith=function(a,b){return b=b||0,this.lastIndexOf(a,b)===b}),String.prototype.endsWith||(String.prototype.endsWith=function(a,b){var c=this.toString();(void 0===b||b>c.length)&&(b=c.length),b-=a.length;var d=c.indexOf(a,b);return-1!==d&&d===b}),window.hasOwnProperty||(window.hasOwnProperty=function(a){return Object.prototype.hasOwnProperty.call(window,a)}),window.selectText=function(a){var b,c,d=document;d.body.createTextRange?(b=document.body.createTextRange(),b.moveToElementText(a),b.select()):window.getSelection&&(c=window.getSelection(),b=document.createRange(),b.selectNodeContents(a),c.removeAllRanges(),c.addRange(b))},window.isObjectEmpty=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},window.utf8_to_b64=function(a){return window.btoa(jsesc(a,{json:!0}))},window.b64_to_utf8=function(a){return window.atob(a)}}(),function(){"use strict";var a="0.1.7-dev",b=angular.module("ods-widgets",["infinite-scroll","ngSanitize","translate","translate.directives","translate.filters"]);b.provider("ODSWidgetsConfig",function(){this.defaultConfig={ODSWidgetsVersion:a,defaultDomain:"",language:null,disqusShortname:null,customAPIHeaders:null,basemaps:[{provider:"mapquest",label:"MapQuest"}],mapGeobox:!1,chartColors:null,mapPrependAttribution:null,basePath:null,websiteName:null,themes:{},defaultMapLocation:"12,48.85218,2.36996"},this.customConfig={},this.setConfig=function(a){angular.extend(this.customConfig,a)},this.$get=function(){return angular.extend({},this.defaultConfig,this.customConfig)}}),b.run(["translate","ODSWidgetsConfig",function(a,b){if(a.add({}),!b.basePath){var c,d,e,f,g=document.getElementsByTagName("script"),h=/[\/^]ods-widgets(\.min)?\.js\??/;for(c=0;c<g.length;c++)d=g[c].src,e=d.match(h),e&&(f=d.split(h)[0],f?".js"===f.substring(f.length-3)?b.basePath="":b.basePath=f+"/":b.basePath="/")}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.service("ODSAPI",["$http","ODSWidgetsConfig","odsErrorService",function(a,b,c){var d=function(d,e,f,g){var h=d?d.domainUrl:"";h+=e,f=ODS.URLUtils.cleanupAPIParams(f)||{},f.timezone=jstz.determine().name(),d&&d.apikey&&(f.apikey=d.apikey);var i={params:f};return g&&(i.timeout=g),h.startsWith("http://")||(b.customAPIHeaders?i.headers=b.customAPIHeaders:i.headers={},i.headers["ODS-Widgets-Version"]=b.ODSWidgetsVersion),!d.domainUrl||Modernizr.cors?a.get(h,i).error(function(a){a&&c.sendErrorNotification(a)}):(h+=h.indexOf("?")>-1?"&":"?",h+="callback=JSON_CALLBACK",a.jsonp(h,i))};return{getDomainURL:function(a){var c=null;return angular.isUndefined(a)||null===a||""===a?c=b.defaultDomain:(c="/"!==a.substr(0,1)&&-1===a.indexOf(".")?a+".opendatasoft.com":a,"/"!==c.substr(0,1)&&-1===c.indexOf("http://")&&-1===c.indexOf("https://")&&(c="https://"+c)),"/"===c.substr(-1)&&(c=c.substr(0,c.length-1)),c},datasets:{get:function(a,b,c){return d(a,"/api/datasets/1.0/"+b+"/",c)},search:function(a,b){var c=angular.extend({},a.parameters,b);return d(a,"/api/datasets/1.0/search/",c)},facets:function(a,b){return this.search(a,{rows:0,facet:b})}},records:{analyze:function(a,b,c){return d(a,"/api/records/1.0/analyze/",angular.extend({},b,{dataset:a.dataset.datasetid}),c)},search:function(a,b,c){return d(a,"/api/records/1.0/search/",angular.extend({},b,{dataset:a.dataset.datasetid}),c)},download:function(a,b,c){return d(a,"/api/records/1.0/download/",angular.extend({},b,{dataset:a.dataset.datasetid}),c)},geo:function(a,b,c){return d(a,"/api/records/1.0/geocluster/",angular.extend({},b,{dataset:a.dataset.datasetid}),c)},geopreview:function(a,b,c){return d(a,"/api/records/1.0/geopreview/",angular.extend({},b,{dataset:a.dataset.datasetid}),c)},boundingbox:function(a,b,c){return d(a,"/api/records/1.0/boundingbox/",angular.extend({},b,{dataset:a.dataset.datasetid}),c)},geopolygon:function(a,b,c){return d(a,"/api/records/1.0/geopolygon/",angular.extend({},b,{dataset:a.dataset.datasetid}),c)}},reuses:function(a,b){return d(a,"/api/reuses/",b)}}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.factory("AggregationHelper",["translate",function(a){var b=[{label:a("Count"),func:"COUNT"},{label:a("Average"),func:"AVG"},{label:a("Minimum"),func:"MIN"},{label:a("Maximum"),func:"MAX"},{label:a("Standard deviation"),func:"STDDEV"},{label:a("Sum"),func:"SUM"},{label:a("Percentile"),func:"QUANTILES"},{label:a("Constant value"),func:"CONSTANT"}];return{getAvailableFunctions:function(a){return 0===a?[b[0],b[b.length-1]]:b},getAvailableFunction:function(a){return b[a]},getFunctionLabel:function(a){return a=a.toUpperCase(),$.grep(b,function(b){return a===b.func})[0].label}}}]),a.factory("ChartHelper",["translate","AggregationHelper","ODSWidgetsConfig","colorScale",function(a,b,c,d){var e={},f={},g={year:a("Year"),month:a("Month"),day:a("Day"),hour:a("Hour"),minute:a("Minute"),"month month":a("Month of year"),"day day":a("Day of month"),"day weekday":a("Day of week"),"hour weekday":a("Hour per weekday"),"day month":a("Day of year"),"hour hour":a("Hour of day")},h={},i=[],j={"top left":{center:["15%","20%"],size:"25%"},"top right":{center:["85%","20%"],size:"25%"},"bottom left":{center:["15%","80%"],size:"25%"},"bottom right":{center:["85%","80%"],size:"25%"},center:{}},k=c.chartColors||chroma.brewer.Set2,l=[{label:a("Line"),type:"line",group:a("line charts")},{label:a("Spline"),type:"spline",group:a("line charts")},{label:a("Range"),type:"arearange",group:a("Area charts"),filter:"hasNumericField"},{label:a("Range spline"),type:"areasplinerange",group:a("Area charts"),filter:"hasNumericField"},{label:a("Column range"),type:"columnrange",group:a("Area charts"),filter:"hasNumericField"},{label:a("Treemap"),type:"treemap",group:a("Special")},{label:a("Area"),type:"area",group:a("Area charts")},{label:a("Area spline"),type:"areaspline",group:a("Area charts")},{label:a("Column chart"),type:"column",group:a("Bar charts")},{label:a("Bar chart"),type:"bar",group:a("Bar charts")},{label:a("Pie chart"),type:"pie",group:a("Pie charts")},{label:a("Scatter plot"),type:"scatter",group:a("line charts")}],m=["year","month","day","hour","minute"],n=["month month","day day","day weekday","hour weekday","day month","hour hour"],o={},p={},q=function(a,b,c){var d=!1;a?d=!0:a="date"==b?"day":"hour";for(var e=[],f=0;f<=m.indexOf(a)&&(e.push({name:m[f],label:g[m[f]]}),"date"!==b||"day"!=m[f])&&("datetime"!==b||d||"hour"!=m[f])&&("datetime"!==b||!d||"minute"!=m[f]);f++);if(c)for(var h=0;h<n.length&&(e.push({name:n[h],label:g[n[h]]}),"date"!==b||"day month"!=m[h]);h++);return e};return{getDatasetUniqueId:function(a){var b;if(angular.forEach(p,function(c,d){return d.endsWith(a)&&(b=c),!1}),b)return b.getUniqueId();throw"dataset "+a+" not loaded yet."},getDataset:function(a){var b;return angular.forEach(p,function(c,d){return a===d&&(b=c),!1}),b},isChartSortable:function(a){return!this.isRangeChart(a)},isRangeChart:function(a){return["arearange","areasplinerange","columnrange"].indexOf(a)>-1},getAllTimescales:function(){return q("minute","datetime",!0)},getAvailableX:function(a,b,c){c=!!c;var d=this;return"undefined"==typeof b?c?$.grep(e[a],function(b){return-1!==["date","datetime"].indexOf(d.getFieldType(a,b.name))}):e[a]:e[a][b]},getAvailableBreakDowns:function(a,b){if(!b)return[];for(var c=-1!==["date","datetime"].indexOf(this.getFieldType(a,b)),d=[],f=0;f<e[a].length;f++)e[a][f].name!==b&&(c&&-1!==["date","datetime"].indexOf(this.getFieldType(a,e[a][f].name))||d.push({label:e[a][f].label,name:e[a][f].name}));return d},getAvailableY:function(a,b){return"undefined"==typeof b?f[a]:f[a][b]},getTimescales:function(a,b,c){for(var d,e,f=0;f<o[a].length;f++)if(o[a][f].name===b){e=o[a][f];break}if(e){if(e.annotations)for(var g=0;g<e.annotations.length;g++)if("timeserie_precision"==e.annotations[g].name){d=e.annotations[g].args[0];break}return q(d,e.type,c)}},getDatasetId:function(a){return(a.domain||"")+"."+a.dataset.datasetid},init:function(a,b,c){"undefined"==typeof c&&(c=!1);var d=[],e=[],f=this.getDatasetId(a);if(c||!(f in i)){o[f]=a.dataset.fields;for(var g=0;g<o[f].length;g++){var h=o[f][g];if(("int"==h.type||"double"==h.type)&&e.push(h),"datetime"==h.type||"date"==h.type)d.unshift(h);else if(h.annotations)for(var j=0;j<h.annotations.length;j++){var k=h.annotations[j];"facet"==k.name&&d.push(h)}}this.setAvailableX(f,d),this.setAvailableY(f,e),i[f]=!0,p[f]=a.dataset,this.load(f)}},isInitialized:function(a){return""===a?!!i.length:!!(a in i)},load:function(a){if(h[a])for(var b=0;b<h[a].length;b++)h[a][b]();if(h[a]=[],h[""])for(var b=0;b<h[""].length;b++)h[""][b]();h[""]=[]},onLoad:function(a,b){"function"==typeof a&&(b=a,a=""),this.isInitialized(a)?b():(a in h||(h[a]=[]),h[a].indexOf(b)<0&&h[a].push(b))},setAvailableX:function(a,b){e[a]=b},setAvailableY:function(a,b){f[a]=b},resolvePosition:function(a){return void 0==typeof a&&(a="center"),a in j||(a="center"),j[a]},getPieChartPositions:function(){return $.map(j,function(a,b){return b})},getDefaultColors:function(){return k},getDefaultColor:function(a,b,c,e){return d.getDefaultColor(a,this.getAllowedColors(b,c),e)},getAllowedColors:function(a,b){var c=[];return(b||-1!==["pie"].indexOf(a))&&c.push("range"),b||-1!==["pie"].indexOf(a)||c.push("single"),c},getAvailableChartTypes:function(a,b){var c=[];if(p[a])for(var d=0;d<l.length;d++)(b&&-1!==["column","area","areaspline","line","spline","bar"].indexOf(l[d].type)||!b)&&("undefined"==typeof l[d].filter?c.push(l[d]):p[a][l[d].filter]()&&c.push(l[d]));return c},getSerieTemplate:function(){return angular.copy({})},setChartDefaultValues:function(a,b,c){var d,e="";if("undefined"==typeof c&&(c=!1),b.timescale){for(var f=0;f<b.queries.length;f++)d=this.getFieldType(a,b.queries[f].xAxis),!b.queries[f].timescale||"date"!==d&&"datetime"!==d||(e=b.queries[f].timescale);e||(b.timescale="")}else{for(var f=0;f<b.queries.length;f++)d=this.getFieldType(a,b.queries[f].xAxis),!b.queries[f].timescale||"date"!==d&&"datetime"!==d||(e=b.queries[f].timescale);e&&(b.timescale=b.queries[0].timescale)}if(b.timescale)for(var f=0;f<b.queries.length;f++)b.queries[f].timescale||(b.queries[f].timescale=b.timescale);b.singleAxis||(delete b.singleAxisLabel,delete b.singleAxisScale,delete b.yRangeMin,delete b.yRangeMax),c||delete b.xLabel},setDefaultQueryValues:function(a,b,c,d,e,f){b||(b={});var g={},h=g.x||this.getAvailableX(a,0).name,i=50,j="";("date"==this.getFieldType(a,h)||"datetime"==this.getFieldType(a,h))&&(i="",j=g.timescale||"year"),b.xAxis||(b.xAxis=h),"undefined"==typeof b.maxpoints&&(b.maxpoints=i),b.charts||(b.charts=[]);var k=b.xAxis,l=this.getFieldType(a,k);"date"==l||"datetime"==l?b.timescale&&-1!==this.getTimescales(a,k,c).map(function(a){return a.name}).indexOf(b.timescale)||(b.timescale="year",c&&e?b.timescale=e:b.timescale="year"):b.timescale&&(b.timescale=""),b.seriesBreakdown===k&&(b.seriesBreakdown="",b.seriesBreakdownTimescale="");for(var m=!1,n=0;n<b.charts.length;n++)-1!==["treemap","pie"].indexOf(b.charts[n].type)&&(m=!0);m&&(b.seriesBreakdown="",b.seriesBreakdownTimescale=""),!b.seriesBreakdown&&b.charts.length<2&&delete b.stacked,(!b.sort||b.seriesBreakdown)&&(b.sort="")},setSerieDefaultValues:function(a,b,c,d){if("undefined"!=typeof c){var e=this.getAvailableY(a);b.type||(b.type="column",!c||"date"!=this.getFieldType(a,c)&&"datetime"!=this.getFieldType(a,c)||(b.type="line")),b.func||(b.func=e.length>0?"AVG":"COUNT"),"undefined"!=typeof b.expr&&"undefined"==typeof b.yAxis&&(b.yAxis=b.expr,delete b.expr),"undefined"==typeof b.yAxis||""===b.yAxis?(0===e.length&&-1===["COUNT","CONSTANT","CUSTOM"].indexOf(b.func)&&(b.func="COUNT"),d||-1!==["COUNT","CONSTANT","CUSTOM"].indexOf(b.func)||(b.yAxis=e[0].name)):d||-1!==["COUNT","CONSTANT","CUSTOM"].indexOf(b.func)||0===$.grep(e,function(a){return a.name===b.yAxis}).length&&(b.yAxis=e[0].name),b.type&&this.isRangeChart(b.type)?(b.func="COUNT",b.charts||(b.charts=[{func:"MIN",yAxis:b.yAxis},{func:"MAX",yAxis:b.yAxis}]),("undefined"==typeof b.charts[0].yAxis||""===b.charts[0].yAxis)&&(b.charts[0].yAxis=b.charts[0].expr||b.yAxis,delete b.charts[0].expr),("undefined"==typeof b.charts[1].yAxis||""===b.charts[1].yAxis)&&(b.charts[1].yAxis=b.charts[1].expr||b.yAxis,delete b.charts[1].expr),"QUANTILES"!==b.charts[0].func||""!==b.charts[0].subsets&&"undefined"!=typeof b.charts[0].subsets||(b.charts[0].subsets=5),"QUANTILES"!==b.charts[1].func||""!==b.charts[1].subsets&&"undefined"!=typeof b.charts[1].subsets||(b.charts[1].subsets=95),"QUANTILES"!==b.charts[0].func&&b.charts[0].subsets&&delete b.charts[0].subsets,"QUANTILES"!==b.charts[1].func&&b.charts[1].subsets&&delete b.charts[1].subsets):(b.charts&&delete b.charts,"QUANTILES"===b.func?b.subsets||(b.subsets=50):b.subsets&&delete b.subsets),"pie"!==b.type||b.position||(b.position="center"),delete b.yLabel,delete b.extras}},setSerieDefaultColors:function(a,b,c){a.color=this.getDefaultColor(a.color,a.type,b,c)},getXLabel:function(a,b,c,d){var e=this.getFieldType(a,b),f=this.getFieldLabel(a,b);return"date"!==e&&"datetime"!==e||!c?f:f+" ("+g[c]+")"},getYLabel:function(a,c){if(c.yLabelOverride)return c.yLabelOverride;if(this.isRangeChart(c.type))return this.getYLabel(a,c.charts[0])+" / "+this.getYLabel(a,c.charts[1]);var d=b.getFunctionLabel(c.func),e=c.yAxis||c.expr,f=$.grep(this.getAvailableY(a),function(a){return a.name==e});return f.length>0&&"COUNT"!==c.func&&"CONSTANT"!==c.func&&"CUSTOM"!==c.func?d+" "+f[0].label:d},getField:function(a,b){if(!o[a])return null;for(var c=0;c<o[a].length;c++){var d=o[a][c];if(d.name==b)return d}return void 0},getFieldLabel:function(a,b){var c=this.getField(a,b);return c?c.label:c},getFieldType:function(a,b){var c=this.getField(a,b);return c?c.type:c},getFieldUnit:function(a,b){var c=this.getField(a,b);if(c.annotations){for(var d=0;d<c.annotations.length;d++)if("unit"===c.annotations[d].name)return c.annotations[d].args[0];return c.annotations.unit}return!1},getAvailableFunctions:function(a){return b.getAvailableFunctions(this.getAvailableY(a).length)},allowThresholds:function(a){return-1!==["column","bar","scatter"].indexOf(a)}}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.factory("colorScale",["ODSWidgetsConfig",function(a){function b(a){var b;return a?(a.startsWith("custom-")&&(a=a.replace("custom-","")),a.startsWith("range-")?a=a.replace("range-",""):a.startsWith("single-")&&(a=a.replace("single-","")),chroma.brewer[a]&&(b=a)):b=f||e,b}function c(a){var c,d=b(a);return d?c=chroma.scale(d):(a=a.replace("custom-",""),a=a.replace("single-",""),c=chroma.scale().range([a,a])),c}var d=[{label:"Accent",colors:chroma.brewer.Accent},{label:"Dark2",colors:chroma.brewer.Dark2},{label:"Pastel2",colors:chroma.brewer.Pastel2},{label:"Pastel1",colors:chroma.brewer.Pastel1},{label:"Set2",colors:chroma.brewer.Set2},{label:"Set1",colors:chroma.brewer.Set1},{label:"Paired",colors:chroma.brewer.Paired},{label:"Set3",colors:chroma.brewer.Set3},{label:"OrRd",colors:chroma.brewer.OrRd.slice(1)},{label:"PuBu",colors:chroma.brewer.PuBu.slice(1)},{label:"BuPu",colors:chroma.brewer.BuPu.slice(1)},{label:"Oranges",colors:chroma.brewer.Oranges.slice(1)},{label:"YlOrBr",colors:chroma.brewer.YlOrBr.slice(1)},{label:"YlGn",colors:chroma.brewer.YlGn.slice(1)},{label:"Reds",colors:chroma.brewer.Reds.slice(1)},{label:"RdPu",colors:chroma.brewer.RdPu.slice(1)},{label:"Greens",colors:chroma.brewer.Greens.slice(1)},{label:"YlGnBu",colors:chroma.brewer.YlGnBu.slice(1)},{label:"Purples",colors:chroma.brewer.Purples.slice(1)},{label:"GnBu",colors:chroma.brewer.GnBu.slice(1)},{label:"Greys",colors:chroma.brewer.Greys.slice(1)},{label:"YlOrRd",colors:chroma.brewer.YlOrRd.slice(1)},{label:"PuRd",colors:chroma.brewer.PuRd.slice(1)},{label:"Blues",colors:chroma.brewer.Blues.slice(1)},{label:"PuBuGn",colors:chroma.brewer.PuBuGn.slice(1)},{label:"Spectral",colors:chroma.brewer.Spectral},{label:"RdYlGn",colors:chroma.brewer.RdYlGn},{label:"RdBu",colors:chroma.brewer.RdBu},{label:"PiYG",colors:chroma.brewer.PiYG},{label:"PRGn",colors:chroma.brewer.PRGn},{label:"RdYlBu",colors:chroma.brewer.RdYlBu},{label:"BrBG",colors:chroma.brewer.BrBG},{label:"RdGy",colors:chroma.brewer.RdGy},{label:"PuOr",colors:chroma.brewer.PuOr}],e="Set2",f="",g=0;return a.chartColors&&a.chartColors.length>0&&(f="custom",d.unshift({label:"custom",colors:a.chartColors}),chroma.brewer.custom=a.chartColors),{getScale:function(a,b,d){return b="undefined"!=typeof b?b:0,d="undefined"!=typeof d?d:1,c(a).domain([b,d])},getUniqueColor:function(a){return c(a)(1).hex()},getColorAtIndex:function(a,c){var d,e=b(a);return e?(d=chroma.brewer[e],d[c%d.length]):a},getColors:function(a){var c=b(a);return c?chroma.brewer[c]:[a,a]},getColorSets:function(){return chroma.brewer},getOrderedColorSets:function(){return d},getDefaultColorSet:function(){return f||e},getDefaultColor:function(a,b,c){var d,e=this.getColorList(b);return"undefined"!=typeof a&&""!==a?a:"undefined"!=typeof backupColor&&""!==backupColor?backupColor:(e[g].label.startsWith("custom-")&&(g=(g+1)%e.length),"undefined"!=typeof c?d=e[c%e.length].label:(d=e[g].label,g=(g+1)%e.length),d)},getColorList:function(a,b){var c=[];if(-1!==a.indexOf("single")){var d=this.getColors(this.getDefaultColorSet());angular.forEach(d,function(a){c.push({label:a,color:a})})}return-1!==a.indexOf("range")&&angular.forEach(this.getOrderedColorSets(),function(a){c.push({label:"range-"+a.label,color:a.colors})}),c},isColorAllowed:function(a,b,c){var d=!1;return a?-1===c.indexOf("range")?a.startsWith("range-")||a.startsWith("custom-range-")?!1:!0:-1!==c.indexOf("range")?a.startsWith("custom-single-")?!1:(angular.forEach(b,function(b){b.label===a&&(d=!0)}),d):void 0:!1}}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.factory("MapHelper",["ODSWidgetsConfig","ODSAPI","$q",function(a,b,c){var d=5,e=",";return{WORLD_BOUNDS:[[-60,-180],[80,180]],retrieveBounds:function(a){var d=this,e=c.defer();if(0===a.length)e.resolve(null);else{var f=[];angular.forEach(a,function(a){var c={};jQuery.extend(c,a.parameters),f.push(b.records.boundingbox(a,c))}),c.all(f).then(function(a){var b;angular.forEach(a,function(a){var c=a.data,d=[[c.bbox[1],c.bbox[0]],[c.bbox[3],c.bbox[2]]];c.count>0&&(b?b.extend(d):b=L.latLngBounds(d))}),b&&b.isValid()?e.resolve(b):e.resolve(d.WORLD_BOUNDS)})}return e.promise},getLocationStructure:function(a){var b=a.split(e);return{center:[b[1],b[2]],zoom:b[0]}},getLocationParameter:function(a,b){angular.isArray(a)&&(a=L.latLng(a));var c=L.Util.formatNum(a.lat,d),f=L.Util.formatNum(a.lng,d);return b+e+c+e+f},MapConfiguration:{getActiveContextList:function(a,b){var c=[];return angular.forEach(a.layers,function(a){a.displayed&&angular.forEach(a.activeDatasets,function(a){b?a.context.dataset.hasGeoField()&&c.push(a.context):c.push(a.context)})}),c},createLayerGroupConfiguration:function(){return{color:"#369",title:"Calque #1",displayed:!0,picto:"icon-circle",activeDatasets:[]}},createLayerConfiguration:function(a,b){angular.isUndefined(b)&&(b={});var c=b.display||"auto";return"clusters"===c&&(c="polygon"),"clustersforced"===c&&(c="polygonforced"),"raw"===c&&(c="none"),{context:null,color:b.color,picto:b.picto,clusterMode:c,func:b["function"]||(b.expression?"AVG":"COUNT"),expr:b.expression||null,marker:null,tooltipTemplate:a,localKey:b.localKey||null,remoteKey:b.remoteKey||null,tooltipSort:b.tooltipSort,hoverField:b.hoverField||null,opacity:b.opacity,borderColor:b.borderColor}}}}}]),a.factory("MapLayerRenderer",["ODSAPI","AggregationHelper","SVGInliner","PictoHelper","$q","$filter","$rootScope","$compile","$timeout",function(a,b,c,d,e,f,g,h,i){return{updateDataLayer:function(b,c){var d=this,f=b.rendered;b.currentRequestTimeout&&b.currentRequestTimeout.resolve();var h=e.defer();b.currentRequestTimeout=h;var j=e.defer();if("tiles"===b.clusterMode){b.rendered||(b.rendered=new L.BundleTileLayer("",{tileSize:512,minZoom:c.getMinZoom(),maxZoom:c.getMaxZoom(),gridLayer:{options:{resolution:4}}}),c.addLayer(b.rendered),i(function(){b.rendered.on("loading",function(){b.loading=!0,g.$apply()}),b.rendered.on("load",function(){b.loading=!1,g.$apply()})},0),d.bindTooltip(c,b.rendered,b));var k={color:b.color,icon:b.picto,showmarker:b.marker};angular.extend(k,b.context.parameters);var l="/api/datasets/1.0/"+b.context.dataset.datasetid+"/tiles/simple/{z}/{x}/{y}.bundle",m="";angular.forEach(k,function(a,b){null!==a&&(m+=m?"&":"?",m+=b+"="+encodeURIComponent(a))}),l+=m,b.rendered._url!==l&&b.rendered.setUrl(l),j.resolve()}else if("none"===b.clusterMode||c.getZoom()===c.getMaxZoom()&&"polygon"===b.clusterMode)b.loading=!0,this.buildRawLayer(b,c,h).then(function(a){d.swapLayers(c,f,a),b.rendered=a,b.currentRequestTimeout=null,b.loading=!1,j.resolve()});else if("polygon"===b.clusterMode||"polygonforced"===b.clusterMode)b.loading=!0,this.buildClusteredLayer(b,c,h,!0).then(function(a){d.swapLayers(c,f,a),b.rendered=a,b.currentRequestTimeout=null,b.loading=!1,j.resolve()});else if("heatmap"===b.clusterMode)b.loading=!0,this.buildHeatmapLayer(b,c,h).then(function(a){d.swapLayers(c,f,a),b.rendered=a,b.currentRequestTimeout=null,b.loading=!1,j.resolve()});else if("shape"===b.clusterMode||"aggregation"===b.clusterMode)b.loading=!0,this.buildAggregationLayer(b,c,h).then(function(a){d.swapLayers(c,f,a),b.rendered=a,b.currentRequestTimeout=null,b.loading=!1,j.resolve()});else if("auto"===b.clusterMode){b.loading=!0;var n=angular.extend({},b.context.parameters,{"geofilter.bbox":ODS.GeoFilter.getBoundsAsBboxParameter(c.getBounds())});a.records.boundingbox(b.context,n).success(function(a){var e=200,g=5e5,i=5e5,k=a.count<i;a.count<e||c.getZoom()===c.getMaxZoom()?d.buildRawLayer(b,c,h).then(function(a){d.swapLayers(c,f,a),b.rendered=a,b.currentRequestTimeout=null,b.loading=!1,j.resolve()}):a.count<g?a.geometries.Point&&a.geometries.Point>a.count/2?d.buildClusteredLayer(b,c,h,k).then(function(a){d.swapLayers(c,f,a),b.rendered=a,b.currentRequestTimeout=null,b.loading=!1,j.resolve()}):d.buildShapePreviewLayer(b,c,h).then(function(a){
d.swapLayers(c,f,a),b.rendered=a,b.currentRequestTimeout=null,b.loading=!1,j.resolve()}):d.buildClusteredLayer(b,c,h,k).then(function(a){d.swapLayers(c,f,a),b.rendered=a,b.currentRequestTimeout=null,b.loading=!1,j.resolve()})})}return j.promise},swapLayers:function(a,b,c){b&&a.removeLayer(b),a.addLayer(c)},buildRawLayer:function(b,f,g){var h=this,i=e.defer(),j=new L.LayerGroup,k=angular.extend({},b.context.parameters,{rows:1e4,format:"json","geofilter.bbox":ODS.GeoFilter.getBoundsAsBboxParameter(f.getBounds())}),l=b.context.dataset.getFieldsForType("geo_shape"),m=l.length?l[0].name:null;return a.records.download(b.context,k,g.promise).success(function(a){for(var e=0;e<a.length;e++){var g,k=a[e];if(m){if(!k.fields[m])return;g=k.fields[m],"Point"===g.type&&angular.isDefined(k.geometry)&&(g=k.geometry)}else{if(!k.geometry)return;g=k.geometry}if("Point"===g.type)!function(a,e){c.getPromise(d.mapPictoToURL(b.picto,b.context),b.marker?"white":h.getRecordColor(e,b)).then(function(c){var d=new L.VectorMarker([a.coordinates[1],a.coordinates[0]],{color:h.getRecordColor(e,b),icon:c,marker:b.marker});h.bindTooltip(f,d,b,a,e.recordid),j.addLayer(d)})}(g,k);else{var l=new L.GeoJSON(g,{style:function(a){var c={radius:3,weight:1,opacity:.9,fillOpacity:.5,color:h.getRecordColor(k,b)};return c.fillColor=h.getRecordColor(k,b),"LineString"===a.geometry.type||"MultiLineString"===a.geometry.type?(c.weight=5,c.color=h.getRecordColor(k,b)):c.color="#fff",c}});h.bindTooltip(f,l,b,g,k.recordid),j.addLayer(l)}}i.resolve(j)}),i.promise},buildClusteredLayer:function(b,f,g,h){var i=this,j=e.defer(),k=new L.LayerGroup,l=angular.extend({},b.context.parameters,{clusterdistance:50,clusterprecision:f.getZoom(),"geofilter.bbox":ODS.GeoFilter.getBoundsAsBboxParameter(f.getBounds()),return_polygons:h});return"COUNT"!==b.func&&i.isAnalyzeEnabledClustering(b)&&(l["y.serie1.expr"]=b.expr,l["y.serie1.func"]=b.func),a.records.geo(b.context,l,g.promise).success(function(a){for(var e=a.clusters,g=0;g<e.length;g++){var h=e[g];if(1===h.count&&"polygonforced"!==b.clusterMode)!function(a){c.getPromise(d.mapPictoToURL(b.picto,b.context),b.marker?"white":b.color).then(function(c){var d=new L.VectorMarker(a.cluster_center,{color:b.color,icon:c,marker:b.marker});i.bindTooltip(f,d,b,a.cluster),k.addLayer(d)})}(h);else{var l=i.getClusterValue(h,b);if(null!==l){var m=new L.ClusterMarker(h.cluster_center,{geojson:h.cluster,value:i.getClusterValue(h,b),total:i.getClusterMax(a,b),color:b.color,numberFormattingFunction:i.formatNumber});i.bindZoomable(f,m,b),k.addLayer(m)}}}j.resolve(k)}),j.promise},buildHeatmapLayer:function(b,c,d){var f=this,g=e.defer(),h=L.TileLayer.heatMap({zIndex:10,radius:{absolute:!1,value:20},opacity:.8,gradient:{.45:"rgb(0,0,255)",.55:"rgb(0,255,255)",.65:"rgb(0,255,0)",.95:"yellow",1:"rgb(255,0,0)"}}),i=angular.extend({},b.context.parameters,{clustermode:"heatmap",clusterdistance:15,clusterprecision:c.getZoom(),"geofilter.bbox":ODS.GeoFilter.getBoundsAsBboxParameter(c.getBounds())});return"COUNT"!==b.func&&f.isAnalyzeEnabledClustering(b)&&(i["y.serie1.expr"]=b.expr,i["y.serie1.func"]=b.func),a.records.geo(b.context,i,d.promise).success(function(a){var c=a.clusters;h.options.radius.value=Math.min(1/a.clusters.length*4e3+20,50);for(var d=[],e=0;e<c.length;e++){var i=c[e],j=f.getClusterValue(i,b);null!==j&&d.push({lat:i.cluster_center[0],lon:i.cluster_center[1],value:f.getClusterValue(i,b)-f.getClusterMin(a,b)+1})}d.length>0&&h.setData(d),g.resolve(h)}),g.promise},buildAggregationLayer:function(c,d,f){function g(a){var e=i(a);if(0===e.length)return void l.resolve(m);var f=k.getClusterMin(a,c),g=k.getClusterMax(a,c),j=k.getClusterValues(a,c),n=function(a){return k.getColor(a,c,f,g,j.length)},o={radius:3,color:"#fff",weight:1,opacity:.9,fillOpacity:.5};if((!angular.isObject(c.color)||"range"!==c.color.type)&&("COUNT"!==c.func&&k.isAnalyzeEnabledClustering(c)||f!==g)){L.Legend=L.Control.extend({initialize:function(a){L.Control.prototype.initialize.call(this,a)},onAdd:function(a){var d=chroma.scale().domain([f,g],Math.min(10,j.length)).domain(),e="",h=L.DomUtil.create("div","odswidget-map__legend"),i=c.context.dataset.datasetid,l=c.expr;if(l&&(l=c.context.dataset.getFieldLabel(c.expr)),i=c.context.dataset.metas.title,e+='<div class="odswidget-map__legend-title">'+i+"<br/>"+b.getFunctionLabel(c.func),"COUNT"!==c.func&&(e+=" "+l),e+="</div>",e+='<div class="odswidget-map__legend-colors">',1===j.length)e+='<i class="color_0" style="width: 90%; background-color:'+n((d[0]+d[1])/2)+'; opacity: 1;"></i>',e+='</div><div class="odswidget-map__legend-counts">',e+='<span class="odswidget-map__legend-value">',e+=k.formatNumber(d[0]),e+="</span>";else{for(var m=90/(d.length-1),o=0;o<d.length-1;o++)e+='<i class="odswidget-map__legend-color" style="width:'+m+"%; background-color:"+n((d[o]+d[o+1])/2)+'; opacity: 1;"></i>';e+="</div><div>",e+='<span class="odswidget-map__legend-value">',e+=k.formatNumber(d[0]),e+="</span>",e+='<span class="odswidget-map__legend-value">',e+=k.formatNumber(d[d.length-1]),e+="</span>"}return e+="</div>",h.innerHTML=e,h}});var p=new L.Legend({position:"bottomleft"}),q=function(a){a.layer===m&&(d.addControl(p),d.off("layeradd",q))};d.on("layeradd",q);var r=function(a){a.layer===m&&(d.removeControl(p),d.off("layerremove",r))};d.on("layerremove",r)}for(var s=function(a,b,c,d){b.on("mouseover",function(a){var b=a.target;b.setStyle({weight:2})}),b.on("mouseout",function(a){var b=a.target;b.setStyle({weight:1})})},t=0;t<e.length;t++){var u,v,w=e[t],x=k.getClusterValue(w,c),y=function(a,b){return L.circleMarker(b,o)};null!==x&&(v=h(w),v&&(u=new L.GeoJSON(v,{pointToLayer:y,highlight:k.getColor(x,c,f,g,j.length),style:function(a){var b=angular.copy(o);return b.fillColor=n(x),angular.isDefined(c.opacity)&&(b.fillOpacity=c.opacity),"LineString"===a.geometry.type||"MultiLineString"===a.geometry.type?(b.weight=5,b.color=n(x)):angular.isDefined(c.borderColor)&&(b.color=c.borderColor),b}}),"LineString"!==v.type&&"MultiLineString"!==v.type&&s(c,u,w,null),c.joinContext&&c.hoverField?w.x[0].fields[c.hoverField]?(u.bindLabel(w.x[0].fields[c.hoverField]),c.refineOnClick&&k.bindTooltip(d,u,c,v,null,w.geo_digest,w.x[0].fields[c.hoverField])):c.refineOnClick&&k.bindTooltip(d,u,c,v,null,w.geo_digest):(("COUNT"!==c.func&&k.isAnalyzeEnabledClustering(c)||f!==g)&&u.bindLabel(k.formatNumber(x)),c.refineOnClick&&k.bindTooltip(d,u,c,v,null,w.geo_digest)),m.addLayer(u)))}l.resolve(m)}var h,i,j,k=this,l=e.defer(),m=new L.LayerGroup;if(c.joinContext){var n=c.localKey,o=c.remoteKey;n&&o||console.error("An aggregation layer with a remote dataset requires a local-key and a remote-key");var p=c.joinContext.dataset.getFieldsForType("geo_shape");p.length||console.error("You can only join an aggregation layer with a dataset that contains a geo_shape field.");var q=p[0].name;h=function(a){return a.x[0].fields?a.x[0].fields[q]:null},i=function(a){return a.results};var r=q;c.hoverField&&(r+=","+c.hoverField),j=angular.extend({},c.context.parameters,{clusterprecision:d.getZoom(),"geofilter.bbox":ODS.GeoFilter.getBoundsAsBboxParameter(d.getBounds()),"join.agg1.fields":r,"join.agg1.remotedataset":c.joinContext.dataset.datasetid,"join.agg1.remotekey":o,"join.agg1.localkey":n,"agg.agg1.func":"MIN,MAX","agg.agg1.expr":"serie1","y.serie1.expr":c.expr,"y.serie1.func":c.func}),a.records.analyze(c.context,j,f.promise).success(g)}else h=function(a){return a.cluster},i=function(a){return a.clusters},j=angular.extend({},c.context.parameters,{clusterprecision:d.getZoom(),"geofilter.bbox":ODS.GeoFilter.getBoundsAsBboxParameter(d.getBounds())}),"COUNT"!==c.func&&k.isAnalyzeEnabledClustering(c)&&(j["y.serie1.expr"]=c.expr,j["y.serie1.func"]=c.func),a.records.geopolygon(c.context,j,f.promise).success(g);return l.promise},buildShapePreviewLayer:function(b,c,d){var f=this,g=e.defer(),h=angular.extend({},b.context.parameters,{rows:1e3,clusterprecision:c.getZoom(),"geofilter.bbox":ODS.GeoFilter.getBoundsAsBboxParameter(c.getBounds())}),i=new L.LayerGroup;return a.records.geopreview(b.context,h,d.promise).success(function(a){for(var d,e=0;e<a.length;e++){d=a[e];var h={radius:3,color:"#fff",weight:1,opacity:.9,fillOpacity:.5,fillColor:b.color},j=new L.GeoJSON(d.geometry,{pointToLayer:function(a,b){return L.circleMarker(b,h)},style:function(a){var c=angular.copy(h);return("LineString"===a.geometry.type||"MultiLineString"===a.geometry.type)&&(c.weight=5,c.color=b.color),c}});i.addLayer(j),f.bindTooltip(c,j,b,d.geometry,null,d.geo_digest)}g.resolve(i)}),g.promise},getRecordColor:function(a,b){if(angular.isString(b.color))return b.color;if("range"===b.color.type){if(b.color.field){var c=a.fields[b.color.field];return angular.isUndefined(c)?b.color.colors[0]:this.getColor(c,b)}return console.error("Range coloring requires a field"),b.color.colors[0]}return console.error("Scale coloring is not supported for simple records"),chroma.scale(b.color.scale).out("hex").scale(0)},getColor:function(a,b,c,d,e){if(e=e||10,angular.isString(b.color))return angular.isDefined(c)&&angular.isDefined(d)?chroma.scale([chroma(b.color).brighten(50),b.color]).domain([c,d],Math.min(10,e)).out("hex")(a):b.color;if("scale"===b.color.type)return chroma.scale(b.color.scale).domain([c,d],Math.min(10,e)).out("hex")(a);if("range"===b.color.type){var f;for(f=0;f<b.color.ranges.length;f++)if(a<b.color.ranges[f])return b.color.colors[f];return b.color.colors[b.color.colors.length-1]}},bindTooltip:function(a,b,c,d,e,f,g){var h=this;c.refineOnClick?b.on("click",function(b){a.isDrawing||h.refineContextOnClick(c,d,f,g)}):b.on("click",function(b){if(!a.isDrawing&&(d||e||f||b.data)){var g,i;angular.isDefined(b.target.getLatLng)?g=b.target.getLatLng():(g=b.latlng,i=0),h.showPopup(a,c,g,d,e,f,i,b.data||null)}})},refineContextOnClick:function(b,c,d,e){var f=function(f){var h=f.contextField,i=f.mapField,j=f.context,k=f.replaceRefine;if(i||h)if(angular.isDefined(e)&&i==b.hoverField)g.$apply(function(){j.toggleRefine(h,e,k)});else{var l={format:"json"};d?l.geo_digest=d:ODS.GeoFilter.addGeoFilterFromSpatialObject(l,c),angular.extend(l,b.context.parameters,{rows:1}),a.records.download(b.context,l).success(function(a){angular.isDefined(a[0].fields[i])&&j.toggleRefine(h,a[0].fields[i],k)})}else g.$apply(function(){ODS.GeoFilter.addGeoFilterFromSpatialObject(j.parameters,c)})};angular.forEach(b.refineOnClick,f)},bindZoomable:function(a,b,c){b.on("click",function(b){a.isDrawing||(a.getZoom()===a.getMaxZoom()?this.showPopup(a,c,b.target.getLatLng(),b.target.getClusterShape()):a.setView(b.latlng,a.getZoom()+2))})},showPopup:function(a,b,c,d,e,f,i,j){var k=g.$new(!0);e&&(k.recordid=e),d&&(k.shape=d),j&&(k.gridData=j);var l=b.context.dataset;k.map=a,k.template=b.tooltipTemplate||l.extra_metas&&l.extra_metas.visualization&&l.extra_metas.visualization.map_tooltip_html||"";var m={offset:[0,angular.isDefined(i)?i:-30],maxWidth:250,minWidth:250};k.context=b.context;var n=new L.Popup(m).setLatLng(c).setContent(h('<ods-map-tooltip tooltip-sort="'+(b.tooltipSort||"")+'" shape="shape" recordid="recordid" context="context" map="map" template="{{ template }}" grid-data="gridData" geo-digest="'+(f||"")+'"></ods-map-tooltip>')(k)[0]);n.openOn(a)},formatNumber:function(a){return a=Math.round(100*a)/100,a=f("number")(a)},getClusterValue:function(a,b){return"aggregation"===b.clusterMode&&b.joinContext?a.serie1:"COUNT"!==b.func&&this.isAnalyzeEnabledClustering(b)?a.series?a.series.serie1:null:a.count},getClusterMin:function(a,b){return"aggregation"===b.clusterMode&&b.joinContext?a.aggregations.agg1.min:"COUNT"!==b.func&&this.isAnalyzeEnabledClustering(b)?a.series.serie1.min:a.count.min},getClusterMax:function(a,b){return"aggregation"===b.clusterMode&&b.joinContext?a.aggregations.agg1.max:"COUNT"!==b.func&&this.isAnalyzeEnabledClustering(b)?a.series.serie1.max:a.count.max},getClusterValues:function(a,b){var c,d=[];if("aggregation"===b.clusterMode&&b.joinContext)for(c=0;c<a.results.length;c++)d.push(a.results[c].serie1);else if("COUNT"!==b.func&&this.isAnalyzeEnabledClustering(b))for(c=0;c<a.clusters.length;c++)a.clusters[c].series&&d.push(a.clusters[c].series.serie1);else for(c=0;c<a.clusters.length;c++)d.push(a.clusters[c].count);return d},isAnalyzeEnabledClustering:function(a){return"heatmap"===a.clusterMode||"polygonforced"===a.clusterMode||"shape"===a.clusterMode||"aggregation"===a.clusterMode},doesLayerRefreshOnLocationChange:function(a){return"tiles"===a.clusterMode?!1:"shape"!==a.clusterMode&&"aggregation"!==a.clusterMode||!a.joinContext?!0:!1}}}])}(),function(){"use strict";var a=angular.module("ods-widgets"),b={},c=[];a.provider("ModuleLazyLoader",function(){var a={highcharts:{css:[],js:[["https://code.highcharts.com/3.0.10/highcharts.js"],["https://code.highcharts.com/3.0.10/modules/no-data-to-display.js"],["https://code.highcharts.com/3.0.10/highcharts-more.js"],["https://code.highcharts.com/modules/treemap.js"]]},leaflet:{css:["https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css","https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v0.0.3/leaflet.fullscreen.css","https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.24.0/L.Control.Locate.css","libs/leaflet-control-geocoder/Control.Geocoder.css","libs/ods-vectormarker/vectormarker.css","libs/ods-clustermarker/clustermarker.css","libs/leaflet-label/leaflet.label.css","libs/leaflet-draw/leaflet.draw.css"],js:[["L@https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"],["L.Control.FullScreen@https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v0.0.3/Leaflet.fullscreen.min.js","L.Control.Locate@https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.24.0/L.Control.Locate.js","L.Label@libs/leaflet-label/leaflet.label.js","L.ODSMap@libs/ods-map/ods-map.js","L.ODSTileLayer@libs/ods-map/ods-tilelayer.js","L.Control.Geocoder@libs/leaflet-control-geocoder/Control.Geocoder.js","L.VectorMarker@libs/ods-vectormarker/vectormarker.js","L.ClusterMarker@libs/ods-clustermarker/clustermarker.js","L.Draw@libs/leaflet-draw/leaflet.draw.js","QuadTree@libs/leaflet-heatmap/QuadTree.js","h337@libs/leaflet-heatmap/heatmap.js","L.TileLayer.HeatMap@libs/leaflet-heatmap/heatmap-leaflet.js"]]},rome:{css:["libs/rome/rome.css"],js:["libs/rome/rome.standalone.js"]},fullcalendar:{css:["libs/fullcalendar/fullcalendar.min.css"],js:["libs/fullcalendar/fullcalendar.min.js"],language_specific:{ar:{js:["libs/fullcalendar/lang/ar.js"]},fr:{js:["libs/fullcalendar/lang/fr.js"]},nl:{js:["libs/fullcalendar/lang/nl.js"]}}},qtip:{css:["libs/qtip/jquery.qtip.min.css"],js:["libs/qtip/jquery.qtip.min.js"]}};this.getConfig=function(){return a};var d=function(a,b){var c=b.split(".");if(a.hasOwnProperty(c[0])&&angular.isDefined(a[c[0]])){if(1===c.length)return!0;var e=a[c[0]];return c.shift(),d(e,c.join("."))}return!1},e=function(a){return d(window,a)};this.$get=["$q","ODSWidgetsConfig",function(d,f){var g=function(a,e){if(angular.isUndefined(b[e])){var g=d.defer();b[e]=g;var h="/"===e.substring(0,1)||"http://"===e.substring(0,7)||"https://"===e.substring(0,8)?e:f.basePath+e;LazyLoad[a](h,function(){g.resolve(),c.push(e)}),b[e]=g}return b[e]},h=function(a,f,i,j){var k,l=[];if(angular.isUndefined(j)&&(j=0),j>=f.length)i.resolve();else{k=f[j],angular.isArray(k)||(k=[k]);for(var m=0;m<k.length;m++){var n,o=k[m].split("@");if(o.length>1){if(e(o[0]))continue;n=o[1]}else n=o[0];-1===c.indexOf(n)?l.push(g(a,n).promise):l.push(b[n].promise)}d.all(l).then(function(){h(a,f,i,j+1)})}return i.promise};return function(){for(var b=[],c=0;c<arguments.length;c++){var e=a[arguments[c]];e.language_specific&&e.language_specific[f.language]&&angular.forEach(e.language_specific[f.language],function(a,b){e[b]?e[b]=e[b].concat(a):e[b]=a}),e.css&&b.push(h("css",e.css,d.defer())),e.js&&b.push(h("js",e.js,d.defer()))}return d.all(b)}}]}),a.factory("DebugLogger",["$window",function(a){return{log:function(){("#debug"==a.location.hash||a.location.hash.indexOf("debug=")>=0||$(document.body).hasClass("showDebug"))&&console.log.apply(console,arguments)}}}]),a.factory("odsErrorService",function(){var a=[];return{registerForErrorNotification:function(b){a.push(b)},sendErrorNotification:function(b){angular.isString(b)&&(b={title:"Error",error:b}),angular.forEach(a,function(a){a(b)})},markErrorAsHandled:function(a){a.handled=!0}}}),a.provider("SVGInliner",function(){var a={},b='<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg id="dot-icon" width="19px" height="19px" viewBox="0 0 19 19" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">    <path d="M13,9.50004202 C13,11.4330618 11.4329777,13.000084 9.49995798,13.000084 C7.56693813,13.000084 5.99991595,11.4330618 5.99991595,9.50004202 C5.99991595,7.56702218 7.56693813,6 9.49995798,6 C11.4329777,6 13,7.56702218 13,9.50004202 L13,9.50004202 Z" id="path8568" fill="#000000"></path>    <rect style="opacity: 0" x="0" y="0" width="19" height="19"></rect></svg>',c=function(a,b,c){var d=angular.element(b);c&&(d.css("fill",c),d.find("path, polygon, circle, rect, text").css("fill",c)),a.append(d)};this.$get=["$http","$q",function(d,e){var f=function(f,g,h){var i;h&&(i=e.defer());var j=angular.element("<div></div>");if(f)if(-1===f.indexOf(".svg"))j.append(angular.element('<img src="'+f+'"/>')),h&&i.resolve(j);else if(a[f])a[f].code?(c(j,a[f].code,g),h&&i.resolve(j)):a[f].promise.success(function(a){c(j,a,g),h&&i.resolve(j)}).error(function(){c(j,b,g),h&&i.resolve(j)});else{var k=d.get(f);a[f]={promise:k},k.success(function(b){a[f].code=b,c(j,b,g),h&&i.resolve(j)}).error(function(d,e){console.log("WARNING: Unable to fetch SVG image",f,"HTTP status:",e),a[f].code=b,c(j,b,g),h&&i.resolve(j)})}else c(j,b,g),h&&i.resolve(j);return h?i.promise:j};return{getElement:function(a,b){return f(a,b)},getPromise:function(a,b){return f(a,b,!0)}}}]}),a.service("PictoHelper",function(){var a={"ban-circle":"ban","bar-chart":"bar-chart-o",beaker:"flask",bell:"bell-o","bell-alt":"bell","bitbucket-sign":"bitbucket-square","bookmark-empty":"bookmark-o",building:"building-o (4.0.2)","calendar-empty":"calendar-o","check-empty":"square-o","check-minus":"minus-square-o","check-sign":"check-square",check:"check-square-o","chevron-sign-down":"chevron-down","chevron-sign-left":"chevron-left","chevron-sign-right":"chevron-right","chevron-sign-up":"chevron-up","circle-arrow-down":"arrow-circle-down","circle-arrow-left":"arrow-circle-left","circle-arrow-right":"arrow-circle-right","circle-arrow-up":"arrow-circle-up","circle-blank":"circle-o",cny:"rub","collapse-alt":"minus-square-o","collapse-top":"caret-square-o-up",collapse:"caret-square-o-down","comment-alt":"comment-o","comments-alt":"comments-o",copy:"files-o",cut:"scissors",dashboard:"tachometer","double-angle-down":"angle-double-down","double-angle-left":"angle-double-left","double-angle-right":"angle-double-right","double-angle-up":"angle-double-up",download:"arrow-circle-o-down","download-alt":"download","edit-sign":"pencil-square",edit:"pencil-square-o","ellipsis-horizontal":"ellipsis-h (4.0.2)","ellipsis-vertical":"ellipsis-v (4.0.2)","envelope-alt":"envelope-o","exclamation-sign":"exclamation-circle","expand-alt":"plus-square-o (4.0.2)",expand:"caret-square-o-right","external-link-sign":"external-link-square","eye-close":"eye-slash","eye-open":"eye","facebook-sign":"facebook-square","facetime-video":"video-camera","file-alt":"file-o","file-text-alt":"file-text-o","flag-alt":"flag-o","folder-close-alt":"folder-o","folder-close":"folder","folder-open-alt":"folder-open-o",food:"cutlery",frown:"frown-o",fullscreen:"arrows-alt (4.0.2)","github-sign":"github-square","google-plus-sign":"google-plus-square",group:"users (4.0.2)","h-sign":"h-square","hand-down":"hand-o-down","hand-left":"hand-o-left","hand-right":"hand-o-right","hand-up":"hand-o-up",hdd:"hdd-o (4.0.1)","heart-empty":"heart-o",hospital:"hospital-o (4.0.2)","indent-left":"outdent","indent-right":"indent","info-sign":"info-circle",keyboard:"keyboard-o",legal:"gavel",lemon:"lemon-o",lightbulb:"lightbulb-o","linkedin-sign":"linkedin-square",meh:"meh-o","microphone-off":"microphone-slash","minus-sign-alt":"minus-square","minus-sign":"minus-circle","mobile-phone":"mobile",moon:"moon-o",move:"arrows (4.0.2)",off:"power-off","ok-circle":"check-circle-o","ok-sign":"check-circle",ok:"check","paper-clip":"paperclip",paste:"clipboard","phone-sign":"phone-square",picture:"picture-o","pinterest-sign":"pinterest-square","play-circle":"play-circle-o","play-sign":"play-circle","plus-sign-alt":"plus-square","plus-sign":"plus-circle",pushpin:"thumb-tack","question-sign":"question-circle","remove-circle":"times-circle-o","remove-sign":"times-circle",remove:"times",reorder:"bars (4.0.2)","resize-full":"expand (4.0.2)","resize-horizontal":"arrows-h (4.0.2)","resize-small":"compress (4.0.2)","resize-vertical":"arrows-v (4.0.2)","rss-sign":"rss-square",save:"floppy-o",screenshot:"crosshairs","share-alt":"share","share-sign":"share-square",share:"share-square-o","sign-blank":"square",signin:"sign-in",signout:"sign-out",smile:"smile-o","sort-by-alphabet-alt":"sort-alpha-desc","sort-by-alphabet":"sort-alpha-asc","sort-by-attributes-alt":"sort-amount-desc","sort-by-attributes":"sort-amount-asc","sort-by-order-alt":"sort-numeric-desc","sort-by-order":"sort-numeric-asc","sort-down":"sort-desc","sort-up":"sort-asc",stackexchange:"stack-overflow","star-empty":"star-o","star-half-empty":"star-half-o",sun:"sun-o","thumbs-down-alt":"thumbs-o-down","thumbs-up-alt":"thumbs-o-up",time:"clock-o",trash:"trash-o","tumblr-sign":"tumblr-square","twitter-sign":"twitter-square",unlink:"chain-broken",upload:"arrow-circle-o-up","upload-alt":"upload","warning-sign":"exclamation-triangle","xing-sign":"xing-square","youtube-sign":"youtube-square","zoom-in":"search-plus","zoom-out":"search-minus"};return{mapPictoToURL:function(b,c){if(!b)return null;var d=c&&c.domainUrl||"";if(b.startsWith("icon-")){var e=b.replace("icon-","");a[e]&&(e=a[e]),d+="/static/pictos/img/set-v1/fa/"+e+".svg"}else b.startsWith("pdpicto-")||b.startsWith("odspicto-")?(b=b.replace("pdpicto-","pdpicto/").replace("odspicto-","odspicto/"),d+="/static/pictos/img/set-v1/"+b+".svg"):d+="/static/pictos/img/set-v2/"+b+".svg";return d}}}),a.factory("URLSynchronizer",["$location","$document",function(a,b){var c=!1,d=[];b.bind("webkitfullscreenchange mozfullscreenchange ofullscreenchange msfullscreenchange khtmlfullscreenchange",function(){var a=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement;if(a)c=!0;else{c=!1;for(var b=0;b<d.length;b++)d[b]()}});var e=[];return{addSynchronizedValue:function(b,f,g,h){e.push(f),g&&e.push(g);var i=a.search()[g||f];b.$eval(f+"=newObj",{newObj:i});var j=function(){var c=b.$eval(f);h&&a.replace(),a.search(g||f,c)},k=b.$watch(f,function(a,b){c||j()},!0);d.push(j);var l=b.$watch(function(){return a.search()[g||f]},function(a,c){a&&b.$eval(f+"=newObj",{newObj:a})},!0);return function(){k(),l()}},addJSONSynchronizedObject:function(b,f,g){e.push(g||f);var h=a.search()[g||f];h&&("{"===h[0]?b.$eval(f+"=newObj",{newObj:JSON.parse(h)}):b.$eval(f+"=newObj",{newObj:JSON.parse(b64_to_utf8(h))}));var i,j=function(){var c=b.$eval(f);"undefined"==typeof c&&(c=""),i=utf8_to_b64(angular.toJson(c)),a.search(g||f,i)};d.push(j);var k=b.$watch(function(){return[b.$eval(f),a.search()[g||f]]},function(a,d){"undefined"==typeof a[0]&&(a[0]=""),i===utf8_to_b64(angular.toJson(a[0]))||c?i!==a[1]&&a[1]&&b.$eval(function(b){b[f]=JSON.parse(b64_to_utf8(a[1]))}):j()},!0);return k},addSynchronizedObject:function(b,f,g){g=g||[];var h=function(){var c=angular.copy(a.search());if(angular.forEach(c,function(a,b){e.indexOf(b)>=0&&delete c[b]}),g.length>0){var d=b.$eval(f);angular.forEach(g,function(a){angular.isDefined(d[a])&&(c[a]=d[a])})}b.$eval(f+"=newVal",{newVal:c})},i=function(){var c=angular.copy(b.$eval(f));angular.forEach(g,function(a){angular.isDefined(c[a])&&delete c[a]}),angular.forEach(a.search(),function(a,b){(e.indexOf(b)>=0||g.indexOf(b)>=0)&&(c[b]=a)}),a.search(c)};h();var j=b.$watch(f,function(a,b){c||i()},!0);d.push(i);var k=b.$watch(function(){return a.search()},h,!0);return function(){j(),k()}}}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.service("ValueDisplay",["$filter",function(a){var b={language:function(b){return a("isocode_to_language")(b)},visualization:function(a){switch(a){case"analyze":return'<i class="fa fa-bar-chart"></i> <span translate>Analyze</span>';case"calendar":return'<i class="fa fa-calendar"></i> <span translate>Calendar</span>';case"geo":return'<i class="fa fa-globe"></i> <span translate>Map</span>';case"image":return'<i class="fa fa-picture-o"></i> <span translate>Image</span>';case"api":return'<i class="fa fa-cogs"></i> <span translate>API</span>';default:return a}}};return{format:function(a,c){return angular.isDefined(b)?b[c](a):(console.log('Warning (ValueDisplay): unknown value formatter "'+c+'"'),a)}}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.filter("nofollow",function(){return function(a){return angular.isString(a)?a.replace(/<a href="/g,'<a target="_blank" rel="nofollow" href="'):a}}),a.filter("prettyText",["$filter",function(a){function b(a){return a.replace(/&/g,"&amp;").replace(d,function(a){return"&#"+a.charCodeAt(0)+";"}).replace(/</g,"&lt;").replace(/>/g,"&gt;")}var c=/[<>]+/,d=/([^\#-~| |!])/g;return function(d){return d&&angular.isString(d)?c.test(d)?b(d):a("linky")(d,"_blank"):d}}]),a.filter("safenewlines",function(){return function(a){return a?a.replace(/\n/g,"<br/>").replace(/&#10;/g,"<br/>"):a}}),a.filter("imagify",["$sce",function(a){var b=/^(http(?:s?):\/\/[^;,]*(?:jpg|jpeg|png|gif)(?:\?[^,;]*)?)(?:$|;|,|&)/i;return function(c){if(angular.isString(c)){c=c.trim();var d=b.exec(c);if(null!==d)return a.trustAsHtml('<img class="odswidget odswidget-imagified" src="'+d[1]+'" />')}return c}}]),a.filter("videoify",["$sce",function(a){var b=/^https?:\/\/(?:(?:youtu.be\/)|(?:(?:www.)?youtube.com\/watch\?v=))([0-9a-z_-]+)$/i,c=/^https?:\/\/(?:(?:dai.ly)|(?:www.dailymotion.com))\/(?:video\/)?([0-9a-z]+)(?:[0-9a-z_-]*)$/i,d=/^https?:\/\/vimeo.com\/([0-9]+)$/i;return function(e){if(angular.isString(e)){var f=b.exec(e.trim());if(null!==f)return a.trustAsHtml('<iframe width="200" height="113" src="//www.youtube.com/embed/'+f[1]+'" frameborder="0" allowfullscreen></iframe>');if(f=c.exec(e.trim()),null!==f)return a.trustAsHtml('<iframe frameborder="0" width="200" height="113" src="//www.dailymotion.com/embed/video/'+f[1]+'" allowfullscreen></iframe>');if(f=d.exec(e.trim()),null!==f)return a.trustAsHtml('<iframe src="https://player.vimeo.com/video/'+f[1]+'" width="200" height="113" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>')}return e}}]),a.filter("isDefined",function(){return function(a){return angular.isDefined(a)}}),a.filter("displayImageValue",function(a){return function(b,c){if(!b)return b;var d="/explore/dataset/"+c+"/files/"+b.id+"/300/";return a.trustAsHtml('<img class="odswidget odswidget-imagified" src="'+d+'" />')}}),a.filter("fieldsForVisualization",function(){var a={table:[],map:["geo_point_2d","geo_shape"],images:["file"],calendar:[]};return function(b,c){if(angular.isUndefined(b))return b;if(angular.isUndefined(a[c]))throw'Unknown visualization type "'+c+"'";return b.filter(function(b){return-1===a[c].indexOf(b.type)})}}),a.filter("formatFieldValue",["$filter","$sce",function(a,b){var c=function(a){if(a.annotations){var b=a.annotations.filter(function(a){return"timeserie_precision"===a.name});if(b.length>0)return b[0].args[0]}return null};return function(d,e){var f=d[e.name];if(null===f||void 0===f)return"";if("int"===e.type||"double"===e.type){var g="";if(e.annotations)for(var h=0;h<e.annotations.length;h++)"unit"===e.annotations[h].name&&(g=e.annotations[h].args[0]);var i=a("number")(f);return g&&(i="$"===g?g+i:i+" "+g),i}if("geo_point_2d"===e.type)return f[0]+", "+f[1];if("geo_shape"===e.type)return a("limitTo")(angular.toJson(f),200);if("date"===e.type){var j=c(e);if("year"===j)return f;if("month"===j){var k=moment(f,"YYYY-MM");return a("capitalize")(a("moment")(k,"MMMM YYYY"))}return a("moment")(f,"LL")}return"datetime"===e.type?(19===f.length&&(f+="Z"),a("moment")(f,"LLL")):"file"===e.type?angular.isObject(f)?b.trustAsHtml('<a target="_self" href="files/'+f.id+'/download/">'+(f.filename||d.filename)+"</a>"):""+f:a("limitTo")(""+f,1e3)}}]),a.filter("capitalize",[function(){return function(a){return ODS.StringUtils.capitalize(a)}}]),a.filter("truncate",function(){return function(a,b){return a&&angular.isString(a)?(b||(b=200),a.substring(0,b)):a}}),a.filter("fieldsFilter",function(){return function(a,b){if(!a)return a;if(angular.isArray(b)&&b.length){var c=[];return angular.forEach(b,function(b){var d=$.grep(a,function(a){return a.name===b})[0];angular.isDefined(d)&&c.push(d)}),c}return a}}),a.filter("moment",[function(){return function(a,b){return a?moment(a).format(b):void 0}}]),a.filter("momentadd",[function(){return function(a,b,c){return a?moment(a).add(b,parseInt(c,10)).toISOString().replace(".000Z","Z"):void 0}}]),a.filter("timesince",[function(){return function(a){return a?moment(a).fromNow():void 0}}]),a.filter("themeSlug",["$filter",function(a){return function(b){return!b||angular.isArray(b)&&0===b.length?b:(angular.isArray(b)&&(b=b[0]),a("slugify")(a("normalize")(b)))}}]),a.filter("slugify",function(){return function(a){return a?ODS.StringUtils.slugify(a):a}}),a.filter("normalize",[function(){var a=[{base:"A",letters:/[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]/g},{base:"AA",letters:/[\uA732]/g},{base:"AE",letters:/[\u00C6\u01FC\u01E2]/g},{base:"AO",letters:/[\uA734]/g},{base:"AU",letters:/[\uA736]/g},{base:"AV",letters:/[\uA738\uA73A]/g},{base:"AY",letters:/[\uA73C]/g},{base:"B",letters:/[\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]/g},{base:"C",letters:/[\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]/g},{base:"D",letters:/[\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]/g},{base:"DZ",letters:/[\u01F1\u01C4]/g},{base:"Dz",letters:/[\u01F2\u01C5]/g},{base:"E",letters:/[\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]/g},{base:"F",letters:/[\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]/g},{base:"G",letters:/[\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]/g},{base:"H",letters:/[\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]/g},{base:"I",letters:/[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]/g},{base:"J",letters:/[\u004A\u24BF\uFF2A\u0134\u0248]/g},{base:"K",letters:/[\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]/g},{base:"L",letters:/[\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]/g},{base:"LJ",letters:/[\u01C7]/g},{base:"Lj",letters:/[\u01C8]/g},{base:"M",letters:/[\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]/g},{base:"N",letters:/[\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]/g},{base:"NJ",letters:/[\u01CA]/g},{base:"Nj",letters:/[\u01CB]/g},{base:"O",letters:/[\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]/g},{base:"OI",letters:/[\u01A2]/g},{base:"OO",letters:/[\uA74E]/g},{base:"OU",
letters:/[\u0222]/g},{base:"P",letters:/[\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]/g},{base:"Q",letters:/[\u0051\u24C6\uFF31\uA756\uA758\u024A]/g},{base:"R",letters:/[\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]/g},{base:"S",letters:/[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]/g},{base:"T",letters:/[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]/g},{base:"TZ",letters:/[\uA728]/g},{base:"U",letters:/[\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]/g},{base:"V",letters:/[\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]/g},{base:"VY",letters:/[\uA760]/g},{base:"W",letters:/[\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]/g},{base:"X",letters:/[\u0058\u24CD\uFF38\u1E8A\u1E8C]/g},{base:"Y",letters:/[\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]/g},{base:"Z",letters:/[\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]/g},{base:"a",letters:/[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]/g},{base:"aa",letters:/[\uA733]/g},{base:"ae",letters:/[\u00E6\u01FD\u01E3]/g},{base:"ao",letters:/[\uA735]/g},{base:"au",letters:/[\uA737]/g},{base:"av",letters:/[\uA739\uA73B]/g},{base:"ay",letters:/[\uA73D]/g},{base:"b",letters:/[\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]/g},{base:"c",letters:/[\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]/g},{base:"d",letters:/[\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]/g},{base:"dz",letters:/[\u01F3\u01C6]/g},{base:"e",letters:/[\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]/g},{base:"f",letters:/[\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]/g},{base:"g",letters:/[\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]/g},{base:"h",letters:/[\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]/g},{base:"hv",letters:/[\u0195]/g},{base:"i",letters:/[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]/g},{base:"j",letters:/[\u006A\u24D9\uFF4A\u0135\u01F0\u0249]/g},{base:"k",letters:/[\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]/g},{base:"l",letters:/[\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]/g},{base:"lj",letters:/[\u01C9]/g},{base:"m",letters:/[\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]/g},{base:"n",letters:/[\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]/g},{base:"nj",letters:/[\u01CC]/g},{base:"o",letters:/[\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]/g},{base:"oi",letters:/[\u01A3]/g},{base:"ou",letters:/[\u0223]/g},{base:"oo",letters:/[\uA74F]/g},{base:"p",letters:/[\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]/g},{base:"q",letters:/[\u0071\u24E0\uFF51\u024B\uA757\uA759]/g},{base:"r",letters:/[\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]/g},{base:"s",letters:/[\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]/g},{base:"t",letters:/[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]/g},{base:"tz",letters:/[\uA729]/g},{base:"u",letters:/[\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]/g},{base:"v",letters:/[\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]/g},{base:"vy",letters:/[\uA761]/g},{base:"w",letters:/[\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]/g},{base:"x",letters:/[\u0078\u24E7\uFF58\u1E8B\u1E8D]/g},{base:"y",letters:/[\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]/g},{base:"z",letters:/[\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]/g}];return function(b){if(!b)return b;for(var c=0;c<a.length;c++)b=b.replace(a[c].letters,a[c].base);return b}}]),a.filter("shortSummary",[function(){return function(a,b){if(b=b||400,!a)return"";var c="",d=angular.element("<div>"+a+"</div>");if(0===d.children().length)c=a.indexOf("\n")>-1?a.substring(0,a.indexOf("\n")):a;else{var e=d.contents()[0];if(3==e.nodeType)c=e.textContent;else if(d.find("p").length>0){var f=d.find("p")[0];c=angular.isDefined(f.textContent)?f.textContent:f.innerText}else c=d.text()}return c.length>b&&(c=c.substring(0,b-3)+"…"),c}}]),a.filter("imageUrl",function(){return function(a,b){if(!a||angular.equals(a,{}))return null;if(b||console.log("ERROR : This filter requires a context as second parameter."),!b.dataset)return null;angular.isObject(a)||console.log("ERROR : This field is not an file field.");var c=b.domainUrl;return c+="/api/datasets/1.0/"+b.dataset.datasetid+"/files/"+a.id+"/"}}),a.filter("thumbnailUrl",["imageUrlFilter",function(a){return function(b,c){var d=a(b,c);return d?d+"300/":null}}]),a.filter("firstValue",function(){return function(a){return angular.isArray(a)?a.length>0?a[0]:null:a}}),a.filter("split",function(){return function(a,b){if(!a)return a;b||(b=";");var c=a.split(b);return c}}),a.filter("join",function(){return function(a,b){return a?(b||(b=", "),angular.isArray(a)?a.join(b):a):a}}),a.filter("stringify",function(){return function(a){return angular.isObject(a)?JSON.stringify(a):a}}),a.filter("themeColor",function(a){return function(b){return b&&a.themes[b]?a.themes[b].color:""}}),a.filter("isBefore",function(){return function(a,b){return moment(a).isBefore(b)}}),a.filter("isAfter",function(){return function(a,b){return moment(a).isAfter(b)}})}(),function(a){var b={Context:{toggleRefine:function(a,b,c,d){var e="refine."+b;if(angular.isDefined(a.parameters[e])){var f=angular.copy(a.parameters[e]);angular.isArray(f)||(f=[f]),f.indexOf(c)>-1?f.splice(f.indexOf(c),1):(angular.forEach(f,function(a,b){c.startsWith(a+"/")?f.splice(b,1):a.startsWith(c+"/")&&f.splice(b,1)}),angular.isUndefined(d)||d===!1?f.push(c):f=[c]),0===f.length?delete a.parameters[e]:a.parameters[e]=f}else a.parameters[e]=c}},GeoFilter:{getBboxParameterAsBounds:function(a){var b=a.split(",");return[[b[0],b[1]],[b[2],b[3]]]},getBoundsAsBboxParameter:function(a){return angular.isArray(a)?[a[0][0],a[0][1],a[1][0],a[1][1]].join(","):[a.getSouthWest().lat,a.getSouthWest().lng,a.getNorthEast().lat,a.getNorthEast().lng].join(",")},getBoundsAsPolygonParameter:function(a){var b;b=angular.isArray(a)?new L.LatLngBounds(a):a;for(var c=[[b.getNorthWest().lat,b.getNorthWest().lng],[b.getNorthEast().lat,b.getNorthEast().lng],[b.getSouthEast().lat,b.getSouthEast().lng],[b.getSouthWest().lat,b.getSouthWest().lng]],d=[],e=0;e<c.length;e++){var f=c[e];d.push(f.join(","))}var g="("+d.join("),(")+")";return g},getPolygonParameterAsBounds:function(a){for(var b,c,d,e,f=a.replace(/[()]/g,"").split(","),g=0;g<f.length;g+=2){var h=parseFloat(f[g]),i=parseFloat(f[g+1]);(!b||b>h)&&(b=h),(!c||c>i)&&(c=i),(!d||h>d)&&(d=h),(!e||i>e)&&(e=i)}return[[b,c],[d,e]]},getPolygonParameterAsGeoJSON:function(a){for(var b={type:"Polygon",coordinates:[[]]},c=a.replace(/[()]/g,"").split(","),d=0;d<c.length;d+=2){var e=parseFloat(c[d]),f=parseFloat(c[d+1]);b.coordinates[0].push([f,e])}return b},getBboxParameterAsPolygonParameter:function(a){return this.getBoundsAsPolygonParameter(this.getBboxParameterAsBounds(a))},getGeoJSONPolygonAsPolygonParameter:function(a){var b,c=[];if("LineString"===a.type){b=a.coordinates;var d=null,e=null,f=null,g=null;angular.forEach(b,function(a){var b=a[0],c=a[1];d=null===d?b:Math.min(d,b),e=null===e?c:Math.min(e,c),f=null===f?b:Math.max(f,b),g=null===g?c:Math.max(g,c)}),c.push(e+","+d),c.push(e+","+f),c.push(g+","+f),c.push(g+","+d)}else{b=a.coordinates[0],"MultiPolygon"===a.type&&(b=b[0]);for(var h=0;h<b.length;h++){var i=angular.copy(b[h]);i.length>2&&i.splice(2,1),i.reverse(),c.push(i.join(","))}}return"("+c.join("),(")+")"},addGeoFilterFromSpatialObject:function(a,b){angular.isArray(b)?a["geofilter.distance"]=b[0]+","+b[1]:"Point"===b.type?a["geofilter.distance"]=b.coordinates[1]+","+b.coordinates[0]:a["geofilter.polygon"]=this.getGeoJSONPolygonAsPolygonParameter(b)}},StringUtils:{slugify:function(a){return a?a.toLowerCase().replace(/\s+/g,"-").replace(/[^\w-]+/g,"").replace(/-+/g,"-"):a},capitalize:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},startsWith:function(a,b){return a&&0===a.indexOf(b)}},URLUtils:{cleanupAPIParams:function(a){function b(b,c,d){c.startsWith(b+".")&&(a[b]?angular.isArray(a[b])?a[b].push(d):a[b]=[a[b],d]:a[b]=d,delete a[c])}var a=angular.copy(a);return angular.forEach(a,function(a,c){angular.forEach(["q","rq"],function(d){b(d,c,a)})}),a},getAPIQueryString:function(a){var b=[];return a=this.cleanupAPIParams(a),angular.forEach(a,function(a,c){angular.isString(a)?b.push(c+"="+encodeURIComponent(a)):angular.forEach(a,function(a){b.push(c+"="+encodeURIComponent(a))})}),b.join("&")}},DatasetUtils:{isFieldSortable:function(a){var b=["int","double","date","datetime"];if(b.indexOf(a.type)>=0)return!0;if("text"===a.type&&a.annotations)for(var c=0;c<a.annotations.length;c++){var d=a.annotations[c];if("sortable"===d.name)return!0}return!1}},Dataset:function(a){var b,c,d,e=function(a,b){if(a.annotations)for(var c=0;c<a.annotations.length;c++)if(a.annotations[c].name===b)return!0;return!1},f=function(a){d={facets:[]},b=[],c=0;for(var f=0;f<a.length;f++){var g=a[f];e(g,"facet")&&(c++,d.facets.push(g)),b[g.type]?b[g.type]+=1:b[g.type]=1}};return{datasetid:a.datasetid||"preview",has_records:a.has_records,metas:a.metas||{domain:"preview"},features:a.features,attachments:a.attachments,fields:a.fields,extra_metas:a.extra_metas,interop_metas:a.interop_metas,setFields:function(a){this.fields=a,f(this.fields)},getUniqueId:function(){return this.metas.domain+"."+this.datasetid},getTypes:function(){return"undefined"==typeof b&&f(this.fields),b},hasFeature:function(b){return a.features.indexOf(b)>-1},hasFieldType:function(a){for(var b=0;b<this.fields.length;b++)if(this.fields[b].type==a)return!0;return!1},countFieldType:function(a){for(var b=0,c=0;c<this.fields.length;c++)this.fields[c].type==a&&b++;return b},countFieldTypes:function(a){for(var b=0,c=0;c<a.length;c++)b+=this.countFieldType(a[c]);return b},getFacetsCount:function(){return"undefined"==typeof c&&f(this.fields),c},hasFacet:function(){return"undefined"==typeof c&&f(this.fields),c>0},getFilterDescription:function(){return"undefined"==typeof d&&f(this.fields),d},getFacets:function(){return this.getFilterDescription().facets},setMetas:function(a){this.metas=a},getField:function(a){for(var b=0;b<this.fields.length;b++){var c=this.fields[b];if(c.name===a)return c}return null},getFieldLabel:function(a){var b=this.getField(a);return b?b.label:b},getFieldsForType:function(a){for(var b=[],c=0;c<this.fields.length;c++){var d=this.fields[c];d.type===a&&b.push(d)}return b},hasNumericField:function(){for(var a=0;a<this.fields.length;a++){var b=this.fields[a];if("int"===b.type||"double"===b.type)return!0}return!1},hasGeoField:function(){for(var a=0;a<this.fields.length;a++){var b=this.fields[a];if("geo_point_2d"===b.type||"geo_shape"===b.type)return!0}return!1},getExtraMeta:function(a,b){return this.extra_metas&&this.extra_metas[a]&&this.extra_metas[a][b]?this.extra_metas[a][b]:null},isFieldAnnotated:function(a,b){return e(a,b)}}}};"undefined"==typeof a.ODS&&(a.ODS={}),a.ODS=angular.extend(a.ODS,b)}(window),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsAggregation",["ODSAPI",function(a){return{restrict:"A",scope:!0,controller:["$scope","$attrs",function(b,c){var d=b.$eval(c.odsAggregationContext),e=c.odsAggregationFunction||"COUNT",f=c.odsAggregationExpression,g=c.odsAggregation||"aggregation";d.wait().then(function(){b.$watch(d.name+".parameters",function(c,h){var i=angular.extend({},c,{"y.serie1.expr":f,"y.serie1.func":e});a.records.analyze(d,i).success(function(a){b[g]=a[0].serie1})},!0)})}]}}])}(),function(){"use strict";var a=function(a,b,c){try{return!!a.$eval(b,{y:c})}catch(d){console.warn("Error while compiling condition with expr",b)}return!1},b=angular.module("ods-widgets");b.directive("odsAnalysis",["ODSAPI",function(a){var b=function(a,b){var c,d=/([A-Z_-]*?)\((.*?)\)/g,e=/([A-Z_-]*?)\(([a-zA-Z0-9\._]+),\s?([0-9\.]+)\)/g,f=b||a;a.compiled_expr=""+a.expr,f.aggregates=[];for(var g={};c=d.exec(a.expr);){var h=e.exec(c[0]);if(h&&4===h.length&&(c=h),c&&(3===c.length||4===c.length))if(0===c[2].indexOf("serie")){var i="operators."+c[1].toLowerCase()+".apply(null, accumulation['"+c[2]+"']";4===c.length&&(i+=", "+c[3]),i+=")",a.compiled_expr=a.compiled_expr.replace(c[0],i),f.aggregates.push(c[2])}else g.func=c[1],g.expr=c[2],c[3]&&(g.subsets=c[3]),a.compiled_expr+=a.compiled_expr.replace(c[0],"y")}return g};return{restrict:"A",priority:1001,controller:["$scope","$attrs",function(c,d){c[d.odsAnalysisContext].wait().then(function(){c.$watch(d.odsAnalysisContext,function(e){var f=d.odsAnalysis||"results",g=angular.extend({},e.parameters,{maxpoints:d.odsAnalysisMax||0}),h={},i={},j=[];d.odsAnalysisSort&&(g.sort=d.odsAnalysisSort),angular.forEach(d,function(a,c){var d,e;if(c.startsWith("odsAnalysisSerie"))if(d=c.replace("odsAnalysisSerie",""),e=!1,d.endsWith("Cumulative")&&d.replace("Cumulative","").length>0&&(d=d.replace("Cumulative",""),e=a),d=d.toLowerCase(),i[d]||(i[d]={}),e)i[d].cumulative=e;else{var f={expr:a};angular.extend(i[d],b(f))}else c.startsWith("odsAnalysisAggregation")?(d=c.replace("odsAnalysisAggregation",""),d=d.toLowerCase(),h[d]||(h[d]={}),h[d].expr=d,h[d].func=a):c.startsWith("odsAnalysisX")&&j.push(a)}),j.length>0&&(g.x=j),angular.forEach(i,function(a,b){g["y."+b+".expr"]=a.expr,g["y."+b+".func"]=a.func,g["y."+b+".cumulative"]=a.cumulative||"false","QUANTILES"===a.func&&(g["y."+b+".subsets"]=a.subsets||"50"),h[b]&&(g["agg."+b+".expr"]=h[b].expr,g["agg."+b+".func"]=h[b].func)}),a.records.analyze(e,g).success(function(a){c[f]={},angular.isArray(a)?c[f]={results:a}:c[f]=a})},!0)})}]}}]),b.directive("odsAnalysisSerie",[function(){return{restrict:"A",scope:!0,controller:["$scope","$attrs",function(a,b){a.condition="",a.field="",a.$watch(b.odsAnalysisSerieCondition,function(c){b.odsAnalysisSerieCondition&&(a.condition=b.odsAnalysisSerieCondition)},!0),a.$watch(b.odsAnalysisSerieName,function(c){b.odsAnalysisSerieName&&(a.name=b.odsAnalysisSerieName)},!0),a.$watch(b.odsAnalysisSerieSeparateOnX,function(c){b.odsAnalysisSerieSeparateOnX&&(a.separateOnX=b.odsAnalysisSerieSeparateOnX)},!0),a.$watch(b.odsAnalysisSerieMode,function(c){b.odsAnalysisSerieMode&&(a.mode=b.odsAnalysisSerieMode)},!0)}],link:function(b,c,d){b.$watch(d.odsAnalysisSerie,function(c,d){var e,f,g,h,i=c,j={};if(b.separateOnX&&(j={}),b.results={},i){for(f={},e=0;e<i.length;e++)g=i[e][b.name],h=b.separateOnX?i[e].x[b.separateOnX]:"global",a(b,b.condition,g)?(j[h]||(j[h]=[]),j[h].push(i[e])):j[h]&&((!f[h]||f[h].length<j[h].length)&&(f[h]=j[h]),j[h]=!1);if(angular.forEach(j,function(a,b){(!f[b]||f[b].length<a.length)&&(f[b]=a)}),"reduce"==b.mode&&b.separateOnX){var k=Object.keys(f),l=[];for(e=0;e<k.length;e++)f[k[e]].length>l.length&&(l=f[k[e]]);angular.copy({global:l},b.results)}else angular.copy(f,b.results)}})}}}]),b.directive("odsSubaggregation",["ModuleLazyLoader",function(a){var b=function(a,b){var c,d=/([A-Z_-]*?)\((.*?)\)/g,e=/([A-Z_-]*?)\(([a-zA-Z0-9\._]+),\s?(.+)\)/g,f=b||a;a.compiled_expr=""+a.expr,f.aggregates=[];for(var g={};c=d.exec(a.expr);){var h=e.exec(c[0]);if(h&&4===h.length&&(c=h),c&&(3===c.length||4===c.length)){g.func=c[1],g.expr=c[2],c[3]&&(g.param=c[3]);var i="operators."+c[1].toLowerCase()+"(accumulation['"+c[2]+"']";4===c.length&&(i+=", "+c[3]),i+=")",g.compiled_expr=a.compiled_expr.replace(c[0],i),g.needed_aggregates=c[2]}}return g},c=function(a,b,c,d){var e;try{e=a.$eval(b,{operators:ss,accumulation:function(a,b){var c={};return angular.forEach(b,function(b){c[b]=a[b]}),c}(c,d),console:console})}catch(f){console.warn("Error while compiling aggregation value with expr",b)}return e};return{restrict:"A",scope:!0,controller:["$scope","$attrs",function(a,c){a.aggregations={};var d=a.$watch(c.odsSubaggregation,function(e){if(e){var f={};angular.forEach(c,function(a,c){var d;if(c.startsWith("odsSubaggregationSerie")){d=c.replace("odsSubaggregationSerie",""),d=d.toLowerCase(),f[d]||(f[d]={});var e={expr:a};angular.extend(f[d],b(e))}}),angular.copy(f,a.aggregations),d()}},!0)}],link:function(b,d,e){a("simple-statistics").then(function(){b.$watch(e.odsSubaggregation,function(a,d){var e,f,g={},h=a;if(b.results=[],h){for(f={},angular.forEach(b.aggregations,function(a,b){g[a.needed_aggregates]=[]}),e=0;e<h.length;e++)angular.forEach(g,function(a,b){"undefined"!=typeof h[e][b]&&g[b].push(h[e][b])});angular.forEach(b.aggregations,function(a,d){f[d]=c(b,a.compiled_expr,g,[a.needed_aggregates])}),b.results.push(f)}},!0)})}}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsCalendar",["ODSAPI","ModuleLazyLoader","ODSWidgetsConfig","$compile",function(a,b,c,d){return{restrict:"E",scope:{context:"=",startField:"@?",endField:"@?",titleField:"@?",tooltipFields:"@?",eventColor:"@?"},replace:!0,template:'<div class="odswidget-calendar">    <div class="odswidget-calendar__fullcalendar"></div>    <div class="odswidget-calendar__tooltip"></div>    <div class="odswidget-calendar__loading-backdrop">        <ods-spinner class="odswidget-calendar__loading-wheel"></ods-spinner>    </div></div>',link:function(e,f){var g=function(){var a={};if(e.context.dataset&&e.context.dataset.extra_metas&&e.context.dataset.extra_metas.visualization&&(a=e.context.dataset.extra_metas.visualization),angular.isDefined(e.startField)||(e.startField=a.calendar_event_start),angular.isDefined(e.endField)||(e.endField=a.calendar_event_end),angular.isDefined(e.titleField)||(e.titleField=a.calendar_event_title),angular.isDefined(e.eventColor)||(a.calendar_event_color?e.eventColor=a.calendar_event_color:e.eventColor="#C32D1C"),angular.isDefined(e.tooltipFields)){var b=[];angular.forEach(e.tooltipFields.split(","),function(a){b.push(a.trim())}),e.tooltipFields=b}else a.calendar_tooltip_fields?e.tooltipFields=a.calendar_tooltip_fields:e.tooltipFields=[];e.tooltip=$(f).children(".odswidget-calendar__tooltip").first().qtip({id:"odswidget-calendar",content:{text:"",button:!0},position:{my:"bottom center",at:"top center",target:"mouse",viewport:$(".odswidget-calendar__fullcalendar"),adjust:{mouse:!1,scroll:!1}},show:!1,hide:!1}).qtip("api"),$(document).on("click",function(a){$(a.target).parents(".fc-event").length||$(a.target).parents("#qtip-odswidget-calendar").length||h()}),e.fullcalendar=$(f).children(".odswidget-calendar__fullcalendar").first(),e.fullcalendar.fullCalendar({lazyFetching:!1,header:{left:"prevYear,prev,next,nextYear, today",center:"title",right:"month,agendaWeek,agendaDay"},lang:c.language,loading:j,editable:!0,eventLimit:!0,events:k,eventDataTransform:l,eventColor:e.eventColor,eventClick:function(a,b){h(),e.tooltip.set({"content.text":a.buildTooltipContent(),"position.target":[b.pageX,b.pageY]}).reposition(b).show(b)}})},h=function(){$("#qtip-odswidget-calendar").hide()},i=function(){e.fullcalendar.fullCalendar("refetchEvents")},j=function(a){a?$(".odswidget-calendar__loading-backdrop").show():$(".odswidget-calendar__loading-backdrop").hide()},k=function(b,c,d,f){a.records.search(e.context,n(b,c)).success(function(a){f(a.records)})},l=function(a){return{title:a.fields[e.titleField],start:a.fields[e.startField],end:a.fields[e.endField],buildTooltipContent:m(a),editable:!1}},m=function(a){var b=function(){var b=e.$new(!0);b.record=a,b.titleField=e.titleField,b.tooltipFields=e.tooltipFields,b.dataset=e.context.dataset;var c=d("<ods-calendar-tooltip></ods-calendar-tooltip")(b);return b.$apply(),c};return b},n=function(a,b){var c={dataset:e.context.dataset.datasetid,rows:1e4};c=$.extend(c,e.context.parameters);var d=[e.startField+"<"+b.format("YYYY-MM-DD"),e.endField+">"+a.format("YYYY-MM-DD")].join(" AND ");return c=$.extend(c,{"q.calendar_bounds":d})};b("fullcalendar","qtip").then(function(){e.context.wait().then(function(){g(),e.$watch("context.parameters",function(a,b){a!==b&&i()},!0)})})}}}]),a.directive("odsCalendarTooltip",function(){return{restrict:"E",template:'<h2 class="odswidget-calendar__tooltip-title">{{ record.fields[titleField] }}</h2><dl class="odswidget-calendar__tooltip-fields">    <dt ng-repeat-start="field in dataset.fields|fieldsForVisualization:\'calendar\'|fieldsFilter:tooltipFields"        ng-show="record.fields[field.name]|isDefined"        class="odswidget-calendar__tooltip-field-name">        {{ field.label }}    </dt>    <dd ng-repeat-end ng-switch="field.type" ng-show="record.fields[field.name]|isDefined">        <debug data="record.fields[field.name]"></debug>        <span ng-switch-when="geo_point_2d">            <ods-geotooltip width="300" height="300" coords="record.fields[field.name]">                {{ record.fields|formatFieldValue:field }}            </ods-geotooltip>        </span>        <span ng-switch-when="geo_shape">            <ods-geotooltip width="300" height="300" geojson="record.fields[field.name]">                {{ record.fields|formatFieldValue:field }}            </ods-geotooltip>        </span>        <span ng-switch-when="file">            <div ng-if="!dataset.isFieldAnnotated(field, \'has_thumbnails\')"                 ng-bind-html="record.fields|formatFieldValue:field"></div>            <div ng-if="dataset.isFieldAnnotated(field, \'has_thumbnails\')"                 ng-bind-html="record.fields[field.name]|displayImageValue:dataset.datasetid"                 style="text-align: center;"></div>        </span>        <span ng-switch-default               title="{{record.fields|formatFieldValue:field}}"               ng-bind-html="record.fields|formatFieldValue:field|imagify|videoify|prettyText|nofollow">        </span>    </dd></dl>'}})}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsCatalogContext",["ODSAPI","URLSynchronizer",function(a,b){return{restrict:"AE",scope:!0,replace:!0,link:function(c,d,e){for(var f=e.context.split(","),g=0;g<f.length;g++){var h=f[g].trim(),i=e[h+"Domain"],j=c.$eval(e[h+"Parameters"])||{};e[h+"Source"]&&(j.source=e[h+"Source"]),c[h]={name:h,type:"catalog",domain:i,domainUrl:a.getDomainURL(i),apikey:e[h+"Apikey"],parameters:j,toggleRefine:function(a,b,c){ODS.Context.toggleRefine(this,a,b,c)}},c.$eval(e[h+"Urlsync"])&&(angular.equals(j,{})||console.log("WARNING : Context "+h+" : There are specific parameters defined, but URL sync is enabled, so the parameters will be ignored."),b.addSynchronizedObject(c,h+".parameters"))}}}}])}(),function(){"use strict";var a=angular.module("ods-widgets"),b=function(a,b,c){var d=c.find(".dataset-item").first(),e=c.find(".card-container"),f=$(e).outerHeight();"bottom"==b.position?($(d).css("top",0),$(d).css("bottom",f)):($(d).css("top",f),$(d).css("bottom",0)),a(function(a){$(d).html(a)}),b.$apply()};a.directive("odsDatasetCard",function(){return{restrict:"E",scope:{context:"="},template:'<div class="odswidget odswidget-dataset-card"><div class="card-container" ng-class="{bottom: position == \'bottom\', expanded: expanded, expandable: isExpandable()}"><h2 class="dataset-title" ng-click="expanded = !expanded" ng-show="!expanded || (expanded && !context.dataset.metas.description)">{{context.dataset.metas.title}}</h2><div ng-click="expanded = !expanded" class="expand-control"><span translate>Details</span> <i class="fa fa-chevron-down" ng-show="!expanded"></i><i class="fa fa-chevron-up" ng-hide="!expanded"></i></div><div class="dataset-expanded" ng-click="expanded = !expanded""><h2 class="dataset-title" ng-show="expanded">{{context.dataset.metas.title}}</h2><p class="dataset-description" ng-if="expanded" ng-bind-html="safeHtml(context.dataset.metas.description)"></p></div><div class="dataset-infos"><span class="dataset-infos-text"><a ng-href="{{datasetUrl}}" target="_blank" ng-bind-html="websiteName"></a><span ng-show="context.dataset.metas.license"> - <span translate>License</span> {{context.dataset.metas.license}}</span></span></div></div><div class="dataset-item"></div></div>',replace:!0,transclude:!0,link:function(a,c,d){a.position=d.position||"top",a.renderContent=b},controller:["$scope","$element","ODSWidgetsConfig","$transclude","$sce",function(a,b,c,d,e){a.websiteName=c.websiteName,a.expanded=!1,a.safeHtml=function(a){return e.trustAsHtml(a)},a.isExpandable=function(){return a.context&&a.context.dataset&&a.context.dataset.datasetid&&a.context.dataset.metas.description?!0:!1};var f=a.$watch("context",function(c,e){c&&c.dataset&&(setTimeout(function(){a.renderContent(d,a,b)},0),a.expanded=!1,a.datasetUrl=a.context.domainUrl+"/explore/dataset/"+a.context.dataset.datasetid+"/",a.websiteName||(a.websiteName=a.context.domainUrl),f())},!0)}]}}),a.directive("odsMultidatasetsCard",["ODSWidgetsConfig",function(a){return{restrict:"E",scope:{title:"=",datasets:"=",context:"="},template:'<div class="odswidget-multidatasets-card">  <div class="card-container multidatasets" ng-class="{bottom: (position == \'bottom\'), expanded: expanded, expandable: isExpandable()}">      <h2 ng-show="!expanded" ng-click="tryToggleExpand()">{{ title }}</h2>      <div ng-click="tryToggleExpand()" class="expand-control" ng-class="{expanded: expanded}"><span translate>Details</span> <i class="icon-chevron-down"></i></div>      <h3 class="datasets-counter" ng-click="tryToggleExpand()" ng-show="!expanded">          <span class="count-text" ng-hide="!datasetObjectKeys || datasetObjectKeys.length <= 1">               <span ng-pluralize count="datasetObjectKeys.length" translate="when" when="{\'0\': \'no datasets to display\', \'1\': \'{} dataset\', \'other\': \'{} datasets\'}"></span>          </span>      </h3>      <div class="datasets-expanded">          <h2 ng-show="expanded" ng-click="tryToggleExpand()">{{ title }}</h2>          <h3 class="datasets-counter" ng-click="tryToggleExpand()" ng-show="expanded">              <span class="count-text">                   <span ng-pluralize count="datasetObjectKeys.length" translate="when" when="{\'0\': \'no datasets to display\', \'1\': \'{} dataset\', \'other\': \'{} datasets\'}"></span>              </span>          </h3>          <ul class="dataset-list"              ng-show="(datasetObjectKeys && datasetObjectKeys.length === 1) || (isExpandable() && expanded)"              ng-class="{\'single-dataset\': datasetObjectKeys.length === 1}">              <li ng-repeat="(key, dataset) in datasets"> <a                  ng-href="{{context.domainUrl}}/explore/dataset/{{dataset.datasetid}}/"                  target="_blank">{{ dataset.metas.title }}</a>                  <span ng-show="dataset.metas.license">- <span translate>License</span> {{ dataset.metas.license }}</span></li>          </ul>      </div>      <div class="dataset-infos"><span class="dataset-infos-text"><a ng-href="/" target="_blank" ng-bind-html="websiteName"></a></span></div>  </div>  <!-- embedded content (chart, map etc.) -->  <div class="dataset-item" ng-transclude></div></div>',replace:!0,transclude:!0,link:function(a,c,d){a.position=d.position||"top",a.renderContent=b},controller:["$scope","$element","ODSWidgetsConfig","$transclude","$sce",function(a,b,c,d,e){a.datasetObjectKeys=[],a.websiteName=c.websiteName,a.safeHtml=function(a){return e.trustAsHtml(a)},a.isExpandable=function(){return a.datasetObjectKeys.length&&1!==a.datasetObjectKeys.length?!0:!1},a.tryToggleExpand=function(){a.isExpandable()&&(a.expanded=!a.expanded)};var f=a.$watch("datasets",function(c,e){var g=Object.keys(c);0!==g.length&&(a.datasetObjectKeys=g,setTimeout(function(){a.renderContent(d,a,b)},0),a.expanded=!1,f())},!0)}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsDatasetContext",["ODSAPI","$q","$interpolate","URLSynchronizer",function(a,b,c,d){var e=function(c,e,f,g,h,i,j,k,l,m){var n;if(angular.equals(i,{}))if(j){var o=f.$watch(j,function(a,b){a&&(k&&(a.parameters.source=k),f[g].parameters=a.parameters,o())});n=null}else n=angular.equals(i,{})?i:{};else n=i,l&&console.log("WARNING : Context "+g+" : There are specific parameters defined, but URL sync is enabled, so the parameters will be ignored.");k&&n&&(n.source=k);var p=b.defer();f[g]={wait:function(){return p.promise},getDownloadURL:function(a,b){b=b||{},a=a||"csv";var c=this.domainUrl+"/explore/dataset/"+this.dataset.datasetid+"/download/?format="+a;return c+="&"+ODS.URLUtils.getAPIQueryString(angular.extend({},this.parameters,b))},toggleRefine:function(a,b,c){ODS.Context.toggleRefine(this,a,b,c)},name:g,type:"dataset",domain:c,domainUrl:a.getDomainURL(c),apikey:h,dataset:null,parameters:n},l&&d.addSynchronizedObject(f,g+".parameters",["basemap","location"]),m?(f[g].dataset=new ODS.Dataset(m),p.resolve(f[g].dataset)):a.datasets.get(f[g],e,{extrametas:!0,interopmetas:!0,source:n.source}).success(function(a){f[g].dataset=new ODS.Dataset(a),p.resolve(f[g].dataset)}).error(function(a){p.reject("Failed to fetch "+g+" context.")})};return{restrict:"AE",scope:!0,replace:!0,controller:["$scope","$attrs",function(a,b){for(var d=b.context.split(","),f=0;f<d.length;f++){var g=d[f].trim();b[g+"Dataset"]||b[g+"DatasetSchema"]||console.log("ERROR : Context "+g+" : Missing dataset parameter");var h,i,j,k,l,m;b[g+"Dataset"]&&(h=c(b[g+"Dataset"])(a)),b[g+"Domain"]&&(i=c(b[g+"Domain"])(a)),b[g+"Apikey"]&&(j=c(b[g+"Apikey"])(a)),b[g+"Sort"]&&(k=c(b[g+"Sort"])(a)),b[g+"Source"]&&(l=c(b[g+"Source"])(a)),b[g+"DatasetSchema"]&&(m=angular.fromJson(c(b[g+"DatasetSchema"])(a)));var n=a.$eval(b[g+"Parameters"])||{},o=b[g+"ParametersFromContext"];k&&(n.sort=k);var p=a.$eval(b[g+"Urlsync"]);e(i,h,a,g,j,n,o,l,p,m)}}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsDisqus",["ODSWidgetsConfig","$location","$window",function(a,b,c){return{restrict:"E",replace:!0,scope:{shortname:"@",identifier:"@"},template:'<div id="disqus_thread" class="odswidget"></div>',link:function(d){c.disqus_shortname=d.shortname||a.disqusShortname,d.identifier&&(c.disqus_identifier=d.identifier),c.disqus_url=b.absUrl(),c.disqus_config=function(){this.language=a.language};var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+c.disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsDomainStatistics",["ODSAPI",function(a){return{restrict:"AE",scope:!0,controller:["$scope","$attrs",function(b,c){var d=function(a,b,c){return c.name===b?(a.stats[b]=c.facets.length,!0):!1},e=b.$watch(c.context,function(b){b.stats={dataset:0,keyword:0,publisher:0,theme:0},a.datasets.search(b,{facet:["keyword","publisher","theme"]}).success(function(a){if(b.stats.dataset=a.nhits,a.facet_groups)for(var c=0;c<a.facet_groups.length;c++)d(b,"keyword",a.facet_groups[c])||d(b,"publisher",a.facet_groups[c])||!d(b,"theme",a.facet_groups[c]);
}),e()},!0)}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsFacetResults",["ODSAPI",function(a){return{restrict:"A",scope:!0,priority:1001,controller:["$scope","$attrs",function(b,c){b.$watch(c.odsFacetResultsContext,function(d){var e,f=c.odsFacetResultsFacetName,g=angular.extend({},d.parameters,{rows:0,facet:f}),h=c.odsFacetResults||"results";if("dataset"===d.type&&d.dataset)e=a.records.search(d,g);else{if("catalog"!==d.type)return;e=a.datasets.search(d,g)}e.success(function(a){if(a.facet_groups){var c=a.facet_groups.filter(function(a){return a.name===f});0===c.length&&(b[h]=[]),b[h]=c[0].facets}else b[h]=[]})},!0)}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsFacets",["$compile","translate",function(a,b){var c=function(b,c,d){var e="";angular.forEach(d,function(a){e+='<ods-facet name="'+a.name+'" title="'+(a.title&&a.title.replace(/"/g,"&quot;")||a.name)+'" sort="'+(a.sort||"")+'" disjunctive="'+(a.disjunctive||"")+'" hide-if-single-category="'+(a.hideIfSingleCategory?"true":"false")+'" hide-category-if="'+(a.hideCategoryIf||"")+'"value-formatter="'+(a.valueFormatter||"")+'">'+(a.template||"")+"</ods-facet>"});var f=angular.element(e);c.append(f),a(f)(b)};return{restrict:"E",replace:!0,scope:{context:"=",facetsConfig:"="},compile:function(a){var d=a.children().length;return function(a,e){if(a.facetsConfig)c(a,e,a.facetsConfig),a.init();else if(0===d)var f,g=a.$watch("context",function(){a.context&&(g(),"catalog"===a.context.type?(f=[{name:"modified",title:b("Modified")},{name:"publisher",title:b("Publisher")},{name:"keyword",title:b("Keyword")},{name:"theme",title:b("Theme")}],c(a,e,f),a.init()):a.context.wait().then(function(){f=angular.copy(a.context.dataset.getFacets()),angular.forEach(f,function(a){a.title=a.label,delete a.label,angular.forEach(a.annotations,function(b){"facetsort"===b.name&&b.args.length>0&&(a.sort=b.args[0]),"disjunctive"===b.name&&(a.disjunctive=!0)})}),c(a,e,f),a.init()}))},!0);else a.init()}},controller:["$scope","ODSAPI",function(a,b){a.facets=[],a.init=function(){a.$watch(function(){var b=angular.copy(a.context.parameters);return b.sort&&delete b.sort,b.start&&delete b.start,b.tab&&delete b.tab,b.dataChart&&delete b.dataChart,"dataset"===a.context.type?[b,a.context.dataset]:b},function(){("catalog"===a.context.type||a.context.dataset)&&(angular.isDefined(a.context.parameters.start)&&delete a.context.parameters.start,a.refreshData())},!0)},a.refreshData=function(){var c=angular.extend({},a.context.parameters,{rows:0,facet:a.facets.map(function(a){return a.name})});a.facets.map(function(a){a.sort&&a.sort.length&&"["!==a.sort[0]&&(c["facetsort."+a.name]=a.sort)});var d;d="dataset"===a.context.type?b.records.search(a.context,c):b.datasets.search(a.context,c),d.success(function(b){a.context.nhits=b.nhits;var c,d,e;angular.forEach(a.facets,function(a){a.categories.splice(0,a.categories.length)}),b.facet_groups&&angular.forEach(b.facet_groups,function(b){if(d=a.facets.filter(function(a){return a.name===b.name}),d.length>0){if(c=d[0].categories,e=[],d[0].sort&&d[0].sort.length&&"["===d[0].sort[0]){var f=a.$eval(d[0].sort);angular.forEach(f,function(a){var c,d;for(c=0;c<b.facets.length;c++)if(d=b.facets[c],d.path===a){e.push(d),b.facets.splice(c,1);break}}),Array.prototype.push.apply(e,b.facets)}else e=b.facets;Array.prototype.push.apply(c,e)}})})},this.registerFacet=function(b,c){var d=[];return a.facets.push({name:b,categories:d,sort:c}),d},this.setDisjunctive=function(b){a.context.parameters["disjunctive."+b]=!0},this.toggleRefinement=function(b,c){a.context.toggleRefine(b,c)}}]}}]),a.directive("odsFacet",function(){return{restrict:"E",replace:!0,scope:{name:"@",title:"@",visibleItems:"@",hideIfSingleCategory:"@",hideCategoryIf:"@",sort:"@",disjunctive:"@",valueSearch:"@",valueFormatter:"@"},template:function(a){return a.data("facet-template",a.html()),"<div ng-class=\"{'odswidget': true, 'odswidget-facet': true, 'odswidget-facet--disjunctive': isDisjunctive()}\">"+'<h3 class="odswidget-facet__facet-title" ng-if="title && categories.length && visible()">{{title}}</h3><ods-facet-category-list ng-if="visible()" facet-name="{{ name }}" value-search="{{ valueSearch }}" hide-category-if="{{ hideCategoryIf }}" categories="categories" template="{{ customTemplate }}" value-formatter="{{valueFormatter}}"></ods-facet-category-list></div>'},require:"^odsFacets",link:function(a,b,c,d){angular.isUndefined(d)&&console.log("ERROR : odsFacet must be used within an odsFacets tag."),a.categories=d.registerFacet(a.name,a.sort),a.facetsCtrl=d,a.isDisjunctive()&&d.setDisjunctive(a.name)},controller:["$scope","$element",function(a,b){a.isDisjunctive=function(){return angular.isString(a.disjunctive)&&"true"===a.disjunctive.toLowerCase()},a.visibleItemsNumber=a.visibleItems||6,this.toggleRefinement=function(b){a.facetsCtrl.toggleRefinement(a.name,b)},this.getVisibleItemsNumber=function(){return a.visibleItemsNumber},a.visible=function(){return!(angular.isString(a.hideIfSingleCategory)&&"true"===a.hideIfSingleCategory.toLowerCase()&&1===a.categories.length&&"refined"!==a.categories[0].state)},a.customTemplate=b.data("facet-template")}]}}),a.directive("odsFacetCategoryList",function(){return{restrict:"E",replace:!0,scope:{categories:"=",template:"@",facetName:"@",hideCategoryIf:"@",valueSearch:"@",valueFormatter:"@"},require:"^odsFacet",template:'<ul class="odswidget-facet__category-list">   <li class="odswidget-facet__value-search" ng-show="valueSearchEnabled">       <input class="odswidget-facet__value-search-input" ng-model="valueFilter">       <i ng-show="!!valueFilter" class="odswidget-facet__value-search-cancel icon-remove" ng-click="valueFilter=\'\'"></i>   </li>   <li ng-repeat="category in categories|filter:searchValue(valueFilter)" class="odswidget-facet__category-container">       <ods-facet-category ng-if="!categoryIsHidden(category)" facet-name="{{ facetName }}" category="category" template="{{template}}" value-formatter="{{valueFormatter}}" ng-show="visible($index)"></ods-facet-category>   </li>   <li ng-if="!suggestMode && visibleItems < (categories|filter:searchValue(valueFilter)).length" class="odswidget-facet__expansion-control">       <a ng-hide="expanded" href="#" ng-click="toggle($event)" translate>More</a>       <a ng-show="expanded" href="#" ng-click="toggle($event)" translate>Less</a>   </li></ul>',link:function(a,b,c,d){a.expanded=!1,a.visibleItems=d.getVisibleItemsNumber(),a.visible=function(b){return a.expanded||b<a.visibleItems},a.toggle=function(b){b.preventDefault(),a.expanded=!a.expanded},a.categoryIsHidden=function(b){if(a.suggestMode&&""===a.valueFilter)return!0;if(!a.hideCategoryIf)return!1;var c=a.$new(!1);return c.category=b,c.$eval(a.hideCategoryIf)}},controller:["$scope","$filter",function(a,b){a.valueFilter="",a.valueSearchEnabled=!1,a.suggestMode=!1,angular.isString(a.valueSearch)&&("true"===a.valueSearch.toLowerCase()?a.valueSearchEnabled=!0:"suggest"===a.valueSearch.toLowerCase()&&(a.valueSearchEnabled=!0,a.suggestMode=!0)),a.searchValue=function(a){return a?(a=b("normalize")(a).toLowerCase(),function(c){var d=b("normalize")(c.name).toLowerCase();return d.indexOf(a)>-1}):function(){return!0}},this.emptySearch=function(){a.valueFilter=""}}]}}),a.directive("odsFacetCategory",["$compile",function(a){return{restrict:"E",replace:!0,require:["^odsFacet","^?odsFacetCategoryList"],scope:{category:"=",facetName:"@",template:"@",valueFormatter:"@"},template:'<div class="odswidget odswidget-facet-category">   <a class="odswidget-facet__category" href="#" ng-click="toggleRefinement($event, category.path)" ng-class="{\'odswidget-facet__category--refined\': category.state === \'refined\'}" title="{{ category.name }}">   </a></div>',link:function(b,c,d,e){var f=e[0],g=e[1];b.toggleRefinement=function(a,b){a.preventDefault(),f.toggleRefinement(b),g.emptySearch()};var h=b.template||'<span class="odswidget-facet__category-name" ng-bind-html="formatCategory(category.name)"></span> <span class="odswidget-facet__category-count">{{ category.count|number }}</span>';if(c.find("a").append(a("<div>"+h+"</div>")(b).children()),b.category.facets){var i=angular.element('<ods-facet-category-list categories="category.facets" template="{{template}}"></ods-facet-category-list>');c.find("a").after(i),a(i)(b)}},controller:["$scope","ValueDisplay",function(a,b){a.formatCategory=function(c){return a.valueFormatter?b.format(c,a.valueFormatter):c}}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsFilterSummary",function(){return{restrict:"E",replace:!0,template:'<ul class="odswidget odswidget-filter-summary">    <li class="odswidget-filter-summary__active-filter" ng-show="isParameterActive(\'q\')">        <a class="odswidget-filter-summary__active-filter-link" ng-click="removeParameter(\'q\')">            <span class="odswidget-filter-summary__active-filter-label" translate>Text</span> {{context.parameters.q}}        </a>    </li>    <li class="odswidget-filter-summary__active-filter" ng-show="isParameterActive(\'geofilter.polygon\') || isParameterActive(\'geofilter.distance\')">        <a class="odswidget-filter-summary__active-filter-link" ng-click="removeParameter(\'geofilter.polygon\'); removeParameter(\'geofilter.distance\');" translate>Drawn area on the map</a>    </li>    <li class="odswidget-filter-summary__active-filter" ng-repeat="refinement in refinements">        <a class="odswidget-filter-summary__active-filter-link" ng-click="removeParameter(\'refine.\'+refinement.groupName, refinement.path)">            <i class="fa fa-filter odswidget-filter-summary__active_filter_icon"></i> <span class="odswidget-filter-summary__active-filter-label">{{refinement.groupLabel}}</span> {{refinement.label}}        </a>    </li>    <li class="odswidget-filter-summary__clear-all" ng-show="clearAllButton && isAnyFilterActive">        <a class="odswidget-filter-summary__clear-all-link" ng-click="clearAll()">            <i class="fa fa-ban odswidget-filter-summary__clear-all-icon"></i> <span translate>Clear all</span>        </a>    </li></ul>',scope:{context:"=",exclude:"@",clearAllButton:"=?"},controller:["$scope","translate",function(a,b){Boolean(a.clearAllButton)!==a.clearAllButton&&(a.clearAllButton=!0),a.isAnyFilterActive=!1;var c=a.exclude?a.exclude.split(","):[];a.isParameterActive=function(b){return a.context&&a.context.parameters&&-1===c.indexOf(b)&&a.context.parameters[b]&&void 0!==a.context.parameters[b]};var d=function(c){if("catalog"===a.context.type)return"features"===c&&(c="view"),b(ODS.StringUtils.capitalize(c));for(var d=0;d<a.context.dataset.fields.length;d++){var e=a.context.dataset.fields[d];if(e.name==c)return e.label}},e=function(){if(a.context&&a.context.parameters){var b=Object.keys(a.context.parameters);return b.filter(function(a){return"q"==a||"geofilter.polygon"==a||"geofilter.distance"==a||0===a.indexOf("refine.")})}return[]};a.clearAll=function(){angular.forEach(e(),function(b){delete a.context.parameters[b]})},a.removeParameter=function(b,c){if(c){var d=a.context.parameters[b];angular.isArray(d)||(d=[d]);for(var e=0;e<d.length;e++)if(d[e]==c)return d.splice(e,1),void(0===d.length&&delete a.context.parameters[b])}else delete a.context.parameters[b]};var f=function(){var b=[];if(a.context&&a.context.parameters&&("catalog"===a.context.type||a.context.dataset))for(var f in a.context.parameters)if("refine."==f.substring(0,7)&&-1===c.indexOf(f)){var g=a.context.parameters[f],h=f.substring(7);angular.isArray(g)||(g=[g]);for(var i=0;i<g.length;i++){var j=g[i];b.push({groupLabel:d(h),groupName:h,path:j,label:j.replace(/\//g," > ")})}}a.refinements=b,a.isAnyFilterActive=e().length>0};a.$watch("context",function(a,b){f()},!0)}]}})}(),function(){"use strict";angular.module("ods-widgets").directive("odsGeotooltip",["$timeout","ModuleLazyLoader",function(a,b){var c=angular.element('<div id="odswidget-geotooltip" class="odswidget" style="opacity: 0; transition: opacity 200ms ease-out; position: fixed; z-index: 40000; visibility: hidden;"></div>'),d=null,e=null,f=function(a,b,f,g,h,i){var j=!1;(b!==c.css("width")||f!==c.css("height"))&&(j=!0),c.css("width",b),c.css("height",f);var k=jQuery(window).height()-(a.offset().top-jQuery(document).scrollTop());c.height()<k?c.css("top",a.height()+a.offset().top-jQuery(document).scrollTop()+5+"px"):c.css("top",a.offset().top-jQuery(document).scrollTop()-5-c.height()+"px");var l=jQuery(window).width()-(a.offset().left-jQuery(document).scrollLeft());if(c.width()<l?c.css("left",a.offset().left-jQuery(document).scrollLeft()+"px"):c.css("left",a.offset().left-jQuery(document).scrollLeft()-c.width()+"px"),a.after(c),null===d){d=new L.map(c[0],{zoomControl:!1});var m=new L.TileLayer("http://otile{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png",{minZoom:1,maxZoom:16,attribution:'Tiles <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png"> - Map data © <a href="http://www.openstreetmap.org/" target="_blank">OpenStreetMap</a>',subdomains:"1234"});d.addLayer(m)}else j&&d.invalidateSize();null!==e&&d.removeLayer(e),e=L.layerGroup();var n=new L.LatLngBounds;if(g){angular.isString(g)&&(g=g.split(","));var o=new L.LatLng(g[0],g[1]),p=L.marker(o);e.addLayer(p),n.extend(o)}if(h){angular.isString(h)&&(h=angular.fromJson(h));var q=L.geoJson(h);e.addLayer(q),n.extend(q.getBounds())}if(i&&angular.isDefined(i.geometry)){var q=L.geoJson(i.geometry);e.addLayer(q),n.extend(q.getBounds())}e.addTo(d),d.fitBounds(n,{reset:!0}),c.css("opacity","1"),c.css("visibility","visible")},g=function(){c.css("opacity","0"),a(function(){c.css("visibility","hidden")},200)};return{template:'<span ng-transclude style="border-bottom: 1px dotted #000000; cursor: help;" class="geotooltip"></span>',replace:!0,restrict:"E",transclude:!0,scope:{coords:"=",width:"@",height:"@",delay:"@",geojson:"=",record:"="},link:function(c,d,e){b("leaflet").then(function(){var b=(e.width||200)+"px",h=(e.height||200)+"px",i=null,j=e.delay||500;d.bind("mouseenter",function(){0===j?f(d,b,h,c.coords,c.geojson,c.record):i=a(function(){f(d,b,h,c.coords,c.geojson,c.record),i=null},j)}),d.bind("click",function(){f(d,b,h,c.coords,c.geojson,c.record),null!==i&&(a.cancel(i),i=null)}),d.bind("mouseleave",function(){g(),null!==i&&(a.cancel(i),i=null)})})}}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.factory("requestData",["ODSAPI","$q","ChartHelper","AggregationHelper",function(a,b,c,d){var e=function(a,b){var c=[];return"year"==b?c.push(a+".year"):"month"==b?(c.push(a+".year"),c.push(a+".month")):"day"==b?(c.push(a+".year"),c.push(a+".month"),c.push(a+".day")):"hour"==b?(c.push(a+".year"),c.push(a+".month"),c.push(a+".day"),c.push(a+".hour")):"minute"==b?(c.push(a+".year"),c.push(a+".month"),c.push(a+".day"),c.push(a+".hour"),c.push(a+".minute")):"month month"==b?c.push(a+".month"):"day day"==b?c.push(a+".day"):"day weekday"==b?c.push(a+".weekday"):"hour weekday"==b?(c.push(a+".weekday"),c.push(a+".hour")):"day month"==b?c.push(a+".yearday"):"hour hour"==b?c.push(a+".hour"):c.push(a),c},f=function(a,b,c,d){var f,g,h={dataset:a.config.dataset,x:[],sort:a.sort||"",maxpoints:a.maxpoints||""};g=e(a.xAxis,a.timescale);for(var i=0;i<g.length;i++)h.x.push(g[i]);if(a.seriesBreakdown){f=a.seriesBreakdown,g=e(f,a.seriesBreakdownTimescale);for(var i=0;i<g.length;i++)h.x.push(g[i])}return(b||a.seriesBreakdown)&&(h.sort=h.x.map(function(a){return"x."+a}).join(",")),h},g=function(a,b,c){var d,e=/([A-Z_-]*?)\((.*?)\)/g,f=/([A-Z_-]*?)\(([a-zA-Z0-9\.]+),\s?([0-9\.]+)\)/g,g=c||a;a.compiled_expr=""+a.expr,g.aggregates=[];for(var h={};d=e.exec(a.expr);){var i=f.exec(d[0]);if(i&&4===i.length&&(d=i),d&&(3===d.length||4===d.length))if(0===d[2].indexOf("serie")){var j="operators."+d[1].toLowerCase()+".apply(null, accumulation['"+d[2]+"']";4===d.length&&(j+=", "+d[3]),j+=")",a.compiled_expr=a.compiled_expr.replace(d[0],j),g.aggregates.push(d[2])}else h[b+".func"]=d[1],h[b+".expr"]=d[2],a.compiled_expr+=a.compiled_expr.replace(d[0],"y")}return h},h=function(a,b,c,d){var e={};return"CUSTOM"===a.func?g(a,"y."+b,d):(e["y."+b+".expr"]=a.yAxis||a.expr,e["y."+b+".func"]=a.func,e["y."+b+".cumulative"]=a.cumulative||!1,"QUANTILES"===a.func&&(a.subsets||(a.subsets=50),e["y."+b+".subsets"]=a.subsets||50),"CONSTANT"===a.func&&(e["y."+b+".expr"]=a.yAxis||0,e["y."+b+".func"]="AVG"),angular.isDefined(a.multiplier)&&""!==a.multiplier&&null!==a.multiplier&&(e["y."+b+".expr"]+=" * "+a.multiplier),e)},i=function(a,b,d){if(b.type&&c.isRangeChart(b.type))if(a.sort==="y."+d&&(a.sort=""),"QUANTILES"===b.charts[0].func&&"QUANTILES"===b.charts[1].func&&b.charts[0].yAxis===b.charts[1].yAxis){var e=angular.copy(b.charts[0]);e.subsets=b.charts[0].subsets+","+b.charts[1].subsets,i(a,e,d)}else angular.isDefined(b.multiplier)&&(b.charts[0].multiplier=b.multiplier,b.charts[1].multiplier=b.multiplier),i(a,b.charts[0],d+"min"),i(a,b.charts[1],d+"max");else angular.extend(a,h(b,d))};return function(c,d,e,g,h,j,k,l){var m=[],n=[],o=j;return angular.forEach(c,function(b,c){var p={},q=f(b,e,g,h);angular.forEach(b.charts,function(a,b){var d="serie"+(c+1)+"-"+(b+1);i(q,a,d),p[d]=a}),j=b.config.domain||o,k=b.config.apikey||k;var r={domain:j,domainUrl:a.getDomainURL(j),dataset:{datasetid:q.dataset},apikey:k,parameters:{}};m.push(a.records.analyze(r,angular.extend({},d,b.config.options,q),l.promise)),n.push(p)}),{promise:b.all(m),charts:n}}}]),a.directive("odsHighchartsChart",["colorScale","requestData","translate","ModuleLazyLoader","AggregationHelper","ChartHelper","$rootScope","odsErrorService","$q",function(a,b,c,d,e,f,g,h,i){function j(a,b,d,e,f){var g=w(d,e);return g&&f?g.getTime():g?a(b,g):"undefined"==typeof d?void 0:angular.isObject(d)?d.week?c("Week")+" "+d.week:void 0:""+d}function k(a,b){return"QUANTILES"===b.func&&b.subsets?"undefined"==typeof a[b.subsets+".0"]?null:a[b.subsets+".0"]:"undefined"==typeof a?null:a}function l(a,b,c,d){var e;try{e=a.$eval(b,{operators:Math,accumulation:function(a,b){var c={};return angular.forEach(b,function(b){c[b]=a[b]}),c}(c,d),console:console})}catch(f){console.warn("Error while compiling aggregation value with expr",b)}return e}var m=function(a,b){var c;return c=b?b+"."+a:f.getDatasetUniqueId(a)},n=function(a){var b,c,d;if(a.timescale&&0===$.grep(a.queries,function(a){return a.sort}).length){d=a.timescale;var e=d.split(" ");b=e[0],c=2==e.length?e[1]:""}else d=!1,b=!1,c=!1;return{precision:b,periodic:c,timeSerieMode:d}},o=function(a,b,d,e,g){e.height(),e.width();if(0===a.queries.length)a.xLabel="";else if(!angular.isDefined(a.xLabel)){var h=m(a.queries[0].config.dataset,g);a.xLabel=f.getXLabel(h,a.queries[0].xAxis,a.timescale)}angular.isUndefined(a.displayLegend)&&(a.displayLegend=!0);var i={chart:{},title:{text:""},credits:{enabled:!1},series:[],xAxis:{title:{text:a.xLabel},labels:{step:1,rotation:-45,align:"right"},startOfWeek:1,minPadding:0,maxPadding:0,dateTimeLabelFormats:{second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%e %b %y",week:"%e. %b",month:"%b '%y",year:"%Y"}},legend:{enabled:!!a.displayLegend},yAxis:[],plotOptions:{series:{animation:!1},columnrange:{pointPadding:0,groupPadding:0,borderWidth:0,tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.low}</b> - <b>{point.high}</b>'}},arearange:{tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.low}</b> - <b>{point.high}</b>'}},areasplinerange:{tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.low}</b> - <b>{point.high}</b>'}},pie:{tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.y} ({point.percentage:.1f}%)</b>'}},treemap:{tooltip:{headerFormat:"",pointFormat:'<span style="color:{series.color}">{point.name}</span>: {point.value}</b>'},layoutAlgorithm:"squarified"}},tooltip:{valueDecimals:2,headerFormat:"{point.key}<br>",pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b>',formatter:function(a){var b,c=this.points||angular.isArray(this)?this:[this],d=c[0].series;return b=[a.tooltipHeaderFormatter(c[0])],angular.forEach(c,function(a){d=a.series;var c=d.tooltipFormatter&&d.tooltipFormatter(a)||a.point.tooltipFormatter(d.tooltipOptions.pointFormat);c=c.replace(/(\.|,)00</,"<"),c=c.replace(/(\.|,)00 /," "),b.push(c)}),b.push(a.options.footerFormat||""),b.join("")}},noData:{style:{fontFamily:"Open Sans",fontWeight:"normal",fontSize:"1.4em",color:"#333",opacity:"0.5"}},lang:{noData:c("No data available yet")}};if(b?(i.xAxis.type="datetime",i.xAxis.maxZoom=36e5,i.chart.zoomType="xy"):i.xAxis.categories=[],"month"===d?i.xAxis.labels.format="{value: %B}":"weekday"===d?(i.xAxis.labels.format="{value: %A}","hour"===b&&(i.xAxis.labels.format="{value: %A %Hh}")):"day"===d?i.xAxis.labels.format="{value: %d}":"hour"===d&&(i.xAxis.labels.format="{value: %H}"),b||(i.xAxis.labels.formatter=function(){return this.value.length>11?this.value.substring(0,8)+"...":this.value}),a.singleAxis){var j={color:"#000000",scale:a.singleAxisScale,yRangeMin:a.yRangeMin,yRangeMax:a.yRangeMax};i.yAxis=[v(a.singleAxisLabel,j,!1)]}return i},p={},q=0,r=function(b,c,d,e,g,h,i){var j,k=f.getDatasetId({dataset:{datasetid:d.config.dataset},domain:h}),l=f.getYLabel(k,e);g||"pie"===e.type?"pie"===e.type?(e.extras||(e.extras={}),e.innersize&&(e.extras.innerSize=e.innersize),"inside"===e.labelsposition&&(e.extras.dataLabels={distance:-50}),e.extras.colors=a.getColors(e.color)):(p[g+e.color]||(p[g+e.color]=a.getColorAtIndex(e.color,q),q++),j=p[g+e.color]):j=a.getUniqueColor(e.color);var m=angular.extend({},{name:g?g:l,color:j,type:e.type,yAxis:b.singleAxis?0:c[k][l],marker:{enabled:"scatter"===e.type,radius:3},shadow:!1,tooltip:{},data:[],stacking:d.stacked?d.stacked:null},e.extras);if(m.dataLabels||(m.dataLabels={}),e.displayValues&&(m.dataLabels.enabled=!0,m.dataLabels.color="black","treemap"!==e.type&&(m.dataLabels.formatter=function(){var a=Highcharts.numberFormat(this.point.y,2);return a.replace(/[,\.]00$/,"")})),e.displayUnits&&"COUNT"!==e.func){var n=f.getFieldUnit(k,e.yAxis);if(n&&(m.tooltip.valueSuffix=" "+n,e.displayValues&&"treemap"!==e.type)){var o=m.dataLabels.formatter;m.dataLabels.formatter=function(){return o.bind(this)(this.point.y)+" "+n}}}return e.refineOnClick&&(m.point={events:{click:function(a){var b=this.category||this.name;angular.forEach(e.refineOnClick,function(a){i[a["context-name"]].toggleRefine(a.field,b),i.$apply()})}}},m.cursor="pointer"),m=angular.extend(m,f.resolvePosition(e.position)),delete m.position,m},s=function(a){var b="";return angular.isObject(a)&&("year"in a||"month"in a||"day"in a||"hour"in a||"minute"in a||"weekday"in a)&&("year"in a?("day"in a&&(b+=" %e"),"month"in a&&(b+=" %B"),b+=" %Y","hour"in a&&(b+="minute"in a?" %Hh%M":" %Hh")):("month"in a&&(b="%B"),"day"in a&&(b="month"in a?"%e %B":"%e"),"weekday"in a?(b="%a","hour"in a&&(b+=" %Hh")):"hour"in a&&(b="%Hh"))),b},t=function(a,b){var c={};return b&&(c.xDateFormat=s(a)),c},u=function(a,b,c){c&&angular.isObject(a)&&("second"in a?b.minTickInterval=Date.UTC(2010,1,1,1,1,2)-Date.UTC(2010,1,1,1,1,1):"minute"in a?b.minTickInterval=Date.UTC(2010,1,1,1,2)-Date.UTC(2010,1,1,1,1):"hour"in a?b.minTickInterval=Date.UTC(2010,1,1,2)-Date.UTC(2010,1,1,1):"weekday"in a?b.minTickInterval=Date.UTC(2010,1,2)-Date.UTC(2010,1,1):"day"in a||"yearday"in a?b.minTickInterval=Date.UTC(2010,1,2)-Date.UTC(2010,1,1):"month"in a?b.minTickInterval=Date.UTC(2010,1,1)-Date.UTC(2010,0,1):"year"in a&&(b.minTickInterval=Date.UTC(2010,0,1)-Date.UTC(2009,0,1)))},v=function(a,b,c,d){var e="undefined"!=typeof b.yRangeMin&&""!==b.yRangeMin,f="undefined"!=typeof b.yRangeMax&&""!==b.yRangeMax,g={title:{text:a||"",style:{color:b.color}},labels:{style:{color:b.color}},type:b.scale||"linear",min:e?b.yRangeMin:null,max:f?b.yRangeMax:null,startOnTick:e?!1:!0,endOnTick:f?!1:!0,opposite:c};return d&&(g.stackLabels={enabled:!0}),g},w=function(a,b){var c=b?b.getFullYear():2e3,d=b?b.getMonth():0,e=b?b.getDate():1,f=b?b.getHours():0,g=b?b.getMinutes():0;if(angular.isObject(a)&&("year"in a||"month"in a||"day"in a||"hour"in a||"minute"in a||"weekday"in a||"yearday"in a)){var h=new Date(a.year||c,a.month-1||0,a.day||1,a.hour||0,a.minute||0);return h.setFullYear(a.year||c),!1 in a&&h.setUTCMonth(d),!1 in a&&h.setUTCDate(e),!1 in a&&h.setUTCHours(f),!1 in a&&h.setUTCMinutes(g),"year"in a||("weekday"in a&&h.setDate(h.getDate()+7-h.getDay()+a.weekday),"yearday"in a&&h.setDate(0+a.yearday)),"day"in a?29!=a.day||2!=a.month||a.year||(h.setDate(28),h.setMonth(1)):"month"in a&&h.setDate(16),h}};return{restrict:"A",replace:!0,require:["odsHighchartsChart"],scope:{parameters:"=parameters",domain:"=",apikey:"=",colors:"=",contexts:"=?"},template:'<div class="ods-chart">    <div class="ods-chart__loading" ng-show="loading">        <ods-spinner></ods-spinner>    </div>    <div class="chartplaceholder"></div>    <debug data="chartoptions"></debug></div>',controller:["$scope","$element","$attrs",function(d){var e,g,p,q,w,x=this;d.$watch("contexts",function(a,b){if(d.contexts&&d.contexts.length>0){var c=d.contexts.length-1;d[d.contexts[c].name]=d.contexts[c]}},!0),this.highchartsLoaded=function(y,z){function A(a){if(!p){if(angular.isObject(a)&&("day"in a||"month"in a||"year"in a)){var b=new Date(a.year,a.month-1||0,a.day||1,a.hour||0,a.minute||0);return y.dateFormat("%Y-%m-%d",b)}return""+a}switch(console.warn("formatRowX on periodic value should not be used anymore"),p){case"month":return[c("Jan"),c("Feb"),c("Mar"),c("Apr"),c("May"),c("Jun"),c("Jul"),c("Aug"),c("Sep"),c("Oct"),c("Nov"),c("Dec")][a.month-1];case"weekday":return[c("Monday"),c("Tuesday"),c("Wednesday"),c("Thursday"),c("Friday"),c("Saturday"),c("Sunday")][a.weekday];case"day":return a.day;default:return""+a}}var B=z.find(".chartplaceholder");y.setOptions({global:{useUTC:!1}});var C=i.defer();x.update=function(z){function D(a,b,c,d,e,f,g){if("datetime"===H.xAxis.type){if("object"==typeof e){var h=e[0],i=e[1];"logarithmic"===c&&(0>=h||0>=i)?a.data.push([d,null,null]):a.data.push([d,h,i])}else if("pie"==a.type)a.data.push({name:y.dateFormat(a.tooltip.xDateFormat,new Date(d)),y:e});else if("treemap"==a.type)a.data.push({name:y.dateFormat(a.tooltip.xDateFormat,new Date(d)),value:e});else if("logarithmic"===c&&0>=e?a.data.push([d,null]):a.data.push([d,e]),g.length>0)for(var j=g.length-1;j>=0;j--)if(e>=g[j].value){a.data[a.data.length-1]={x:a.data[a.data.length-1][0],y:a.data[a.data.length-1][1],color:g[j].color};break}}else if("pie"==a.type)a.data[b]={name:A(d),y:e};else if("treemap"==a.type)a.data[b]={name:A(d),value:e};else{if("object"==typeof e){var h=e[0],i=e[1];"logarithmic"===c&&(0>=h||0>=i)?a.data[b]=[null,null]:a.data[b]=[h,i]}else"logarithmic"===c&&0>=e?a.data[b]=null:a.data[b]=e;if(g.length>0)for(var j=g.length-1;j>=0;j--)if(e>=g[j].value){a.data[b]={y:a.data[b],color:g[j].color};break}}}if("undefined"==typeof z&&(z=d.parameters),z=angular.copy(z),!z||!z.queries||0===z.queries.length)return void(d.chart&&angular.element(d.chart.container).empty());e=void 0,g=void 0,p=void 0,q={};for(var E=0;E<z.queries.length;E++)try{m(z.queries[E].config.dataset,w)}catch(F){return void f.onLoad(x.update)}var G=n(z);e=G.timeSerieMode,g=G.precision,p=G.periodic;var H=o(z,g,p,B,w);d.chartoptions=H,angular.forEach(z.queries,function(b){var c=f.getDatasetId({dataset:{datasetid:b.config.dataset},domain:b.config.domain});angular.isUndefined(q[c])&&(q[c]={}),angular.forEach(b.charts,function(b){var d=f.getYLabel(c,b);if(!z.singleAxis&&angular.isUndefined(q[c][d])){var e=v(d,b,!!(H.yAxis.length%2),b.stacked);q[c][d]=H.yAxis.push(e)-1}if("bar"==b.type&&(H.xAxis.labels.rotation=0),b.colorScale=a.getScale(b.color),f.allowThresholds(b.type)){if(b.thresholds){for(var g=0;g<b.thresholds.length;g++)angular.isNumber(b.thresholds[g].value)||b.thresholds.splice(g,1);b.thresholds=b.thresholds.sort(function(a,b){return a.value>b.value})}}else delete b.thresholds})}),C.resolve("new request coming, cancelling current one"),C=i.defer(),d.loading=!0;var I=b(z.queries,d.searchoptions,e,g,p,d.domain,d.apikey,C);I.promise.then(function(b){d.loading=!1;var f,i=I.charts;if(g)for(var m=0;m<b.length;m++)for(var n=b[m],o=0;o<n.data.length;o++){var p=n.data[o];if(p.x.year){var v=new Date(p.x.year,p.x.month-1||0,p.x.day||1,p.x.hour||0,p.x.minute||0);v.setFullYear(p.x.year),(void 0===f||f>v)&&(f=v)}}for(var x=[],o=0;o<z.queries.length;o++)if(!z.queries[o].seriesBreakdown)for(var A=0;A<z.queries[o].charts.length;A++)x.push("serie"+(o+1)+"-"+(A+1)),H.series.push(!1);var C=function(a,b,c,e,f,h,i,j,k){var l,m=x.indexOf(a);h.colorScale(j).hex();-1===m?(c.series.push(r(b,q,f,h,k,f.config.domain||w,d)),m=x.push(a)-1):c.series[m]||(c.series[m]=r(b,q,f,h,k,f.config.domain||w,d)),g||-1!==(l=c.xAxis.categories.indexOf(i))||(l=c.xAxis.categories.length,c.xAxis.categories.push(i)),angular.extend(c.series[m].tooltip,e),k||"pie"===h.type?D(c.series[m],l,b.singleAxisScale||h.scale,i,j,c.series[m].color,h.thresholds||[]):D(c.series[m],l,b.singleAxisScale||h.scale,i,j,h.colorScale(j).hex(),h.thresholds||[])};angular.forEach(b,function(b,c){var h,m;if(b.data&&0!==b.data.length&&(b.data.results?(h=b.data.results,m=b.data.aggregations):h=b.data,0!==h.length)){var n=z.queries[c],o=i[c],p=n.xAxis,q=!!n.seriesBreakdown,r=t(q?h[0].x[p]:h[0].x,H,e);u(q?h[0].x[p]:h[0].x,H.xAxis,e),n.defaultValues={},angular.forEach(o,function(a,b){n.defaultValues[b]=null}),m&&angular.forEach(m,function(b,c){var d,e;if(c.endsWith("min"))c=c.replace("min",""),d=b.min,e=m[c+"max"].max;else{if(c.endsWith("max"))return;o[c].charts&&"QUANTILES"===o[c].charts[0].func&&"QUANTILES"===o[c].charts[1].func?(d=b.min[o[c].charts[0].subset+".0"],d=b.max[o[c].charts[1].subset+".0"]):(d=b.min,e=b.max)}o[c].colorScale=a.getScale(o[c].color,d,e)});for(var v=!1,w=[],x=[],A={},B=z.queries[c].charts.length,D=0;B>D;D++){var E=z.queries[c].charts[D];if(E.aggregates)for(var F=0;F<E.aggregates.length;F++){var G=E.aggregates[F];G&&-1===w.indexOf(G)&&(w.push(G),A[G]=[])}E.compiled_expr&&(v=!0)}for(var I=0;I<h.length;I++){var J=h[I];angular.extend({},n.defaultValues,J);var K=j(y.dateFormat,r.xDateFormat,q?J.x[p]:J.x,f,g),D=0;angular.forEach(J,function(a,b){var c,d;if("x"!==b){if(b.endsWith("min"))return;d=b.endsWith("max")?b.replace("max",""):b;var e=o[d];c=b.endsWith("max")?[k(J[b.replace("max","min")],e.charts[0]),k(a,e.charts[1])]:e.charts?[k(a,e.charts[0]),k(a,e.charts[1])]:k(a,e),q?angular.forEach(J.x,function(a,b){b!==p&&(a=j(y.dateFormat,s(a),a,f,!1),C(""+d+b+a,z,H,r,n,e,K,c,a),w.indexOf(d)>=0&&A[d].push(c))}):(C(""+d,z,H,r,n,e,K,c),w.indexOf(d)>=0&&A[d].push(c)),v&&x.push(K),D++}})}if(v){x.sort(function(a,b){return a-b});for(var I=x.length-1;I>0;I--)x[I]==x[I-1]&&x.splice(I,1)}for(var I=0;I<n.charts.length;I++)if(n.charts[I].aggregates)for(var L=n.charts[I],M=l(d,L.compiled_expr,A,L.aggregates),D=0;D<x.length;D++)C("aggr"+c+"-"+I,z,H,r,n,L,x[D],M)}});var E=H.xAxis.categories;if(E)for(var o=0;o<H.series.length;o++)for(var F=0;F<E.length;F++)"undefined"==typeof H.series[o].data[F]&&(H.series[o].data[F]=null);d.chart&&H.chart.renderTo&&(d.chart.destroy(),B=$element.find(".chartplaceholder")),H.chart.renderTo=B[0];try{H.series.length>500&&(h.sendErrorNotification(c("There are too many series to be displayed correctly, try to refine your query a bit.")),H.series=H.series.slice(0,10)),d.chart=new y.Chart(H,function(){})}catch(G){G.indexOf&&0===G.indexOf("Highcharts error #19")?(h.sendErrorNotification(c("There was too many points to display, the maximum number of points has been decreased.")),angular.forEach(d.parameters.queries,function(a){a.maxpoints=20})):angular.isString(G)?h.sendErrorNotification(G):h.sendErrorNotification(G.message)}},function(a){d.loading=!1})}}}],link:function(a,b,c,e){var f=e[0];d("highcharts").then(function(){f.highchartsLoaded(Highcharts,b),a.$watch("parameters",function(a,b){f.update(a)},!0)})}}}]),a.directive("odsHighcharts",["colorScale",function(a){
var b=a.getColors(a.getDefaultColorSet());return{restrict:"E",scope:{context:"=",fieldX:"@",expressionY:"@",functionY:"@",timescale:"@",chartType:"@",color:"@",chartConfig:"=",labelX:"@",labelY:"@",sort:"@",maxpoints:"@"},replace:!0,template:'<div class="odswidget odswidget-highcharts"><div ods-highcharts-chart parameters="chart" domain="context.domain" apikey="context.apikey"></div></div>',controller:["$scope","ODSWidgetsConfig","ChartHelper",function(a,c,d){var e=c.chartColors||b;a.color&&(e=a.color.split(",").map(function(a){return a.trim()}));var f=a.$watch("context.dataset",function(b){if(b){if("dataset"!==a.context.type&&console.error("ods-highcharts requires a Dataset Context"),d.init(a.context),angular.isUndefined(a.chartConfig)){var c={};"pie"===a.chartType&&(c={colors:e});var g="";g="y"===a.sort?"serie1-1":"-y"===a.sort?"-serie1-1":a.sort;var h=a.labelY||("COUNT"===a.functionY.toUpperCase()?"Count":a.expressionY);a.chart={timescale:a.timescale,xLabel:a.labelX,queries:[{config:{dataset:a.context.dataset.datasetid,options:a.context.parameters,domain:a.context.domain},xAxis:a.fieldX,sort:g,maxpoints:a.maxpoints||50,charts:[{yAxis:a.expressionY,yLabelOverride:h,func:a.functionY,color:e[0],type:a.chartType,extras:c}]}]}}else angular.isString(a.chartConfig)?a.chart=JSON.parse(b64_to_utf8(a.chartConfig)):a.chart=angular.copy(a.chartConfig);a.$broadcast("chartConfigReady",a.chart),a.$watch("chart",function(b){if(b){for(var c=d.getDatasetId(a.context),e=0;e<b.queries.length;e++){var f=b.queries[e];"undefined"==typeof f.xAxis&&d.setDefaultQueryValues(c,f,!0);for(var g=0;g<f.charts.length;g++)d.setSerieDefaultValues(c,f.charts[g],f.xAxis,!0);d.setDefaultQueryValues(c,f,!0),1===a.chart.queries.length&&d.setChartDefaultValues(c,b,!0);for(var g=0;g<f.charts.length;g++)d.setSerieDefaultColors(f.charts[g],f.seriesBreakdown)}a.$broadcast("chartConfigReady",a.chart)}},!0),f()}})}]}}]),a.directive("odsMultiHighcharts",["ODSAPI","ChartHelper","$q",function(a,b,c){return{restrict:"E",scope:{context:"=",chartConfig:"="},replace:!0,template:'<div class="odswidget odswidget-multihighcharts"><div ods-chart parameters="chart" domain="context.domain" apikey="context.apikey"></div></div>',controller:["$scope",function(d){var e=d.$watch("context",function(f){if(f){"catalog"!==f.type&&console.error("ods-multi-highcharts requires a Catalog Context");var g;g=angular.isString(d.chartConfig)?JSON.parse(b64_to_utf8(d.chartConfig)):d.chartConfig;for(var h=[],i=0;i<g.queries.length;i++){var j=g.queries[i].config.dataset;-1===h.indexOf(j)&&h.push(j)}for(var k=[],i=0;i<h.length;i++)k.push(a.datasets.get(d.context,h[i],{extrametas:!0}).success(function(a){var c=new ODS.Dataset(a);d.context.dataset=c,b.init(d.context)}));c.all(k).then(function(a){d.chart=g}),e()}})}]}}]),a.directive("odsChart",["ODSAPI","ChartHelper","ODSWidgetsConfig",function(a,b,c){return{restrict:"EA",scope:{timescale:"@",labelX:"@",singleYAxis:"@",singleYAxisLabel:"@",singleYAxisScale:"@",min:"@",max:"@",logarithmic:"@",displayLegend:"@",context:"=?",fieldX:"@",expressionY:"@",functionY:"@",chartType:"@",color:"@",chartConfig:"=?",labelY:"@",sort:"@",maxpoints:"@",chart:"=?parameters"},replace:!0,transclude:!0,template:'<div class="odswidget odswidget-charts"><debug data="chart"></debug><div ods-highcharts-chart parameters="chart" domain="context.domain" apikey="context.apikey" contexts="contexts"></div><div ng-transclude></div></div>',controller:["$scope","$element","$attrs","$transclude",function(a,d,e,f){a.contexts=[],a.chart||(a.chart={queries:[],xLabel:angular.isDefined(a.labelX)?a.labelX:void 0,timescale:a.timescale||"",singleAxis:!!a.singleYAxis,singleAxisLabel:angular.isDefined(a.singleYAxisLabel)?a.singleYAxisLabel:void 0,singleAxisScale:a.logarithmic?"logarithmic":"",yRangeMin:angular.isDefined(a.min)?parseInt(a.min,10):void 0,yRangeMax:angular.isDefined(a.max)?parseInt(a.max,10):void 0,displayLegend:angular.isDefined(a.displayLegend)&&"false"===a.displayLegend?!1:!0}),angular.forEach(a.chart,function(b,c){"undefined"==typeof b&&delete a.chart[c]}),e.context?(!function(){var d=c.chartColors||defaultColors;a.color&&(d=a.color.split(",").map(function(a){return a.trim()}));var e=a.$watch("context.dataset",function(c){if(c){if("dataset"!==a.context.type&&console.error("ods-chart requires a Dataset Context"),b.init(a.context),angular.isUndefined(a.chartConfig)){var f={};"pie"===a.chartType&&(f={colors:d});var g="";g="y"===a.sort?"serie1-1":"-y"===a.sort?"-serie1-1":a.sort;var h=a.labelY||("COUNT"===a.functionY.toUpperCase()?"Count":a.expressionY);a.chart={timescale:a.timescale,xLabel:a.labelX,queries:[{config:{dataset:a.context.dataset.datasetid,options:a.context.parameters},xAxis:a.fieldX,sort:g,maxpoints:a.maxpoints||50,charts:[{yAxis:a.expressionY,yLabelOverride:h,func:a.functionY,color:d[0],type:a.chartType,extras:f}]}]}}else angular.isString(a.chartConfig)?a.chart=JSON.parse(b64_to_utf8(a.chartConfig)):a.chart=a.chartConfig;e()}})}(),this.setQuery=function(a,b){console.error("cannot use ods-chart-query when context and chartConfig are declared on ods-chart")}):(this.setQuery=function(c,d){var e,f=a.chart.queries.indexOf(c);-1===f?(f=a.chart.queries.length,a.chart.queries.push(c)):a.chart.queries[f]=c,c.sort&&(e=c.sort.match(/^(-?)serie([0-9]+)$/))&&(a.chart.queries[f].sort=e[1]+"serie"+(f+1)+"-"+e[2]),a.contexts.push(d);var g=b.getDatasetId(d);"undefined"==typeof c.xAxis&&b.setDefaultQueryValues(g,c,!0);for(var h=0;h<c.charts.length;h++)b.setSerieDefaultValues(g,c.charts[h],c.xAxis,!0);b.setDefaultQueryValues(g,c,!0),1===a.chart.queries.length&&b.setChartDefaultValues(g,a.chart,!0);for(var h=0;h<c.charts.length;h++)b.setSerieDefaultColors(c.charts[h],c.seriesBreakdown)},a.$watch("labelX",function(b,c){a.chart.xLabel=b}))}]}}]),a.directive("odsChartQuery",["ODSAPI","ChartHelper",function(a,b){return{restrict:"E",require:["odsChartQuery","^odsChart"],controller:["$scope",function(a){}],compile:function(){return{pre:function(a,c,d,e){var f=e[0],g=e[1],h={config:{},charts:[],xAxis:d.fieldX,maxpoints:d.maxpoints?parseInt(d.maxpoints,10):void 0,timescale:d.timescale,stacked:d.stacked,seriesBreakdown:d.seriesBreakdown,seriesBreakdownTimescale:d.seriesBreakdownTimescale};h.sort="","y"===d.sort?h.sort="serie1":"-y"===d.sort?h.sort="-serie1":h.sort=d.sort;var i=d.options||{};angular.forEach(h,function(a,b){"undefined"==typeof a&&delete h[b]}),f.setChart=function(a){-1===h.charts.indexOf(a)&&h.charts.push(a)};var j=function(a){a&&g.setQuery(h,a)},k=d.context;a[k].wait().then(function(c){b.init(a[k]),h.config.dataset=c.datasetid,h.config.domain=a[k].domain,h.config.apikey=a[k].apikey,h.config.options=angular.extend({},a[k].parameters,i),f.setChart=function(b){-1===h.charts.indexOf(b)&&h.charts.push(b),j(a[k])},j(a[k]),a.$watch(k+".parameters",function(b,c){b&&(h.config.options=angular.extend({},b,i),j(a[k]))},!0)})}}}}}]),a.directive("odsChartSerie",["ODSAPI","ChartHelper","$compile","$parse",function(a,b,c,d){return{restrict:"E",require:"^odsChartQuery",controller:["$scope","$transclude",function(a,b){}],link:function(a,b,c,d){var e,f=d,g={type:c.chartType||void 0,innersize:c.innersize||void 0,labelsposition:c.labelsposition||void 0,func:c.functionY||void 0,yAxis:c.expressionY||void 0,color:c.color||void 0,cumulative:!!c.cumulative||!1,yLabelOverride:angular.isDefined(c.labelY)?c.labelY:void 0,scale:c.logarithmic?"logarithmic":"",yRangeMin:angular.isDefined(c.min)?parseInt(c.min,10):void 0,yRangeMax:angular.isDefined(c.max)?parseInt(c.max,10):void 0,displayUnits:"true"===c.displayUnits,displayValues:"true"===c.displayValues,multiplier:angular.isDefined(c.multiplier)?parseInt(c.multiplier,10):void 0,thresholds:c.colorThresholds?a.$eval(c.colorThresholds):[],subsets:c.subsets,charts:c.subseries?JSON.parse(c.subseries):void 0};if(c.refineOnClickContext){e=angular.isArray(c.refineOnClickContext)?c.refineOnClickContext:[c.refineOnClickContext];for(var h=0;h<e.length;h++)c["refineOnClick"+ODS.StringUtils.capitalize(e[h])+"ContextField"]?(g.refineOnClick||(g.refineOnClick=[]),g.refineOnClick.push({context:a[e[h]],"context-name":e[h],field:c["refineOnClick"+ODS.StringUtils.capitalize(e[h])+"ContextField"],scopeApply:a.$apply})):console.warn("Field for context "+ODS.StringUtils.capitalize(e[h])+" is not set in chart.")}angular.forEach(g,function(a,b){"undefined"==typeof a&&delete g[b]}),f.setChart(g),c.$observe("labelY",function(a){g.yLabelOverride=a,f.setChart(g)})}}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsInfiniteScrollResults",function(){return{template:'<div class="{{listClass}} odswidget-infinite-scroll-results" infinite-scroll="loadMore()" infinite-scroll-distance="1" infinite-scroll-disabled="fetching">   <div class="{{resultClass}}" ng-repeat="item in results" inject>   </div></div>',scope:{context:"=",resultClass:"@",listClass:"@",scrollTopWhenRefresh:"="},transclude:!0,controller:["$scope","$window","ODSAPI",function(a,b,c){var d=0;a.fetching=!1,a.results=[];var e=function(b){b?d=0:d+=1;var e=10*d;a.fetching=!0,"catalog"==a.context.type?c.datasets.search(a.context,{rows:10,start:e}).success(function(a){f(a.datasets,b)}):c.records.search(a.context,{rows:10,start:e}).success(function(a){f(a.records,b)})},f=function(c,d){d&&(a.results=[]),a.results=a.results.concat(c),a.fetching=!1,d&&a.scrollTopWhenRefresh&&b.scrollTo(b.scrollX,0)};a.loadMore=function(){e(!1)},a.$watch("context.parameters",function(a,b){angular.isDefined(a)&&a!==b&&e(!0)})}]}})}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsLastDatasetsFeed",["ODSAPI",function(a){return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-last-datasets-feed"><ul>   <li class="no-data" ng-hide="datasets" translate>No data available yet</li>   <li ng-repeat="dataset in datasets" ng-if="datasets">       <ods-theme-picto theme="{{dataset.metas.theme|firstValue}}"></ods-theme-picto>       <div class="dataset-details">           <div class="title"><a ng-href="{{context.domainUrl}}/explore/dataset/{{dataset.datasetid}}/" target="_self">{{ dataset.metas.title }}</a></div>           <div class="modified"><i class="icon-calendar"></i> <span title="{{ dataset.metas.modified|moment:\'LLL\' }}"><span translate>Modified</span> {{ dataset.metas.modified|timesince }}</span></div>       </div>   </li></ul></div>',scope:{context:"="},controller:["$scope",function(b){var c=function(){a.datasets.search(b.context,{rows:5,sort:"modified"}).success(function(a){b.datasets=a.datasets})};b.$watch("context",function(){c()})}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsLastReusesFeed",["ODSAPI",function(a){return{restrict:"E",replace:!0,transclude:!0,template:'<div class="odswidget odswidget-last-reuses-feed"><ul>   <li class="no-data" ng-hide="reuses" translate>No data available yet</li>   <li ng-repeat="reuse in reuses" ng-if="reuses" inject>       <div class="reuse-thumbnail">           <span style="display: inline-block; height: 100%; vertical-align: middle;"></span>           <a ng-href="{{reuse.url}}" target="_self"><img ng-if="reuse.thumbnail" ng-src="{{ reuse.thumbnail }}"></a>       </div>       <div class="reuse-details">           <div class="title"><a ng-href="{{reuse.url}}" target="_self">{{ reuse.title }}</a></div>           <div class="dataset"><a ng-href="{{reuse.url}}" target="_self">{{ reuse.dataset.title }}</a></div>           <div class="modified"><span title="{{ reuse.created_at|moment:\'LLL\' }}"><i class="icon-calendar"></i> {{ reuse.created_at|timesince }}</span></div>       </div>   </li></ul></div>',scope:{context:"=",max:"@"},controller:["$scope",function(b){b.max=b.max||5;var c=function(){a.reuses(b.context,{rows:b.max}).success(function(a){angular.forEach(a.reuses,function(a){a.url=b.context.domainUrl+"/explore/dataset/"+a.dataset.id+"/?tab=metas"}),b.reuses=a.reuses})};b.$watch("context",function(){c()})}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsMapLegacy",["ModuleLazyLoader",function(a){return{restrict:"E",scope:{context:"=",embedMode:"@",autoResize:"@",mapContext:"=?",location:"@",basemap:"@",isStatic:"@",showFilters:"@",itemClickContext:"=",colorBy:"@",colorByField:"@",colorByContext:"=",colorByAggregationKey:"@",colorByKey:"@",colorByExpression:"@",colorByFunction:"@",colorByRanges:"@",colorByRangesColors:"@"},replace:!0,template:function(a){return a.contents().wrapAll("<div>"),a.contents().length>0&&a.contents().html().trim().length>0&&(a.contents().wrapAll("<div>"),a.data("tooltip-template",a.children().html())),'<div class="odswidget odswidget-map"><div class="odswidget-map__map"></div><div class="odswidget-overlay map odswidget-overlay--opaque" ng-show="pendingRequests.length && initialLoading"><ods-spinner></ods-spinner></div></div>'},link:function(b,c){function d(){$(".odswidget-map__map").length>0&&$(".odswidget-map__map").height(Math.max(200,$(window).height()-$(".odswidget-map__map").offset().top))}angular.isUndefined(b.mapContext)&&(b.mapContext={},b.location&&(b.mapContext.location=b.location),b.basemap&&(b.mapContext.basemap=b.basemap)),"true"===b.autoResize&&($(window).on("resize",d),d()),a("leaflet").then(function(){L.Control.FilterByView=L.Control.extend({options:{position:"topright"},onAdd:function(a){var c="leaflet-control-filterview",d=c+" leaflet-bar leaflet-control",e=L.DomUtil.create("div",d),f=L.DomUtil.create("a","leaflet-bar-part",e);return f.href="#",b.mapViewFilter&&(e.className=d+" active"),L.DomEvent.on(f,"click",L.DomEvent.stopPropagation).on(f,"click",L.DomEvent.preventDefault).on(f,"click",function(){return b.$apply(function(a){a.mapViewFilter=!a.mapViewFilter}),b.mapViewFilter?e.className=d+" active":e.className=d,!1}).on(f,"dblclick",L.DomEvent.stopPropagation),b.$watch("mapViewFilter",function(a,b){a!==b&&(a?e.className=d+" active":e.className=d)}),e}}),b.initMap=function(a,d,e,f,g,h,i,j,k){var l={basemapsList:e,worldCopyJump:!0,minZoom:2,basemap:h,dragging:!i,zoomControl:!i,prependAttribution:j};i&&(l.doubleClickZoom=!1,l.scrollWheelZoom=!1);var m=new L.ODSMap(c.children()[0],l);if(m.addControl(new L.Control.Scale),g&&!i){var n=L.Control.geocoder({placeholder:f("Find a place..."),errorMessage:f("Nothing found."),geocoder:new L.Control.Geocoder.Nominatim({serviceUrl:"https://nominatim.openstreetmap.org/",geocodingQueryParams:{"accept-language":k||"en",polygon_geojson:!0}})});n.markGeocode=function(a){if(m.fitBounds(a.bbox),a.properties.geojson){var b=L.geoJson(a.properties.geojson,{style:function(){return{opacity:0,fillOpacity:.8,fillColor:"orange",className:"leaflet-geocoder-highlight"}}});m.addLayer(b),$timeout(function(){c.addClass("geocoder-highlight-on")},0),$timeout(function(){c.removeClass("geocoder-highlight-on"),m.removeLayer(b)},2500)}},m.addControl(n)}"true"!==d&&("true"===b.showFilters&&m.addControl(new L.Control.FilterByView),m.addControl(new L.Control.Fullscreen)),i||m.addControl(new L.Control.Locate({maxZoom:18})),m.on("popupclose",function(a){jQuery(a.popup.getContent()).trigger("popupclose")}),b.map=m}})},controller:["$scope","$http","$compile","$q","$filter","$element","translate","ODSAPI","DebugLogger","ODSWidgetsConfig","$attrs",function(a,b,c,d,e,f,g,h,i,j,k){i.log("init map"),a.pendingRequests=b.pendingRequests,a.initialLoading=!0,(a.itemClickMapField&&!a.itemClickContextField||!a.itemClickMapField&&a.itemClickContextField)&&console.log("ERROR: You need to configure both item-click-context-field and item-click-map-field.");var l,m=null,n=null,o={delimiter:",",accuracy:5,formatLatLng:function(a){var b=L.Util.formatNum(a.lat,this.accuracy),c=L.Util.formatNum(a.lng,this.accuracy);return new L.latLng(b,c)},getLocationParameterAsArray:function(a){return a.split(this.delimiter)},getLocationParameterFromMap:function(a){var b=this.formatLatLng(a.getCenter());return a.getZoom()+this.delimiter+b.lat+this.delimiter+b.lng},getCenterFromLocationParameter:function(a){var b=this.getLocationParameterAsArray(a);return new L.latLng(b[1],b[2])},getZoomFromLocationParameter:function(a){return this.getLocationParameterAsArray(a)[0]}},p=function(a,b){ODS.GeoFilter.addGeoFilterFromSpatialObject(a.parameters,b)},q=function(a,b,c,d){angular.isDefined(d.fields[b])&&(a.parameters["refine."+c]=d.fields[b])},r=function(b,c,d,e,f){if(c||d)if(f)a.$apply(function(){q(b,c,d,f)});else{var g={};ODS.GeoFilter.addGeoFilterFromSpatialObject(g,e),jQuery.extend(g,a.staticSearchOptions,a.context.parameters,{rows:1}),h.records.download(a.context,g).success(function(a){q(b,c,d,a[0])})}else a.$apply(function(){p(b,e)})},s=function(b,d,e,g){var h,i,j;if(a.itemClickContext)angular.isArray(a.itemClickContext)?angular.forEach(a.itemClickContext,function(a){i=k["itemClick"+ODS.StringUtils.capitalize(a.name)+"ContextField"],h=k["itemClick"+ODS.StringUtils.capitalize(a.name)+"MapField"],r(a,h,i,d,g)}):(j=a.itemClickContext,i=k["itemClick"+ODS.StringUtils.capitalize(j.name)+"ContextField"]||k.itemClickContextField,h=k["itemClick"+ODS.StringUtils.capitalize(j.name)+"MapField"]||k.itemClickMapField,r(j,h,i,d,g));else{var l=a.$new(!1);e?l.recordid=e:l.shape=d;var m={offset:[0,-30],maxWidth:250,minWidth:250,autoPanPaddingTopLeft:[50,305],autoPan:!a.mapViewFilter&&!a.staticMap},n=f.data("tooltip-template");(angular.isUndefined(n)||!angular.isString(n)||""===n.trim())&&(n=a.context.dataset.extra_metas&&a.context.dataset.extra_metas.visualization&&a.context.dataset.extra_metas.visualization.map_tooltip_html?a.context.dataset.extra_metas.visualization.map_tooltip_html:""),l.template=n;var o=new L.Popup(m).setLatLng(b).setContent(c('<ods-map-tooltip shape="shape" context="context" recordid="recordid" map="map" template="{{template}}"></ods-map-tooltip>')(l)[0]);o.openOn(a.map)}},t=function(a){return a=Math.round(100*a)/100,a=e("number")(a)},u=function(b){return function(c,d){if(c.count>1){var e=new L.ClusterMarker(c.cluster_center,{geojson:c.cluster,value:c.count,total:d,numberFormattingFunction:t,color:a.markerColor});a.staticMap||e.on("click",function(b){a.map.getZoom()===a.map.getMaxZoom()?s(marker.getLatLng(),c.cluster):a.$apply(function(){if(c.cluster)if("Point"===c.cluster.type)a.map.fitBounds([[c.cluster.coordinates[1],c.cluster.coordinates[0]],[c.cluster.coordinates[1],c.cluster.coordinates[0]]]);else{var d={},e=ODS.GeoFilter.getBoundsAsPolygonParameter(L.geoJson(c.cluster).getBounds());jQuery.extend(d,a.staticSearchOptions,a.context.parameters,{"geofilter.polygon":e}),h.records.boundingbox(a.context,d).success(function(b){a.map.fitBounds([[b.bbox[1],b.bbox[0]],[b.bbox[3],b.bbox[2]]])})}else a.map.setView(b.latlng,a.map.getZoom()+2)})}),b.addLayer(e)}else{var f=n(c.cluster_center);f.on("click",function(a){s(a.target.getLatLng(),c.cluster)}),b.addLayer(f)}}},v=function(b){var c={"geofilter.polygon":ODS.GeoFilter.getBoundsAsPolygonParameter(a.map.getBounds()),clusterprecision:a.map.getZoom(),clusterdistance:50,return_polygons:b};jQuery.extend(c,a.staticSearchOptions,a.context.parameters),a.currentClusterRequestCanceler&&a.currentClusterRequestCanceler.resolve(),a.currentClusterRequestCanceler=d.defer(),h.records.geo(a.context,c,a.currentClusterRequestCanceler.promise).success(function(b){var c=b.clusters;a.records=c?c.length:0;for(var d=new L.LayerGroup,e=u(d),f=0;f<c.length;f++){var g=c[f];e(g,b.count.max)}d.addTo(a.map),a.layerGroup&&a.map.removeLayer(a.layerGroup),a.layerGroup=d,a.initialLoading=!1,a.currentClusterRequestCanceler=null})},w=function(){var b={"geofilter.polygon":ODS.GeoFilter.getBoundsAsPolygonParameter(a.map.getBounds()),clusterprecision:a.map.getZoom()};jQuery.extend(b,a.staticSearchOptions,a.context.parameters),b.rows=1e3,a.currentClusterRequestCanceler&&a.currentClusterRequestCanceler.resolve(),a.currentClusterRequestCanceler=d.defer(),h.records.geopreview(a.context,b,a.currentClusterRequestCanceler.promise).success(function(b){for(var c=new L.LayerGroup,d=0;d<b.length;d++)x(c,b[d]);c.addTo(a.map),a.layerGroup&&a.map.removeLayer(a.layerGroup),a.layerGroup=c,a.initialLoading=!1,a.currentClusterRequestCanceler=null})},x=function(a,b){var c={radius:3,fillColor:"#0033ff",color:"#0000ff",weight:1,opacity:1,fillOpacity:.5},d=new L.GeoJSON(b.geometry,{pointToLayer:function(a,b){return L.circleMarker(b,c)}});a.addLayer(d),d.on("click",function(a){s(a.latlng,b.geometry,b.id)})},y=function(a){var b;for(b=0;b<l.ranges.length;b++)if(a<l.ranges[b])return l.colors[b];return l.colors[l.colors.length-1]},z=function(){var b=angular.extend({},l.context.parameters,{"join.geo.remotedataset":a.context.dataset.datasetid,"join.geo.localkey":l.localkey,"join.geo.remotekey":l.remotekey,"y.agg.expr":l.expr,"y.agg.func":l.func}),c=new L.LayerGroup,d=new L.LatLngBounds,e=new L.FeatureGroup;h.records.analyze(l.context,b).success(function(b){angular.forEach(b,function(a){var b=a.x,f=a.agg;angular.forEach(b,function(a){B(a,c,d,e,y(f))})}),a.layerGroup&&a.map.removeLayer(a.layerGroup),c.addLayer(e),c.addTo(a.map),a.layerGroup=c,a.initialLoading=!1})},A=function(){var b={};b["geofilter.polygon"]=ODS.GeoFilter.getBoundsAsPolygonParameter(a.map.getBounds()),jQuery.extend(b,a.staticSearchOptions,a.context.parameters),i.log("map -> download"),h.records.download(a.context,b).success(function(b,c,d,e){a.records=b,a.error="",a.nhits=b.length;for(var f=new L.LayerGroup,g=new L.LatLngBounds,h=new L.FeatureGroup,i=0;i<b.length;i++){var j=b[i];B(j,f,g,h)}a.layerGroup&&a.map.removeLayer(a.layerGroup),f.addLayer(h),f.addTo(a.map),a.layerGroup=f,a.initialLoading=!1}).error(function(b,c,d,e){a.error=b.error,a.initialLoading=!1})},B=function(b,c,d,e,f){var g,h=f;if("value"===a.colorBy){var i=b.fields[l.field];i&&(h=y(i))}if(m){if(!b.fields[m])return;g=b.fields[m],"Point"===g.type&&angular.isDefined(b.geometry)&&(g=b.geometry)}else{if(!b.geometry)return;g=b.geometry}if("Point"==g.type){var j=new L.LatLng(g.coordinates[1],g.coordinates[0]),k=n(j,h);k.on("click",function(a){s(a.target.getLatLng(),g,null,b)}),e.addLayer(k),d.extend(j)}else{var o;o=h?new L.GeoJSON(g,{style:function(a){var b={radius:3,weight:1,opacity:.9,fillOpacity:.5,color:h};return b.fillColor=h,"LineString"===a.geometry.type||"MultiLineString"===a.geometry.type?(b.weight=5,b.color=h):b.color="#fff",b}}):new L.GeoJSON(g),o.on("click",function(a){s(L.latLng(b.geometry.coordinates[1],b.geometry.coordinates[0]),g,b.recordid,b)}),c.addLayer(o),d.extend(o.getBounds())}};a.$watch("context.parameters",function(b,c){return b===c||a.initialLoading?void 0:(i.log("map -> searchOptions watch -> refresh records"),!b["geofilter.polygon"]&&c["geofilter.polygon"]?void(a.mapViewFilter=!1):!c["geofilter.polygon"]&&b["geofilter.polygon"]?void(a.mapViewFilter=!0):void C(a.mapViewFilter?!1:!0))},!0),"aggregation"===a.colorBy&&a.$watch("colorByContext.parameters",function(){a.map&&C(!1)},!0),a.$watch("mapContext.location",function(){a.map&&C(!1)},!0);var C=function(b){var c=200,d=5e5,e=5e5,f=function(b){"aggregation"===a.colorBy?z():"value"===a.colorBy||b.count<c||a.map.getZoom()===a.map.getMaxZoom()?A():b.count<d?b.geometries.Point&&b.geometries.Point>b.count/2?v(b.count<=e):w():v(b.count<=e)},g={without_bbox:!b};b||(g["geofilter.polygon"]=ODS.GeoFilter.getBoundsAsPolygonParameter(a.map.getBounds())),jQuery.extend(g,a.staticSearchOptions,a.context.parameters),h.records.boundingbox(a.context,g).success(function(c){if(b)if(c.bbox.length>0){var d=a.map.getBounds();a.map.fitBounds([[c.bbox[1],c.bbox[0]],[c.bbox[3],c.bbox[2]]]);var e=a.map.getBounds();angular.equals(d,e)&&f(c)}else f(c);else f(c)})},D=function(b){var c=b.getSize();c.x>0&&c.y>0&&(a.mapContext.location=o.getLocationParameterFromMap(b),a.mapViewFilter&&(a.context.parameters["geofilter.polygon"]=ODS.GeoFilter.getBoundsAsPolygonParameter(b.getBounds())))},E=a.$watch("[context.dataset, colorByContext.dataset]",function(b,c){if(b[0]&&b[0].datasetid&&("aggregation"!==a.colorBy||b[1]&&b[1].datasetid)){"aggregation"===a.colorBy?l={context:a.colorByContext,localkey:a.colorByAggregationKey||a.colorByKey,remotekey:a.colorByKey,expr:a.colorByExpression,func:a.colorByFunction,ranges:a.colorByRanges.split(","),colors:a.colorByRangesColors.split(",")}:"value"===a.colorBy&&(l={field:a.colorByField,ranges:a.colorByRanges.split(","),colors:a.colorByRangesColors.split(",")}),b=b[0],a.context.parameters["geofilter.polygon"]?a.mapViewFilter=!0:a.mapViewFilter=!1,a.staticMap="true"===a.isStatic||"true"===a.context.parameters["static"];var e=a.$watch("initMap",function(){a.initMap&&(e(),a.initMap(b,a.embedMode,j.basemaps,g,j.mapGeobox,a.mapContext.basemap,a.staticMap,j.mapPrependAttribution,j.language))});E(),a.staticSearchOptions={rows:a.recordLimit,dataset:a.context.dataset.datasetid,format:"json"};for(var f=0;f<b.fields.length;f++){var k=b.fields[f];if("geo_shape"===k.type){m=k.name;break}}var p={};b.extra_metas&&b.extra_metas.visualization&&(p=b.extra_metas.visualization),a.markerColor=p.map_marker_color||"#29398C",n=function(b,c){return new L.VectorMarker(b,{color:c||a.markerColor,icon:p.map_marker_picto||"icon-circle",marker:!p.map_marker_hidemarkershape})},i.log("map -> dataset watch -> refresh records");var q=a.$watch("map",function(b,c){if(b){a.$watch("mapViewFilter",function(b,c){b!==c&&(b?a.context.parameters["geofilter.polygon"]=ODS.GeoFilter.getBoundsAsPolygonParameter(a.map.getBounds()):a.context.parameters["geofilter.polygon"]&&delete a.context.parameters["geofilter.polygon"])});var e=function(b){var c=d.defer();if(a.context.parameters.mapviewport)"("===a.context.parameters.mapviewport.substring(0,1)&&(a.context.parameters.mapviewport=ODS.GeoFilter.getBoundsAsBboxParameter(ODS.GeoFilter.getPolygonParameterAsBounds(a.context.parameters.mapviewport))),c.resolve(ODS.GeoFilter.getBboxParameterAsBounds(a.context.parameters.mapviewport));else if(a.context.parameters["geofilter.polygon"])c.resolve(ODS.GeoFilter.getPolygonParameterAsBounds(a.context.parameters["geofilter.polygon"]));else{var e={};jQuery.extend(e,a.staticSearchOptions,a.context.parameters),h.records.boundingbox(a.context,e).success(function(a){a.count>0?c.resolve([[a.bbox[1],a.bbox[0]],[a.bbox[3],a.bbox[2]]]):c.resolve([[-60,-180],[80,180]])})}return c.promise},f=function(){var c=d.defer();if(a.mapContext.location){i.log("Location found");var f=o.getCenterFromLocationParameter(a.mapContext.location),g=o.getZoomFromLocationParameter(a.mapContext.location);i.log(f,g),b.setView(f,g),C(!1),c.resolve()}else i.log("Use boundsRetrieval"),e(a.context.dataset).then(function(d){a.context.parameters.mapviewport&&(i.log("Deleted mapviewport"),delete a.context.parameters.mapviewport),i.log(d),b.fitBounds(d),c.resolve()});return c.promise};f().then(function(){i.log("First onViewportMove"),D(a.map),a.map.on("moveend",function(b){D(b.target),a.$$phase||a.$root.$$phase||a.$apply()})}),j.basemaps.length>1&&a.map.on("baselayerchange",function(b){a.mapContext.basemap=b.layer.basemapId,a.$$phase||a.$root.$$phase||a.$apply()}),q()}})}},!0)}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsMap",["URLSynchronizer","MapHelper","ModuleLazyLoader","ODSWidgetsConfig","MapLayerRenderer","translate","$q","$timeout",function(a,b,c,d,e,f,g,h){return{restrict:"EA",scope:{context:"=",syncToUrl:"@",syncToObject:"=",location:"@",basemap:"@",staticMap:"@",noRefit:"@",autoResize:"@",toolbarDrawing:"@",toolbarGeolocation:"@",toolbarFullscreen:"@"},transclude:!0,template:'<div class="odswidget odswidget-map">    <div class="odswidget odswidget-map__map"></div>    <div class="odswidget-overlay map odswidget-overlay--opaque" ng-show="initialLoading">        <ods-spinner></ods-spinner>    </div>    <div class="odswidget-map__loading" ng-show="loading">        <ods-spinner></ods-spinner>    </div>    <div ng-transclude></div></div>',link:function(i,j,k){function l(){var a=$(".odswidget-map__map");if("true"===i.autoResize&&a.length>0){var b=Math.max(200,$(window).height()-a.offset().top);a.height(b)}}var m=angular.element(j.children()[0]);k.id&&m.attr("id",k.id),k.style&&m.attr("style",k.style),k["class"]&&m.addClass(k["class"]);var n=i.staticMap&&"true"===i.staticMap.toLowerCase(),o=i.noRefit&&"true"===i.noRefit.toLowerCase(),p=!(i.toolbarDrawing&&"false"===i.toolbarDrawing.toLowerCase()),q=!(i.toolbarGeolocation&&"false"===i.toolbarGeolocation.toLowerCase()),r=!(i.toolbarFullscreen&&"false"===i.toolbarFullscreen.toLowerCase());if(k.context){var s=b.MapConfiguration.createLayerGroupConfiguration(),t=b.MapConfiguration.createLayerConfiguration();s.activeDatasets.push(t),i.mapConfig.layers.push(s);var u=i.$watch("context",function(a){t.context=a;var b=i.$watch("context.dataset",function(a){a&&(null!==t.context.dataset.getExtraMeta("visualization","map_marker_hidemarkershape")?t.marker=!t.context.dataset.getExtraMeta("visualization","map_marker_hidemarkershape"):t.marker=!0,t.color=t.context.dataset.getExtraMeta("visualization","map_marker_color")||"#C32D1C",t.picto=t.context.dataset.getExtraMeta("visualization","map_marker_picto")||(t.marker?"circle":"dot"),b())});u()})}"true"===i.autoResize&&($(window).on("resize",l),l()),i.initialLoading=!0,i.syncToObject?i.mapContext=i.syncToObject:i.mapContext={},"false"!==i.syncToUrl&&(a.addSynchronizedValue(i,"mapContext.location","location",!0),a.addSynchronizedValue(i,"mapContext.basemap","basemap")),i.location&&(i.mapContext.location=i.mapContext.location||i.location),i.basemap&&(i.mapContext.basemap=i.mapContext.basemap||i.basemap),c("leaflet").then(function(){var a={basemapsList:d.basemaps,worldCopyJump:!0,minZoom:2,basemap:i.mapContext.basemap,dragging:!n,keyboard:!n,prependAttribution:d.mapPrependAttribution,maxBounds:[[-90,-180],[90,180]],zoomControl:!1};n&&(a.doubleClickZoom=!1,a.scrollWheelZoom=!1),l();var c=new L.ODSMap(j.children()[0].children[0],a);if(c.addControl(new L.Control.Scale),n||c.addControl(new L.Control.Zoom({zoomInTitle:f("Zoom in"),zoomOutTitle:f("Zoom out")})),r)try{window.self===window.top&&c.addControl(new L.Control.Fullscreen({title:{"false":f("View Fullscreen"),"true":f("Exit Fullscreen")}}))}catch(k){}if(d.mapGeobox&&!n){var m=L.Control.geocoder({placeholder:f("Find a place..."),errorMessage:f("Nothing found."),geocoder:new L.Control.Geocoder.Nominatim({serviceUrl:"https://nominatim.openstreetmap.org/",geocodingQueryParams:{"accept-language":d.language||"en",polygon_geojson:!0}})});m.markGeocode=function(a){if(c.fitBounds(a.bbox),a.properties.geojson){var b=L.geoJson(a.properties.geojson,{style:function(){return{opacity:0,fillOpacity:.8,fillColor:"orange",className:"leaflet-geocoder-highlight"}}});c.addLayer(b),h(function(){j.addClass("geocoder-highlight-on")},0),h(function(){j.removeClass("geocoder-highlight-on"),c.removeLayer(b)},2500)}},c.addControl(m)}if(q&&!n&&c.addControl(new L.Control.Locate({maxZoom:18,strings:{title:f("Show me where I am"),popup:f("You are within {distance} {unit} from this point"),outsideMapBoundsMsg:f("You seem located outside the boundaries of the map")}})),i.drawnItems=new L.FeatureGroup,c.addLayer(i.drawnItems),p&&!n){L.drawLocal.draw.toolbar.buttons.circle=f("Draw a circle to filter on"),L.drawLocal.draw.toolbar.buttons.polygon=f("Draw a polygon to filter on"),L.drawLocal.draw.toolbar.buttons.rectangle=f("Draw a rectangle to filter on"),L.drawLocal.draw.toolbar.actions={title:f("Cancel area filter"),text:f("Cancel")},L.drawLocal.draw.toolbar.undo={title:f("Delete last point"),text:f("Delete last point")},L.drawLocal.edit.toolbar.buttons={edit:f("Edit area filter."),editDisabled:f("No area filter to edit."),remove:f("Delete area filter."),removeDisabled:f("No area filter to delete.")},L.drawLocal.edit.toolbar.actions={save:{title:f("Save changes."),text:f("Save")},cancel:{title:f("Cancel editing, discards all changes."),text:f("Cancel")}};var s=new L.Control.Draw({edit:{featureGroup:i.drawnItems},draw:{polyline:!1,marker:!1}});c.addControl(s)}i.map=c;var t=function(a){var c=g.defer();if(a){var e=b.getLocationStructure(a);i.map.setView(e.center,e.zoom),v().then(function(){x(!1)}),c.resolve()}else v().then(function(){
b.retrieveBounds(b.MapConfiguration.getActiveContextList(i.mapConfig,!0)).then(function(a){if(a)i.map.fitBounds(a);else{var e=b.getLocationStructure(d.defaultMapLocation);i.map.setView(e.center,e.zoom)}x(!1),c.resolve()})});return c.promise};t(i.mapContext.location).then(function(){i.initialLoading=!1,u(i.map),n||v().then(y),i.map.on("moveend",function(a){i.$apply(function(){u(a.target)})}),i.$watch("mapContext.location",function(a,b){a!==b&&x(!1,!0)}),i.$watch(function(){var a=0;return angular.forEach(i.mapConfig.layers,function(b){angular.forEach(b.activeDatasets,function(b){b.loading&&a++})}),a},function(a){i.loading=!!a}),i.$watch(function(){var a=[];return angular.forEach(b.MapConfiguration.getActiveContextList(i.mapConfig),function(b){a.push(b.parameters)}),a},function(a,b){a!==b&&(w(),x(!0))},!0)}),d.basemaps.length>1&&i.map.on("baselayerchange",function(a){i.$evalAsync('mapContext.basemap = "'+a.layer.basemapId+'"'),angular.forEach(i.mapConfig.layers,function(b){b.displayed&&angular.forEach(b.activeDatasets,function(b){"tiles"===b.clusterMode&&b.rendered&&(b.rendered.setMinZoom(a.layer.options.minZoom),b.rendered.setMaxZoom(a.layer.options.maxZoom))})})});var u=function(a){var c=a.getSize();c.x>0&&c.y>0&&(i.mapContext.location=b.getLocationParameter(a.getCenter(),a.getZoom()))},x=function(a,c){a=!o&&a;var d=function(a){var b=[];angular.forEach(i.mapConfig.layers,function(c){return c.displayed?void angular.forEach(c.activeDatasets,function(c){(!a||e.doesLayerRefreshOnLocationChange(c))&&b.push(e.updateDataLayer(c,i.map))}):void angular.forEach(c.activeDatasets,function(a){a.rendered&&(i.map.removeLayer(a.rendered),a.rendered=null)})}),g.all(b).then(function(){})};a?b.retrieveBounds(b.MapConfiguration.getActiveContextList(i.mapConfig,!0)).then(function(a){a&&a!==b.WORLD_BOUNDS?h(function(){var b=i.map.getBounds().toBBoxString();i.map.fitBounds(a);var c=i.map.getBounds().toBBoxString();b===c&&x(!1,!0)},0):d(c)}):d()},y=function(){i.map.on("draw:drawstart draw:editstart",function(){i.map.isDrawing=!0}),i.map.on("draw:drawstop draw:editstop",function(){i.map.isDrawing=!1});var a=function(a){a._path.setAttribute("style","cursor: pointer; pointer-events: auto;")},c=function(a){a._path.setAttribute("style","cursor: auto; pointer-events: none;")};i.map.on("draw:deletestart",function(){a(i.drawnItems.getLayers()[0])}),i.map.on("draw:deleteend",function(){c(i.drawnItems.getLayers()[0])}),i.map.on("draw:created",function(a){var b=a.layer;i.drawnItems.getLayers().length>0&&i.drawnItems.removeLayer(i.drawnItems.getLayers()[0]),i.drawnItems.addLayer(b),d(b,a.layerType),i.$apply()}),i.map.on("draw:edited",function(a){var b=a.layers.getLayers()[0],c=e(b);d(b,c),i.$apply()}),i.map.on("draw:deleted",function(){delete i.mapConfig.drawnArea,i.$apply()});var d=function(a,b){if("circle"===b){var c=a.getRadius(),d=a.getLatLng();i.mapConfig.drawnArea={shape:"circle",coordinates:d.lat+","+d.lng+","+c}}else{var e=a.toGeoJSON(),f=ODS.GeoFilter.getGeoJSONPolygonAsPolygonParameter(e.geometry);i.mapConfig.drawnArea={shape:"polygon",coordinates:f}}},e=function(a){return angular.isDefined(a.getRadius)?"circle":"polygon"},f={color:"#2ca25f",fillOpacity:.2,opacity:.8,clickable:!0};i.$watch("mapConfig.drawnArea",function(a){i.drawnItems.getLayers().length>0&&i.drawnItems.removeLayer(i.drawnItems.getLayers()[0]);var d;if(a){if("polygon"===a.shape){var e=ODS.GeoFilter.getPolygonParameterAsGeoJSON(a.coordinates),g=e.coordinates[0];g.splice(e.coordinates[0].length-1,1);var h,j,k;for(h=0;h<g.length;h++)j=g[h],k=j[0],j[0]=j[1],j[1]=k;d=4===g.length&&g[0][0]===g[3][0]&&g[1][0]===g[2][0]&&g[0][1]===g[1][1]&&g[2][1]===g[3][1]?new L.Rectangle(g,f):new L.Polygon(g,f)}else if("circle"===a.shape){var l=a.coordinates.split(","),m=l[0],n=l[1],o=l[2];d=new L.Circle([m,n],o,f)}d&&(i.drawnItems.addLayer(d),c(i.drawnItems.getLayers()[0]))}angular.forEach(b.MapConfiguration.getActiveContextList(i.mapConfig,!0),function(b){a?"circle"===a.shape?(b.parameters["geofilter.distance"]=a.coordinates,delete b.parameters["geofilter.polygon"]):"polygon"===a.shape&&(b.parameters["geofilter.polygon"]=a.coordinates,delete b.parameters["geofilter.distance"]):(delete b.parameters["geofilter.polygon"],delete b.parameters["geofilter.distance"])})},!0)}});var v=function(){var a=g.defer(),c=b.MapConfiguration.getActiveContextList(i.mapConfig),d=c.map(function(a){return a.wait()});return g.all(d).then(function(){w(),a.resolve()}),a.promise},w=function(){var a,c;angular.forEach(b.MapConfiguration.getActiveContextList(i.mapConfig,!0),function(b){angular.isUndefined(a)&&angular.isUndefined(a)?(a=b.parameters["geofilter.polygon"],c=b.parameters["geofilter.distance"]):(a!==b.parameters["geofilter.polygon"]&&(a=null),c!==b.parameters["geofilter.distance"]&&(c=null))}),a?i.mapConfig.drawnArea={shape:"polygon",coordinates:a}:c?i.mapConfig.drawnArea={shape:"circle",coordinates:c}:i.mapConfig.drawnArea={}}},controller:["$scope",function(a){a.mapConfig={layers:[]},this.registerLayer=function(c){var d=b.MapConfiguration.createLayerGroupConfiguration();return d.activeDatasets.push(c),a.mapConfig.layers.push(d),d},this.registerLayerGroup=function(b){a.mapConfig.layers.push(b)}}]}}]),a.directive("odsMapLayerGroup",function(){return{restrict:"EA",scope:{},require:"^odsMap",link:function(a,b,c,d){d.registerLayerGroup(a.group)},controller:["$scope",function(a){a.group={activeDatasets:[]},this.registerLayer=function(b){return a.group.activeDatasets.push(b),a.group}}]}}),a.directive("odsMapLayer",["MapHelper",function(a){return{restrict:"EA",scope:{context:"=",showIf:"=",color:"@",borderColor:"@",opacity:"@",colorScale:"@",colorRanges:"@",colorByField:"@",picto:"@",showMarker:"@",display:"@","function":"@",expression:"@",tooltipSort:"@",hoverField:"@",refineOnClickContext:"=",joinContext:"=",localKey:"@",remoteKey:"@"},template:function(a){var b="";return a.contents().wrapAll("<div>"),a.contents().length>0&&a.contents().html().trim().length>0&&(a.contents().wrapAll("<div>"),b=a.children().html()),'<div tooltiptemplate="'+b.replace(/"/g,"&quot;")+'"></div>'},require:["?^odsMapLayerGroup","^odsMap"],link:function(b,c,d,e){var f,g=e[0],h=e[1],i=angular.element(c.children()[0]),j=i.attr("tooltiptemplate");if(b.color)f=b.color;else if(b.colorScale)f={type:"scale",scale:b.colorScale};else if(b.colorRanges){var k=b.colorRanges.split(";"),l=k.filter(function(a,b){return b%2===1}),m=k.filter(function(a,b){return b%2===0});f={type:"range",ranges:l,colors:m,field:b.colorByField}}var n,o={color:f,borderColor:b.borderColor,opacity:b.opacity,picto:b.picto,display:b.display,"function":b["function"],expression:b.expression,localKey:b.localKey,remoteKey:b.remoteKey,tooltipSort:b.tooltipSort,hoverField:b.hoverField},p=a.MapConfiguration.createLayerConfiguration(j,o);n=g?g.registerLayer(p):h.registerLayer(p),d.showIf&&b.$watch("showIf",function(a,b){n.displayed=a});var q=b.$watch("context",function(a){a&&(p.context=a,a.wait().then(function(){b.showMarker?p.marker="true"===b.showMarker.toLowerCase():null!==p.context.dataset.getExtraMeta("visualization","map_marker_hidemarkershape")?p.marker=!p.context.dataset.getExtraMeta("visualization","map_marker_hidemarkershape"):p.marker=!0,p.color=p.color||p.context.dataset.getExtraMeta("visualization","map_marker_color")||"#C32D1C",p.picto=p.picto||p.context.dataset.getExtraMeta("visualization","map_marker_picto")||(p.marker?"circle":"dot")}),q())}),r=b.$watch("joinContext",function(a){a&&(p.joinContext=a,r())}),s=b.$watch("refineOnClickContext",function(a){if(angular.isArray(a)){var b=!0;if(angular.forEach(a,function(a){b=b&&angular.isDefined(a)}),!b)return}else if(!a)return;p.refineOnClick=[];var c=angular.isArray(a)&&a||[a];angular.forEach(c,function(a){var b=!1,c="refineOnClick"+ODS.StringUtils.capitalize(a.name);angular.isDefined(d[c+"ReplaceRefine"])?"false"!==d[c+"ReplaceRefine"]&&(b=!0):angular.isDefined(d.refineOnClickReplaceRefine)&&"false"!==d.refineOnClickReplaceRefine&&(b=!0),p.refineOnClick.push({context:a,mapField:d[c+"MapField"]||d.refineOnClickMapField,contextField:d[c+"ContextField"]||d.refineOnClickContextField,replaceRefine:b}),s()})})},controller:["$scope",function(a){}]}}]),a.directive("odsMapTooltip",["$compile","$templateCache",function(a,b){return{restrict:"E",transclude:!0,template:'<div class="odswidget-map-tooltip">   <ods-spinner class="odswidget-map-tooltip__spinner" ng-hide="records"></ods-spinner>   <h2 ng-show="records.length > 1" class="odswidget-map-tooltip__scroll-control ng-leaflet-tooltip-cloak">       <i class="odswidget-map-tooltip__scroll-left fa fa-chevron-left" ng-click="moveIndex(-1)"></i>       <span ng-bind="(selectedIndex+1)+\'/\'+records.length" ng-click="moveIndex(1)"></span>       <i class="odswidget-map-tooltip__scroll-right fa fa-chevron-right" ng-click="moveIndex(1)"></i>   </h2>   <div class="ng-leaflet-tooltip-cloak odswidget-map-tooltip__limited-results-warning" ng-show="records && records.length == RECORD_LIMIT" translate>      (limited to the first {{RECORD_LIMIT}} records)   </div>   <div ng-repeat="record in records" ng-show="$index == selectedIndex" class="odswidget-map-tooltip__record">       <div ng-if="!template" ng-include src="\'default-tooltip\'"></div>       <div ng-if="template" ng-include src="\'custom-tooltip-\'+context.dataset.datasetid"></div>   </div></div>',scope:{shape:"=",context:"=",recordid:"=",map:"=",template:"@",gridData:"=",geoDigest:"@",tooltipSort:"@"},replace:!0,link:function(a,c,d){var e=function(b){b.popup._content===c[0]&&(a.selectedShapeLayer&&a.map.removeLayer(a.selectedShapeLayer),a.map.off("popupclose",e),a.$destroy())};a.map.on("popupclose",e),a.unCloak=function(){jQuery(".ng-leaflet-tooltip-cloak",c).removeClass("ng-leaflet-tooltip-cloak")},d.template&&""!==d.template?b.put("custom-tooltip-"+a.context.dataset.datasetid,d.template):b.put("default-tooltip",'<div class="infoPaneLayout"><h2 class="odswidget-map-tooltip__header" ng-show="!!getTitle(record)" ng-bind="getTitle(record)"></h2><dl class="odswidget-map-tooltip__record-values">    <dt ng-repeat-start="field in context.dataset.fields|fieldsForVisualization:\'map\'|fieldsFilter:context.dataset.extra_metas.visualization.map_tooltip_fields"         ng-show="record.fields[field.name]|isDefined"        class="odswidget-map-tooltip__field-name">        {{ field.label }}    </dt>    <dd ng-repeat-end         ng-switch="field.type"         ng-show="record.fields[field.name]|isDefined"        class="odswidget-map-tooltip__field-value">        <span ng-switch-when="geo_point_2d">            <ods-geotooltip width="300" height="300" coords="record.fields[field.name]">{{ record.fields|formatFieldValue:field }}</ods-geotooltip>        </span>        <span ng-switch-when="geo_shape">            <ods-geotooltip width="300" height="300" geojson="record.fields[field.name]">{{ record.fields|formatFieldValue:field }}</ods-geotooltip>        </span>        <span ng-switch-when="file">            <div ng-if="!context.dataset.isFieldAnnotated(field, \'has_thumbnails\')" ng-bind-html="record.fields|formatFieldValue:field"></div>            <div ng-if="context.dataset.isFieldAnnotated(field, \'has_thumbnails\')" ng-bind-html="record.fields[field.name]|displayImageValue:context.dataset.datasetid" style="text-align: center;"></div>        </span>        <span ng-switch-default title="{{record.fields|formatFieldValue:field}}" ng-bind-html="record.fields|formatFieldValue:field|imagify|videoify|prettyText|nofollow"></span>    </dd></dl></div>')},controller:["$scope","$filter","ODSAPI",function(a,b,c){a.RECORD_LIMIT=100,a.records=[],a.selectedIndex=0;var d=a.tooltipSort;!d&&a.context.dataset.getExtraMeta("visualization","map_tooltip_sort_field")&&(d=(a.context.dataset.getExtraMeta("visualization","map_tooltip_sort_direction")||"")+a.context.dataset.getExtraMeta("visualization","map_tooltip_sort_field")),a.moveIndex=function(b){var c=(a.selectedIndex+b)%a.records.length;0>c&&(c=a.records.length+c),a.selectedIndex=c};var e=function(){function b(b){if(b.length>0){a.selectedIndex=0,a.records=b,a.unCloak();var c,d=a.context.dataset.getFieldsForType("geo_shape");if(d.length&&(c=d[0].name),c&&a.gridData&&("Polygon"===a.gridData["ods:geo_type"]||"LineString"===a.gridData["ods:geo_type"]||"MultiPolygon"===a.gridData["ods:geo_type"]||"MultiLineString"===a.gridData["ods:geo_type"])){var e=b[0];if(e.fields[c]){var f=e.fields[c];"Point"!==f.type&&(a.selectedShapeLayer=L.geoJson(f,{fill:!1,color:"#CC0000",opacity:1,dashArray:[5],weight:2}),a.map.addLayer(a.selectedShapeLayer))}}}else a.map.closePopup()}var e={format:"json",rows:a.RECORD_LIMIT},f=null;a.shape&&(f=a.shape.type),a.recordid&&"Point"!==f?e.q="recordid:'"+a.recordid+"'":a.geoDigest?e.geo_digest=a.geoDigest:a.gridData?null!==a.gridData["ods:geo_grid"]?e.geo_grid=a.gridData["ods:geo_grid"]:e.geo_digest=a.gridData["ods:geo_digest"]:a.shape&&ODS.GeoFilter.addGeoFilterFromSpatialObject(e,a.shape);var g={};angular.extend(g,a.context.parameters,e),d?(g.sort=d,c.records.search(a.context,g).success(function(a){b(a.records)})):c.records.download(a.context,g).success(b)};a.$watch("searchOptions",function(){e()}),a.$apply(),a.getTitle=function(b){if(a.context.dataset.extra_metas&&a.context.dataset.extra_metas.visualization&&a.context.dataset.extra_metas.visualization.map_tooltip_title){var c=a.context.dataset.extra_metas.visualization.map_tooltip_title;if(angular.isDefined(b.fields[c])&&""!==b.fields[c])return b.fields[c]}return null}}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsMostPopularDatasets",["ODSAPI",function(a){return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-most-popular-datasets"><ul>   <li class="no-data" ng-hide="datasets" translate>No data available yet</li>   <li ng-repeat="dataset in datasets" ng-if="datasets">       <ods-theme-picto theme="{{dataset.metas.theme|firstValue}}"></ods-theme-picto>       <div class="dataset-details">           <div class="title"><a ng-href="{{context.domainUrl}}/explore/dataset/{{dataset.datasetid}}/" target="_self">{{ dataset.metas.title }}</a></div>           <div class="count"><i class="icon-download-alt"></i> {{ dataset.extra_metas.explore.download_count }} '+"<span ng-pluralize count=\"dataset.extra_metas.explore.download_count\" translate=\"when\" when=\"{'0': 'download', '1': 'download', 'other': 'downloads'}\"></span></div>       </div>   </li></ul></div>",scope:{context:"="},controller:["$scope",function(b){var c=function(){a.datasets.search(b.context,{rows:5,sort:"explore.download_count",extrametas:!0}).success(function(a){b.datasets=a.datasets})};b.$watch("context",function(){c()})}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsMostUsedThemes",["ODSAPI",function(a){return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-most-used-themes"><ul>   <li class="no-data" ng-hide="themes" translate>No data available yet</li>   <li ng-repeat="theme in themes" ng-if="themes">       <div class="dataset-details">           <div class="name"><a ng-href="{{ context.domainUrl }}/explore/?refine.theme={{ theme.path }}" target="_self">{{ theme.name }}</a></div>           <div class="count"><i class="icon-table"></i> <span translate>Used by</span> {{ theme.count }} '+"<span ng-pluralize count=\"theme.count\" translate=\"when\" when=\"{'0': 'dataset', '1': 'dataset', 'other': 'datasets'}\"></span></div>       </div>   </li></ul></div>",scope:{context:"="},controller:["$scope",function(b){var c=function(){a.datasets.facets(b.context,"theme").success(function(a){a.facet_groups&&(b.themes=a.facet_groups[0].facets.slice(0,5))})};b.$watch("context",function(){c()})}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsPaginationBlock",["$location",function(a){return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-pagination" ng-show="pages.length > 1">    <ul class="odswidget-pagination__page-list">        <li class="odswidget-pagination__page" ng-repeat="page in pages">            <a class="odswidget-pagination__page-link"                ng-class="{\'odswidget-pagination__page-link--active\': page.start == (context.parameters.start||0)}"                ng-attr-rel="{{nofollow?\'nofollow\':\'\'}}"               ng-click="click($event, page.start)"                href="?start={{ page.start }}"                rel="nofollow">{{ page.label }}</a>        </li>    </ul></div>',scope:{context:"=",perPage:"@",nofollow:"@"},controller:["$scope","$anchorScroll",function(b,c){b.location=a,b.pages=[],b.perPage=b.perPage||10,b.click=function(a,c){a.preventDefault(),b.context.parameters.start=c};var d=function(){if(0===b.context.nhits)return void(b.pages=[]);var a,c=Math.max(1,Math.floor((b.context.nhits-1)/b.perPage)+1),d=[];if(8>=c)for(a=1;c>=a;a++)d.push({label:a,start:(a-1)*b.perPage});else{var e;if(e=b.context.parameters.start?Math.floor(b.context.parameters.start/b.perPage)+1:1,5>=e){for(a=1;8>=a;a++)d.push({label:a,start:(a-1)*b.perPage});d.push({label:">>",start:(c-1)*b.perPage})}else if(e>=c-4)for(d.push({label:"<<",start:0}),a=c-7;c>=a;a++)d.push({label:a,start:(a-1)*b.perPage});else{for(d.push({label:"<<",start:0}),a=e-3;e+3>=a;a++)d.push({label:a,start:(a-1)*b.perPage});d.push({label:">>",start:(c-1)*b.perPage})}}b.pages=d},e=b.$watch("context",function(a,f){a&&(b.$watch("context.nhits",function(a,c){void 0!==b.context.nhits&&b.perPage&&d()}),b.$watch("perPage",function(a,c){b.context.nhits&&b.perPage&&d()}),b.$watch("context.parameters.start",function(a,e){b.context.nhits&&b.perPage&&d(),c()}),e())})}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsPicto",["SVGInliner","$http","$document",function(a,b,c){return{restrict:"E",replace:!0,scope:{url:"=",color:"=",classes:"="},template:'<div class="odswidget odswidget-picto {{ classes }}"></div>',link:function(b,c){var d;b.$watch("[url, color]",function(e){if(e[0]){if(Modernizr&&!Modernizr.svg)return;d&&c.empty(),d=a.getElement(b.url,b.color),b.color||d.addClass("colorless"),c.append(d)}},!0)}}}]),a.directive("odsThemePicto",["ODSWidgetsConfig","$compile",function(a,b){return{restrict:"E",replace:!0,scope:{theme:"@"},template:"",link:function(c,d){c.originalClasses=d.attr("class").replace("ng-isolate-scope","").trim();var e='<ods-picto url="themeConfig.img" color="themeConfig.color" classes="originalClasses + \' odswidget-theme-picto theme-\' + (getTheme()|themeSlug) "></ods-picto>',f=!1;a.themes[c.theme]?c.themeConfig=a.themes[c.theme]:(c.themeConfig=a.themes["default"],f=!0),c.getTheme=function(){return f?"default":c.theme},c.themeConfig&&d.replaceWith(angular.element(b(e)(c)))}}}]),a.directive("odsMapPicto",["ODSWidgetsConfig","PictoHelper","$compile",function(a,b,c){return{restrict:"E",replace:!0,scope:{name:"@",color:"@"},template:"",link:function(a,d){a.originalClasses=d.attr("class").replace("ng-isolate-scope","").trim();var e='<ods-picto url="pictoUrl" color="color" classes="originalClasses + \' odswidget-map-picto\'"></ods-picto>';a.$watch("[name, color]",function(){a.pictoUrl=b.mapPictoToURL(a.name),a.pictoUrl&&d.replaceWith(angular.element(c(e)(a)))},!0)}}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsResultEnumerator",["ODSAPI",function(a){return{restrict:"E",replace:!0,transclude:!0,scope:{context:"=",max:"@?",showHitsCounter:"@?",showPagination:"@?"},template:'<div class="odswidget odswidget-result-enumerator"><div ods-results="items" ods-results-context="context" ods-results-max="{{maxHits}}"><div ng-if="loading"><ods-spinner class="odswidget-spinner--large"></ods-spinner></div><div ng-if="!loading && !items.length" class="odswidget-result-enumerator__no-results-message" translate>No results</div><div ng-if="!loading && items.length && hitsCounter" class="odswidget-result-enumerator__results-count">{{context.nhits}} <span translate>results</span></div><div ng-repeat="item in items" inject class="odswidget-result-enumerator__item"></div></div><ods-pagination-block ng-if="pagination" context="context" per-page="{{maxHits}}"></ods-pagination-block></div>',controller:["$scope",function(a){a.maxHits=a.max||10,a.hitsCounter=angular.isString(a.showHitsCounter)&&"true"===a.showHitsCounter.toLowerCase(),a.pagination=angular.isString(a.showPagination)&&"true"===a.showPagination.toLowerCase()}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsResults",["ODSAPI",function(a){return{restrict:"A",scope:!0,priority:1001,controller:["$scope","$attrs",function(b,c){b.$watch(c.odsResultsContext,function(d){var e=angular.extend({},d.parameters,{rows:c.odsResultsMax}),f=c.odsResults||"results";b.loading=!0,"catalog"===d.type?(angular.extend(e,{extrametas:"true",interopmetas:"true"}),a.datasets.search(d,e).success(function(a){b[f]=a.datasets,d.nhits=a.nhits,b.loading=!1}).error(function(){b.loading=!1})):"dataset"===d.type&&d.dataset&&a.records.search(d,e).success(function(a){b[f]=a.records,d.nhits=a.nhits,b.loading=!1}).error(function(){b.loading=!1})},!0)}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsReuses",["ODSAPI",function(a){return{restrict:"E",replace:!0,transclude:!0,template:'<div class="odswidget odswidget-reuses">  <div infinite-scroll="loadMore()" infinite-scroll-distance="1">      <div class="odswidget-reuses__reuse" ng-repeat="reuse in reuses" ods-full-click inject>          <h2 class="odswidget-reuses__reuse-title">{{ reuse.title }}             <a href="/explore/dataset/{{ reuse.dataset.id }}/?tab=metas" class="odswidget-reuses__reuse-dataset-link" target="_self"><span translate>From dataset:</span> {{ reuse.dataset.title }}</a>          </h2>          <div class="odswidget-reuses__reuse-infos">              <div class="odswidget-reuses__reuse-thumbnail" ng-class="{\'odswidget-reuses__reuse-thumbnail--no-thumbnail\': !reuse.thumbnail}">                  <a ng-show="reuse.thumbnail" href="{{ reuse.url }}" ods-main-click title="{{ reuse.title }}" target="_blank"><img class="odswidget-reuses__reuse-thumbnail-image" ng-src="{{ reuse.thumbnail }}" /></a>                  <i ng-hide="reuse.thumbnail" class="fa fa-ban odswidget-reuses__reuse-thumbnail-image--no-thumbnail"></i>              </div>              <div class="odswidget-reuses__reuse-description" ng-bind-html="reuse.description|prettyText|safenewlines"></div>          </div>          <div class="odswidget-reuses__reuse-author">              <strong ng-if="reuse.user.first_name || reuse.user.last_name">{{ reuse.user.first_name }} {{ reuse.user.last_name }}</strong>              <strong ng-if="!reuse.user.first_name && !reuse.user.last_name">{{ reuse.user.username }}</strong>              <i class="fa fa-calendar odswidget-reuses__creation-icon"></i> {{ reuse.created_at|moment:\'LLL\' }}          </div>      </div> </div></div>',scope:{context:"="},controller:["$scope",function(b){var c=!1,d=!1,e=0,f=1,g=20;b.reuses=[],b.loadMore=function(){if(b.reuses.length&&!c&&!d){d=!0;var h=f*g;a.reuses(b.context,{rows:g,start:h}).success(function(a){b.reuses=b.reuses.concat(a.reuses),c=(f+1)*g>=e,f++,d=!1}).error(function(){d=!1})}};var h=function(){d=!0,a.reuses(b.context,{rows:g}).success(function(a){b.reuses=a.reuses,c=g>=a.nhits,e=a.nhits,d=!1}).error(function(a){d=!1})};b.$watch("context",function(){h()})}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsSearchbox",function(){return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-searchbox"><form method="GET" action="{{ actionUrl }}" ng-if="actionUrl"><input class="odswidget-searchbox__box" name="q" type="text" placeholder="{{placeholder|translate}}"></form></div>',scope:{placeholder:"@",context:"="},controller:["$scope","$sce",function(a,b){a.actionUrl="/explore/";var c=a.$watch("context",function(d){d&&(a.actionUrl=b.trustAsResourceUrl(a.context.domainUrl+a.actionUrl),c())})}]}})}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsSocialButtons",[function(){return{restrict:"E",scope:{addthisPubid:"@",buttons:"@?"},replace:!0,template:'<div class="odswidget-social-buttons"      ng-init="displayButtons=false"     ng-mouseenter="displayButtons=true" ng-mouseleave="displayButtons=false">    <div class="odswidget-social-buttons__header">        <span translate>Share</span>        <i class="fa fa-angle-down"></i>    </div>    <div class="odswidget-social-buttons__buttons"          ng-class="{\'odswidget-social-buttons__buttons--open\': displayButtons}">        <div class="addthis_toolbox addthis_counter_style">            <a ng-if="selectedButtons.indexOf(\'facebook\') > -1"                class="addthis_button_facebook_like" fb:like:layout="box_count"></a>            <a ng-if="selectedButtons.indexOf(\'twitter\') > -1"                class="addthis_button_tweet" tw:count="vertical"></a>            <a ng-if="selectedButtons.indexOf(\'google-plus\') > -1"                class="addthis_button_google_plusone" g:plusone:size="tall"></a>        </div>    </div>    <script type="text/javascript">        var addthis_config = addthis_config || {};        addthis_config.pubid = "{{ addthisPubid }}";    </script>    <script type="text/javascript" src=""></script></div>',link:function(a){var b=["google-plus","facebook","twitter"];if(a.selectedButtons=b,angular.isDefined(a.buttons)){var c=a.buttons.split(",").map(function(a){return a.trim()});a.selectedButtons=[],angular.forEach(c,function(c){b.indexOf(c)>-1&&a.selectedButtons.push(c)})}var d=document.createElement("script");d.type="text/javascript",d.async=!0,d.src="//s7.addthis.com/js/300/addthis_widget.js#domready=1",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(d)}}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsSpinner",["ODSWidgetsConfig",function(a){return{restrict:"E",replace:!0,template:function(){return Modernizr&&Modernizr.cssanimations&&Modernizr.svg?'<img src="'+a.basePath+'src/img/spinner.gif"      class="odswidget-spinner odswidget-spinner--gif"/>':'<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" version="1.1"     class="odswidget-spinner odswidget-spinner--svg">    <rect x="0" y="0" width="30" height="30" class="odswidget-spinner__cell-11"></rect>    <rect x="35" y="0" width="30" height="30" class="odswidget-spinner__cell-12"></rect>    <rect x="70" y="0" width="30" height="30" class="odswidget-spinner__cell-13"></rect>    <rect x="0" y="35" width="30" height="30" class="odswidget-spinner__cell-21"></rect>    <rect x="35" y="35" width="30" height="30" class="odswidget-spinner__cell-22"></rect>    <rect x="70" y="35" width="30" height="30" class="odswidget-spinner__cell-23"></rect>    <rect x="0" y="70" width="30" height="30" class="odswidget-spinner__cell-31"></rect>    <rect x="35" y="70" width="30" height="30" class="odswidget-spinner__cell-32"></rect>    <rect x="70" y="70" width="30" height="30" class="odswidget-spinner__cell-33"></rect></svg>'}}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsTable",["ODSWidgetsConfig","$sce",function(a,b){return{restrict:"E",scope:{context:"=",displayedFields:"@",sort:"@",datasetFeedback:"@"},replace:!0,transclude:!0,template:'<div class="records records-table odswidget odswidget-table"> <div class="odswidget-table__header" ng-show="records.length">     <table class="odswidget-table__internal-table">         <thead class="odswidget-table__internal-header-table-header">         <tr>             <th class="odswidget-table__header-cell odswidget-table__header-cell--spinner"><div class="odswidget-table__cell-container"><ods-spinner ng-show="fetching" class="odswidget-spinner--large"></ods-spinner></div></th>             <th class="odswidget-table__header-cell" ng-repeat="field in context.dataset.fields|fieldsForVisualization:\'table\'|fieldsFilter:displayedFieldsArray"                 title="{{ field.description }}"                 ng-click="toggleSort(field)"                 >                 <div class="odswidget-table__header-cell-container">                     <span ng-bind="field.label"></span>                     <div ng-class="{\'odswidget-table__sort-icons\': true, \'odswidget-table__sort-icons--active\': field.name == context.parameters.sort || \'-\'+field.name == context.parameters.sort}" ng-show="isFieldSortable(field)">                         <i class="fa fa-chevron-up odswidget-table__sort-icons__up" ng-hide="isAscendingSorted(field)"></i>                         <i class="fa fa-chevron-down odswidget-table__sort-icons__down" ng-hide="isDescendingSorted(field)"></i>                     </div>                 </div>             </th>         </tr>         </thead>     </table> </div> <div class="odswidget-table__records">     <table class="odswidget-table__internal-table" infinite-scroll="loadMore()" infinite-scroll-distance="1" infinite-scroll-disabled="fetching">         <thead class="odswidget-table__internal-table-header">             <tr>                 <th class="odswidget-table__header-cell odswidget-table__header-cell--spinner"><div class="odswidget-table__cell-container"><ods-spinner ng-show="fetching" class="odswidget-spinner--large"></ods-spinner></div></th>                 <th class="odswidget-table__header-cell" ng-repeat="field in context.dataset.fields|fieldsForVisualization:\'table\'|fieldsFilter:displayedFieldsArray"                     title="{{ field.name }}">                     <div class="odswidget-table__cell-container">                         <span ng-bind="field.label"></span>                         <div class="odswidget-table__sort-icons" ng-show="isFieldSortable(field)">                             <i class="fa fa-chevron-up odswidget-table__sort-icons__up"></i>                             <i class="fa fa-chevron-down odswidget-table__sort-icons__down"></i>                         </div>                     </div>                 </th>             </tr>         </thead>         <tbody class="odswidget-table__records-tbody">         </tbody>     </table> </div> <div ng-if="displayDatasetFeedback" class="table-feedback-new"><a ods-dataset-feedback ods-dataset-feedback-dataset="context.dataset"><i class="icon-comment"></i> <span translate>Suggest a new record</span></a></div> <div class="odswidget-overlay" ng-hide="fetching || records"><span class="odswidget-overlay__message" translate>No results</span></div> <div class="odswidget-overlay" ng-hide="(!fetching || records) && !working"><ods-spinner></ods-spinner></div></div>',controller:["$scope","$element","$timeout","$document","$window","ODSAPI","DebugLogger","$filter","$http","$compile","$transclude","$q",function(a,b,c,d,e,f,g,h,i,j,k,l){a.displayedFieldsArray=null,a.displayDatasetFeedback=!1,a.page=0,a.resultsPerPage=40,a.fetching=!1,a.records=[],a.working=!0,a.layout=[],a.done=!1;var m,n,o=b.find(".odswidget-table__header"),p=b.find(".odswidget-table__records-tbody"),q=o.offset().left,r=0,s=0,t=!1,u=0,v=0,w=100,x=0,y=0,z=Math.random().toString(36).substring(7),A="table-"+z,B="stylesheet-"+z,C=[],D=function(b){a.fetching=!0;var c,d={};if(b?(a.done=!1,a.page=0,a.records=[],c=0,C.length&&(C.forEach(function(a){a.resolve()}),C.splice(0,C.length))):(a.page++,c=a.page*a.resultsPerPage),jQuery.extend(d,a.staticSearchOptions,a.context.parameters,{start:c}),a.displayedFieldsArray&&a.context.dataset.fields.length>a.displayedFieldsArray.length&&jQuery.extend(d,{fields:a.displayedFieldsArray.join(",")}),d.sort){var e=d.sort.replace("-","");a.context.dataset.getField(e)||delete d.sort}var g=l.defer();C.push(g),f.records.search(a.context,d,g.promise).success(function(c,d,e,f){c.records.length||(a.working=!1),a.records=b?c.records:a.records.concat(c.records),a.nhits=c.nhits,a.error="",a.fetching=!1,a.done=(a.page+1)*a.resultsPerPage>=c.nhits,C.splice(C.indexOf(g),1)}).error(function(b,c,d,e){b&&(a.error=b.error),C.splice(C.indexOf(g),1),
a.fetching=!1})};a.loadMore=function(){a.fetching||a.done||!a.staticSearchOptions||D(!1)},a.isFieldSortable=function(a){return ODS.DatasetUtils.isFieldSortable(a)},a.isAscendingSorted=function(b){return"text"===b.type?b.name===a.context.parameters.sort:"-"+b.name===a.context.parameters.sort},a.isDescendingSorted=function(b){return"text"===b.type?"-"+b.name===a.context.parameters.sort:b.name===a.context.parameters.sort},a.toggleSort=function(b){if(a.isFieldSortable(b)){if(a.context.parameters.sort==b.name)return void(a.context.parameters.sort="-"+b.name);if(a.context.parameters.sort=="-"+b.name)return void(a.context.parameters.sort=b.name);a.context.parameters.sort="text"===b.type?b.name:"-"+b.name}else delete a.context.parameters.sort};var E=!1;k(function(a){a.contents().wrapAll("<div>"),E=a.contents().length>0&&a.contents().html().trim().length>0});var F=function(c,d,e){var f,g,i=d[c];if(f=document.createElement("tr"),f.className="odswidget-table__internal-table-row record-"+c,"end"===e){var l=b.find(".js-placeholder-bottom")[0];l.parentNode.insertBefore(f,l)}else{var n=b.find(".js-placeholder-top")[0];n.parentNode.insertBefore(f,n.nextSibling)}g=document.createElement("td"),g.className="odswidget-table__cell";var o=document.createElement("div");if(o.className="odswidget-table__cell-container",a.displayDatasetFeedback){var p='<i class="fa fa-comment table-feedback-icon" ods-dataset-feedback ods-dataset-feedback-record="record" ods-dataset-feedback-dataset="dataset" ods-tooltip="Suggest changes for this record" translate="ods-tooltip"></i>',q=a.$new(!0);q.record=i,q.dataset=a.context.dataset,o.appendChild(j(p)(q)[0])}o.appendChild(document.createTextNode(c+1)),g.appendChild(o),f.appendChild(g);for(var r=0;r<m.length;r++){var s=m[r],t=h("formatFieldValue")(i.fields,s);g=document.createElement("td"),g.className="odswidget-table__cell",f.appendChild(g),o=document.createElement("div"),o.className="odswidget-table__cell-container",g.appendChild(o);var u,v;E?(u=a.$new(!0),u.record=i,u.currentField=s.name,u.currentValue=i.fields[s.name],u.currentFormattedValue=t,v=j("<div inject></div>",k)(u)[0]):(u=a.$new(!1),u.recordFields=i.fields[s.name],s&&"geo_point_2d"===s.type?(u.fieldValue=t,window.ie8?(v=document.createElement("span"),v.title=t,v.innerHTML=t):v=j('<ods-geotooltip width="300" height="300" coords="recordFields">'+t+"</ods-geotooltip>")(u)[0]):s&&"geo_shape"===s.type?(u.fieldValue=h("truncate")(t),window.ie8?(v=document.createElement("span"),v.title=t,v.innerHTML=t):v=j('<ods-geotooltip width="300" height="300" geojson="recordFields">'+t+"</ods-geotooltip>")(u)[0]):s&&"file"===s.type?(v=document.createElement("span"),v.title=i.fields[s.name]?i.fields[s.name].filename:"",v.innerHTML=h("nofollow")(h("prettyText")(t))):(v=document.createElement("span"),v.title=t,v.innerHTML=h("nofollow")(h("prettyText")(t)))),o.appendChild(v)}return f},G=function(a){var c=b[0].getElementsByClassName("record-"+a)[0];c&&c.parentNode.removeChild(c)},H=function(a){var b;return angular.forEach(a.classList,function(a){a.startsWith("record-")&&(b=parseInt(a.substr(7),10))}),b},I=function(){var c=b.find(".odswidget-table__records")[0].offsetHeight,d=b.find(".odswidget-table__records")[0].scrollTop,e=p.find("tr").eq(1).height(),f=b.find(".js-placeholder-top")[0],g=b.find(".js-placeholder-bottom")[0];e?(x=Math.max(Math.floor((d-w*e)/e),0),y=Math.min(Math.ceil((d+c+w*e)/e),a.records.length)):(x=0,y=a.records.length),x=x&&x%2?x+1:x;var h=x-u>0||y-v>0;if(x!==u||y!==v){var i,j,k,l,m,n;if(f||(i=document.createElement("tr"),i.className="js-placeholder-top",i.style.height="0px",p[0].appendChild(i),f=b.find(".js-placeholder-top")[0]),g||(i=document.createElement("tr"),i.className="js-placeholder-bottom",i.style.height="0px",p[0].appendChild(i),g=b.find(".js-placeholder-bottom")[0]),!a.layout.length&&a.records.length){var o=Math.min(a.records.length,a.resultsPerPage);for(m=0;o>m;m++)F(m,a.records,"end")}else if(h){for(m=0;x>m;m++)G(m);f.style.height=x*e+"px",j=b[0].getElementsByTagName("tbody")[0].getElementsByTagName("tr"),k=j.length>2;var q=k?H(j[j.length-2]):x;for(l=0,m=q+1;y>m;m++)F(m,a.records,"end"),l++;n=k?$(g).height()-l*e:(a.records.length-y)*e,n=n>0?n:0,g.style.height=n+"px"}else{for(l=0,m=y+1;m<a.records.length;m++)G(m),l++;var r=a.records.length-(y+1);r=r>=0?r:0,g.style.height=r*e+"px",j=b[0].getElementsByTagName("tbody")[0].getElementsByTagName("tr"),k=j.length>2;var s=k?H(j[1]):y;for(l=0,m=s-1;m>=x;m--)F(m,a.records,"begin"),l++;n=k?$(f).height()-l*e:x*e,n=n>0?n:0,f.style.height=n+"px"}u=x,v=y}};a.$watch("records",function(c,d){c!==d&&(I(),a.computeLayout(),n||(n=b.find("[infinite-scroll]")),b.height()>n.height()&&a.loadMore())}),a.context.wait().then(function(){if(a.displayedFields?a.displayedFieldsArray=a.displayedFields.split(",").map(function(a){return a.trim()}):a.context.dataset.extra_metas&&a.context.dataset.extra_metas.visualization&&angular.isArray(a.context.dataset.extra_metas.visualization.table_fields)&&a.context.dataset.extra_metas.visualization.table_fields.length>0?a.displayedFieldsArray=a.context.dataset.extra_metas.visualization.table_fields:a.displayedFieldsArray=null,!a.context.parameters.sort&&a.context.dataset.extra_metas&&a.context.dataset.extra_metas.visualization&&a.context.dataset.extra_metas.visualization.table_default_sort_field){var b=a.context.dataset.extra_metas.visualization.table_default_sort_field;"-"===a.context.dataset.extra_metas.visualization.table_default_sort_direction&&(b="-"+b),a.context.parameters.sort=b}a.displayDatasetFeedback="true"===a.datasetFeedback&&a.context.dataset.getExtraMeta("explore","feedback_enabled"),a.staticSearchOptions={rows:a.resultsPerPage},g.log("table -> dataset watch -> refresh records");var c=h("fieldsForVisualization")(a.context.dataset.fields,"table");m=h("fieldsFilter")(c,a.displayedFieldsArray),D(!0)}),a.$watch("context.parameters",function(c,d){c!==d&&(g.log("table -> searchOptions watch -> refresh records"),a.layout=[],a.working=!0,s=b.find(".odswidget-table__records")[0].scrollLeft,t=!0,p.empty(),D(!0))},!0);var J=function(){b.find(".odswidget-table__records").scrollLeft(0),o.css({left:"auto"}),q=b.find(".odswidget-table__header").offset().left};$(window).on("resize",function(){c(function(){J(),a.layout=[],a.computeLayout()},0)});var K=0;b.find(".odswidget-table__records").on("scroll",function(){if(this.scrollLeft!==r)o.offset({left:q-this.scrollLeft}),r=this.scrollLeft;else{t=!1;var a=Math.max(Math.floor(b.find(".odswidget-table__records")[0].scrollTop/p.find("tr").eq(1).height()),0);if(Math.abs(a-K)<w&&a>x)return;K=a,I()}});var L=function(b,c){for(var d="",e=0;e<a.layout.length;e++){var f=e+1,g=c?"max-width: none; ":"";d+="#"+b+" .odswidget-table__header tr th:nth-child("+f+") > div, #"+b+" .odswidget-table__records tr td:nth-child("+f+") > div { width: "+a.layout[e]+"px; "+g+"} "}return d};a.computeLayout=function(){var d,e=b.find(".odswidget-table__internal-table-row"),f=22;if(!a.layout.length&&a.records.length){b.attr("id")||b.attr("id",A),b.hasClass("odswidget-table--embedded")?(d=$(window).height()-b.offset().top,b.height(d)):d=b.height();var g=0;a.displayDatasetFeedback&&(g=b.find(".table-feedback-new").height()+5),b.find(".odswidget-table__records").height(d-25-g);var h=p.find("tr").eq(1).height(),i=(e.length-2)*h,j=document.getElementById(B);j&&j.parentNode&&j.parentNode.removeChild(j),b.find(".odswidget-table__internal-header-table-header").hide(),b.find(".odswidget-table__internal-table-header").show();var k=0;angular.forEach(b.find(".odswidget-table__internal-table-header .odswidget-table__cell-container"),function(b,c){a.layout[c]=$(b).width()+8,k+=a.layout[c]}),a.layout[0]=30;var l=b.find(".odswidget-table__internal-table").width(),m=k+f*a.layout.length<b.width();if(m){for(var n=Math.floor(l/a.layout.length),q=l-n*a.layout.length,r=1;r<a.layout.length;r++)a.layout[r]=n-f;a.layout[a.layout.length-1]+=q,i>500?b.find(".odswidget-table__internal-header-table").width(l):b.find(".odswidget-table__internal-header-table").width("")}var u=document.createElement("style"),v=L(A,m);u.id=B,u.type="text/css",u.styleSheet?u.styleSheet.cssText=v:u.appendChild(document.createTextNode(v)),b[0].appendChild(u),b.find(".odswidget-table__internal-table-header").hide(),b.find(".odswidget-table__internal-header-table-header").show(),t||c(function(){J()},0)}t&&(s||o.css({left:"auto"}),b.find(".odswidget-table__records")[0].scrollLeft=s),a.layout.length&&(a.working=!1)}}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsTagCloud",["ODSAPI","$location",function(a,b){function c(a){var b=Math.floor(a.length/2);return a.length%2?a[b].count:(a[b-1].count+a[b].count)/2}function d(a,b){var c=$.grep(a,function(a){return a.count>=b}),d=$.grep(a,function(a){return a.count<=b}),e=[{count:c.length,min:c[c.length-1].count,max:c[0].count},{count:d.length,min:d[d.length-1].count,max:d[0].count}];return e[0].delta=e[0].max-e[0].min,e[1].delta=e[1].max-e[1].min,e}function e(a,b,c,d){var e,f=(a.count>=b?c[0].delta:c[1].delta)/2;return e=a.count>=2*f?1:a.count>=f&&a.count<2*f?2:3,e=a.count>=b?e:e+3,a={count:a.count,name:a.name,opacity:((7-e+4)/10+.05).toFixed(2),size:((7-e)/3).toFixed(1),weight:e},a.size=6!==e?a.size:parseFloat(a.size)+.3,a}function f(a,b,c){var d=a.parameters["refine."+b];return angular.isDefined(d)&&(angular.isArray(d)&&d.indexOf(c)>-1||d===c)}function g(a){for(var b=a.length-1;b>0;b--){var c=Math.floor(Math.random()*(b+1)),d=a[b];a[b]=a[c],a[c]=d}return a}return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-tag-cloud">    <ul class="odswidget-tag-cloud__tag-list">        <li class="odswidget-tag-cloud__no-data-label" ng-hide="tags" translate>No data available yet</li>        <li ng-repeat="tag in tags"             class="odswidget-tag-cloud__tag"             ng-class="{\'odswidget-tag-cloud__tag--selected\': tag.selected}"            ng-style="{\'font-size\': tag.size + \'em\', \'opacity\': tag.opacity}">            <a ng-click="refine(tag.name)" href="">                {{ tag.name }}            </a>        </li>    </ul></div>',scope:{context:"=",facetName:"@",max:"@?",redirectTo:"@?",contextToRefine:"=?"},controller:["$scope",function(b){b.refine=function(a){if(b.redirectTo){var c="refine."+b.facetName+"="+a,d=b.redirectTo.indexOf("?")>-1?"&":"?";window.location=b.redirectTo+d+c}else b.contextToRefine?b.contextToRefine.toggleRefine(b.facetName,a):b.context.toggleRefine(b.facetName,a)};var h=function(){var h,i={rows:0,facet:b.facetName};"catalog"===b.context.type?h=a.datasets.search(b.context,i):(i=$.extend({},b.context.parameters,i),h=a.records.search(b.context,i)),h.success(function(a){if(a.facet_groups){b.tags=a.facet_groups[0].facets,b.max&&(b.tags=b.tags.slice(0,b.max));for(var h=c(b.tags),i=0;i<b.tags.length;i++)b.tags[i]=e(b.tags[i],h,d(b.tags,h),b.context.domainUrl),b.tags[i].selected=f(b.contextToRefine?b.contextToRefine:b.context,b.facetName,b.tags[i].name);b.tags=g(b.tags)}})};b.$watch("context",function(a,c){("catalog"===b.context.type||"dataset"===b.context.type&&b.context.dataset)&&h()},!0)}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsTextSearch",function(){return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-text-search"><form ng-submit="applySearch()" class="odswidget-text-search__form"><input class="odswidget-text-search__search-box" name="q" type="text" ng-model="searchExpression" placeholder="{{placeholder}}"></form></div>',scope:{placeholder:"@?",context:"="},controller:["$scope","translate",function(a,b){var c=a.$watch("context",function(b,d){b&&(a.searchExpression=a.context.parameters.q,c())});a.applySearch=function(){a.context.parameters.q=a.searchExpression}}]}})}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsThemeBoxes",function(){return{restrict:"E",replace:!1,template:'<div class="odswidget odswidget-theme-boxes"><div class="odswidget odswidget-facet-enumerator"><div ng-repeat="item in items" class="item" ods-facet-results="items" ods-facet-results-context="context" ods-facet-results-facet-name="theme"><a ng-href="{{context.domainUrl}}/explore/?refine.theme={{item.path}}" target="_self" ods-tooltip="{{item.name}} ({{formatCount(item.count)}})" ods-tooltip-direction="bottom" style="display: block;"><ods-theme-picto theme="{{item.name}}"></ods-theme-picto></a></div></div></div>',scope:{context:"="},controller:["$scope","translate",function(a,b){a.formatCount=function(a){return a>1?a+" "+b("datasets"):a+" "+b("dataset")}}]}})}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsTileMap",["ModuleLazyLoader",function(a){return{restrict:"E",replace:!0,scope:{context:"=",embedMode:"@",autoResize:"@",mapContext:"=?",location:"@",basemap:"@",isStatic:"@"},template:function(a){return a.contents().wrapAll("<div>"),a.contents().length>0&&a.contents().html().trim().length>0&&(a.contents().wrapAll("<div>"),a.data("tooltip-template",a.children().html())),'<div class="odswidget odswidget-map"><div class="map"></div><div class="overlay map opaque-overlay" ng-show="pendingRequests.length && initialLoading"><ods-spinner></ods-spinner></div><div class="odswidget-map__loading" ng-show="loadingTiles"><ods-spinner></ods-spinner></div></div>'},link:function(b,c,d){function e(){$(".odswidget-map > .map").length>0&&$(".odswidget-map > .map").height(Math.max(200,$(window).height()-$(".odswidget-map > .map").offset().top))}angular.isUndefined(b.mapContext)&&(b.mapContext={},b.location&&(b.mapContext.location=b.location),b.basemap&&(b.mapContext.basemap=b.basemap)),"true"===b.autoResize&&($(window).on("resize",e),e()),a("leaflet").then(function(){b.initMap=function(a,d,e,f,g,h,i,j){var k={basemapsList:e,worldCopyJump:!0,minZoom:2,basemap:h,dragging:!i,zoomControl:!i,prependAttribution:j};i&&(k.doubleClickZoom=!1,k.scrollWheelZoom=!1);var l=new L.ODSMap(c.children()[0],k);l.addControl(new L.Control.Scale),"true"!==d&&l.addControl(new L.Control.Fullscreen),i||l.addControl(new L.Control.Locate({maxZoom:18})),b.drawnItems=new L.FeatureGroup,l.addLayer(b.drawnItems);var m=new L.Control.Draw({edit:{featureGroup:b.drawnItems},draw:{polyline:!1,marker:!1}});l.addControl(m),b.map=l,l.on("popupclose",function(a){jQuery(a.popup.getContent()).trigger("popupclose")})}})},controller:["$scope","$q","$compile","$element","ODSAPI","ODSWidgetsConfig","translate","DebugLogger","odsErrorService",function(a,b,c,d,e,f,g,h,i){a.initialLoading=!0;var j={delimiter:",",accuracy:5,formatLatLng:function(a){var b=L.Util.formatNum(a.lat,this.accuracy),c=L.Util.formatNum(a.lng,this.accuracy);return new L.LatLng(b,c)},getLocationParameterAsArray:function(a){return a.split(this.delimiter)},getLocationParameterFromMap:function(a){var b=this.formatLatLng(a.getCenter());return a.getZoom()+this.delimiter+b.lat+this.delimiter+b.lng},getCenterFromLocationParameter:function(a){var b=this.getLocationParameterAsArray(a);return new L.LatLng(b[1],b[2])},getZoomFromLocationParameter:function(a){return this.getLocationParameterAsArray(a)[0]}};a.$watch("context.parameters",function(b,c){b!==c&&(a.initialLoading||k(!0))},!0);var k=function(b){var c=function(){var b={color:a.context.dataset.getExtraMeta("visualization","map_marker_color"),icon:a.context.dataset.getExtraMeta("visualization","map_marker_picto"),showmarker:!a.context.dataset.getExtraMeta("visualization","map_marker_hidemarkershape")};angular.extend(b,a.context.parameters);var c="/api/datasets/1.0/"+a.context.dataset.datasetid+"/tiles/simple/{z}/{x}/{y}.bundle",d="";angular.forEach(b,function(a,b){null!=a&&(d+=d?"&":"?",d+=b+"="+encodeURIComponent(a))}),c+=d,a.bundleLayer._url!==c&&a.bundleLayer.setUrl(c)};if(b){var d={};jQuery.extend(d,a.staticSearchOptions,a.context.parameters),e.records.boundingbox(a.context,d).success(function(b){b.bbox.length>0&&a.map.fitBounds([[b.bbox[1],b.bbox[0]],[b.bbox[3],b.bbox[2]]]),c()})}else c()},l=function(b){var c=b.getSize();c.x>0&&c.y>0&&(a.mapContext.location=j.getLocationParameterFromMap(b))},m=a.$watch("context.dataset",function(n,o){if(n&&n.datasetid){a.context.dataset.hasFieldType("geo_shape")?angular.forEach(a.context.dataset.fields,function(b){angular.isUndefined(a.shapeField)&&"geo_shape"===b.type&&(a.shapeField=b.name)}):a.shapeField=null,a.staticMap="true"===a.isStatic||"true"===a.context.parameters["static"];var p=a.$watch("initMap",function(){a.initMap&&(p(),a.initMap(n,a.embedMode,f.basemaps,g,f.mapGeobox,a.mapContext.basemap,a.staticMap,f.mapPrependAttribution))});m(),a.staticSearchOptions={dataset:a.context.dataset.datasetid};var q=a.$watch("map",function(g,m){if(g){a.bundleLayer=new L.BundleTileLayer("",{tileSize:512,minZoom:g.getMinZoom(),maxZoom:g.getMaxZoom(),gridLayer:{options:{resolution:4},events:{click:function(b){if(!a.drawing&&b.data){console.log(b.data);var e=a.$new(!1),f={offset:[0,-10],maxWidth:250,minWidth:250},g=d.data("tooltip-template");(angular.isUndefined(g)||!angular.isString(g)||""===g.trim())&&(g=a.context.dataset.extra_metas&&a.context.dataset.extra_metas.visualization&&a.context.dataset.extra_metas.visualization.map_tooltip_html?a.context.dataset.extra_metas.visualization.map_tooltip_html:""),e.template=g,e.map=a.map,e.gridData=b.data;var h=new L.Popup(f).setLatLng(b.latlng).setContent(c('<ods-map-tooltip context="context" grid-data="gridData" template="{{template}}" map="map" shape-field="'+(a.shapeField||"")+'"></ods-map-tooltip')(e)[0]);h.openOn(a.map)}}}}}),a.bundleLayer.on("loading",function(){a.$evalAsync("loadingTiles = true")}),a.bundleLayer.on("load",function(){a.$evalAsync("loadingTiles = false")}),a.bundleLayer.on("tileerror",function(){i.sendErrorNotification({error:"Error while loading the map view."})}),a.map.addLayer(a.bundleLayer);var n=function(){var c=b.defer();if(a.context.parameters.mapviewport)"("===a.context.parameters.mapviewport.substring(0,1)&&(a.context.parameters.mapviewport=ODS.GeoFilter.getBoundsAsBboxParameter(ODS.GeoFilter.getPolygonParameterAsBounds(a.context.parameters.mapviewport))),c.resolve(ODS.GeoFilter.getBboxParameterAsBounds(a.context.parameters.mapviewport));else if(a.context.parameters["geofilter.polygon"])c.resolve(ODS.GeoFilter.getPolygonParameterAsBounds(a.context.parameters["geofilter.polygon"]));else{var d={};jQuery.extend(d,a.staticSearchOptions,a.context.parameters),e.records.boundingbox(a.context,d).success(function(a){a.count>0?c.resolve([[a.bbox[1],a.bbox[0]],[a.bbox[3],a.bbox[2]]]):c.resolve([[-60,-180],[80,180]])})}return c.promise},o=function(){var c=b.defer();if(a.mapContext.location){h.log("Location found");var d=j.getCenterFromLocationParameter(a.mapContext.location),e=j.getZoomFromLocationParameter(a.mapContext.location);h.log(d,e),g.setView(d,e),k(!1),c.resolve()}else h.log("Use boundsRetrieval"),n().then(function(b){a.context.parameters.mapviewport&&(h.log("Deleted mapviewport"),delete a.context.parameters.mapviewport),h.log(b),g.fitBounds(b),k(!1),c.resolve()});return c.promise};o().then(function(){a.initialLoading=!1,h.log("First onViewportMove"),l(a.map),a.map.on("moveend",function(b){l(b.target),a.$$phase||a.$root.$$phase||a.$apply()})}),f.basemaps.length>1&&a.map.on("baselayerchange",function(b){a.mapContext.basemap=b.layer.basemapId,a.bundleLayer.setMinZoom(b.layer.options.minZoom),a.bundleLayer.setMaxZoom(b.layer.options.maxZoom),a.$$phase||a.$root.$$phase||a.$apply()});var p=function(b,c){if("circle"===c){var d=b.getRadius(),e=b.getLatLng();a.context.parameters["geofilter.distance"]=e.lat+","+e.lng+","+d,delete a.context.parameters["geofilter.polygon"]}else{var f=b.toGeoJSON(),g=ODS.GeoFilter.getGeoJSONPolygonAsPolygonParameter(f.geometry);a.context.parameters["geofilter.polygon"]=g,delete a.context.parameters["geofilter.distance"]}},r=function(a){return angular.isDefined(a.getRadius)?"circle":"polygon"},s=function(a){a._path.setAttribute("style","cursor: pointer; pointer-events: auto;")},t=function(a){a._path.setAttribute("style","cursor: auto; pointer-events: none;")};a.map.on("draw:drawstart draw:editstart",function(){a.drawing=!0,a.$apply()}),a.map.on("draw:drawstop draw:editstop",function(){a.drawing=!1,a.$apply()}),a.map.on("draw:created",function(b){var c=b.layer;a.drawnItems.getLayers().length>0&&a.drawnItems.removeLayer(a.drawnItems.getLayers()[0]),a.drawnItems.addLayer(c),p(c,b.layerType),a.$apply()}),a.map.on("draw:deleted",function(b){delete a.context.parameters["geofilter.distance"],delete a.context.parameters["geofilter.polygon"],a.$apply()}),a.map.on("draw:edited",function(b){var c=b.layers.getLayers()[0],d=r(c);p(c,d),a.$apply()}),a.map.on("draw:deletestart",function(){s(a.drawnItems.getLayers()[0])}),a.map.on("draw:deleteend",function(){t(a.drawnItems.getLayers()[0])});var u={color:"#2ca25f",fillOpacity:.2,opacity:.8,clickable:!0};a.$watch('[context.parameters["geofilter.polygon"], context.parameters["geofilter.distance"]]',function(b,c){var d=b[0],e=b[1];a.drawnItems.getLayers().length>0&&a.drawnItems.removeLayer(a.drawnItems.getLayers()[0]);var f;if(d){var g=ODS.GeoFilter.getPolygonParameterAsGeoJSON(d),h=g.coordinates[0];h.splice(g.coordinates[0].length-1,1);var i,j,k;for(i=0;i<h.length;i++)j=h[i],k=j[0],j[0]=j[1],j[1]=k;f=4===h.length&&h[0][0]===h[3][0]&&h[1][0]===h[2][0]&&h[0][1]===h[1][1]&&h[2][1]===h[3][1]?new L.Rectangle(h,u):new L.Polygon(h,u)}else if(e){var l=e.split(","),m=l[0],n=l[1],o=l[2];f=new L.Circle([m,n],o,u)}f&&(a.drawnItems.addLayer(f),t(a.drawnItems.getLayers()[0]))},!0),q()}})}},!0)}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsTimerange",["ModuleLazyLoader",function(a){var b={styles:{container:"rd-container odswidgets-rd-container"},weekStart:1},c=function(a){return"yesterday"===a?moment().subtract("days",1):"now"===a?moment():angular.isString(a)?moment(a):null},d=function(a){return a?moment(a).milliseconds(0).toISOString().replace(".000Z","Z"):null};return{restrict:"E",replace:!0,scope:{context:"=",timeField:"@?",defaultFrom:"@?",defaultTo:"@?",displayTime:"@?",dateFormat:"@?",to:"=?",from:"=?"},template:'<div class="odswidget odswidget-timerange"><span class="odswidget-timerange-from"><span translate>From</span> <input type="text"></span><span class="odswidget-timerange-to"><span translate>to</span> <input type="text"></span></div>',link:function(e,f,g){var h=f.find("input");e.dateFormat=e.dateFormat||"YYYY-MM-DD HH:mm",angular.isDefined(e.defaultFrom)&&(h[0].value=c(e.defaultFrom).format(e.dateFormat),e.from=d(c(e.defaultFrom))),angular.isDefined(e.defaultTo)&&(h[1].value=c(e.defaultTo).format(e.dateFormat),e.to=d(c(e.defaultTo))),a("rome").then(function(){"undefined"==typeof e.displayTime?e.displayTime=!0:e.displayTime="true"===e.displayTime,rome(h[0],angular.extend({},b,{time:e.displayTime,dateValidator:rome.val.beforeEq(h[1]),initialValue:e.defaultFrom,inputFormat:e.dateFormat})).on("data",function(a){e.$apply(function(){e.from=d(moment(a,e.dateFormat))})}),rome(h[1],angular.extend({},b,{time:e.displayTime,dateValidator:rome.val.afterEq(h[0]),initialValue:e.defaultTo,inputFormat:e.dateFormat})).on("data",function(a){e.$apply(function(){e.to=d(moment(a,e.dateFormat))})})})},controller:["$scope","$attrs","$q","$compile","$rootScope","$parse",function(a,b,c,d,e,f){var g=[],h={},i=function(a){if(a){var b=a.fields.filter(function(a){return"date"===a.type||"datetime"===a.type});return b.length>1&&console.log('Warning: the dataset "'+a.getUniqueId()+'" has more than one date or datetime field, the first date or datetime field will be used. You can specify the field to use using the "time-field" parameter.'),0===b.length&&console.log('Error: the dataset "'+a.getUniqueId()+"\" doesn't have any date or datetime field, which is required for the Timerange widget."),b[0].name}return null};angular.isArray(a.context)?g=a.context:(g.push(a.context),h[a.context.name]={},a.timeField&&(h[a.context.name].timeField=a.timeField)),angular.forEach(g,function(c){h[c.name]={timefield:h[a.context.name]&&h[a.context.name].timeField?h[a.context.name].timeField:null,formatter:f("$field + ':[' + $from + ' TO ' + $to + ']'"),parameter:"q"},angular.isDefined(b[c.name+"ParameterFormatter"])&&(h[c.name].formatter=f(b[c.name+"ParameterFormatter"])),angular.isDefined(b[c.name+"ParameterName"])&&(h[c.name].parameter=b[c.name+"ParameterName"]),angular.isDefined(b[c.name+"TimeField"])&&(h[c.name].timefield=b[c.name+"TimeField"])}),c.all(g.map(function(a){return a.wait().then(function(b){null===h[a.name].timefield&&(h[a.name].timefield=i(b))})})).then(function(){j(g,h)});var j=function(b,c){a.$watch("[from, to]",function(d){d[0]&&d[1]&&angular.forEach(b,function(b){var d=c[b.name].parameter,e={};e.$to=a.to,e.$from=a.from,e.$field=c[b.name].timefield,["q","rq"].indexOf(d)>-1&&(d+=".timerange"),b.parameters[d]=c[b.name].formatter(e)})},!0)}}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsTimescale",function(){return{restrict:"E",replace:!0,scope:{context:"=",timeField:"@",defaultValue:"@"},template:'<div class="odswidget odswidget-timescale">   <ul class="odswidget-timescale__scale-list">       <li class="odswidget-timescale__scale" ng-class="{\'odswidget-timescale__scale--active\': scale == \'everything\' || !scale}"> <a class="odswidget-timescale__scale-link" href="#" ng-click="scale = \'everything\'; $event.preventDefault();" translate>Everything</a></li>       <li class="odswidget-timescale__scale" ng-class="{\'odswidget-timescale__scale--active\': scale == \'year\'}">                 <a class="odswidget-timescale__scale-link" href="#" ng-click="scale = \'year\'; $event.preventDefault();" translate>Last 12 months</a></li>       <li class="odswidget-timescale__scale" ng-class="{\'odswidget-timescale__scale--active\': scale == \'month\'}">                <a class="odswidget-timescale__scale-link" href="#" ng-click="scale = \'month\'; $event.preventDefault();" translate>Last 4 weeks</a></li>       <li class="odswidget-timescale__scale" ng-class="{\'odswidget-timescale__scale--active\': scale == \'week\'}">                 <a class="odswidget-timescale__scale-link" href="#" ng-click="scale = \'week\'; $event.preventDefault();" translate>Last 7 days</a></li>       <li class="odswidget-timescale__scale" ng-class="{\'odswidget-timescale__scale--active\': scale == \'day\'}">                  <a class="odswidget-timescale__scale-link" href="#" ng-click="scale = \'day\'; $event.preventDefault();" translate>Last 24 hours</a></li>   </ul></div>',controller:["$scope","$attrs","$q",function(a,b,c){var d=[],e={},f="q.timescale",g=function(a){if(a){var b=a.fields.filter(function(a){return"date"===a.type||"datetime"===a.type});b.length>1&&console.log('Warning: the dataset "'+a.getUniqueId()+'" has more than one date or datetime field, the first date or datetime field will be used. You can specify the field to use using the "time-field" parameter.'),0===b.length&&console.log('Error: the dataset "'+a.getUniqueId()+"\" doesn't have any date or datetime field, which is required for the Timerange widget."),e[a.getUniqueId()]=b[0].name}};angular.isArray(a.context)?d=a.context:d.push(a.context),c.all(d.map(function(c){return c.wait().then(function(d){angular.isDefined(b[c.name+"TimeField"])?e[c.dataset.getUniqueId()]=b[c.name+"TimeField"]:a.timeField?e[c.dataset.getUniqueId()]=a.timeField:g(d)})})).then(function(){h(d,e)});var h=function(b,c){a.scale=a.defaultValue||"everything",a.$watch("scale",function(a){if("everything"===a)return void angular.forEach(b,function(a){delete a.parameters[f]});var d=null,e=new Date;"day"===a?e.setDate(e.getDate()-1):"week"===a?e.setDate(e.getDate()-7):"month"===a?e.setMonth(e.getMonth()-1):"year"===a&&e.setFullYear(e.getFullYear()-1),d=e.toISOString(),angular.forEach(b,function(a){a.parameters[f]=c[a.dataset.getUniqueId()]+'>="'+d+'"'})},!0)}}]}})}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsToggleModel",function(){var a=function(a,b,c){a[b]?angular.isArray(a[b])?a[b].indexOf(c)<0&&a[b].push(c):angular.equals(a[b],c)||(a[b]=[a[b],c]):a[b]=c},b=function(a,b,c){a[b]&&(angular.isArray(a[b])?a[b].indexOf(c)>=0&&(1===a[b].length?delete a[b]:a[b].splice(a[b].indexOf(c),1)):angular.equals(a[b],c)&&delete a[b])};return{restrict:"A",scope:{odsToggleModel:"=",odsToggleKey:"@",odsToggleValue:"@"},link:function(c,d,e){d.on("change",function(d){var e=d.currentTarget.checked;e?c.$apply(function(){a(c.odsToggleModel,c.odsToggleKey,c.odsToggleValue)}):c.$apply(function(){b(c.odsToggleModel,c.odsToggleKey,c.odsToggleValue)})}),c.$watch("odsToggleModel[odsToggleKey]",function(a){a?angular.isArray(a)&&a.indexOf(c.odsToggleValue)>=0?d.prop("checked",!0):angular.equals(a,c.odsToggleValue)?d.prop("checked",!0):d.prop("checked",!1):d.prop("checked",!1)},!0)}}})}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsTopPublishers",["ODSAPI",function(a){return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-top-publishers"><ul>   <li class="no-data" ng-hide="publishers" translate>No data available yet</li>   <li ng-repeat="publisher in publishers" ng-if="publishers">       <div class="dataset-details">           <div class="name"><a ng-href="{{ context.domainUrl }}/explore/?refine.publisher={{ publisher.path }}" target="_self">{{ publisher.name }}</a></div>           <div class="count"><i class="icon-table"></i> <span translate>Used by</span> {{ publisher.count }} '+"<span ng-pluralize count=\"publisher.count\" translate=\"when\" when=\"{'0': 'dataset', '1': 'dataset', 'other': 'datasets'}\"></span></div>       </div>   </li></ul></div>",scope:{context:"="},controller:["$scope",function(b){var c=function(){a.datasets.facets(b.context,"publisher").success(function(a){b.publishers=a.facet_groups[0].facets.slice(0,5)})};b.$watch("context",function(){c()})}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsTwitterTimeline",function(){return{restrict:"E",replace:!0,template:'<div class="odswidget"></div>',scope:{widgetId:"@"},link:function(a,b,c){var d='<a class="twitter-timeline" href="https://twitter.com/twitterapi" data-widget-id="'+c.widgetId+'">Tweets</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>';b.append(d)}}})}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("inject",function(){return{link:function(a,b,c,d,e){var f=a.$new();return e?void e(f,function(a){var c=a.clone();c.contents().wrapAll("<div>"),c.contents().length>0&&c.contents().html().trim().length>0&&(b.empty(),b.append(a),b.on("$destroy",function(){f.$destroy()}))}):void console.warn("inject directive used on an element with no transcluded directives",b)}}}),a.directive("odsFullClick",function(){return{restrict:"A",link:function(a,b,c){c.odsFullClick&&b.find("[ods-main-click]").attr("href",c.odsFullClick),b.click(function(a){if(!$(a.target).is("a,button,[ng-click]")&&0===$(a.target).parents("a,button,[ng-click]").length&&b.find("[ods-main-click]").length)if(document.createEvent){var c=document.createEvent("MouseEvents"),d=a.originalEvent;c.initMouseEvent(d.type,d.bubbles,d.cancelable,window,d.detail,d.screenX,d.screenY,d.clientX,d.clientY,d.ctrlKey,d.altKey,d.shiftKey,d.metaKey,d.button,d.relatedTarget),b.find("[ods-main-click]")[0].dispatchEvent(c)}else document.createEventObject&&(window.location=b.find("[ods-main-click]")[0].href)})}}})}();