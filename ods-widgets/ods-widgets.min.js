angular.module("gettext",[]),angular.module("gettext").constant("gettext",function(a){return a}),angular.module("gettext").service("translate",["gettextCatalog",function(a){return function(b){return a.getString(b)}}]),angular.module("gettext").factory("gettextCatalog",["gettextPlurals","gettextFallbackLanguage","$http","$cacheFactory","$interpolate","$rootScope",function(a,b,c,d,e,f){function g(){f.$broadcast("gettextLanguageChanged")}var h,i="$$noContext",j='<span id="test" title="test" class="tested">test</span>',k=angular.element("<span>"+j+"</span>").html()!==j,l=function(a){return h.debug&&h.currentLanguage!==h.baseLanguage?h.debugPrefix+a:a},m=function(a){return h.showTranslatedMarkers?h.translatedMarkerPrefix+a+h.translatedMarkerSuffix:a};return h={debug:!1,debugPrefix:"[MISSING]: ",showTranslatedMarkers:!1,translatedMarkerPrefix:"[",translatedMarkerSuffix:"]",strings:{},baseLanguage:"en",currentLanguage:"en",cache:d("strings"),setCurrentLanguage:function(a){this.currentLanguage=a,g()},getCurrentLanguage:function(){return this.currentLanguage},setStrings:function(a,b){this.strings[a]||(this.strings[a]={});for(var c in b){var d=b[c];if(k&&(c=angular.element("<span>"+c+"</span>").html()),angular.isString(d)||angular.isArray(d)){var e={};e[i]=d,d=e}for(var f in d){var h=d[f];d[f]=angular.isArray(h)?h:[h]}this.strings[a][c]=d}g()},getStringFormFor:function(b,c,d,e){return b?(((this.strings[b]||{})[c]||{})[e||i]||[])[a(b,d)]:null},getString:function(a,c,d){var f=b(this.currentLanguage);return a=this.getStringFormFor(this.currentLanguage,a,1,d)||this.getStringFormFor(f,a,1,d)||l(a),a=c?e(a)(c):a,m(a)},getPlural:function(a,c,d,f,g){var h=b(this.currentLanguage);return c=this.getStringFormFor(this.currentLanguage,c,a,g)||this.getStringFormFor(h,c,a,g)||l(1===a?c:d),f&&(f.$count=a,c=e(c)(f)),m(c)},loadRemote:function(a){return c({method:"GET",url:a,cache:h.cache}).then(function(a){var b=a.data;for(var c in b)h.setStrings(c,b[c]);return a})}}}]),angular.module("gettext").directive("translate",["gettextCatalog","$parse","$animate","$compile","$window",function(a,b,c,d,e){function f(a,b,c){if(!a)throw new Error("You should add a "+b+" attribute whenever you add a "+c+" attribute.")}var g=function(){return String.prototype.trim?function(a){return"string"==typeof a?a.trim():a}:function(a){return"string"==typeof a?a.replace(/^\s*/,"").replace(/\s*$/,""):a}}(),h=function(){return function(a){if("string"!=typeof a)return a;for(a=g(a),a=a.replace("\n"," ");a.indexOf("  ")>-1;)a=a.replace("  "," ");return a}}(),i=parseInt((/msie (\d+)/.exec(angular.lowercase(e.navigator.userAgent))||[])[1],10);return{restrict:"AE",compile:function(e,g){f(!g.translatePlural||g.translateN,"translate-n","translate-plural"),f(!g.translateN||g.translatePlural,"translate-plural","translate-n");var j,k;g.translate?(k=g.$normalize(g.translate),j=h(g[k])):j=h(e.html());var l=g.translatePlural,m=g.translateContext;return i<=8&&"<!--IE fix-->"===j.slice(-13)&&(j=j.slice(0,-13)),{post:function(e,f,g){function i(){var b;if(l?(e=n||(n=e.$new()),e.$count=k(e),b=a.getPlural(e.$count,j,l,null,m)):b=a.getString(j,null,m),g.translate){if(f.attr(g.translate)===b)return;f.attr(g.translate,b)}else{var i=f.contents();if(0===i.length)return;if(b===h(i.html()))return void(o&&d(i)(e));var p=angular.element("<span>"+b+"</span>");d(p.contents())(e);var q=p.contents();c.enter(q,f),c.leave(i)}}var k=b(g.translateN),n=null,o=!0;g.translateN&&e.$watch(g.translateN,i),e.$on("gettextLanguageChanged",i),i(),o=!1}}}}}]),angular.module("gettext").factory("gettextFallbackLanguage",function(){var a={},b=/([^_]+)_[^_]+$/;return function(c){if(a[c])return a[c];var d=b.exec(c);return d?(a[c]=d[1],d[1]):null}}),angular.module("gettext").filter("translate",["gettextCatalog",function(a){function b(b,c){return a.getString(b,null,c)}return b.$stateful=!0,b}]),angular.module("gettext").factory("gettextPlurals",function(){return function(a,b){switch(a){case"ay":case"bo":case"cgg":case"dz":case"fa":case"id":case"ja":case"jbo":case"ka":case"kk":case"km":case"ko":case"ky":case"lo":case"ms":case"my":case"sah":case"su":case"th":case"tt":case"ug":case"vi":case"wo":case"zh":return 0;case"is":return b%10!=1||b%100==11?1:0;case"jv":return 0!=b?1:0;case"mk":return 1==b||b%10==1?0:1;case"ach":case"ak":case"am":case"arn":case"br":case"fil":case"fr":case"gun":case"ln":case"mfe":case"mg":case"mi":case"oc":case"pt_BR":case"tg":case"ti":case"tr":case"uz":case"wa":case"zh":return b>1?1:0;case"lv":return b%10==1&&b%100!=11?0:0!=b?1:2;case"lt":return b%10==1&&b%100!=11?0:b%10>=2&&(b%100<10||b%100>=20)?1:2;case"be":case"bs":case"hr":case"ru":case"sr":case"uk":return b%10==1&&b%100!=11?0:b%10>=2&&b%10<=4&&(b%100<10||b%100>=20)?1:2;case"mnk":return 0==b?0:1==b?1:2;case"ro":return 1==b?0:0==b||b%100>0&&b%100<20?1:2;case"pl":return 1==b?0:b%10>=2&&b%10<=4&&(b%100<10||b%100>=20)?1:2;case"cs":case"sk":return 1==b?0:b>=2&&b<=4?1:2;case"sl":return b%100==1?1:b%100==2?2:b%100==3||b%100==4?3:0;case"mt":return 1==b?0:0==b||b%100>1&&b%100<11?1:b%100>10&&b%100<20?2:3;case"gd":return 1==b||11==b?0:2==b||12==b?1:b>2&&b<20?2:3;case"cy":return 1==b?0:2==b?1:8!=b&&11!=b?2:3;case"kw":return 1==b?0:2==b?1:3==b?2:3;case"ga":return 1==b?0:2==b?1:b<7?2:b<11?3:4;case"ar":return 0==b?0:1==b?1:2==b?2:b%100>=3&&b%100<=10?3:b%100>=11?4:5;default:return 1!=b?1:0}}}),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I;h=function(b,c,d,e){return new a(b,c,d,e)},"undefined"!=typeof module&&null!==module&&null!=module.exports&&(module.exports=h),"function"==typeof define&&define.amd?define([],function(){return h}):(E="undefined"!=typeof exports&&null!==exports?exports:this,E.chroma=h),h.color=function(b,c,d,e){return new a(b,c,d,e)},h.hsl=function(b,c,d,e){return new a(b,c,d,e,"hsl")},h.hsv=function(b,c,d,e){return new a(b,c,d,e,"hsv")},h.rgb=function(b,c,d,e){return new a(b,c,d,e,"rgb")},h.hex=function(b){return new a(b)},h.css=function(b){return new a(b)},h.lab=function(b,c,d){return new a(b,c,d,"lab")},h.lch=function(b,c,d){return new a(b,c,d,"lch")},h.hsi=function(b,c,d){return new a(b,c,d,"hsi")},h.gl=function(b,c,d,e){return new a(255*b,255*c,255*d,e,"gl")},h.interpolate=function(b,c,d,e){return null==b||null==c?"#000":("string"===F(b)&&(b=new a(b)),"string"===F(c)&&(c=new a(c)),b.interpolate(d,c,e))},h.mix=h.interpolate,h.contrast=function(b,c){var d,e;return"string"===F(b)&&(b=new a(b)),"string"===F(c)&&(c=new a(c)),d=b.luminance(),e=c.luminance(),d>e?(d+.05)/(e+.05):(e+.05)/(d+.05)},h.luminance=function(a){return h(a).luminance()},h._Color=a,a=function(){function a(){var a,b,c,d,e,f,g,h,j,k,p,r,s,u,v;for(e=this,c=[],j=0,k=arguments.length;j<k;j++)null!=(b=arguments[j])&&c.push(b);if(0===c.length)p=[255,0,255,1,"rgb"],f=p[0],g=p[1],h=p[2],a=p[3],d=p[4];else if("array"===F(c[0])){if(3===c[0].length)r=c[0],f=r[0],g=r[1],h=r[2],a=1;else{if(4!==c[0].length)throw"unknown input argument";s=c[0],f=s[0],g=s[1],h=s[2],a=s[3]}d=null!=(u=c[1])?u:"rgb"}else"string"===F(c[0])?(f=c[0],d="hex"):"object"===F(c[0])?(v=c[0]._rgb,f=v[0],g=v[1],h=v[2],a=v[3],d="rgb"):c.length>=3&&(f=c[0],g=c[1],h=c[2]);3===c.length?(d="rgb",a=1):4===c.length?"string"===F(c[3])?(d=c[3],a=1):"number"===F(c[3])&&(d="rgb",a=c[3]):5===c.length&&(a=c[3],d=c[4]),null==a&&(a=1),"rgb"===d?e._rgb=[f,g,h,a]:"gl"===d?e._rgb=[255*f,255*g,255*h,a]:"hsl"===d?(e._rgb=n(f,g,h),e._rgb[3]=a):"hsv"===d?(e._rgb=o(f,g,h),e._rgb[3]=a):"hex"===d?e._rgb=l(f):"lab"===d?(e._rgb=q(f,g,h),e._rgb[3]=a):"lch"===d?(e._rgb=t(f,g,h),e._rgb[3]=a):"hsi"===d&&(e._rgb=m(f,g,h),e._rgb[3]=a),i(e._rgb)}return a.prototype.rgb=function(){return this._rgb.slice(0,3)},a.prototype.rgba=function(){return this._rgb},a.prototype.hex=function(){return x(this._rgb)},a.prototype.toString=function(){return this.name()},a.prototype.hsl=function(){return z(this._rgb)},a.prototype.hsv=function(){return A(this._rgb)},a.prototype.lab=function(){return B(this._rgb)},a.prototype.lch=function(){return C(this._rgb)},a.prototype.hsi=function(){return y(this._rgb)},a.prototype.gl=function(){return[this._rgb[0]/255,this._rgb[1]/255,this._rgb[2]/255,this._rgb[3]]},a.prototype.luminance=function(){return v(this._rgb)},a.prototype.name=function(){var a,b;a=this.hex();for(b in h.colors)if(a===h.colors[b])return b;return a},a.prototype.alpha=function(a){return arguments.length?(this._rgb[3]=a,this):this._rgb[3]},a.prototype.css=function(a){var b,c,d,e;return null==a&&(a="rgb"),c=this,d=c._rgb,3===a.length&&d[3]<1&&(a+="a"),"rgb"===a?a+"("+d.slice(0,3).map(Math.round).join(",")+")":"rgba"===a?a+"("+d.slice(0,3).map(Math.round).join(",")+","+d[3]+")":"hsl"===a||"hsla"===a?(b=c.hsl(),e=function(a){return Math.round(100*a)/100},b[0]=e(b[0]),b[1]=e(100*b[1])+"%",b[2]=e(100*b[2])+"%",4===a.length&&(b[3]=d[3]),a+"("+b.join(",")+")"):void 0},a.prototype.interpolate=function(b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r;if(l=this,null==d&&(d="rgb"),"string"===F(c)&&(c=new a(c)),"hsl"===d||"hsv"===d||"lch"===d||"hsi"===d)"hsl"===d?(q=l.hsl(),r=c.hsl()):"hsv"===d?(q=l.hsv(),r=c.hsv()):"hsi"===d?(q=l.hsi(),r=c.hsi()):"lch"===d&&(q=l.lch(),r=c.lch()),"h"===d.substr(0,1)?(g=q[0],o=q[1],j=q[2],h=r[0],p=r[1],k=r[2]):(j=q[0],o=q[1],g=q[2],k=r[0],p=r[1],h=r[2]),isNaN(g)||isNaN(h)?isNaN(g)?isNaN(h)?f=Number.NaN:(f=h,1!==j&&0!==j||"hsv"===d||(n=p)):(f=g,1!==k&&0!==k||"hsv"===d||(n=o)):(e=h>g&&h-g>180?h-(g+360):h<g&&g-h>180?h+360-g:h-g,f=g+b*e),null==n&&(n=o+b*(p-o)),i=j+b*(k-j),m="h"===d.substr(0,1)?new a(f,n,i,d):new a(i,n,f,d);else if("rgb"===d)q=l._rgb,r=c._rgb,m=new a(q[0]+b*(r[0]-q[0]),q[1]+b*(r[1]-q[1]),q[2]+b*(r[2]-q[2]),d);else{if("lab"!==d)throw"color mode "+d+" is not supported";q=l.lab(),r=c.lab(),m=new a(q[0]+b*(r[0]-q[0]),q[1]+b*(r[1]-q[1]),q[2]+b*(r[2]-q[2]),d)}return m.alpha(l.alpha()+b*(c.alpha()-l.alpha())),m},a.prototype.premultiply=function(){var a,b;return b=this.rgb(),a=this.alpha(),h(b[0]*a,b[1]*a,b[2]*a,a)},a.prototype.darken=function(a){var b,c;return null==a&&(a=20),c=this,b=c.lch(),b[0]-=a,h.lch(b).alpha(c.alpha())},a.prototype.darker=function(a){return this.darken(a)},a.prototype.brighten=function(a){return null==a&&(a=20),this.darken(-a)},a.prototype.brighter=function(a){return this.brighten(a)},a.prototype.saturate=function(a){var b,c;return null==a&&(a=20),c=this,b=c.lch(),b[1]+=a,h.lch(b).alpha(c.alpha())},a.prototype.desaturate=function(a){return null==a&&(a=20),this.saturate(-a)},a}(),i=function(a){var b;for(b in a)b<3?(a[b]<0&&(a[b]=0),a[b]>255&&(a[b]=255)):3===b&&(a[b]<0&&(a[b]=0),a[b]>1&&(a[b]=1));return a},k=function(a){var b,c,d,e,f,g,i,j;if(a=a.toLowerCase(),null!=h.colors&&h.colors[a])return l(h.colors[a]);if(d=a.match(/rgb\(\s*(\-?\d+),\s*(\-?\d+)\s*,\s*(\-?\d+)\s*\)/)){for(e=d.slice(1,4),c=f=0;f<=2;c=++f)e[c]=+e[c];e[3]=1}else if(d=a.match(/rgba\(\s*(\-?\d+),\s*(\-?\d+)\s*,\s*(\-?\d+)\s*,\s*([01]|[01]?\.\d+)\)/))for(e=d.slice(1,5),c=g=0;g<=3;c=++g)e[c]=+e[c];else if(d=a.match(/rgb\(\s*(\-?\d+(?:\.\d+)?)%,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*\)/)){for(e=d.slice(1,4),c=i=0;i<=2;c=++i)e[c]=Math.round(2.55*e[c]);e[3]=1}else if(d=a.match(/rgba\(\s*(\-?\d+(?:\.\d+)?)%,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*([01]|[01]?\.\d+)\)/)){for(e=d.slice(1,5),c=j=0;j<=2;c=++j)e[c]=Math.round(2.55*e[c]);e[3]=+e[3]}else(d=a.match(/hsl\(\s*(\-?\d+(?:\.\d+)?),\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*\)/))?(b=d.slice(1,4),b[1]*=.01,b[2]*=.01,e=n(b),e[3]=1):(d=a.match(/hsla\(\s*(\-?\d+(?:\.\d+)?),\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*([01]|[01]?\.\d+)\)/))&&(b=d.slice(1,4),b[1]*=.01,b[2]*=.01,e=n(b),e[3]=+d[4]);return e},l=function(a){var b,c,d,e,f,g;if(a.match(/^#?([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/))return 4!==a.length&&7!==a.length||(a=a.substr(1)),3===a.length&&(a=a.split(""),a=a[0]+a[0]+a[1]+a[1]+a[2]+a[2]),g=parseInt(a,16),e=g>>16,d=g>>8&255,c=255&g,[e,d,c,1];if(a.match(/^#?([A-Fa-f0-9]{8})$/))return 9===a.length&&(a=a.substr(1)),g=parseInt(a,16),e=g>>24&255,d=g>>16&255,c=g>>8&255,b=255&g,[e,d,c,b];if(f=k(a))return f;throw"unknown color: "+a},m=function(a,d,e){var f,g,h,i;return i=G(arguments),a=i[0],d=i[1],e=i[2],a/=360,a<1/3?(f=(1-d)/3,h=(1+d*j(c*a)/j(b-c*a))/3,g=1-(f+h)):a<2/3?(a-=1/3,h=(1-d)/3,g=(1+d*j(c*a)/j(b-c*a))/3,f=1-(h+g)):(a-=2/3,g=(1-d)/3,f=(1+d*j(c*a)/j(b-c*a))/3,h=1-(g+f)),h=u(e*h*3),g=u(e*g*3),f=u(e*f*3),[255*h,255*g,255*f]},n=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n;if(m=G(arguments),d=m[0],h=m[1],f=m[2],0===h)g=c=a=255*f;else{for(k=[0,0,0],b=[0,0,0],j=f<.5?f*(1+h):f+h-f*h,i=2*f-j,d/=360,k[0]=d+1/3,k[1]=d,k[2]=d-1/3,e=l=0;l<=2;e=++l)k[e]<0&&(k[e]+=1),k[e]>1&&(k[e]-=1),6*k[e]<1?b[e]=i+6*(j-i)*k[e]:2*k[e]<1?b[e]=j:3*k[e]<2?b[e]=i+(j-i)*(2/3-k[e])*6:b[e]=i;n=[Math.round(255*b[0]),Math.round(255*b[1]),Math.round(255*b[2])],g=n[0],c=n[1],a=n[2]}return[g,c,a]},o=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;if(l=G(arguments),d=l[0],i=l[1],k=l[2],k*=255,0===i)h=c=a=k;else switch(360===d&&(d=0),d>360&&(d-=360),d<0&&(d+=360),d/=60,e=Math.floor(d),b=d-e,f=k*(1-i),g=k*(1-i*b),j=k*(1-i*(1-b)),e){case 0:m=[k,j,f],h=m[0],c=m[1],a=m[2];break;case 1:n=[g,k,f],h=n[0],c=n[1],a=n[2];break;case 2:o=[f,k,j],h=o[0],c=o[1],a=o[2];break;case 3:p=[f,g,k],h=p[0],c=p[1],a=p[2];break;case 4:q=[j,f,k],h=q[0],c=q[1],a=q[2];break;case 5:r=[k,f,g],h=r[0],c=r[1],a=r[2]}return h=Math.round(h),c=Math.round(c),a=Math.round(a),[h,c,a]},d=.95047,e=1,f=1.08883,p=function(){var a,b,c,d,e,f;return f=G(arguments),e=f[0],a=f[1],b=f[2],c=Math.sqrt(a*a+b*b),d=Math.atan2(b,a)/Math.PI*180,[e,c,d]},q=function(a,b,c){var g,h,i,j,k,l,m;return void 0!==a&&3===a.length&&(l=a,a=l[0],b=l[1],c=l[2]),void 0!==a&&3===a.length&&(m=a,a=m[0],b=m[1],c=m[2]),j=(a+16)/116,i=j+b/500,k=j-c/200,i=r(i)*d,j=r(j)*e,k=r(k)*f,h=I(3.2404542*i-1.5371385*j-.4985314*k),g=I(-.969266*i+1.8760108*j+.041556*k),c=I(.0556434*i-.2040259*j+1.0572252*k),[u(h,0,255),u(g,0,255),u(c,0,255),1]},r=function(a){return a>.206893034?a*a*a:(a-4/29)/7.787037},I=function(a){return Math.round(255*(a<=.00304?12.92*a:1.055*Math.pow(a,1/2.4)-.055))},s=function(){var a,b,c,d;return d=G(arguments),c=d[0],a=d[1],b=d[2],b=b*Math.PI/180,[c,Math.cos(b)*a,Math.sin(b)*a]},t=function(a,b,c){var d,e,f,g,h,i,j;return i=s(a,b,c),d=i[0],e=i[1],f=i[2],j=q(d,e,f),h=j[0],g=j[1],f=j[2],[u(h,0,255),u(g,0,255),u(f,0,255)]},v=function(a,b,c){var d;return d=G(arguments),a=d[0],b=d[1],c=d[2],a=w(a),b=w(b),c=w(c),.2126*a+.7152*b+.0722*c},w=function(a){return a/=255,a<=.03928?a/12.92:Math.pow((a+.055)/1.055,2.4)},x=function(){var a,b,c,d,e,f;return f=G(arguments),c=f[0],b=f[1],a=f[2],e=c<<16|b<<8|a,d="000000"+e.toString(16),"#"+d.substr(d.length-6)},y=function(){var a,b,c,d,e,f,g,h,i;return i=G(arguments),g=i[0],c=i[1],b=i[2],a=2*Math.PI,g/=255,c/=255,b/=255,f=Math.min(g,c,b),e=(g+c+b)/3,h=1-f/e,0===h?d=0:(d=(g-c+(g-b))/2,d/=Math.sqrt((g-c)*(g-c)+(g-b)*(c-b)),d=Math.acos(d),b>c&&(d=a-d),d/=a),[360*d,h,e]},z=function(a,b,c){var d,e,f,g,h,i;return void 0!==a&&a.length>=3&&(i=a,a=i[0],b=i[1],c=i[2]),a/=255,b/=255,c/=255,g=Math.min(a,b,c),f=Math.max(a,b,c),e=(f+g)/2,f===g?(h=0,d=Number.NaN):h=e<.5?(f-g)/(f+g):(f-g)/(2-f-g),a===f?d=(b-c)/(f-g):b===f?d=2+(c-a)/(f-g):c===f&&(d=4+(a-b)/(f-g)),d*=60,d<0&&(d+=360),[d,h,e]},A=function(){var a,b,c,d,e,f,g,h,i,j;return j=G(arguments),g=j[0],c=j[1],a=j[2],f=Math.min(g,c,a),e=Math.max(g,c,a),b=e-f,i=e/255,0===e?(d=Number.NaN,h=0):(h=b/e,g===e&&(d=(c-a)/b),c===e&&(d=2+(a-g)/b),a===e&&(d=4+(g-c)/b),(d*=60)<0&&(d+=360)),[d,h,i]},B=function(){var a,b,c,g,h,i,j;return j=G(arguments),c=j[0],b=j[1],a=j[2],c=D(c),b=D(b),a=D(a),g=H((.4124564*c+.3575761*b+.1804375*a)/d),h=H((.2126729*c+.7151522*b+.072175*a)/e),i=H((.0193339*c+.119192*b+.9503041*a)/f),[116*h-16,500*(g-h),200*(h-i)]},D=function(a){return(a/=255)<=.04045?a/12.92:Math.pow((a+.055)/1.055,2.4)},H=function(a){return a>.008856?Math.pow(a,1/3):7.787037*a+4/29},C=function(){var a,b,c,d,e,f,g;return f=G(arguments),e=f[0],c=f[1],b=f[2],g=B(e,c,b),d=g[0],a=g[1],b=g[2],p(d,a,b)},h.scale=function(a,b){var c,d,e,f,g,i,j,k,l,m,n,o,p,q,r,s,t,u,v;return q="rgb",r=h("#ccc"),v=0,!1,n=[0,1],l=[],t=!1,u=[],p=0,o=1,m=!1,s=0,k={},g=function(a,b){var c,d,e,g,i,j,k;if(null==a&&(a=["#ddd","#222"]),null!=a&&"string"===F(a)&&null!=(null!=(i=h.brewer)?i[a]:void 0)&&(a=h.brewer[a]),"array"===F(a)){for(a=a.slice(0),c=e=0,j=a.length-1;0<=j?e<=j:e>=j;c=0<=j?++e:--e)d=a[c],"string"===F(d)&&(a[c]=h(d));if(null!=b)u=b;else for(u=[],c=g=0,k=a.length-1;0<=k?g<=k:g>=k;c=0<=k?++g:--g)u.push(c/(a.length-1))}return f(),l=a},i=function(a){return null==a&&(a=[]),n=a,p=a[0],o=a[a.length-1],f(),s=2===a.length?0:a.length-1},d=function(a){var b,c;if(null!=n){for(c=n.length-1,b=0;b<c&&a>=n[b];)b++;return b-1}return 0},j=function(a){return a},function(a){var b,c,e,f,g;return g=a,n.length>2&&(f=n.length-1,b=d(a),e=n[0]+(n[1]-n[0])*(0+.5*v),c=n[f-1]+(n[f]-n[f-1])*(1-.5*v),g=p+(n[b]+.5*(n[b+1]-n[b])-e)/(c-e)*(o-p)),g},e=function(a,b){var c,e,f,g,i,m,t,v;if(null==b&&(b=!1),isNaN(a))return r;if(b?m=a:n.length>2?(c=d(a),m=c/(s-1)):o!==p?(m=(a-p)/(o-p),m=Math.min(1,Math.max(0,m))):m=p,b||(m=j(m)),g=Math.floor(1e4*m),k[g])e=k[g];else{if("array"===F(l))for(f=t=0,v=u.length-1;0<=v?t<=v:t>=v;f=0<=v?++t:--t){if(i=u[f],m<=i){e=l[f];break}if(m>=i&&f===u.length-1){e=l[f];break}if(m>i&&m<u[f+1]){m=(m-i)/(u[f+1]-i),e=h.interpolate(l[f],l[f+1],m,q);break}}else"function"===F(l)&&(e=l(m));k[g]=e}return e},f=function(){return k={}},g(a,b),c=function(a){var b;return b=e(a),t&&b[t]?b[t]():b},c.domain=function(a,b,d,e){var f;return null==d&&(d="e"),arguments.length?(null!=b&&(f=h.analyze(a,e),a=0===b?[f.min,f.max]:h.limits(f,d,b)),i(a),c):n},c.mode=function(a){return arguments.length?(q=a,f(),c):q},c.range=function(a,b){return g(a,b),c},c.out=function(a){return t=a,c},c.spread=function(a){return arguments.length?(v=a,c):v},c.correctLightness=function(a){return arguments.length?(m=a,f(),j=m?function(a){var b,c,d,f,g,h,i,j,k;for(b=e(0,!0).lab()[0],c=e(1,!0).lab()[0],i=b>c,d=e(a,!0).lab()[0],g=b+(c-b)*a,f=d-g,j=0,k=1,h=20;Math.abs(f)>.01&&h-- >0;)!function(){i&&(f*=-1),f<0?(j=a,a+=.5*(k-a)):(k=a,a+=.5*(j-a)),d=e(a,!0).lab()[0],f=d-g}();return a}:function(a){return a},c):m},c.colors=function(b){var d,e,f,g,h,i;if(null==b&&(b="hex"),a=[],e=[],n.length>2)for(d=f=1,i=n.length;1<=i?f<i:f>i;d=1<=i?++f:--f)e.push(.5*(n[d-1]+n[d]));else e=n;for(g=0,h=e.length;g<h;g++)d=e[g],a.push(c(d)[b]());return a},c},null==h.scales&&(h.scales={}),h.scales.cool=function(){return h.scale([h.hsl(180,1,.9),h.hsl(250,.7,.4)])},h.scales.hot=function(){return h.scale(["#000","#f00","#ff0","#fff"],[0,.25,.75,1]).mode("rgb")},h.analyze=function(a,b,c){var d,e,f,g,i,j,k;if(f={min:Number.MAX_VALUE,max:-1*Number.MAX_VALUE,sum:0,values:[],count:0},null==c&&(c=function(){return!0}),d=function(a){null==a||isNaN(a)||(f.values.push(a),f.sum+=a,a<f.min&&(f.min=a),a>f.max&&(f.max=a),f.count+=1)},i=function(a,e){if(c(a,e))return d(null!=b&&"function"===F(b)?b(a):null!=b&&"string"===F(b)||"number"===F(b)?a[b]:a)},"array"===F(a))for(j=0,k=a.length;j<k;j++)g=a[j],i(g);else for(e in a)g=a[e],i(g,e);return f.domain=[f.min,f.max],f.limits=function(a,b){return h.limits(f,a,b)},f},h.limits=function(a,b,c){var d,e,f,g,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa;if(null==b&&(b="equal"),null==c&&(c=7),"array"===F(a)&&(a=h.analyze(a)),q=a.min,o=a.max,a.sum,C=a.values.sort(function(a,b){return a-b}),n=[],"c"===b.substr(0,1)&&(n.push(q),n.push(o)),"e"===b.substr(0,1)){for(n.push(q),k=D=1,O=c-1;1<=O?D<=O:D>=O;k=1<=O?++D:--D)n.push(q+k/c*(o-q));n.push(o)}else if("l"===b.substr(0,1)){if(q<=0)throw"Logarithmic scales are only possible for values > 0";for(r=Math.LOG10E*Math.log(q),p=Math.LOG10E*Math.log(o),n.push(q),k=E=1,V=c-1;1<=V?E<=V:E>=V;k=1<=V?++E:--E)n.push(Math.pow(10,r+k/c*(p-r)));n.push(o)}else if("q"===b.substr(0,1)){for(n.push(q),k=G=1,W=c-1;1<=W?G<=W:G>=W;k=1<=W?++G:--G)w=C.length*k/c,x=Math.floor(w),x===w?n.push(C[x]):(y=w-x,n.push(C[x]*y+C[x+1]*(1-y)));n.push(o)}else if("k"===b.substr(0,1)){for(t=C.length,d=new Array(t),i=new Array(c),z=!0,u=0,f=null,f=[],f.push(q),k=H=1,X=c-1;1<=X?H<=X:H>=X;k=1<=X?++H:--H)f.push(q+k/c*(o-q));for(f.push(o);z;){for(l=I=0,Y=c-1;0<=Y?I<=Y:I>=Y;l=0<=Y?++I:--I)i[l]=0;for(k=J=0,Z=t-1;0<=Z?J<=Z:J>=Z;k=0<=Z?++J:--J){for(B=C[k],s=Number.MAX_VALUE,l=K=0,$=c-1;0<=$?K<=$:K>=$;l=0<=$?++K:--K)(j=Math.abs(f[l]-B))<s&&(s=j,e=l);i[e]++,d[k]=e}for(v=new Array(c),l=L=0,_=c-1;0<=_?L<=_:L>=_;l=0<=_?++L:--L)v[l]=null;for(k=M=0,aa=t-1;0<=aa?M<=aa:M>=aa;k=0<=aa?++M:--M)g=d[k],null===v[g]?v[g]=C[k]:v[g]+=C[k];for(l=N=0,P=c-1;0<=P?N<=P:N>=P;l=0<=P?++N:--N)v[l]*=1/i[l];for(z=!1,l=ba=0,Q=c-1;0<=Q?ba<=Q:ba>=Q;l=0<=Q?++ba:--ba)if(v[l]!==f[k]){z=!0;break}f=v,u++,u>200&&(z=!1)}for(m={},l=ca=0,R=c-1;0<=R?ca<=R:ca>=R;l=0<=R?++ca:--ca)m[l]=[];for(k=da=0,S=t-1;0<=S?da<=S:da>=S;k=0<=S?++da:--da)g=d[k],m[g].push(C[k]);for(A=[],l=ea=0,T=c-1;0<=T?ea<=T:ea>=T;l=0<=T?++ea:--ea)A.push(m[l][0]),A.push(m[l][m[l].length-1]);for(A=A.sort(function(a,b){return a-b}),n.push(A[0]),k=fa=1,U=A.length-1;fa<=U;k=fa+=2)isNaN(A[k])||n.push(A[k])}return n},h.brewer={OrRd:["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"],PuBu:["#fff7fb","#ece7f2","#d0d1e6","#a6bddb","#74a9cf","#3690c0","#0570b0","#045a8d","#023858"],BuPu:["#f7fcfd","#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#8c6bb1","#88419d","#810f7c","#4d004b"],Oranges:["#fff5eb","#fee6ce","#fdd0a2","#fdae6b","#fd8d3c","#f16913","#d94801","#a63603","#7f2704"],BuGn:["#f7fcfd","#e5f5f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b"],YlOrBr:["#ffffe5","#fff7bc","#fee391","#fec44f","#fe9929","#ec7014","#cc4c02","#993404","#662506"],YlGn:["#ffffe5","#f7fcb9","#d9f0a3","#addd8e","#78c679","#41ab5d","#238443","#006837","#004529"],Reds:["#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#a50f15","#67000d"],RdPu:["#fff7f3","#fde0dd","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177","#49006a"],Greens:["#f7fcf5","#e5f5e0","#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#006d2c","#00441b"],YlGnBu:["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"],Purples:["#fcfbfd","#efedf5","#dadaeb","#bcbddc","#9e9ac8","#807dba","#6a51a3","#54278f","#3f007d"],GnBu:["#f7fcf0","#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"],Greys:["#ffffff","#f0f0f0","#d9d9d9","#bdbdbd","#969696","#737373","#525252","#252525","#000000"],YlOrRd:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"],PuRd:["#f7f4f9","#e7e1ef","#d4b9da","#c994c7","#df65b0","#e7298a","#ce1256","#980043","#67001f"],Blues:["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],PuBuGn:["#fff7fb","#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a","#016c59","#014636"],Spectral:["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#ffffbf","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2"],RdYlGn:["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"],RdBu:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac","#053061"],PiYG:["#8e0152","#c51b7d","#de77ae","#f1b6da","#fde0ef","#f7f7f7","#e6f5d0","#b8e186","#7fbc41","#4d9221","#276419"],PRGn:["#40004b","#762a83","#9970ab","#c2a5cf","#e7d4e8","#f7f7f7","#d9f0d3","#a6dba0","#5aae61","#1b7837","#00441b"],RdYlBu:["#a50026","#d73027","#f46d43","#fdae61","#fee090","#ffffbf","#e0f3f8","#abd9e9","#74add1","#4575b4","#313695"],BrBG:["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#f5f5f5","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"],RdGy:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#ffffff","#e0e0e0","#bababa","#878787","#4d4d4d","#1a1a1a"],PuOr:["#7f3b08","#b35806","#e08214","#fdb863","#fee0b6","#f7f7f7","#d8daeb","#b2abd2","#8073ac","#542788","#2d004b"],Set2:["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3"],Accent:["#7fc97f","#beaed4","#fdc086","#ffff99","#386cb0","#f0027f","#bf5b17","#666666"],Set1:["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"],Set3:["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"],Dark2:["#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#a6761d","#666666"],Paired:["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928"],Pastel2:["#b3e2cd","#fdcdac","#cbd5e8","#f4cae4","#e6f5c9","#fff2ae","#f1e2cc","#cccccc"],Pastel1:["#fbb4ae","#b3cde3","#ccebc5","#decbe4","#fed9a6","#ffffcc","#e5d8bd","#fddaec","#f2f2f2"]},h.colors={indigo:"#4b0082",gold:"#ffd700",hotpink:"#ff69b4",firebrick:"#b22222",indianred:"#cd5c5c",yellow:"#ffff00",mistyrose:"#ffe4e1",darkolivegreen:"#556b2f",olive:"#808000",darkseagreen:"#8fbc8f",pink:"#ffc0cb",tomato:"#ff6347",lightcoral:"#f08080",orangered:"#ff4500",navajowhite:"#ffdead",lime:"#00ff00",palegreen:"#98fb98",darkslategrey:"#2f4f4f",greenyellow:"#adff2f",burlywood:"#deb887",seashell:"#fff5ee",mediumspringgreen:"#00fa9a",fuchsia:"#ff00ff",papayawhip:"#ffefd5",blanchedalmond:"#ffebcd",chartreuse:"#7fff00",dimgray:"#696969",black:"#000000",peachpuff:"#ffdab9",springgreen:"#00ff7f",aquamarine:"#7fffd4",white:"#ffffff",orange:"#ffa500",lightsalmon:"#ffa07a",darkslategray:"#2f4f4f",brown:"#a52a2a",ivory:"#fffff0",dodgerblue:"#1e90ff",peru:"#cd853f",lawngreen:"#7cfc00",chocolate:"#d2691e",crimson:"#dc143c",forestgreen:"#228b22",darkgrey:"#a9a9a9",lightseagreen:"#20b2aa",cyan:"#00ffff",mintcream:"#f5fffa",silver:"#c0c0c0",antiquewhite:"#faebd7",mediumorchid:"#ba55d3",skyblue:"#87ceeb",gray:"#808080",darkturquoise:"#00ced1",goldenrod:"#daa520",darkgreen:"#006400",floralwhite:"#fffaf0",darkviolet:"#9400d3",darkgray:"#a9a9a9",moccasin:"#ffe4b5",saddlebrown:"#8b4513",grey:"#808080",darkslateblue:"#483d8b",lightskyblue:"#87cefa",lightpink:"#ffb6c1",mediumvioletred:"#c71585",slategrey:"#708090",red:"#ff0000",deeppink:"#ff1493",limegreen:"#32cd32",darkmagenta:"#8b008b",palegoldenrod:"#eee8aa",plum:"#dda0dd",turquoise:"#40e0d0",lightgrey:"#d3d3d3",lightgoldenrodyellow:"#fafad2",darkgoldenrod:"#b8860b",lavender:"#e6e6fa",maroon:"#800000",yellowgreen:"#9acd32",sandybrown:"#f4a460",thistle:"#d8bfd8",violet:"#ee82ee",navy:"#000080",magenta:"#ff00ff",dimgrey:"#696969",tan:"#d2b48c",rosybrown:"#bc8f8f",olivedrab:"#6b8e23",blue:"#0000ff",lightblue:"#add8e6",ghostwhite:"#f8f8ff",honeydew:"#f0fff0",cornflowerblue:"#6495ed",slateblue:"#6a5acd",linen:"#faf0e6",darkblue:"#00008b",powderblue:"#b0e0e6",seagreen:"#2e8b57",darkkhaki:"#bdb76b",snow:"#fffafa",sienna:"#a0522d",mediumblue:"#0000cd",royalblue:"#4169e1",lightcyan:"#e0ffff",green:"#008000",mediumpurple:"#9370db",midnightblue:"#191970",cornsilk:"#fff8dc",paleturquoise:"#afeeee",bisque:"#ffe4c4",slategray:"#708090",darkcyan:"#008b8b",khaki:"#f0e68c",wheat:"#f5deb3",teal:"#008080",darkorchid:"#9932cc",deepskyblue:"#00bfff",salmon:"#fa8072",darkred:"#8b0000",steelblue:"#4682b4",palevioletred:"#db7093",lightslategray:"#778899",aliceblue:"#f0f8ff",lightslategrey:"#778899",lightgreen:"#90ee90",orchid:"#da70d6",gainsboro:"#dcdcdc",mediumseagreen:"#3cb371",lightgray:"#d3d3d3",mediumturquoise:"#48d1cc",lemonchiffon:"#fffacd",cadetblue:"#5f9ea0",lightyellow:"#ffffe0",lavenderblush:"#fff0f5",coral:"#ff7f50",purple:"#800080",aqua:"#00ffff",whitesmoke:"#f5f5f5",mediumslateblue:"#7b68ee",darkorange:"#ff8c00",mediumaquamarine:"#66cdaa",darksalmon:"#e9967a",beige:"#f5f5dc",blueviolet:"#8a2be2",azure:"#f0ffff",lightsteelblue:"#b0c4de",oldlace:"#fdf5e6"},F=function(){var a,b,c,d,e;for(a={},e="Boolean Number String Function Array Date RegExp Undefined Null".split(" "),c=0,d=e.length;c<d;c++)b=e[c],a["[object "+b+"]"]=b.toLowerCase();return function(b){var c;return c=Object.prototype.toString.call(b),a[c]||"object"}}(),u=function(a,b,c){return null==b&&(b=0),null==c&&(c=1),a<b&&(a=b),a>c&&(a=c),a},G=function(a){return a.length>=3?a:a[0]},c=2*Math.PI,b=Math.PI/3,j=Math.cos,g=function(a){var b,c,d,e,f,i,j,k,l,m,n;return a=function(){var b,c,d;for(d=[],b=0,c=a.length;b<c;b++)e=a[b],d.push(h(e));return d}(),2===a.length?(l=function(){var b,c,d;for(d=[],b=0,c=a.length;b<c;b++)e=a[b],d.push(e.lab());return d}(),f=l[0],i=l[1],b=function(a){var b,c;return c=function(){var c,d;for(d=[],b=c=0;c<=2;b=++c)d.push(f[b]+a*(i[b]-f[b]));return d}(),h.lab.apply(h,c)}):3===a.length?(m=function(){var b,c,d;for(d=[],b=0,c=a.length;b<c;b++)e=a[b],d.push(e.lab());return d}(),f=m[0],i=m[1],j=m[2],b=function(a){var b,c;return c=function(){var c,d;for(d=[],b=c=0;c<=2;b=++c)d.push((1-a)*(1-a)*f[b]+2*(1-a)*a*i[b]+a*a*j[b]);return d}(),h.lab.apply(h,c)}):4===a.length?(n=function(){var b,c,d;for(d=[],b=0,c=a.length;b<c;b++)e=a[b],d.push(e.lab());return d}(),f=n[0],i=n[1],j=n[2],k=n[3],b=function(a){var b,c;return c=function(){var c,d;for(d=[],b=c=0;c<=2;b=++c)d.push((1-a)*(1-a)*(1-a)*f[b]+3*(1-a)*(1-a)*a*i[b]+3*(1-a)*a*a*j[b]+a*a*a*k[b]);return d}(),h.lab.apply(h,c)}):5===a.length&&(c=g(a.slice(0,3)),d=g(a.slice(2,5)),b=function(a){return a<.5?c(2*a):d(2*(a-.5))}),b},h.interpolate.bezier=g}.call(this),function(a){var b={},c=b.hasOwnProperty,d=function(a,b){var d;for(d in a)c.call(a,d)&&b(d,a[d])},e=function(a,b){return b?(d(b,function(b,c){a[b]=c}),a):a},f=/["'\\\b\f\n\r\t]/,g=/[ !#-&\(-\[\]-~]/,h=function(a,b){var c={es6:!1,json:!1},d=b&&b.json;b=e(c,b);var h,i,j,k,l=a,m=-1,n=l.length;for(h="";++m<n;){var o=l.charAt(m);if(b.es6&&(i=l.charCodeAt(m))>=55296&&i<=56319&&n>m+1&&(j=l.charCodeAt(m+1))>=56320&&j<=57343)k=1024*(i-55296)+j-56320+65536,h+="\\u{"+k.toString(16).toUpperCase()+"}",m++;else if(g.test(o))h+=o;else if('"'!=o)if("'"!=o)if(f.test(o))h+=o;else{var p=o.charCodeAt(0),q=p.toString(16).toUpperCase(),r=q.length>2||d,s="\\"+(r?"u":"x")+("0000"+q).slice(r?-4:-2);h+=s}else h+=o;else h+=o}return h};h.version="0.5.0",a.jsesc=h}(this),function(a){var b=function(){"use strict";var a="s",c=function(a){var b=-a.getTimezoneOffset();return null!==b?b:0},d=function(a,b,c){var d=new Date;return void 0!==a&&d.setFullYear(a),d.setMonth(b),d.setDate(c),d},e=function(a){return c(d(a,0,2))},f=function(a){return c(d(a,5,2))},g=function(a){var b=a.getMonth()>7,d=b?f(a.getFullYear()):e(a.getFullYear()),g=c(a),h=d<0,i=d-g;return h||b?0!==i:i<0},h=function(){var b=e(),c=f(),d=b-c;return d<0?b+",1":d>0?c+",1,"+a:b+",0"};return{determine:function(){var a=h();return new b.TimeZone(b.olson.timezones[a])},date_is_dst:g,dst_start_for:function(a){var b=new Date(2010,6,15,1,0,0,0);return{"America/Denver":new Date(2011,2,13,3,0,0,0),"America/Mazatlan":new Date(2011,3,3,3,0,0,0),"America/Chicago":new Date(2011,2,13,3,0,0,0),"America/Mexico_City":new Date(2011,3,3,3,0,0,0),"America/Asuncion":new Date(2012,9,7,3,0,0,0),"America/Santiago":new Date(2012,9,3,3,0,0,0),"America/Campo_Grande":new Date(2012,9,21,5,0,0,0),"America/Montevideo":new Date(2011,9,2,3,0,0,0),"America/Sao_Paulo":new Date(2011,9,16,5,0,0,0),"America/Los_Angeles":new Date(2011,2,13,8,0,0,0),"America/Santa_Isabel":new Date(2011,3,5,8,0,0,0),"America/Havana":new Date(2012,2,10,2,0,0,0),"America/New_York":new Date(2012,2,10,7,0,0,0),"Europe/Helsinki":new Date(2013,2,31,5,0,0,0),"Pacific/Auckland":new Date(2011,8,26,7,0,0,0),"America/Halifax":new Date(2011,2,13,6,0,0,0),"America/Goose_Bay":new Date(2011,2,13,2,1,0,0),"America/Miquelon":new Date(2011,2,13,5,0,0,0),"America/Godthab":new Date(2011,2,27,1,0,0,0),"Europe/Moscow":b,"Asia/Amman":new Date(2013,2,29,1,0,0,0),"Asia/Beirut":new Date(2013,2,31,2,0,0,0),"Asia/Damascus":new Date(2013,3,6,2,0,0,0),"Asia/Jerusalem":new Date(2013,2,29,5,0,0,0),"Asia/Yekaterinburg":b,"Asia/Omsk":b,"Asia/Krasnoyarsk":b,"Asia/Irkutsk":b,"Asia/Yakutsk":b,"Asia/Vladivostok":b,"Asia/Baku":new Date(2013,2,31,4,0,0),"Asia/Yerevan":new Date(2013,2,31,3,0,0),"Asia/Kamchatka":b,"Asia/Gaza":new Date(2010,2,27,4,0,0),"Africa/Cairo":new Date(2010,4,1,3,0,0),"Europe/Minsk":b,"Pacific/Apia":new Date(2010,10,1,1,0,0,0),"Pacific/Fiji":new Date(2010,11,1,0,0,0),"Australia/Perth":new Date(2008,10,1,1,0,0,0)}[a]}}}();b.TimeZone=function(a){"use strict";var c={"America/Denver":["America/Denver","America/Mazatlan"],"America/Chicago":["America/Chicago","America/Mexico_City"],"America/Santiago":["America/Santiago","America/Asuncion","America/Campo_Grande"],"America/Montevideo":["America/Montevideo","America/Sao_Paulo"],"Asia/Beirut":["Asia/Amman","Asia/Jerusalem","Asia/Beirut","Europe/Helsinki","Asia/Damascus"],"Pacific/Auckland":["Pacific/Auckland","Pacific/Fiji"],"America/Los_Angeles":["America/Los_Angeles","America/Santa_Isabel"],"America/New_York":["America/Havana","America/New_York"],"America/Halifax":["America/Goose_Bay","America/Halifax"],"America/Godthab":["America/Miquelon","America/Godthab"],"Asia/Dubai":["Europe/Moscow"],"Asia/Dhaka":["Asia/Yekaterinburg"],"Asia/Jakarta":["Asia/Omsk"],"Asia/Shanghai":["Asia/Krasnoyarsk","Australia/Perth"],"Asia/Tokyo":["Asia/Irkutsk"],"Australia/Brisbane":["Asia/Yakutsk"],"Pacific/Noumea":["Asia/Vladivostok"],"Pacific/Tarawa":["Asia/Kamchatka","Pacific/Fiji"],"Pacific/Tongatapu":["Pacific/Apia"],"Asia/Baghdad":["Europe/Minsk"],"Asia/Baku":["Asia/Yerevan","Asia/Baku"],"Africa/Johannesburg":["Asia/Gaza","Africa/Cairo"]},d=a,e=function(){for(var a=c[d],e=a.length,f=0,g=a[0];f<e;f+=1)if(g=a[f],b.date_is_dst(b.dst_start_for(g)))return void(d=g)};return function(){return void 0!==c[d]}()&&e(),{name:function(){return d}}},b.olson={},b.olson.timezones={"-720,0":"Pacific/Majuro","-660,0":"Pacific/Pago_Pago","-600,1":"America/Adak","-600,0":"Pacific/Honolulu","-570,0":"Pacific/Marquesas","-540,0":"Pacific/Gambier","-540,1":"America/Anchorage","-480,1":"America/Los_Angeles","-480,0":"Pacific/Pitcairn","-420,0":"America/Phoenix","-420,1":"America/Denver","-360,0":"America/Guatemala","-360,1":"America/Chicago","-360,1,s":"Pacific/Easter","-300,0":"America/Bogota","-300,1":"America/New_York","-270,0":"America/Caracas","-240,1":"America/Halifax","-240,0":"America/Santo_Domingo","-240,1,s":"America/Santiago","-210,1":"America/St_Johns","-180,1":"America/Godthab","-180,0":"America/Argentina/Buenos_Aires","-180,1,s":"America/Montevideo","-120,0":"America/Noronha","-120,1":"America/Noronha","-60,1":"Atlantic/Azores","-60,0":"Atlantic/Cape_Verde","0,0":"UTC","0,1":"Europe/London","60,1":"Europe/Berlin","60,0":"Africa/Lagos","60,1,s":"Africa/Windhoek","120,1":"Asia/Beirut","120,0":"Africa/Johannesburg","180,0":"Asia/Baghdad","180,1":"Europe/Moscow","210,1":"Asia/Tehran","240,0":"Asia/Dubai","240,1":"Asia/Baku","270,0":"Asia/Kabul","300,1":"Asia/Yekaterinburg","300,0":"Asia/Karachi","330,0":"Asia/Kolkata","345,0":"Asia/Kathmandu","360,0":"Asia/Dhaka","360,1":"Asia/Omsk","390,0":"Asia/Rangoon","420,1":"Asia/Krasnoyarsk","420,0":"Asia/Jakarta","480,0":"Asia/Shanghai","480,1":"Asia/Irkutsk","525,0":"Australia/Eucla","525,1,s":"Australia/Eucla","540,1":"Asia/Yakutsk","540,0":"Asia/Tokyo","570,0":"Australia/Darwin","570,1,s":"Australia/Adelaide","600,0":"Australia/Brisbane","600,1":"Asia/Vladivostok","600,1,s":"Australia/Sydney","630,1,s":"Australia/Lord_Howe","660,1":"Asia/Kamchatka","660,0":"Pacific/Noumea","690,0":"Pacific/Norfolk","720,1,s":"Pacific/Auckland","720,0":"Pacific/Tarawa","765,1,s":"Pacific/Chatham","780,0":"Pacific/Tongatapu","780,1,s":"Pacific/Apia","840,0":"Pacific/Kiritimati"},"undefined"!=typeof exports?exports.jstz=b:a.jstz=b}(this),LazyLoad=function(a){function b(b,c){var d,e=a.createElement(b);for(d in c)c.hasOwnProperty(d)&&e.setAttribute(d,c[d]);return e}function c(a){var b,c,d=j[a];d&&(b=d.callback,c=d.urls,c.shift(),k=0,c.length||(b&&b.call(d.context,d.obj),j[a]=null,l[a].length&&e(a)))}function d(){var b=navigator.userAgent;h={async:!0===a.createElement("script").async},(h.webkit=/AppleWebKit\//.test(b))||(h.ie=/MSIE|Trident/.test(b))||(h.opera=/Opera/.test(b))||(h.gecko=/Gecko\//.test(b))||(h.unknown=!0)}function e(e,k,m,n,o){var p,q,r,s,t,u,v=function(){c(e)},w="css"===e,x=[];if(h||d(),k)if(k="string"==typeof k?[k]:k.concat(),w||h.async||h.gecko||h.opera)l[e].push({urls:k,callback:m,obj:n,context:o});else for(p=0,q=k.length;p<q;++p)l[e].push({urls:[k[p]],callback:p===q-1?m:null,obj:n,context:o});if(!j[e]&&(s=j[e]=l[e].shift())){for(i||(i=a.head||a.getElementsByTagName("head")[0]),t=s.urls.concat(),p=0,q=t.length;p<q;++p)u=t[p],w?r=h.gecko?b("style"):b("link",{href:u,rel:"stylesheet"}):(r=b("script",{src:u}),r.async=!1),r.className="lazyload",r.setAttribute("charset","utf-8"),h.ie&&!w&&"onreadystatechange"in r&&!("draggable"in r)?r.onreadystatechange=function(){/loaded|complete/.test(r.readyState)&&(r.onreadystatechange=null,v())}:w&&(h.gecko||h.webkit)?h.webkit?(s.urls[p]=r.href,g()):(r.innerHTML='@import "'+u+'";',f(r)):r.onload=r.onerror=v,x.push(r);for(p=0,q=x.length;p<q;++p)i.appendChild(x[p])}}function f(a){var b;try{b=!!a.sheet.cssRules}catch(d){return k+=1,void(k<200?setTimeout(function(){f(a)},50):b&&c("css"))}c("css")}function g(){var a,b=j.css;if(b){for(a=m.length;--a>=0;)if(m[a].href===b.urls[0]){c("css");break}k+=1,b&&(k<200?setTimeout(g,50):c("css"))}}var h,i,j={},k=0,l={css:[],js:[]},m=a.styleSheets;return{css:function(a,b,c,d){e("css",a,b,c,d)},js:function(a,b,c,d){e("js",a,b,c,d)}}}(this.document),window.Modernizr=function(a,b,c){function d(a){n.cssText=a}function e(a,b){return typeof a===b}var f,g,h="2.8.3",i={},j=!0,k=b.documentElement,l="modernizr",m=b.createElement(l),n=m.style,o=({}.toString,{svg:"http://www.w3.org/2000/svg"}),p={},q=[],r=q.slice,s={}.hasOwnProperty;g=e(s,"undefined")||e(s.call,"undefined")?function(a,b){return b in a&&e(a.constructor.prototype[b],"undefined")}:function(a,b){return s.call(a,b)},Function.prototype.bind||(Function.prototype.bind=function(a){var b=this;if("function"!=typeof b)throw new TypeError;var c=r.call(arguments,1),d=function(){if(this instanceof d){var e=function(){};e.prototype=b.prototype;var f=new e,g=b.apply(f,c.concat(r.call(arguments)));return Object(g)===g?g:f}return b.apply(a,c.concat(r.call(arguments)))};return d}),p.geolocation=function(){return"geolocation"in navigator},p.svg=function(){return!!b.createElementNS&&!!b.createElementNS(o.svg,"svg").createSVGRect},p.inlinesvg=function(){var a=b.createElement("div");return a.innerHTML="<svg/>",(a.firstChild&&a.firstChild.namespaceURI)==o.svg};for(var t in p)g(p,t)&&(f=t.toLowerCase(),i[f]=p[t](),q.push((i[f]?"":"no-")+f));return i.addTest=function(a,b){if("object"==typeof a)for(var d in a)g(a,d)&&i.addTest(d,a[d]);else{if(a=a.toLowerCase(),i[a]!==c)return i;b="function"==typeof b?b():b,void 0!==j&&j&&(k.className+=" "+(b?"":"no-")+a),i[a]=b}return i},d(""),m=null,function(a,b){function c(a,b){var c=a.createElement("p"),d=a.getElementsByTagName("head")[0]||a.documentElement;return c.innerHTML="x<style>"+b+"</style>",d.insertBefore(c.lastChild,d.firstChild)}function d(){var a=s.elements;return"string"==typeof a?a.split(" "):a}function e(a){var b=r[a[p]];return b||(b={},q++,a[p]=q,r[q]=b),b}function f(a,c,d){if(c||(c=b),k)return c.createElement(a);d||(d=e(c));var f;return f=d.cache[a]?d.cache[a].cloneNode():o.test(a)?(d.cache[a]=d.createElem(a)).cloneNode():d.createElem(a),!f.canHaveChildren||n.test(a)||f.tagUrn?f:d.frag.appendChild(f)}function g(a,c){if(a||(a=b),k)return a.createDocumentFragment();c=c||e(a);for(var f=c.frag.cloneNode(),g=0,h=d(),i=h.length;g<i;g++)f.createElement(h[g]);return f}function h(a,b){b.cache||(b.cache={},b.createElem=a.createElement,b.createFrag=a.createDocumentFragment,b.frag=b.createFrag()),a.createElement=function(c){return s.shivMethods?f(c,a,b):b.createElem(c)},a.createDocumentFragment=Function("h,f","return function(){var n=f.cloneNode(),c=n.createElement;h.shivMethods&&("+d().join().replace(/[\w\-]+/g,function(a){return b.createElem(a),b.frag.createElement(a),'c("'+a+'")'})+");return n}")(s,b.frag)}function i(a){a||(a=b);var d=e(a);return!s.shivCSS||j||d.hasCSS||(d.hasCSS=!!c(a,"article,aside,dialog,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}mark{background:#FF0;color:#000}template{display:none}")),k||h(a,d),a}var j,k,l="3.7.0",m=a.html5||{},n=/^<|^(?:button|map|select|textarea|object|iframe|option|optgroup)$/i,o=/^(?:a|b|code|div|fieldset|h1|h2|h3|h4|h5|h6|i|label|li|ol|p|q|span|strong|style|table|tbody|td|th|tr|ul)$/i,p="_html5shiv",q=0,r={};!function(){try{var a=b.createElement("a");a.innerHTML="<xyz></xyz>",j="hidden"in a,k=1==a.childNodes.length||function(){b.createElement("a");var a=b.createDocumentFragment();return void 0===a.cloneNode||void 0===a.createDocumentFragment||void 0===a.createElement}()}catch(a){j=!0,k=!0}}();var s={elements:m.elements||"abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video",version:l,shivCSS:!1!==m.shivCSS,supportsUnknownElements:k,shivMethods:!1!==m.shivMethods,type:"default",shivDocument:i,createElement:f,createDocumentFragment:g};a.html5=s,i(b)}(this,b),i._version=h,k.className=k.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+(j?" js "+q.join(" "):""),i}(0,this.document),function(a,b,c){function d(a){return"[object Function]"==q.call(a)}function e(a){return"string"==typeof a}function f(){}function g(a){return!a||"loaded"==a||"complete"==a||"uninitialized"==a}function h(){var a=r.shift();s=1,a?a.t?o(function(){("c"==a.t?m.injectCss:m.injectJs)(a.s,0,a.a,a.x,a.e,1)},0):(a(),h()):s=0}function i(a,c,d,e,f,i,j){function k(b){if(!n&&g(l.readyState)&&(t.r=n=1,!s&&h(),l.onload=l.onreadystatechange=null,b)){"img"!=a&&o(function(){v.removeChild(l)},50);for(var d in A[c])A[c].hasOwnProperty(d)&&A[c][d].onload()}}var j=j||m.errorTimeout,l=b.createElement(a),n=0,q=0,t={t:d,s:c,e:f,a:i,x:j};1===A[c]&&(q=1,A[c]=[]),"object"==a?l.data=c:(l.src=c,l.type=a),l.width=l.height="0",l.onerror=l.onload=l.onreadystatechange=function(){k.call(this,q)},r.splice(e,0,t),"img"!=a&&(q||2===A[c]?(v.insertBefore(l,u?null:p),o(k,j)):A[c].push(l))}function j(a,b,c,d,f){return s=0,b=b||"j",e(a)?i("c"==b?x:w,a,b,this.i++,c,d,f):(r.splice(this.i++,0,a),1==r.length&&h()),this}function k(){var a=m;return a.loader={load:j,i:0},a}var l,m,n=b.documentElement,o=a.setTimeout,p=b.getElementsByTagName("script")[0],q={}.toString,r=[],s=0,t="MozAppearance"in n.style,u=t&&!!b.createRange().compareNode,v=u?n:p.parentNode,n=a.opera&&"[object Opera]"==q.call(a.opera),n=!!b.attachEvent&&!n,w=t?"object":n?"script":"img",x=n?"script":w,y=Array.isArray||function(a){return"[object Array]"==q.call(a)},z=[],A={},B={timeout:function(a,b){return b.length&&(a.timeout=b[0]),a}};m=function(a){function b(a){var b,c,d,a=a.split("!"),e=z.length,f=a.pop(),g=a.length,f={url:f,origUrl:f,prefixes:a};for(c=0;c<g;c++)d=a[c].split("="),(b=B[d.shift()])&&(f=b(f,d));for(c=0;c<e;c++)f=z[c](f);return f}function g(a,e,f,g,h){var i=b(a),j=i.autoCallback;i.url.split(".").pop().split("?").shift(),i.bypass||(e&&(e=d(e)?e:e[a]||e[g]||e[a.split("/").pop().split("?")[0]]),i.instead?i.instead(a,e,f,g,h):(A[i.url]?i.noexec=!0:A[i.url]=1,f.load(i.url,i.forceCSS||!i.forceJS&&"css"==i.url.split(".").pop().split("?").shift()?"c":c,i.noexec,i.attrs,i.timeout),(d(e)||d(j))&&f.load(function(){k(),e&&e(i.origUrl,h,g),j&&j(i.origUrl,h,g),A[i.url]=2})))}function h(a,b){function c(a,c){if(a){if(e(a))c||(l=function(){var a=[].slice.call(arguments);m.apply(this,a),n()}),g(a,l,b,0,j);else if(Object(a)===a)for(i in h=function(){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c}(),a)a.hasOwnProperty(i)&&(!c&&!--h&&(d(l)?l=function(){var a=[].slice.call(arguments);m.apply(this,a),n()}:l[i]=function(a){return function(){var b=[].slice.call(arguments);a&&a.apply(this,b),n()}}(m[i])),g(a[i],l,b,i,j))}else!c&&n()}var h,i,j=!!a.test,k=a.load||a.both,l=a.callback||f,m=l,n=a.complete||f;c(j?a.yep:a.nope,!!k),k&&c(k)}var i,j,l=this.yepnope.loader;if(e(a))g(a,0,l,0);else if(y(a))for(i=0;i<a.length;i++)j=a[i],e(j)?g(j,0,l,0):y(j)?m(j):Object(j)===j&&h(j,l);else Object(a)===a&&h(a,l)},m.addPrefix=function(a,b){B[a]=b},m.addFilter=function(a){z.push(a)},m.errorTimeout=1e4,null==b.readyState&&b.addEventListener&&(b.readyState="loading",b.addEventListener("DOMContentLoaded",l=function(){b.removeEventListener("DOMContentLoaded",l,0),b.readyState="complete"},0)),a.yepnope=k(),a.yepnope.executeStack=h,a.yepnope.injectJs=function(a,c,d,e,i,j){var k,l,n=b.createElement("script"),e=e||m.errorTimeout;n.src=a;for(l in d)n.setAttribute(l,d[l]);c=j?h:c||f,n.onreadystatechange=n.onload=function(){!k&&g(n.readyState)&&(k=1,c(),n.onload=n.onreadystatechange=null)},o(function(){k||(k=1,c(1))},e),i?n.onload():p.parentNode.insertBefore(n,p)},a.yepnope.injectCss=function(a,c,d,e,g,i){var j,e=b.createElement("link"),c=i?h:c||f;e.href=a,e.rel="stylesheet",e.type="text/css";for(j in d)e.setAttribute(j,d[j]);g||(p.parentNode.insertBefore(e,p),o(c,0))}}(this,document),Modernizr.load=function(){yepnope.apply(window,[].slice.call(arguments,0))},Modernizr.addTest("cors",!!(window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest)),function(a){function b(a,b,c){switch(arguments.length){case 2:return null!=a?a:b;case 3:return null!=a?a:null!=b?b:c;default:throw new Error("Implement me")}}function c(){return{empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1}}function d(a,b){function c(){!1===pa.suppressDeprecationWarnings&&"undefined"!=typeof console&&console.warn&&console.warn("Deprecation warning: "+a)}var d=!0;return j(function(){return d&&(c(),d=!1),b.apply(this,arguments)},b)}function e(a,b){return function(c){return m(a.call(this,c),b)}}function f(a,b){return function(c){return this.lang().ordinal(a.call(this,c),b)}}function g(){}function h(a){B(a),j(this,a)}function i(a){var b=u(a),c=b.year||0,d=b.quarter||0,e=b.month||0,f=b.week||0,g=b.day||0,h=b.hour||0,i=b.minute||0,j=b.second||0,k=b.millisecond||0;this._milliseconds=+k+1e3*j+6e4*i+36e5*h,this._days=+g+7*f,this._months=+e+3*d+12*c,this._data={},this._bubble()}function j(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return b.hasOwnProperty("toString")&&(a.toString=b.toString),b.hasOwnProperty("valueOf")&&(a.valueOf=b.valueOf),a}function k(a){var b,c={};for(b in a)a.hasOwnProperty(b)&&Da.hasOwnProperty(b)&&(c[b]=a[b]);return c}function l(a){return a<0?Math.ceil(a):Math.floor(a)}function m(a,b,c){for(var d=""+Math.abs(a),e=a>=0;d.length<b;)d="0"+d;return(e?c?"+":"":"-")+d}function n(a,b){var c={milliseconds:0,months:0};return c.months=b.month()-a.month()+12*(b.year()-a.year()),a.clone().add(c.months,"M").isAfter(b)&&--c.months,c.milliseconds=+b-+a.clone().add(c.months,"M"),c}function o(a,b){var c;return b=E(b,a),a.isBefore(b)?c=n(a,b):(c=n(b,a),c.milliseconds=-c.milliseconds,c.months=-c.months),c}function p(a,b,c,d){var e=b._milliseconds,f=b._days,g=b._months;d=null==d||d,e&&a._d.setTime(+a._d+e*c),f&&ja(a,"Date",ia(a,"Date")+f*c),g&&ha(a,ia(a,"Month")+g*c),d&&pa.updateOffset(a,f||g)}function q(a){return"[object Array]"===Object.prototype.toString.call(a)}function r(a){return"[object Date]"===Object.prototype.toString.call(a)||a instanceof Date}function s(a,b,c){var d,e=Math.min(a.length,b.length),f=Math.abs(a.length-b.length),g=0;for(d=0;d<e;d++)(c&&a[d]!==b[d]||!c&&w(a[d])!==w(b[d]))&&g++;return g+f}function t(a){if(a){var b=a.toLowerCase().replace(/(.)s$/,"$1");a=eb[a]||fb[b]||b}return a}function u(a){var b,c,d={};for(c in a)a.hasOwnProperty(c)&&(b=t(c))&&(d[b]=a[c]);return d}function v(b){var c,d;if(0===b.indexOf("week"))c=7,d="day";else{if(0!==b.indexOf("month"))return;c=12,d="month"}pa[b]=function(e,f){var g,h,i=pa.fn._lang[b],j=[];if("number"==typeof e&&(f=e,e=a),h=function(a){var b=pa().utc().set(d,a);return i.call(pa.fn._lang,b,e||"")},null!=f)return h(f);for(g=0;g<c;g++)j.push(h(g));return j}}function w(a){var b=+a,c=0;return 0!==b&&isFinite(b)&&(c=b>=0?Math.floor(b):Math.ceil(b)),c}function x(a,b){return new Date(Date.UTC(a,b+1,0)).getUTCDate()}function y(a,b,c){return da(pa([a,11,31+b-c]),b,c).week}function z(a){return A(a)?366:365}function A(a){return a%4==0&&a%100!=0||a%400==0}function B(a){var b;a._a&&-2===a._pf.overflow&&(b=a._a[wa]<0||a._a[wa]>11?wa:a._a[xa]<1||a._a[xa]>x(a._a[va],a._a[wa])?xa:a._a[ya]<0||a._a[ya]>23?ya:a._a[za]<0||a._a[za]>59?za:a._a[Aa]<0||a._a[Aa]>59?Aa:a._a[Ba]<0||a._a[Ba]>999?Ba:-1,a._pf._overflowDayOfYear&&(b<va||b>xa)&&(b=xa),a._pf.overflow=b)}function C(a){return null==a._isValid&&(a._isValid=!isNaN(a._d.getTime())&&a._pf.overflow<0&&!a._pf.empty&&!a._pf.invalidMonth&&!a._pf.nullInput&&!a._pf.invalidFormat&&!a._pf.userInvalidated,a._strict&&(a._isValid=a._isValid&&0===a._pf.charsLeftOver&&0===a._pf.unusedTokens.length)),a._isValid}function D(a){return a?a.toLowerCase().replace("_","-"):a}function E(a,b){return b._isUTC?pa(a).zone(b._offset||0):pa(a).local()}function F(a,b){return b.abbr=a,Ca[a]||(Ca[a]=new g),Ca[a].set(b),Ca[a]}function G(a){delete Ca[a]}function H(a){var b,c,d,e,f=0,g=function(a){if(!Ca[a]&&Ea)try{require("./lang/"+a)}catch(a){}return Ca[a]};if(!a)return pa.fn._lang;if(!q(a)){if(c=g(a))return c;a=[a]}for(;f<a.length;){for(e=D(a[f]).split("-"),b=e.length,d=D(a[f+1]),d=d?d.split("-"):null;b>0;){if(c=g(e.slice(0,b).join("-")))return c;if(d&&d.length>=b&&s(e,d,!0)>=b-1)break;b--}f++}return pa.fn._lang}function I(a){return a.match(/\[[\s\S]/)?a.replace(/^\[|\]$/g,""):a.replace(/\\/g,"")}function J(a){var b,c,d=a.match(Ia);for(b=0,c=d.length;b<c;b++)kb[d[b]]?d[b]=kb[d[b]]:d[b]=I(d[b]);return function(e){var f="";for(b=0;b<c;b++)f+=d[b]instanceof Function?d[b].call(e,a):d[b];return f}}function K(a,b){return a.isValid()?(b=L(b,a.lang()),gb[b]||(gb[b]=J(b)),gb[b](a)):a.lang().invalidDate()}function L(a,b){function c(a){return b.longDateFormat(a)||a}var d=5;for(Ja.lastIndex=0;d>=0&&Ja.test(a);)a=a.replace(Ja,c),Ja.lastIndex=0,d-=1;return a}function M(a,b){var c=b._strict;switch(a){case"Q":return Ua;case"DDDD":return Wa;case"YYYY":case"GGGG":case"gggg":return c?Xa:Ma;case"Y":case"G":case"g":return Za;case"YYYYYY":case"YYYYY":case"GGGGG":case"ggggg":return c?Ya:Na;case"S":if(c)return Ua;case"SS":if(c)return Va;case"SSS":if(c)return Wa;case"DDD":return La;case"MMM":case"MMMM":case"dd":case"ddd":case"dddd":return Pa;case"a":case"A":return H(b._l)._meridiemParse;case"X":return Sa;case"Z":case"ZZ":return Qa;case"T":return Ra;case"SSSS":return Oa;case"MM":case"DD":case"YY":case"GG":case"gg":case"HH":case"hh":case"mm":case"ss":case"ww":case"WW":return c?Va:Ka;case"M":case"D":case"d":case"H":case"h":case"m":case"s":case"w":case"W":case"e":case"E":return Ka;case"Do":return Ta;default:return new RegExp(V(U(a.replace("\\","")),"i"))}}function N(a){a=a||"";var b=a.match(Qa)||[],c=b[b.length-1]||[],d=(c+"").match(cb)||["-",0,0],e=+60*d[1]+w(d[2]);return"+"===d[0]?-e:e}function O(a,b,c){var d,e=c._a;switch(a){case"Q":null!=b&&(e[wa]=3*(w(b)-1));break;case"M":case"MM":null!=b&&(e[wa]=w(b)-1);break;case"MMM":case"MMMM":d=H(c._l).monthsParse(b),null!=d?e[wa]=d:c._pf.invalidMonth=b;break;case"D":case"DD":null!=b&&(e[xa]=w(b));break;case"Do":null!=b&&(e[xa]=w(parseInt(b,10)));break;case"DDD":case"DDDD":null!=b&&(c._dayOfYear=w(b));break;case"YY":e[va]=pa.parseTwoDigitYear(b);break;case"YYYY":case"YYYYY":case"YYYYYY":e[va]=w(b);break;case"a":case"A":c._isPm=H(c._l).isPM(b);break;case"H":case"HH":case"h":case"hh":e[ya]=w(b);break;case"m":case"mm":e[za]=w(b);break;case"s":case"ss":e[Aa]=w(b);break;case"S":case"SS":case"SSS":case"SSSS":e[Ba]=w(1e3*("0."+b));break;case"X":c._d=new Date(1e3*parseFloat(b));break;case"Z":case"ZZ":c._useUTC=!0,c._tzm=N(b);break;case"dd":case"ddd":case"dddd":d=H(c._l).weekdaysParse(b),null!=d?(c._w=c._w||{},c._w.d=d):c._pf.invalidWeekday=b;break;case"w":case"ww":case"W":case"WW":case"d":case"e":case"E":a=a.substr(0,1);case"gggg":case"GGGG":case"GGGGG":a=a.substr(0,2),b&&(c._w=c._w||{},c._w[a]=w(b));break;case"gg":case"GG":c._w=c._w||{},c._w[a]=pa.parseTwoDigitYear(b)}}function P(a){var c,d,e,f,g,h,i,j;c=a._w,null!=c.GG||null!=c.W||null!=c.E?(g=1,h=4,d=b(c.GG,a._a[va],da(pa(),1,4).year),e=b(c.W,1),f=b(c.E,1)):(j=H(a._l),g=j._week.dow,h=j._week.doy,d=b(c.gg,a._a[va],da(pa(),g,h).year),e=b(c.w,1),null!=c.d?(f=c.d)<g&&++e:f=null!=c.e?c.e+g:g),i=ea(d,e,f,h,g),a._a[va]=i.year,a._dayOfYear=i.dayOfYear}function Q(a){var c,d,e,f,g=[];if(!a._d){for(e=S(a),a._w&&null==a._a[xa]&&null==a._a[wa]&&P(a),a._dayOfYear&&(f=b(a._a[va],e[va]),a._dayOfYear>z(f)&&(a._pf._overflowDayOfYear=!0),d=_(f,0,a._dayOfYear),a._a[wa]=d.getUTCMonth(),a._a[xa]=d.getUTCDate()),c=0;c<3&&null==a._a[c];++c)a._a[c]=g[c]=e[c];for(;c<7;c++)a._a[c]=g[c]=null==a._a[c]?2===c?1:0:a._a[c];a._d=(a._useUTC?_:$).apply(null,g),null!=a._tzm&&a._d.setUTCMinutes(a._d.getUTCMinutes()+a._tzm)}}function R(a){var b;a._d||(b=u(a._i),a._a=[b.year,b.month,b.day,b.hour,b.minute,b.second,b.millisecond],Q(a))}function S(a){var b=new Date;return a._useUTC?[b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate()]:[b.getFullYear(),b.getMonth(),b.getDate()]}function T(a){if(a._f===pa.ISO_8601)return void X(a);a._a=[],a._pf.empty=!0;var b,c,d,e,f,g=H(a._l),h=""+a._i,i=h.length,j=0;for(d=L(a._f,g).match(Ia)||[],b=0;b<d.length;b++)e=d[b],c=(h.match(M(e,a))||[])[0],c&&(f=h.substr(0,h.indexOf(c)),f.length>0&&a._pf.unusedInput.push(f),h=h.slice(h.indexOf(c)+c.length),j+=c.length),kb[e]?(c?a._pf.empty=!1:a._pf.unusedTokens.push(e),O(e,c,a)):a._strict&&!c&&a._pf.unusedTokens.push(e);a._pf.charsLeftOver=i-j,h.length>0&&a._pf.unusedInput.push(h),a._isPm&&a._a[ya]<12&&(a._a[ya]+=12),!1===a._isPm&&12===a._a[ya]&&(a._a[ya]=0),Q(a),B(a)}function U(a){return a.replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(a,b,c,d,e){return b||c||d||e})}function V(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function W(a){var b,d,e,f,g;if(0===a._f.length)return a._pf.invalidFormat=!0,void(a._d=new Date(NaN));for(f=0;f<a._f.length;f++)g=0,b=j({},a),b._pf=c(),b._f=a._f[f],T(b),C(b)&&(g+=b._pf.charsLeftOver,g+=10*b._pf.unusedTokens.length,b._pf.score=g,(null==e||g<e)&&(e=g,d=b));j(a,d||b)}function X(a){var b,c,d=a._i,e=$a.exec(d);if(e){for(a._pf.iso=!0,b=0,c=ab.length;b<c;b++)if(ab[b][1].exec(d)){a._f=ab[b][0]+(e[6]||" ");break}for(b=0,c=bb.length;b<c;b++)if(bb[b][1].exec(d)){a._f+=bb[b][0];break}d.match(Qa)&&(a._f+="Z"),T(a)}else a._isValid=!1}function Y(a){X(a),!1===a._isValid&&(delete a._isValid,pa.createFromInputFallback(a))}function Z(b){var c,d=b._i;d===a?b._d=new Date:r(d)?b._d=new Date(+d):null!==(c=Fa.exec(d))?b._d=new Date(+c[1]):"string"==typeof d?Y(b):q(d)?(b._a=d.slice(0),Q(b)):"object"==typeof d?R(b):"number"==typeof d?b._d=new Date(d):pa.createFromInputFallback(b)}function $(a,b,c,d,e,f,g){var h=new Date(a,b,c,d,e,f,g);return a<1970&&h.setFullYear(a),h}function _(a){var b=new Date(Date.UTC.apply(null,arguments));return a<1970&&b.setUTCFullYear(a),b}function aa(a,b){if("string"==typeof a)if(isNaN(a)){if("number"!=typeof(a=b.weekdaysParse(a)))return null}else a=parseInt(a,10);return a}function ba(a,b,c,d,e){return e.relativeTime(b||1,!!c,a,d)}function ca(a,b,c){var d=pa.duration(a).abs(),e=ua(d.as("s")),f=ua(d.as("m")),g=ua(d.as("h")),h=ua(d.as("d")),i=ua(d.as("M")),j=ua(d.as("y")),k=e<hb.s&&["s",e]||1===f&&["m"]||f<hb.m&&["mm",f]||1===g&&["h"]||g<hb.h&&["hh",g]||1===h&&["d"]||h<hb.d&&["dd",h]||1===i&&["M"]||i<hb.M&&["MM",i]||1===j&&["y"]||["yy",j];return k[2]=b,k[3]=+a>0,k[4]=c,ba.apply({},k)}function da(a,b,c){var d,e=c-b,f=c-a.day();return f>e&&(f-=7),f<e-7&&(f+=7),d=pa(a).add("d",f),{week:Math.ceil(d.dayOfYear()/7),year:d.year()}}function ea(a,b,c,d,e){var f,g,h=_(a,0,1).getUTCDay();return h=0===h?7:h,c=null!=c?c:e,f=e-h+(h>d?7:0)-(h<e?7:0),g=7*(b-1)+(c-e)+f+1,{year:g>0?a:a-1,dayOfYear:g>0?g:z(a-1)+g}}function fa(b){var c=b._i,d=b._f;return null===c||d===a&&""===c?pa.invalid({nullInput:!0}):("string"==typeof c&&(b._i=c=H().preparse(c)),pa.isMoment(c)?(b=k(c),b._d=new Date(+c._d)):d?q(d)?W(b):T(b):Z(b),new h(b))}function ga(a,b){var c,d;if(1===b.length&&q(b[0])&&(b=b[0]),!b.length)return pa();for(c=b[0],d=1;d<b.length;++d)b[d][a](c)&&(c=b[d]);return c}function ha(a,b){var c;return"string"==typeof b&&"number"!=typeof(b=a.lang().monthsParse(b))?a:(c=Math.min(a.date(),x(a.year(),b)),a._d["set"+(a._isUTC?"UTC":"")+"Month"](b,c),a)}function ia(a,b){return a._d["get"+(a._isUTC?"UTC":"")+b]()}function ja(a,b,c){return"Month"===b?ha(a,c):a._d["set"+(a._isUTC?"UTC":"")+b](c)}function ka(a,b){return function(c){return null!=c?(ja(this,a,c),pa.updateOffset(this,b),this):ia(this,a)}}function la(a){return 400*a/146097}function ma(a){return 146097*a/400}function na(a){pa.duration.fn[a]=function(){return this._data[a]}}function oa(a){"undefined"==typeof ender&&(qa=ta.moment,ta.moment=a?d("Accessing Moment through the global scope is deprecated, and will be removed in an upcoming release.",pa):pa)}for(var pa,qa,ra,sa="2.7.0",ta="undefined"!=typeof global?global:this,ua=Math.round,va=0,wa=1,xa=2,ya=3,za=4,Aa=5,Ba=6,Ca={},Da={_isAMomentObject:null,_i:null,_f:null,_l:null,_strict:null,_tzm:null,_isUTC:null,_offset:null,_pf:null,_lang:null},Ea="undefined"!=typeof module&&module.exports,Fa=/^\/?Date\((\-?\d+)/i,Ga=/(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/,Ha=/^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/,Ia=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Q|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,4}|X|zz?|ZZ?|.)/g,Ja=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,Ka=/\d\d?/,La=/\d{1,3}/,Ma=/\d{1,4}/,Na=/[+\-]?\d{1,6}/,Oa=/\d+/,Pa=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,Qa=/Z|[\+\-]\d\d:?\d\d/gi,Ra=/T/i,Sa=/[\+\-]?\d+(\.\d{1,3})?/,Ta=/\d{1,2}/,Ua=/\d/,Va=/\d\d/,Wa=/\d{3}/,Xa=/\d{4}/,Ya=/[+-]?\d{6}/,Za=/[+-]?\d+/,$a=/^\s*(?:[+-]\d{6}|\d{4})-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,_a="YYYY-MM-DDTHH:mm:ssZ",ab=[["YYYYYY-MM-DD",/[+-]\d{6}-\d{2}-\d{2}/],["YYYY-MM-DD",/\d{4}-\d{2}-\d{2}/],["GGGG-[W]WW-E",/\d{4}-W\d{2}-\d/],["GGGG-[W]WW",/\d{4}-W\d{2}/],["YYYY-DDD",/\d{4}-\d{3}/]],bb=[["HH:mm:ss.SSSS",/(T| )\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],cb=/([\+\-]|\d\d)/gi,db=("Date|Hours|Minutes|Seconds|Milliseconds".split("|"),{Milliseconds:1,Seconds:1e3,Minutes:6e4,Hours:36e5,Days:864e5,Months:2592e6,Years:31536e6}),eb={ms:"millisecond",s:"second",m:"minute",h:"hour",d:"day",D:"date",w:"week",W:"isoWeek",M:"month",Q:"quarter",y:"year",DDD:"dayOfYear",e:"weekday",E:"isoWeekday",gg:"weekYear",GG:"isoWeekYear"},fb={dayofyear:"dayOfYear",isoweekday:"isoWeekday",isoweek:"isoWeek",weekyear:"weekYear",isoweekyear:"isoWeekYear"},gb={},hb={s:45,m:45,h:22,d:26,M:11},ib="DDD w W M D d".split(" "),jb="M D H h m s w W".split(" "),kb={M:function(){return this.month()+1},MMM:function(a){return this.lang().monthsShort(this,a)},MMMM:function(a){return this.lang().months(this,a)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(a){return this.lang().weekdaysMin(this,a)},ddd:function(a){return this.lang().weekdaysShort(this,a)},dddd:function(a){return this.lang().weekdays(this,a)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return m(this.year()%100,2)},YYYY:function(){return m(this.year(),4)},YYYYY:function(){return m(this.year(),5)},YYYYYY:function(){var a=this.year();return(a>=0?"+":"-")+m(Math.abs(a),6)},gg:function(){return m(this.weekYear()%100,2)},gggg:function(){return m(this.weekYear(),4)},ggggg:function(){return m(this.weekYear(),5)},GG:function(){return m(this.isoWeekYear()%100,2)},GGGG:function(){return m(this.isoWeekYear(),4)},GGGGG:function(){return m(this.isoWeekYear(),5)},e:function(){return this.weekday()},E:function(){return this.isoWeekday()},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),!0)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),!1)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return w(this.milliseconds()/100)},SS:function(){return m(w(this.milliseconds()/10),2)},SSS:function(){return m(this.milliseconds(),3)},SSSS:function(){return m(this.milliseconds(),3)},Z:function(){var a=-this.zone(),b="+";return a<0&&(a=-a,b="-"),b+m(w(a/60),2)+":"+m(w(a)%60,2)},ZZ:function(){var a=-this.zone(),b="+";return a<0&&(a=-a,b="-"),b+m(w(a/60),2)+m(w(a)%60,2)},z:function(){return this.zoneAbbr()},zz:function(){return this.zoneName()},X:function(){return this.unix()},Q:function(){return this.quarter()}},lb=["months","monthsShort","weekdays","weekdaysShort","weekdaysMin"];ib.length;)ra=ib.pop(),kb[ra+"o"]=f(kb[ra],ra);for(;jb.length;)ra=jb.pop(),kb[ra+ra]=e(kb[ra],2);kb.DDDD=e(kb.DDD,3),j(g.prototype,{set:function(a){var b,c;for(c in a)b=a[c],"function"==typeof b?this[c]=b:this["_"+c]=b},_months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),months:function(a){return this._months[a.month()]},_monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),monthsShort:function(a){return this._monthsShort[a.month()]},monthsParse:function(a){var b,c,d;for(this._monthsParse||(this._monthsParse=[]),b=0;b<12;b++)if(this._monthsParse[b]||(c=pa.utc([2e3,b]),d="^"+this.months(c,"")+"|^"+this.monthsShort(c,""),this._monthsParse[b]=new RegExp(d.replace(".",""),"i")),this._monthsParse[b].test(a))return b},_weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdays:function(a){return this._weekdays[a.day()]},_weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysShort:function(a){return this._weekdaysShort[a.day()]},_weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),weekdaysMin:function(a){return this._weekdaysMin[a.day()]},weekdaysParse:function(a){var b,c,d;for(this._weekdaysParse||(this._weekdaysParse=[]),b=0;b<7;b++)if(this._weekdaysParse[b]||(c=pa([2e3,1]).day(b),d="^"+this.weekdays(c,"")+"|^"+this.weekdaysShort(c,"")+"|^"+this.weekdaysMin(c,""),this._weekdaysParse[b]=new RegExp(d.replace(".",""),"i")),this._weekdaysParse[b].test(a))return b},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(a){var b=this._longDateFormat[a];return!b&&this._longDateFormat[a.toUpperCase()]&&(b=this._longDateFormat[a.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(a){return a.slice(1)}),this._longDateFormat[a]=b),b},isPM:function(a){return"p"===(a+"").toLowerCase().charAt(0)},_meridiemParse:/[ap]\.?m?\.?/i,meridiem:function(a,b,c){return a>11?c?"pm":"PM":c?"am":"AM"},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},calendar:function(a,b){var c=this._calendar[a];return"function"==typeof c?c.apply(b):c},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(a,b,c,d){var e=this._relativeTime[c];return"function"==typeof e?e(a,b,c,d):e.replace(/%d/i,a)},pastFuture:function(a,b){var c=this._relativeTime[a>0?"future":"past"];return"function"==typeof c?c(b):c.replace(/%s/i,b)},ordinal:function(a){return this._ordinal.replace("%d",a)},_ordinal:"%d",preparse:function(a){return a},postformat:function(a){return a},week:function(a){return da(a,this._week.dow,this._week.doy).week},_week:{dow:0,doy:6},_invalidDate:"Invalid date",invalidDate:function(){return this._invalidDate}}),pa=function(b,d,e,f){var g;return"boolean"==typeof e&&(f=e,e=a),g={},g._isAMomentObject=!0,g._i=b,g._f=d,g._l=e,g._strict=f,g._isUTC=!1,g._pf=c(),fa(g)},pa.suppressDeprecationWarnings=!1,pa.createFromInputFallback=d("moment construction falls back to js Date. This is discouraged and will be removed in upcoming major release. Please refer to https://github.com/moment/moment/issues/1407 for more info.",function(a){a._d=new Date(a._i)}),pa.min=function(){return ga("isBefore",[].slice.call(arguments,0))},pa.max=function(){return ga("isAfter",[].slice.call(arguments,0))},pa.utc=function(b,d,e,f){var g;return"boolean"==typeof e&&(f=e,e=a),g={},g._isAMomentObject=!0,g._useUTC=!0,g._isUTC=!0,g._l=e,g._i=b,g._f=d,g._strict=f,g._pf=c(),fa(g).utc()},pa.unix=function(a){return pa(1e3*a)},pa.duration=function(a,b){var c,d,e,f,g=a,h=null;return pa.isDuration(a)?g={ms:a._milliseconds,d:a._days,M:a._months}:"number"==typeof a?(g={},b?g[b]=a:g.milliseconds=a):(h=Ga.exec(a))?(c="-"===h[1]?-1:1,g={y:0,d:w(h[xa])*c,h:w(h[ya])*c,m:w(h[za])*c,s:w(h[Aa])*c,ms:w(h[Ba])*c}):(h=Ha.exec(a))?(c="-"===h[1]?-1:1,e=function(a){var b=a&&parseFloat(a.replace(",","."));return(isNaN(b)?0:b)*c},g={y:e(h[2]),M:e(h[3]),d:e(h[4]),h:e(h[5]),m:e(h[6]),s:e(h[7]),w:e(h[8])}):"object"==typeof g&&("from"in g||"to"in g)&&(f=o(pa(g.from),pa(g.to)),g={},g.ms=f.milliseconds,g.M=f.months),d=new i(g),pa.isDuration(a)&&a.hasOwnProperty("_lang")&&(d._lang=a._lang),d},pa.version=sa,pa.defaultFormat=_a,pa.ISO_8601=function(){},pa.momentProperties=Da,pa.updateOffset=function(){},pa.relativeTimeThreshold=function(b,c){return hb[b]!==a&&(c===a?hb[b]:(hb[b]=c,!0))},pa.lang=function(a,b){var c;return a?(b?F(D(a),b):null===b?(G(a),a="en"):Ca[a]||H(a),c=pa.duration.fn._lang=pa.fn._lang=H(a),c._abbr):pa.fn._lang._abbr},pa.langData=function(a){return a&&a._lang&&a._lang._abbr&&(a=a._lang._abbr),H(a)},pa.isMoment=function(a){return a instanceof h||null!=a&&a.hasOwnProperty("_isAMomentObject")},pa.isDuration=function(a){return a instanceof i};for(ra=lb.length-1;ra>=0;--ra)v(lb[ra]);pa.normalizeUnits=function(a){return t(a)},pa.invalid=function(a){var b=pa.utc(NaN);return null!=a?j(b._pf,a):b._pf.userInvalidated=!0,b},pa.parseZone=function(){return pa.apply(null,arguments).parseZone()},pa.parseTwoDigitYear=function(a){return w(a)+(w(a)>68?1900:2e3)},j(pa.fn=h.prototype,{clone:function(){return pa(this)},valueOf:function(){return+this._d+6e4*(this._offset||0)},unix:function(){return Math.floor(+this/1e3)},toString:function(){return this.clone().lang("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._offset?new Date(+this):this._d},toISOString:function(){var a=pa(this).utc();return 0<a.year()&&a.year()<=9999?K(a,"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]"):K(a,"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]")},toArray:function(){var a=this;return[a.year(),a.month(),a.date(),a.hours(),a.minutes(),a.seconds(),a.milliseconds()]},isValid:function(){return C(this)},isDSTShifted:function(){return!!this._a&&(this.isValid()&&s(this._a,(this._isUTC?pa.utc(this._a):pa(this._a)).toArray())>0)},parsingFlags:function(){return j({},this._pf)},invalidAt:function(){return this._pf.overflow},utc:function(a){return this.zone(0,a)},local:function(a){return this._isUTC&&(this.zone(0,a),this._isUTC=!1,a&&this.add(this._d.getTimezoneOffset(),"m")),this},format:function(a){var b=K(this,a||pa.defaultFormat);return this.lang().postformat(b)},add:function(a,b){var c;return c="string"==typeof a&&"string"==typeof b?pa.duration(isNaN(+b)?+a:+b,isNaN(+b)?b:a):"string"==typeof a?pa.duration(+b,a):pa.duration(a,b),p(this,c,1),this},subtract:function(a,b){var c;return c="string"==typeof a&&"string"==typeof b?pa.duration(isNaN(+b)?+a:+b,isNaN(+b)?b:a):"string"==typeof a?pa.duration(+b,a):pa.duration(a,b),p(this,c,-1),this},diff:function(a,b,c){var d,e,f=E(a,this),g=6e4*(this.zone()-f.zone());return b=t(b),"year"===b||"month"===b?(d=432e5*(this.daysInMonth()+f.daysInMonth()),e=12*(this.year()-f.year())+(this.month()-f.month()),e+=(this-pa(this).startOf("month")-(f-pa(f).startOf("month")))/d,e-=6e4*(this.zone()-pa(this).startOf("month").zone()-(f.zone()-pa(f).startOf("month").zone()))/d,"year"===b&&(e/=12)):(d=this-f,e="second"===b?d/1e3:"minute"===b?d/6e4:"hour"===b?d/36e5:"day"===b?(d-g)/864e5:"week"===b?(d-g)/6048e5:d),c?e:l(e)},from:function(a,b){return pa.duration({to:this,from:a}).lang(this.lang()._abbr).humanize(!b)},fromNow:function(a){return this.from(pa(),a)},calendar:function(a){var b=a||pa(),c=E(b,this).startOf("day"),d=this.diff(c,"days",!0),e=d<-6?"sameElse":d<-1?"lastWeek":d<0?"lastDay":d<1?"sameDay":d<2?"nextDay":d<7?"nextWeek":"sameElse";return this.format(this.lang().calendar(e,this))},isLeapYear:function(){return A(this.year())},isDST:function(){return this.zone()<this.clone().month(0).zone()||this.zone()<this.clone().month(5).zone()},day:function(a){var b=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=a?(a=aa(a,this.lang()),this.add(a-b,"days")):b},month:ka("Month",!0),startOf:function(a){switch(a=t(a)){case"year":this.month(0);case"quarter":case"month":this.date(1);case"week":case"isoWeek":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}return"week"===a?this.weekday(0):"isoWeek"===a&&this.isoWeekday(1),"quarter"===a&&this.month(3*Math.floor(this.month()/3)),this},endOf:function(a){return a=t(a),this.startOf(a).add("isoWeek"===a?"week":a,1).subtract("ms",1)},isAfter:function(a,b){return b=void 0!==b?b:"millisecond",+this.clone().startOf(b)>+pa(a).startOf(b)},isBefore:function(a,b){return b=void 0!==b?b:"millisecond",+this.clone().startOf(b)<+pa(a).startOf(b)},isSame:function(a,b){return b=b||"ms",+this.clone().startOf(b)==+E(a,this).startOf(b)},min:d("moment().min is deprecated, use moment.min instead. https://github.com/moment/moment/issues/1548",function(a){return a=pa.apply(null,arguments),a<this?this:a}),max:d("moment().max is deprecated, use moment.max instead. https://github.com/moment/moment/issues/1548",function(a){return a=pa.apply(null,arguments),a>this?this:a}),zone:function(a,b){var c,d=this._offset||0;return null==a?this._isUTC?d:this._d.getTimezoneOffset():("string"==typeof a&&(a=N(a)),Math.abs(a)<16&&(a*=60),!this._isUTC&&b&&(c=this._d.getTimezoneOffset()),this._offset=a,this._isUTC=!0,null!=c&&this.subtract(c,"m"),d!==a&&(!b||this._changeInProgress?p(this,pa.duration(d-a,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,pa.updateOffset(this,!0),this._changeInProgress=null)),this)},zoneAbbr:function(){return this._isUTC?"UTC":""},zoneName:function(){return this._isUTC?"Coordinated Universal Time":""},parseZone:function(){return this._tzm?this.zone(this._tzm):"string"==typeof this._i&&this.zone(this._i),this},hasAlignedHourOffset:function(a){return a=a?pa(a).zone():0,(this.zone()-a)%60==0},daysInMonth:function(){return x(this.year(),this.month())},dayOfYear:function(a){var b=ua((pa(this).startOf("day")-pa(this).startOf("year"))/864e5)+1;return null==a?b:this.add("d",a-b)},quarter:function(a){return null==a?Math.ceil((this.month()+1)/3):this.month(3*(a-1)+this.month()%3)},weekYear:function(a){var b=da(this,this.lang()._week.dow,this.lang()._week.doy).year;return null==a?b:this.add("y",a-b)},isoWeekYear:function(a){var b=da(this,1,4).year;return null==a?b:this.add("y",a-b)},week:function(a){var b=this.lang().week(this);return null==a?b:this.add("d",7*(a-b))},isoWeek:function(a){var b=da(this,1,4).week;return null==a?b:this.add("d",7*(a-b))},weekday:function(a){var b=(this.day()+7-this.lang()._week.dow)%7;return null==a?b:this.add("d",a-b)},isoWeekday:function(a){return null==a?this.day()||7:this.day(this.day()%7?a:a-7)},isoWeeksInYear:function(){return y(this.year(),1,4)},weeksInYear:function(){var a=this._lang._week;return y(this.year(),a.dow,a.doy)},get:function(a){return a=t(a),this[a]()},set:function(a,b){return a=t(a),"function"==typeof this[a]&&this[a](b),this},lang:function(b){return b===a?this._lang:(this._lang=H(b),this)}}),pa.fn.millisecond=pa.fn.milliseconds=ka("Milliseconds",!1),pa.fn.second=pa.fn.seconds=ka("Seconds",!1),pa.fn.minute=pa.fn.minutes=ka("Minutes",!1),pa.fn.hour=pa.fn.hours=ka("Hours",!0),pa.fn.date=ka("Date",!0),pa.fn.dates=d("dates accessor is deprecated. Use date instead.",ka("Date",!0)),pa.fn.year=ka("FullYear",!0),pa.fn.years=d("years accessor is deprecated. Use year instead.",ka("FullYear",!0)),pa.fn.days=pa.fn.day,pa.fn.months=pa.fn.month,pa.fn.weeks=pa.fn.week,pa.fn.isoWeeks=pa.fn.isoWeek,pa.fn.quarters=pa.fn.quarter,pa.fn.toJSON=pa.fn.toISOString,j(pa.duration.fn=i.prototype,{_bubble:function(){var a,b,c,d=this._milliseconds,e=this._days,f=this._months,g=this._data,h=0;g.milliseconds=d%1e3,a=l(d/1e3),g.seconds=a%60,b=l(a/60),g.minutes=b%60,c=l(b/60),g.hours=c%24,e+=l(c/24),h=l(la(e)),e-=l(ma(h)),f+=l(e/30),e%=30,h+=l(f/12),f%=12,g.days=e,g.months=f,g.years=h},abs:function(){return this._milliseconds=Math.abs(this._milliseconds),this._days=Math.abs(this._days),this._months=Math.abs(this._months),this._data.milliseconds=Math.abs(this._data.milliseconds),this._data.seconds=Math.abs(this._data.seconds),this._data.minutes=Math.abs(this._data.minutes),this._data.hours=Math.abs(this._data.hours),this._data.months=Math.abs(this._data.months),this._data.years=Math.abs(this._data.years),this},weeks:function(){return l(this.days()/7)},valueOf:function(){return this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*w(this._months/12)},humanize:function(a){var b=ca(this,!a,this.lang());return a&&(b=this.lang().pastFuture(+this,b)),this.lang().postformat(b)},add:function(a,b){var c=pa.duration(a,b);return this._milliseconds+=c._milliseconds,this._days+=c._days,this._months+=c._months,this._bubble(),this},subtract:function(a,b){var c=pa.duration(a,b);return this._milliseconds-=c._milliseconds,this._days-=c._days,this._months-=c._months,this._bubble(),this},get:function(a){return a=t(a),this[a.toLowerCase()+"s"]()},as:function(a){var b,c;if(a=t(a),b=this._days+this._milliseconds/864e5,"month"===a||"year"===a)return c=this._months+12*la(b),"month"===a?c:c/12;switch(b+=ma(this._months/12),a){case"week":return b/7;case"day":return b;case"hour":return 24*b;case"minute":return 24*b*60;case"second":return 24*b*60*60;case"millisecond":return 24*b*60*60*1e3;default:throw new Error("Unknown unit "+a)}},lang:pa.fn.lang,toIsoString:function(){var a=Math.abs(this.years()),b=Math.abs(this.months()),c=Math.abs(this.days()),d=Math.abs(this.hours()),e=Math.abs(this.minutes()),f=Math.abs(this.seconds()+this.milliseconds()/1e3);return this.asSeconds()?(this.asSeconds()<0?"-":"")+"P"+(a?a+"Y":"")+(b?b+"M":"")+(c?c+"D":"")+(d||e||f?"T":"")+(d?d+"H":"")+(e?e+"M":"")+(f?f+"S":""):"P0D"}});for(ra in db)db.hasOwnProperty(ra)&&na(ra.toLowerCase());pa.duration.fn.asMilliseconds=function(){return this.as("ms")},pa.duration.fn.asSeconds=function(){return this.as("s")},pa.duration.fn.asMinutes=function(){return this.as("m")},pa.duration.fn.asHours=function(){return this.as("h")},pa.duration.fn.asDays=function(){return this.as("d")},pa.duration.fn.asWeeks=function(){return this.as("weeks")},pa.duration.fn.asMonths=function(){return this.as("M")},pa.duration.fn.asYears=function(){return this.as("y")},pa.lang("en",{ordinal:function(a){var b=a%10;return a+(1===w(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th")}}),Ea?module.exports=pa:"function"==typeof define&&define.amd?(define("moment",function(a,b,c){return c.config&&c.config()&&!0===c.config().noGlobal&&(ta.moment=qa),pa}),oa(!0)):oa()}.call(this);var mod=angular.module("infinite-scroll",[]);mod.directive("infiniteScroll",["$rootScope","$window","$timeout",function(a,b,c){return{link:function(d,e,f){c(function(){b=angular.element(b);var g,h,i,j,k,l,m;return g=e.parents().filter(function(){return/(auto|scroll)/.test($.css(this,"overflow")+$.css(this,"overflow-y"))}).eq(0),0===g.length&&(g=b),null!=f.infiniteScrollSelf&&(g=e),k=0,null!=f.infiniteScrollDistance&&d.$watch(f.infiniteScrollDistance,function(a){return k=parseFloat(a,10)}),l=!0,h=!1,null!=f.infiniteScrollDisabled&&d.$watch(f.infiniteScrollDisabled,function(a){if((l=!a)&&h)return h=!1,j()}),m=g!==b?g.position().top:0,i=e.position().top-m,j=function(){var b,c,j,m;return e==g?(c=e[0].scrollHeight-e.scrollTop()-e.height(),m=c<=e[0].scrollHeight*k):(b=i+e.height(),j=g.height()+g.scrollTop(),c=b-j,m=c<=g.height()*k),m&&l?a.$$phase?d.$eval(f.infiniteScroll):d.$apply(f.infiniteScroll):m?h=!0:void 0},g.on("scroll",j),d.$on("$destroy",function(){return g.off("scroll",j)}),c(function(){return f.infiniteScrollImmediateCheck?d.$eval(f.infiniteScrollImmediateCheck)?j():void 0:j()},0)},0)}}}]),function(){"use strict";Array.prototype.indexOf||(Array.prototype.indexOf=function(a){var b=this.length>>>0,c=Number(arguments[1])||0;for(c=c<0?Math.ceil(c):Math.floor(c),c<0&&(c+=b);c<b;c++)if(c in this&&this[c]===a)return c;return-1}),Array.prototype.filter||(Array.prototype.filter=function(a){if(void 0===this||null===this)throw new TypeError;var b=Object(this),c=b.length>>>0;if("function"!=typeof a)throw new TypeError;for(var d=[],e=arguments.length>=2?arguments[1]:void 0,f=0;f<c;f++)if(f in b){var g=b[f];a.call(e,g,f,b)&&d.push(g)}return d}),Array.prototype.map||(Array.prototype.map=function(a,b){var c,d,e;if(null===this)throw new TypeError(" this is null or not defined");var f=Object(this),g=f.length>>>0;if("function"!=typeof a)throw new TypeError(a+" is not a function");for(arguments.length>1&&(c=b),d=new Array(g),e=0;e<g;){var h,i;e in f&&(h=f[e],i=a.call(c,h,e,f),d[e]=i),e++}return d}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),Object.keys||(Object.keys=function(){var a=Object.prototype.hasOwnProperty,b=!{toString:null}.propertyIsEnumerable("toString"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],d=c.length;return function(e){if("object"!=typeof e&&("function"!=typeof e||null===e))throw new TypeError("Object.keys called on non-object");var f,g,h=[];for(f in e)a.call(e,f)&&h.push(f);if(b)for(g=0;g<d;g++)a.call(e,c[g])&&h.push(c[g]);return h}}()),String.prototype.startsWith||(String.prototype.startsWith=function(a,b){return b=b||0,this.lastIndexOf(a,b)===b}),String.prototype.endsWith||(String.prototype.endsWith=function(a,b){var c=this.toString();(void 0===b||b>c.length)&&(b=c.length),b-=a.length;var d=c.indexOf(a,b);return-1!==d&&d===b}),window.hasOwnProperty||(window.hasOwnProperty=function(a){return Object.prototype.hasOwnProperty.call(window,a)}),window.selectText=function(a){var b,c,d=document;d.body.createTextRange?(b=document.body.createTextRange(),b.moveToElementText(a),b.select()):window.getSelection&&(c=window.getSelection(),b=document.createRange(),b.selectNodeContents(a),c.removeAllRanges(),c.addRange(b))},window.isObjectEmpty=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},window.utf8_to_b64=function(a){return window.btoa(jsesc(a,{json:!0}))},window.b64_to_utf8=function(a){return window.atob(a)},window.format_string=function(){var a=arguments[0];if(null!==arguments[1]&&"object"==typeof arguments[1]){var b=arguments[1];for(var c in b)if(b.hasOwnProperty(c)){var d=new RegExp("\\{"+c+"\\}","gm");a=a.replace(d,b[c])}}else for(var e=1;e<arguments.length;e++){var d=new RegExp("\\{"+(e-1)+"\\}","gm");a=a.replace(d,arguments[e])}return a},"function"!=typeof Object.assign&&(Object.assign=function(a,b){if(null==a)throw new TypeError("Cannot convert undefined or null to object");for(var c=Object(a),d=1;d<arguments.length;d++){var e=arguments[d];if(null!=e)for(var f in e)Object.prototype.hasOwnProperty.call(e,f)&&(c[f]=e[f])}return c})}(),function(){"use strict";var a=angular.module("ods-widgets",["infinite-scroll","ngSanitize","gettext"]);a.provider("ODSWidgetsConfig",function(){this.defaultConfig={ODSWidgetsVersion:"1.0.10",defaultDomain:"",language:null,disqusShortname:null,customAPIHeaders:null,basemaps:[{provider:"jawg.streets",label:"Jawg Streets",jawg_apikey:"opendatasoft-community"}],mapGeobox:!1,chartColors:null,mapPrependAttribution:null,basePath:null,websiteName:null,themes:{},defaultMapLocation:"12,48.85218,2.36996"},this.customConfig={},this.setConfig=function(a){angular.extend(this.customConfig,a)},this.$get=function(){return angular.extend({},this.defaultConfig,this.customConfig)}}),a.run(["gettextCatalog","ODSWidgetsConfig",function(a,b){if(!b.basePath){var c,d,e,f=document.getElementsByTagName("script"),g=/[\/^]ods-widgets(\.min)?\.js\??/;for(c=0;c<f.length;c++)d=f[c].src,d.match(g)&&(e=d.split(g)[0],e?".js"===e.substring(e.length-3)?b.basePath="":b.basePath=e+"/":b.basePath="/")}}])}(),function(){"use strict";function a(a,b){return encodeURIComponent(a).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,b?"%20":"+")}function b(a){return angular.isObject(a)?angular.isDate(a)?a.toISOString():angular.toJson(a):a}var c=angular.module("ods-widgets");c.service("ODSParamSerializer",function(){return function(c){if(!c)return"";var d=[];return angular.forEach(c,function(c,e){null===c||angular.isUndefined(c)||(angular.isArray(c)?angular.forEach(c,function(c,f){d.push(a(e)+"="+a(b(c)))}):d.push(a(e)+"="+a(b(c))))}),d.join("&")}}),c.service("ODSAPI",["$http","ODSWidgetsConfig","odsNotificationService","ODSParamSerializer",function(a,b,c,d){var e=function(e,f,g,h){var i=e?e.domainUrl:"";i+=f,g=ODS.URLUtils.cleanupAPIParams(g)||{},g.timezone=jstz.determine().name(),e&&e.apikey&&(g.apikey=e.apikey),e&&e.source&&(g.source=e.source);var j={params:g,paramSerializer:d};return h&&(j.timeout=h),i.startsWith("http://")||(b.customAPIHeaders?j.headers=b.customAPIHeaders:j.headers={},j.headers["ODS-Widgets-Version"]=b.ODSWidgetsVersion),!e.domainUrl||Modernizr.cors?a.get(i,j).error(function(a){a&&c.sendNotification(a)}):(i+=i.indexOf("?")>-1?"&":"?",i+="callback=JSON_CALLBACK",a.jsonp(i,j))};return{getDomainURL:function(a){var c=null;return angular.isUndefined(a)||null===a||""===a?c=b.defaultDomain:(c="/"!==a.substr(0,1)&&-1===a.indexOf(".")?a+".opendatasoft.com":a,"/"!==c.substr(0,1)&&-1===c.indexOf("http://")&&-1===c.indexOf("https://")&&(c="https://"+c)),"/"===c.substr(-1)&&(c=c.substr(0,c.length-1)),c},datasets:{get:function(a,b,c){return e(a,"/api/datasets/1.0/"+b+"/",c)},search:function(a,b){var c=angular.extend({},a.parameters,b);return e(a,"/api/datasets/1.0/search/",c)},facets:function(a,b){return this.search(a,{rows:0,facet:b})}},records:{analyze:function(a,b,d){return e(a,"/api/records/1.0/analyze/",angular.extend({},b,{dataset:a.dataset.datasetid}),d).success(function(a,b,d,e){d()["ods-analyze-truncated"]&&c.sendNotification("An analysis request hit the maximum number of results limit. Returned data is incomplete and not trustworthy.")})},search:function(a,b,c){return e(a,"/api/records/1.0/search/",angular.extend({},b,{dataset:a.dataset.datasetid}),c)},download:function(a,b,c){return e(a,"/api/records/1.0/download/",angular.extend({},b,{dataset:a.dataset.datasetid}),c)},geo:function(a,b,c){return e(a,"/api/records/1.0/geocluster/",angular.extend({},b,{dataset:a.dataset.datasetid}),c)},geopreview:function(a,b,c){return e(a,"/api/records/1.0/geopreview/",angular.extend({},b,{dataset:a.dataset.datasetid}),c)},boundingbox:function(a,b,c){return e(a,"/api/records/1.0/boundingbox/",angular.extend({},b,{dataset:a.dataset.datasetid}),c)},geopolygon:function(a,b,c){return e(a,"/api/records/1.0/geopolygon/",angular.extend({},b,{dataset:a.dataset.datasetid}),c)}},reuses:function(a,b){return e(a,"/api/reuses/",b)}}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.factory("AggregationHelper",["translate",function(a){var b=[{label:a("Count"),func:"COUNT"},{label:a("Average"),func:"AVG"},{label:a("Minimum"),func:"MIN"},{label:a("Maximum"),func:"MAX"},{label:a("Standard deviation"),func:"STDDEV"},{label:a("Sum"),func:"SUM"},{label:a("Percentile"),func:"QUANTILES"},{label:a("Constant value"),func:"CONSTANT"}];return{getAvailableFunctions:function(a){return 0===a?[b[0],b[b.length-1]]:b},getAvailableFunction:function(a){return b[a]},getFunctionLabel:function(a){return a=a.toUpperCase(),$.grep(b,function(b){return a===b.func})[0].label}}}]),a.factory("ChartHelper",["translate","AggregationHelper","ODSWidgetsConfig","ODSCurrentDomain","colorScale",function(a,b,c,d,e){var f={},g={},h={year:a("Year"),month:a("Month"),day:a("Day"),hour:a("Hour"),minute:a("Minute"),"month month":a("Month of year"),"day day":a("Day of month"),"day weekday":a("Day of week"),"hour weekday":a("Hour per weekday"),"day month":a("Day of year"),"hour hour":a("Hour of day")},i={},j=[],k={"top left":{center:["15%","20%"],size:"25%"},"top right":{center:["85%","20%"],size:"25%"},"bottom left":{center:["15%","80%"],size:"25%"},"bottom right":{center:["85%","80%"],size:"25%"},center:{}},l=c.chartColors||chroma.brewer.Set2,m=[{label:a("Line"),type:"line",group:a("line charts")},{label:a("Spline"),type:"spline",group:a("line charts")},{label:a("Range"),type:"arearange",group:a("Area charts"),filter:"hasNumericField"},{label:a("Range spline"),type:"areasplinerange",group:a("Area charts"),filter:"hasNumericField"},{label:a("Column range"),type:"columnrange",group:a("Area charts"),filter:"hasNumericField"},{label:a("Treemap"),type:"treemap",group:a("Special")},{label:a("Area"),type:"area",group:a("Area charts")},{label:a("Area spline"),type:"areaspline",group:a("Area charts")},{label:a("Column chart"),type:"column",group:a("Bar charts")},{label:a("Bar chart"),type:"bar",group:a("Bar charts")},{label:a("Pie chart"),type:"pie",group:a("Pie charts")},{label:a("Scatter plot"),type:"scatter",group:a("line charts")},{label:a("Spiderweb chart"),type:"spiderweb",group:a("Pie charts")},{label:a("Polar chart"),type:"polar",group:a("Pie charts")},{label:a("Funnel chart"),type:"funnel",group:a("Pyramid charts")},{label:a("Boxplot"),type:"boxplot",group:a("Boxplot charts")}],n=["year","month","day","hour","minute"],o=["month month","day day","day weekday","hour weekday","day month","hour hour"],p={},q={},r=function(a,b,c){var d=!1;a?d=!0:a="date"==b?"day":"hour";for(var e=[],f=0;f<=n.indexOf(a)&&(e.push({name:n[f],label:h[n[f]]}),"date"!==b||"day"!=n[f])&&("datetime"!==b||d||"hour"!=n[f])&&("datetime"!==b||!d||"minute"!=n[f]);f++);if(c)for(var g=0;g<o.length&&(e.push({name:o[g],label:h[o[g]]}),"date"!==b||"day month"!=n[g]);g++);return e};return{getDatasetUniqueId:function(a){var b;if(angular.forEach(q,function(c,d){return d.endsWith(a)&&(b=c),!1}),b)return b.getUniqueId();throw"dataset "+a+" not loaded yet."},getDataset:function(a){var b;return angular.forEach(q,function(c,d){return a===d&&(b=c),!1}),b},isChartSortable:function(a){return!this.isRangeChart(a)},isRangeChart:function(a){return["arearange","areasplinerange","columnrange"].indexOf(a)>-1},getAllTimescales:function(){return r("minute","datetime",!0)},getAvailableX:function(a,b){return void 0===b?f[a]:f[a][b]},getAvailableBreakDowns:function(a,b){if(!b)return[];for(var c=-1!==["date","datetime"].indexOf(this.getFieldType(a,b)),d=[],e=0;e<f[a].length;e++)f[a][e].name!==b&&(c&&-1!==["date","datetime"].indexOf(this.getFieldType(a,f[a][e].name))||d.push({label:f[a][e].label,name:f[a][e].name}));return d},getAvailableY:function(a,b){return void 0===b?g[a]:g[a][b]},getTimescales:function(a,b,c){for(var d,e,f=0;f<p[a].length;f++)if(p[a][f].name===b){e=p[a][f];break}if(e){if(e.annotations)for(var g=0;g<e.annotations.length;g++)if("timeserie_precision"==e.annotations[g].name){d=e.annotations[g].args[0];break}return r(d,e.type,c)}},getDatasetId:function(a){return(a.domain||d.domainId)+"."+a.dataset.datasetid},init:function(a,b,c){void 0===c&&(c=!1);var d=[],e=[],f=this.getDatasetId(a);if(c||!(f in j)){p[f]=a.dataset.fields;for(var g=[],h=0;h<p[f].length;h++){var i=p[f][h];if("int"!=i.type&&"double"!=i.type||e.push(i),"datetime"==i.type||"date"==i.type)d.unshift(i);else if("double"==i.type||"int"==i.type)g.push(i);else if(i.annotations)for(var k=0;k<i.annotations.length;k++){var l=i.annotations[k];"facet"==l.name&&d.push(i)}}d=d.concat(g),this.setAvailableX(f,d),this.setAvailableY(f,e),j[f]=!0,q[f]=a.dataset,this.load(f)}},isInitialized:function(a){return""===a?!!j.length:!!(a in j)},load:function(a){if(i[a])for(var b=0;b<i[a].length;b++)i[a][b]();i[a]=[];var c;if(i[""])for(;i[""].length;)c=i[""].pop(),setTimeout(c)},onLoad:function(a,b){"function"==typeof a&&(b=a,a=""),this.isInitialized(a)?b():(a in i||(i[a]=[]),i[a].indexOf(b)<0&&i[a].push(b))},setAvailableX:function(a,b){f[a]=b},setAvailableY:function(a,b){g[a]=b},resolvePosition:function(a){return void 0==typeof a&&(a="center"),a in k||(a="center"),k[a]},getPieChartPositions:function(){return $.map(k,function(a,b){return b})},getDefaultColors:function(){return l},getDefaultColor:function(a,b,c,d){return e.getDefaultColor(a,this.getAllowedColors(b,c),d)},getAllowedColors:function(a,b){var c=[];return(b||-1!==["pie","treemap"].indexOf(a))&&c.push("range"),b||-1!==["pie","treemap"].indexOf(a)||c.push("single"),c},getAvailableChartTypes:function(a,b){var c=[];if(q[a])for(var d=0;d<m.length;d++)(b&&-1!==["column","area","areaspline","line","spline","bar","polar"].indexOf(m[d].type)||!b)&&(void 0===m[d].filter?c.push(m[d]):q[a][m[d].filter]()&&c.push(m[d]));return c},getSerieTemplate:function(){return angular.copy({})},setChartDefaultValues:function(a,b,c,d){var e,f="";void 0===c&&(c=!1),void 0===d&&(d=!1);for(var g=0;g<b.queries.length;g++)e=this.getFieldType(a,b.queries[g].xAxis),!b.queries[g].timescale||"date"!==e&&"datetime"!==e||(f=b.queries[g].timescale);if(f?!b.timescale&&d&&(b.timescale=f):b.timescale="",b.timescale)for(var g=0;g<b.queries.length;g++)b.queries[g].timescale||(b.queries[g].timescale=b.timescale);b.singleAxis||(delete b.singleAxisLabel,delete b.singleAxisScale,delete b.yRangeMin,delete b.yRangeMax),c||delete b.xLabel},setDefaultQueryValues:function(a,b,c,d,e,f){b||(b={});var g={},h=g.x||this.getAvailableX(a,0).name,i=50;b.xAxis||(b.xAxis=h),"date"!=this.getFieldType(a,b.xAxis)&&"datetime"!=this.getFieldType(a,b.xAxis)||(i="",g.timescale),void 0===b.maxpoints&&(b.maxpoints=i),b.charts||(b.charts=[]);var j=b.xAxis,k=this.getFieldType(a,j);"date"==k||"datetime"==k?b.timescale&&-1!==this.getTimescales(a,j,c).map(function(a){return a.name}).indexOf(b.timescale)||(b.timescale="year",b.timescale=c&&e?e:"year"):b.timescale&&(b.timescale=""),b.seriesBreakdown===j&&(b.seriesBreakdown="",b.seriesBreakdownTimescale="");for(var l=!1,m=0;m<b.charts.length;m++)-1!==["treemap","pie"].indexOf(b.charts[m].type)&&(l=!0);l&&(b.seriesBreakdown="",b.seriesBreakdownTimescale=""),!b.seriesBreakdown&&b.charts.length<2&&delete b.stacked,b.sort&&!b.seriesBreakdown||(b.sort="")},setSerieDefaultValues:function(a,b,c,d){var e,f;if(void 0!==c){var g=this.getAvailableY(a);if(b.type||(b.type="column",!c||"date"!=this.getFieldType(a,c)&&"datetime"!=this.getFieldType(a,c)||(b.type="line")),b.func||(b.func=g.length>0?"AVG":"COUNT"),void 0!==b.expr&&void 0===b.yAxis&&(b.yAxis=b.expr,delete b.expr),void 0===b.yAxis||""===b.yAxis?(0===g.length&&-1===["COUNT","CONSTANT","CUSTOM"].indexOf(b.func)&&(b.func="COUNT"),d||-1!==["COUNT","CONSTANT","CUSTOM"].indexOf(b.func)||(b.yAxis=g[0].name)):d||-1!==["COUNT","CONSTANT","CUSTOM"].indexOf(b.func)||0===$.grep(g,function(a){return a.name===b.yAxis}).length&&(b.yAxis=g[0].name),b.type&&this.isRangeChart(b.type))for(b.func="COUNT",f=[5,95],b.charts||(b.charts=[{func:"MIN",yAxis:b.yAxis},{func:"MAX",yAxis:b.yAxis}]),5===b.charts.length&&(b.charts[1]=angular.copy(b.charts[4]),b.charts.splice(2,3)),e=0;e<2;e++)void 0!==b.charts[e].yAxis&&""!==b.charts[e].yAxis||(b.charts[e].yAxis=b.charts[e].expr||b.yAxis,delete b.charts[e].expr),"QUANTILES"!==b.charts[e].func||""!==b.charts[e].subsets&&void 0!==b.charts[e].subsets||(b.charts[e].subsets=f[e]),"QUANTILES"!==b.charts[e].func&&b.charts[e].subsets&&delete b.charts[e].subsets;else if(b.type&&"boxplot"===b.type){for(b.func="COUNT",f=[1,25,50,75,100],b.charts||(b.charts=[]),2===b.charts.length&&(b.charts[4]=angular.copy(b.charts[1]),b.charts[1]=void 0),void 0===b.charts[0]&&(b.charts[0]={func:"MIN",yAxis:b.yAxis}),e=1;e<4;e++)void 0===b.charts[e]&&(b.charts[e]={func:"QUANTILES",yAxis:b.yAxis,subsets:f[e]});for(void 0===b.charts[4]&&(b.charts[4]={func:"MAX",yAxis:b.yAxis}),e=0;e<5;e++)void 0!==b.charts[e].yAxis&&""!==b.charts[e].yAxis||(b.charts[e].yAxis=b.charts[e].expr||b.charts[e].yAxis||b.yAxis,delete b.charts[e].expr),"QUANTILES"!==b.charts[e].func||""!==b.charts[e].subsets&&void 0!==b.charts[e].subsets||(b.charts[e].subsets=f[e]),"QUANTILES"!==b.charts[e].func&&b.charts[e].subsets&&delete b.charts[e].subsets}else b.charts&&delete b.charts,"QUANTILES"===b.func?b.subsets||(b.subsets=50):b.subsets&&delete b.subsets;"pie"!==b.type||b.position||(b.position="center"),"column"!==b.type&&"bar"!==b.type&&b.displayStackValues&&(b.displayStackValues=!1),void 0===b.scientificDisplay&&(b.scientificDisplay=!0),delete b.yLabel,delete b.extras}},setSerieDefaultColors:function(a,b,c){a.color=this.getDefaultColor(a.color,a.type,b,c)},getXLabel:function(a,b,c,d){var e=this.getFieldType(a,b),f=this.getFieldLabel(a,b);return"date"!==e&&"datetime"!==e||!c?f:f+" ("+h[c]+")"},getYLabel:function(c,d){if(d.yLabelOverride)return d.yLabelOverride;if(this.isRangeChart(d.type))return this.getYLabel(c,d.charts[0])+" / "+this.getYLabel(c,d.charts[1]);if("boxplot"===d.type)return a("Boxplot");var e=b.getFunctionLabel(d.func),f=d.yAxis||d.expr,g=$.grep(this.getAvailableY(c),function(a){return a.name==f});return g.length>0&&"COUNT"!==d.func&&"CONSTANT"!==d.func&&"CUSTOM"!==d.func?e+" "+g[0].label:e},getField:function(a,b){if(!p[a])return null;for(var c=0;c<p[a].length;c++){var d=p[a][c];if(d.name==b)return d}},getFieldLabel:function(a,b){var c=this.getField(a,b);return c?c.label:c},getFieldType:function(a,b){var c=this.getField(a,b);return c?c.type:c},getFieldUnit:function(a,b){var c=this.getField(a,b);if(c&&c.annotations){for(var d=0;d<c.annotations.length;d++)if("unit"===c.annotations[d].name)return c.annotations[d].args[0];return c.annotations.unit}return!1},getDecimals:function(a,b){var c=this.getField(a,b);if(c&&c.annotations){for(var d=0;d<c.annotations.length;d++)if("decimals"===c.annotations[d].name)return c.annotations[d].args[0];return!1}return!1},getAvailableFunctions:function(a){return b.getAvailableFunctions(this.getAvailableY(a).length)},allowThresholds:function(a){return-1!==["column","bar","scatter"].indexOf(a)}}}])}(),function(){"use strict";angular.module("ods-widgets").factory("colorScale",["ODSWidgetsConfig",function(a){function b(a){var b;return a?(a.startsWith("custom-")&&(a=a.replace("custom-","")),a.startsWith("range-")?a=a.replace("range-",""):a.startsWith("single-")&&(a=a.replace("single-","")),chroma.brewer[a]&&(b=a)):b=f||e,b}function c(a){var c,d=b(a);return d?c=chroma.scale(d):(a=a.replace("custom-",""),a=a.replace("single-",""),c=chroma.scale().range([a,a])),c}var d=[{label:"Accent",colors:chroma.brewer.Accent},{label:"Dark2",colors:chroma.brewer.Dark2},{label:"Pastel2",colors:chroma.brewer.Pastel2},{label:"Pastel1",colors:chroma.brewer.Pastel1},{label:"Set2",colors:chroma.brewer.Set2},{label:"Set1",colors:chroma.brewer.Set1},{label:"Paired",colors:chroma.brewer.Paired},{label:"Set3",colors:chroma.brewer.Set3},{label:"OrRd",colors:chroma.brewer.OrRd.slice(1)},{label:"PuBu",colors:chroma.brewer.PuBu.slice(1)},{label:"BuPu",colors:chroma.brewer.BuPu.slice(1)},{label:"Oranges",colors:chroma.brewer.Oranges.slice(1)},{label:"YlOrBr",colors:chroma.brewer.YlOrBr.slice(1)},{label:"YlGn",colors:chroma.brewer.YlGn.slice(1)},{label:"Reds",colors:chroma.brewer.Reds.slice(1)},{label:"RdPu",colors:chroma.brewer.RdPu.slice(1)},{label:"Greens",colors:chroma.brewer.Greens.slice(1)},{label:"YlGnBu",colors:chroma.brewer.YlGnBu.slice(1)},{label:"Purples",colors:chroma.brewer.Purples.slice(1)},{label:"GnBu",colors:chroma.brewer.GnBu.slice(1)},{label:"Greys",colors:chroma.brewer.Greys.slice(1)},{label:"YlOrRd",colors:chroma.brewer.YlOrRd.slice(1)},{label:"PuRd",colors:chroma.brewer.PuRd.slice(1)},{label:"Blues",colors:chroma.brewer.Blues.slice(1)},{label:"PuBuGn",colors:chroma.brewer.PuBuGn.slice(1)},{label:"Spectral",colors:chroma.brewer.Spectral},{label:"RdYlGn",colors:chroma.brewer.RdYlGn},{label:"RdBu",colors:chroma.brewer.RdBu},{label:"PiYG",colors:chroma.brewer.PiYG},{label:"PRGn",colors:chroma.brewer.PRGn},{label:"RdYlBu",colors:chroma.brewer.RdYlBu},{label:"BrBG",colors:chroma.brewer.BrBG},{label:"RdGy",colors:chroma.brewer.RdGy},{label:"PuOr",colors:chroma.brewer.PuOr}],e="Set2",f="",g=0;if(a.chartColors&&a.chartColors.length>0){f="custom";var h=angular.copy(a.chartColors);angular.isArray(h)||(h=[h]),1==h.length&&h.push(h[0]),d.unshift({label:"custom",colors:h}),chroma.brewer.custom=h}return{getScale:function(a,b,d){return b=void 0!==b?b:0,d=void 0!==d?d:1,c(a).domain([b,d])},getUniqueColor:function(a){return c(a)(1).hex()},getColorAtIndex:function(a,c){var d,e=b(a);return e?(d=chroma.brewer[e],d[c%d.length]):a},getColors:function(a){var c=b(a);return c?chroma.brewer[c]:[a,a]},getColorSets:function(){return chroma.brewer},getOrderedColorSets:function(){return d},getDefaultColorSet:function(){return f||e},getDefaultColor:function(a,b,c){var d,e=this.getColorList(b);return void 0!==a&&""!==a?a:"undefined"!=typeof backupColor&&""!==backupColor?backupColor:(e[g].label.startsWith("custom-")&&(g=(g+1)%e.length),void 0!==c?d=e[c%e.length].label:(d=e[g].label,g=(g+1)%e.length),d)},getColorList:function(a,b){var c=[];if(-1!==a.indexOf("single")){var d=this.getColors(this.getDefaultColorSet());angular.forEach(d,function(a){c.push({label:a,color:a})})}return-1!==a.indexOf("range")&&angular.forEach(this.getOrderedColorSets(),function(a){c.push({label:"range-"+a.label,color:a.colors})}),c},isColorAllowed:function(a,b,c){var d=!1;return!!a&&(-1===c.indexOf("range")?!a.startsWith("range-")&&!a.startsWith("custom-range-"):-1!==c.indexOf("range")?!a.startsWith("custom-single-")&&(angular.forEach(b,function(b){b.label===a&&(d=!0)}),d):void 0)}}}])}(),function(){"use strict";var a=angular.module("ods-widgets"),b={},c={};a.factory("ContextHelper",["ODSAPI","$q",function(a,d){return{getDatasetContext:function(e,f,g,h,i,j,k){var l=d.defer(),m={wait:function(){return l.promise},getDownloadURL:function(a,b){a=a||"csv";var c=this.domainUrl+"/explore/dataset/"+this.dataset.datasetid+"/download/?format="+a;return c+=this.getQueryStringURL(b)},getQueryStringURL:function(a){return a=a||{},"&"+ODS.URLUtils.getAPIQueryString(angular.extend({},this.parameters,a))},toggleRefine:function(a,b,c){ODS.Context.toggleRefine(this,a,b,c)},getActiveFilters:function(){if(this.parameters){var a=Object.keys(this.parameters),b=this;return a.filter(function(a){return"q"==a&&b.parameters.q&&b.parameters.q.length>0||"q.timerange"==a||"q.timescale"==a||"q.mapfilter"==a||"geofilter.polygon"==a||"geofilter.distance"==a||0===a.indexOf("refine.")})}return[]},name:e,type:"dataset",domain:f,domainUrl:a.getDomainURL(f),apikey:j,dataset:null,parameters:h,source:h&&h.source||i||null};if(k)m.dataset=new ODS.Dataset(k),l.resolve(m.dataset);else{var n=h&&h.source||i||"",o=(m.domain||"")+"."+n+"."+g+"."+(j||"");angular.isDefined(b[o])?(m.dataset=new ODS.Dataset(b[o]),l.resolve(m.dataset)):angular.isDefined(c[o])?c[o].then(function(a){m.dataset=new ODS.Dataset(a.data),l.resolve(m.dataset)}):(c[o]=a.datasets.get(m,g,{extrametas:!0,interopmetas:!0,source:n}),c[o].success(function(a){b[o]=a,m.dataset=new ODS.Dataset(a),l.resolve(m.dataset)}).error(function(a){l.reject("Failed to fetch "+e+" context.")}))}return m}}}])}(),function(){"use strict";angular.module("ods-widgets").provider("ODSCurrentDomain",[function(){var a={};a.domainId="",this.setDomain=function(b){a.domainId=b},this.$get=function(){return a}}])}(),function(){"use strict";angular.module("ods-widgets").service("I18n",["translate",function(a){return{weekdays:{shorthand:[a("Sun"),a("Mon"),a("Tue"),a("Wed"),a("Thu"),a("Fri"),a("Sat")],longhand:[a("Sunday"),a("Monday"),a("Tuesday"),a("Wednesday"),a("Thursday"),a("Friday"),a("Saturday")]},months:{shorthand:[a("Jan"),a("Feb"),a("Mar"),a("Apr"),a("May"),a("Jun"),a("Jul"),a("Aug"),a("Sep"),a("Oct"),a("Nov"),a("Dec")],longhand:[a("January"),a("February"),a("March"),a("April"),a("May"),a("June"),a("July"),a("August"),a("September"),a("October"),a("November"),a("December")]},fr:{timeFormat:"HH:mm",timeSeparators:[":"],dateFormat:"DD/MM/YYYY",dateSeparators:["/"],firstDayOfWeek:1},en:{timeFormat:"hh:mm A",timeSeparators:[":"," "],dateFormat:"MM/DD/YYYY",dateSeparators:["/"],firstDayOfWeek:0}}}])}(),function(){"use strict";angular.module("ods-widgets").factory("MapHelper",["ODSWidgetsConfig","ODSAPI","$q","AggregationHelper","translate",function(a,b,c,d,e){var f=5,g=",",h="#C32D1C";return{WORLD_BOUNDS:[[-60,-180],[80,180]],DEFAULT_MARKER_COLOR:h,DEFAULT_RANGE_COLORS:["#FC9272","#A5211B"],retrieveBounds:function(a){var d=this,e=c.defer();if(0===a.length)e.resolve(null);else{var f=[];angular.forEach(a,function(a){var c={};jQuery.extend(c,a.parameters),f.push(b.records.boundingbox(a,c))}),c.all(f).then(function(a){var b;angular.forEach(a,function(a){var c=a.data,d=[[c.bbox[1],c.bbox[0]],[c.bbox[3],c.bbox[2]]];c.count>0&&(b?b.extend(d):b=L.latLngBounds(d))}),b&&b.isValid()?e.resolve(b):e.resolve(d.WORLD_BOUNDS)})}return e.promise},getLocationStructure:function(a){var b=a.split(g);return{center:[b[1],b[2]],zoom:b[0]}},getLocationParameter:function(a,b){angular.isArray(a)&&(a=L.latLng(a));var c=L.Util.formatNum(a.lat,f),d=L.Util.formatNum(a.lng,f);return b+g+c+g+d},_getDatasetFieldBound:function(a,d,e){var f=this,g=c.defer(),h=angular.extend({},a.parameters,{rows:1}),i=d;return e&&(i=e+i),b.records.search(a,angular.extend(h,{sort:i})).then(function(a){g.resolve(f.boundAsNumber(a.data.records[0].fields[d]))}),g.promise},getDatasetFieldBoundMin:function(a,b){return this._getDatasetFieldBound(a,b,"-")},getDatasetFieldBoundMax:function(a,b){return this._getDatasetFieldBound(a,b)},getDatasetFieldBounds:function(a,b){var d=[this.getDatasetFieldBoundMin(a,b),this.getDatasetFieldBoundMax(a,b)],e=c.defer();return c.all(d).then(function(a){var b=a.sort(ODS.ArrayUtils.sortNumbers),c=b[0],d=b[1];e.resolve([c,d])}),e.promise},boundAsNumber:function(a){return Math.round(100*parseFloat(a))/100},getLayerLegendLabel:function(a){var b=null;if(["choropleth","categories","heatmap"].indexOf(a.display)>=0){var c;if("categories"===a.display||"choropleth"===a.display?c=a.context.dataset.getField(a.color.field):"COUNT"!==a.func.toUpperCase()&&(c=a.context.dataset.getField(a.expr)),c){b=c.label;var f=[];a.func&&f.push(d.getFunctionLabel(a.func));var g=a.context.dataset.getFieldAnnotation(c,"unit");if(g){var h=e("in {unit}");f.push(format_string(h,{unit:g.args[0]}))}f.length&&(b+=" ("+f.join(", ")+")")}else b=e("Number of elements");return b}},MapConfiguration:{getActiveContextList:function(a,b){b=b||{};var c=[];return angular.forEach(a.groups,function(a){a.displayed&&angular.forEach(a.layers,function(a){b.geoOnly&&!a.context.dataset.hasGeoField()||a.excludeFromRefit&&b.skipExcludedFromRefit||c.push(a.context)})}),c},getContextList:function(a){var b=[];return angular.forEach(a.groups,function(a){angular.forEach(a.layers,function(a){a.context&&a.context.dataset&&a.context.dataset.hasGeoField()&&b.push(a.context)})}),b},createLayerGroupConfiguration:function(){return{color:null,title:null,description:null,displayed:!0,picto:null,layers:[]}},createLayerConfiguration:function(a,b){angular.isUndefined(b)&&(b={});var c=b.display||"auto";"clusters"===c&&(c="polygon"),"clustersforced"===c&&(c="polygonforced"),"raw"===c&&(c="none"),b.size=Math.min(b.size,10),b.radius=Math.min(b.radius,10);var d={context:null,color:b.color,colorFunction:b.colorFunction,picto:b.picto,display:c,func:b.function||(b.expression?"AVG":"COUNT"),expr:b.expression||null,marker:null,size:b.size||null,radius:b.radius||null,tooltipTemplate:a,localKey:b.localKey||null,remoteKey:b.remoteKey||null,tooltipSort:b.tooltipSort,hoverField:b.hoverField||null,shapeOpacity:b.shapeOpacity||null,borderOpacity:b.borderOpacity||null,pointOpacity:b.pointOpacity||null,borderColor:b.borderColor,excludeFromRefit:b.excludeFromRefit,caption:!!angular.isDefined(b.caption)&&b.caption,captionTitle:b.captionTitle||null,showZoomMin:b.showZoomMin||null,showZoomMax:b.showZoomMax||null,minSize:b.minSize||null,maxSize:b.maxSize||null,sizeFunction:b.sizeFunction||null};return this.createLayerId(d),d},setLayerDisplaySettingsFromDefault:function(a){(angular.isUndefined(a.marker)||null===a.marker)&&(null!==a.context.dataset.getExtraMeta("visualization","map_marker_hidemarkershape")?a.marker=!a.context.dataset.getExtraMeta("visualization","map_marker_hidemarkershape"):a.marker=!0),a.color=a.color||a.context.dataset.getExtraMeta("visualization","map_marker_color")||h,a.picto=a.picto||a.context.dataset.getExtraMeta("visualization","map_marker_picto")||(a.marker?"ods-circle":"dot"),a.marker?a.size=a.size||4:a.size=a.size||7,(angular.isUndefined(a.shapeOpacity)||null===a.shapeOpacity)&&(a.shapeOpacity=a.shapeOpacity||.5),(angular.isUndefined(a.pointOpacity)||null===a.pointOpacity)&&(a.pointOpacity=a.pointOpacity||1),a.radius=a.radius||4,a.borderOpacity=a.borderOpacity||1,a.borderColor=a.borderColor||"#FFFFFF",a.borderSize=a.borderSize||1,a.borderPattern=a.borderPattern||"solid",a.sizeFunction=a.sizeFunction||"linear",a.minSize=a.minSize||3,a.maxSize=a.maxSize||5,this.createLayerId(a)},getVisibleLayerIds:function(a){var b=[];return angular.forEach(a.groups,function(a){a.displayed&&angular.forEach(a.layers,function(a){b.push(a._runtimeId)})}),b},createLayerId:function(a){angular.isUndefined(a._runtimeId)&&(a._runtimeId=ODS.StringUtils.getRandomUUID())}}}}])}(),function(){"use strict";angular.module("ods-widgets").factory("MapLayerHelper",["$rootScope","$compile","$filter","ODSAPI","PictoHelper","SVGInliner",function(a,b,c,d,e,f){return{getRecordColor:function(a,b){var c,d;if(angular.isUndefined(b.color))return"#C32D1C";if(angular.isString(b.color))return b.color;if("range"===b.color.type)return b.color.field?(c=a&&a.fields&&a.fields[b.color.field],angular.isUndefined(c)?b.color.colors[0]:this.getColor(c,b)):(console.error("Range coloring requires a field"),b.color.colors[0]);if("categories"===b.color.type)return c=a&&a.fields&&a.fields[b.color.field],d=b.color.categories[c],angular.isUndefined(d)?b.color.otherCategories||"#000000":d;if("field"!==b.color.type){if("choropleth"===b.color.type){if(c=a&&a.fields&&a.fields[b.color.field],angular.isUndefined(c))return"#000000";if(!angular.isNumber(c))return console.warn(c,"is not a numeric value to display in choropleth mode."),"#000000";var e=Object.keys(b.color.ranges).map(function(a){return parseFloat(a)}).sort(function(a,b){return a-b}),f=0;for(f=0;f<e.length;f++)if(c<=e[f])return b.color.ranges[e[f]];return b.color.ranges[e[e.length-1]]}return console.error("Scale coloring is not supported for simple records"),chroma.scale(b.color.scale).out("hex").scale(0)}if(!(d=a&&a.fields&&a.fields[b.color.field]))return"#000000";try{return chroma(d).hex()}catch(a){return"#000000"}},getClusterColor:function(a,b){return angular.isUndefined(b.color)?"#C32D1C":angular.isString(b.color)?b.color:b.color.colors[0]},getColor:function(a,b,c,d,e){if(e=e||10,angular.isUndefined(b.color))return"#C32D1C";if(angular.isString(b.color))return angular.isDefined(c)&&angular.isDefined(d)?chroma.scale([chroma(b.color).brighten(50),b.color]).domain([c,d],Math.min(10,e),b.colorFunction).out("hex")(a):b.color;if("scale"===b.color.type)return chroma.scale(b.color.scale).domain([c,d],Math.min(10,e),b.colorFunction).out("hex")(a);if("range"===b.color.type){var f;for(f=0;f<b.color.ranges.length;f++)if(a<b.color.ranges[f])return b.color.colors[f];return b.color.colors[b.color.colors.length-1]}},bindTooltip:function(a,b,c,d,e,f,g){var h=this;angular.isArray(d)&&(d={type:"Point",coordinates:[d[1],d[0]]}),c.refineOnClick?b.on("click",function(b){a.isDrawing||h.refineContextOnClick(c,d,f,g)}):b.on("click",function(b){if(!a.isDrawing&&(d||e||f||b.data)){var g,i;angular.isDefined(b.target.getLatLng)?g=b.target.getLatLng():(g=b.latlng,i=0),h.showPopup(a,c,g,d,e,f,i,b.data||null)}})},refineContextOnClick:function(b,c,e,f){var g=function(g){var h=g.contextField,i=g.mapField,j=g.context,k=g.replaceRefine;if(i||h)if(angular.isDefined(f)&&i==b.hoverField)a.$apply(function(){j.toggleRefine(h,f,k)});else{var l={format:"json"};e?l.geo_digest=e:ODS.GeoFilter.addGeoFilterFromSpatialObject(l,c),angular.extend(l,b.context.parameters,{rows:1}),d.records.download(b.context,l).success(function(a){angular.isDefined(a[0].fields[i])&&j.toggleRefine(h,a[0].fields[i],k)})}else a.$apply(function(){ODS.GeoFilter.addGeoFilterFromSpatialObject(j.parameters,c)})};angular.forEach(b.refineOnClick,g)},bindZoomable:function(a,b,c){b.on("click",function(b){a.isDrawing||(a.getZoom()===a.getMaxZoom()?this.showPopup(a,c,b.target.getLatLng(),b.target.getClusterShape()):a.setView(b.latlng,a.getZoom()+2))})},showPopup:function(c,d,e,f,g,h,i,j){var k=a.$new(!0);g&&(k.recordid=g),f&&(k.shape=f),j&&(k.gridData=j);var l=d.context.dataset;k.map=c,k.template=d.tooltipTemplate||l.extra_metas&&l.extra_metas.visualization&&l.extra_metas.visualization.map_tooltip_html_enabled&&l.extra_metas.visualization.map_tooltip_html||"";var m={offset:[0,angular.isDefined(i)?i:-30],maxWidth:250,minWidth:250};k.context=d.context,new L.Popup(m).setLatLng(e).setContent(b('<ods-map-tooltip tooltip-sort="'+(d.tooltipSort||"")+'" shape="shape" recordid="recordid" context="context" map="map" template="{{ template }}" grid-data="gridData" geo-digest="'+(h||"")+'"></ods-map-tooltip>')(k)[0]).openOn(c)},formatNumber:function(a){return a=Math.round(100*a)/100,a=c("number")(a)},getClusterValue:function(a,b){return"aggregation"===b.display&&b.joinContext?a.serie1:"COUNT"!==b.func&&this.isAnalyzeEnabledClustering(b)?a.series?a.series.serie1:null:a.count},getClusterMin:function(a,b){return"aggregation"===b.display&&b.joinContext?a.aggregations.agg1.min:"COUNT"!==b.func&&this.isAnalyzeEnabledClustering(b)?a.series.serie1.min:a.count.min},getClusterMax:function(a,b){return"aggregation"===b.display&&b.joinContext?a.aggregations.agg1.max:"COUNT"!==b.func&&this.isAnalyzeEnabledClustering(b)?a.series.serie1.max:a.count.max},getClusterValues:function(a,b){var c,d=[];if("aggregation"===b.display&&b.joinContext)for(c=0;c<a.results.length;c++)d.push(a.results[c].serie1);else if("COUNT"!==b.func&&this.isAnalyzeEnabledClustering(b))for(c=0;c<a.clusters.length;c++)a.clusters[c].series&&d.push(a.clusters[c].series.serie1);else for(c=0;c<a.clusters.length;c++)d.push(a.clusters[c].count);return d},isAnalyzeEnabledClustering:function(a){return["heatmap","polygonforced","shape","aggregation","clusters"].indexOf(a.display)>=0},doesLayerRefreshOnLocationChange:function(a){return"tiles"!==a.display&&("shape"!==a.display&&"aggregation"!==a.display||!a.joinContext)},drawPoint:function(a,b,c,d,g,h){var i=this;f.getPromise(e.mapPictoToURL(a.picto,a.context),a.marker?"white":i.getRecordColor(d,a)).then(function(e){var f=new L.VectorMarker(c,{color:i.getRecordColor(d,a),icon:e,marker:a.marker,opacity:a.pointOpacity,size:a.size});g.addLayer(f),d?i.bindTooltip(b,f,a,c,d.recordid):i.bindTooltip(b,f,a,c,null,h)})},drawShape:function(a,b,c,d,e,f){var g=this,h=new L.GeoJSON(c,{style:function(b){var c={};return c.radius=3,a.borderPattern&&"solid"!==a.borderPattern&&(c.dashArray=g.patternToDashArray(a.borderPattern)),"LineString"===b.geometry.type||"MultiLineString"===b.geometry.type?(c.weight=5,c.color=g.getRecordColor(d,a),angular.isDefined(a.shapeOpacity)?c.opacity=a.shapeOpacity:c.opacity=.5):(c.fillColor=g.getRecordColor(d,a),angular.isDefined(a.borderSize)?c.weight=a.borderSize:c.weight=1,angular.isDefined(a.shapeOpacity)?c.fillOpacity=a.shapeOpacity:c.fillOpacity=.5,angular.isDefined(a.borderOpacity)?c.opacity=a.borderOpacity:c.opacity=1,angular.isDefined(a.borderColor)?c.color=a.borderColor:c.color="#fff",a.borderPattern&&"solid"!==a.borderPattern&&(c.dashArray=g.patternToDashArray(a.borderPattern))),c}});d?g.bindTooltip(b,h,a,c,d.recordid):g.bindTooltip(b,h,a,c,null,f),e.addLayer(h)},patternToDashArray:function(a){var b,c=1,d=5,e=15;switch(a){case"long-dashes":b=[30,e];break;case"medium-dashes":b=[e,e];break;case"short-dashes":b=[d,e];break;case"dots":b=[c,e];break;case"short-dot":b=[c,d,d];break;case"short-dot-dot":b=[c,d,d,c,d];break;case"medium-short":b=[e,d,d,d];break;default:console.error("Unknown border pattern",a)}return b.join(", ")}}}])}(),function(){"use strict";angular.module("ods-widgets").factory("MapLayerRenderer",["ODSAPI","AggregationHelper","SVGInliner","PictoHelper","MapLayerHelper","MapRenderingAggregation","MapRenderingClustered","MapRenderingHeatmap","MapRenderingRaw","MapRenderingShapePreview","$q","$filter","$rootScope","$compile","$timeout",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){return{updateDataLayer:function(b,c){var d=this,l=b._rendered;b._currentRequestTimeout&&b._currentRequestTimeout.resolve();var n=k.defer();b._currentRequestTimeout=n;var p=k.defer(),q=function(a){d.swapLayers(c,l,a),b._rendered=a,b._currentRequestTimeout=null,b._loading=!1,p.resolve()};if("tiles"===b.display){b._rendered||(b._rendered=new L.BundleTileLayer("",{tileSize:512,minZoom:c.getMinZoom(),maxZoom:c.getMaxZoom(),gridLayer:{options:{resolution:4}}}),c.addLayer(b._rendered),o(function(){b._rendered.on("loading",function(){b._loading=!0,m.$apply()}),b._rendered.on("load",function(){b._loading=!1,m.$apply()})},0),e.bindTooltip(c,b._rendered,b));var r={color:b.color,icon:b.picto,showmarker:b.marker};angular.extend(r,b.context.parameters);var s="/api/datasets/1.0/"+b.context.dataset.datasetid+"/tiles/simple/{z}/{x}/{y}.bundle",t="";angular.forEach(r,function(a,b){null!==a&&(t+=t?"&":"?",t+=b+"="+encodeURIComponent(a))}),s+=t,b._rendered._url!==s&&b._rendered.setUrl(s),p.resolve()}else if("none"===b.display||c.getZoom()===c.getMaxZoom()&&"polygon"===b.display)b._loading=!0,i.render(b,c,n).then(q);else if(["polygon","polygonforced","clusters"].indexOf(b.display)>=0)b._loading=!0,g.render(b,c,n,!0).then(q);else if("heatmap"===b.display)b._loading=!0,h.render(b,c,n).then(q);else if("shape"===b.display||"aggregation"===b.display)b._loading=!0,f.render(b,c,n).then(q);else if("categories"===b.display)b._loading=!0,i.render(b,c,n).then(q);else if("choropleth"===b.display)b._loading=!0,i.render(b,c,n).then(q);else if("auto"===b.display){b._loading=!0;var u=angular.extend({},b.context.parameters,{"geofilter.bbox":ODS.GeoFilter.getBoundsAsBboxParameter(c.getBounds())});a.records.boundingbox(b.context,u).success(function(a){var d=5e5,e=a.count<d;a.geometries&&a.geometries.Point&&a.geometries.Point>a.count/2&&(a.count<200||c.getZoom()===c.getMaxZoom())?i.render(b,c,n).then(q):a.count<5e5?a.geometries&&a.geometries.Point&&a.geometries.Point>a.count/2?g.render(b,c,n,e).then(q):j.render(b,c,n).then(q):g.render(b,c,n,e).then(q)})}else console.log('ERROR: Unknown display mode "'+b.display+'"');return p.promise},swapLayers:function(a,b,c){b&&a.removeLayer(b),a.addLayer(c)}}}])}(),function(){"use strict";angular.module("ods-widgets").service("MapRenderingAggregation",["ODSAPI","MapLayerHelper","AggregationHelper","$q",function(a,b,c,d){return{render:function(e,f,g){function h(a){var d=j(a);if(0===d.length)return void l.resolve(m);var g=b.getClusterMin(a,e),h=b.getClusterMax(a,e),k=b.getClusterValues(a,e),n=function(a){return b.getColor(a,e,g,h,k.length)},o={radius:3,color:"#fff",weight:1,opacity:.9,fillOpacity:.5};if((!angular.isObject(e.color)||"range"!==e.color.type)&&("COUNT"!==e.func&&b.isAnalyzeEnabledClustering(e)||g!==h)){L.Legend=L.Control.extend({initialize:function(a){L.Control.prototype.initialize.call(this,a)},onAdd:function(a){var d=chroma.scale().domain([g,h],Math.min(10,k.length),e.colorFunction).domain(),f="",i=L.DomUtil.create("div","odswidget-map__legend"),j=e.context.dataset.datasetid,l=e.expr;if(l&&(l=e.context.dataset.getFieldLabel(e.expr)),j=e.context.dataset.metas.title,f+='<div class="odswidget-map__legend-title">'+j+"<br/>"+c.getFunctionLabel(e.func),"COUNT"!==e.func&&(f+=" "+l),f+="</div>",f+='<div class="odswidget-map__legend-colors">',1===k.length)f+='<i class="color_0" style="width: 90%; background-color:'+n((d[0]+d[1])/2)+'; opacity: 1;"></i>',f+='</div><div class="odswidget-map__legend-counts">',f+='<span class="odswidget-map__legend-value">',f+=b.formatNumber(d[0]),f+="</span>";else{for(var m=90/(d.length-1),o=0;o<d.length-1;o++)f+='<i class="odswidget-map__legend-color" style="width:'+m+"%; background-color:"+n((d[o]+d[o+1])/2)+'; opacity: 1;"></i>';f+="</div><div>",f+='<span class="odswidget-map__legend-value">',f+=b.formatNumber(d[0]),f+="</span>",f+='<span class="odswidget-map__legend-value">',f+=b.formatNumber(d[d.length-1]),f+="</span>"}return f+="</div>",i.innerHTML=f,i}});var p=new L.Legend({position:"bottomleft"}),q=function(a){a.layer===m&&(f.addControl(p),f.off("layeradd",q))};f.on("layeradd",q);var r=function(a){a.layer===m&&(f.removeControl(p),f.off("layerremove",r))};f.on("layerremove",r)}for(var s=function(a,b,c,d){b.on("mouseover",function(a){a.target.setStyle({weight:2})}),b.on("mouseout",function(a){a.target.setStyle({weight:1})})},t=0;t<d.length;t++){var u,v,w=d[t],x=b.getClusterValue(w,e),y=function(a,b){return L.circleMarker(b,o)};null!==x&&(v=i(w))&&(u=new L.GeoJSON(v,{pointToLayer:y,highlight:b.getColor(x,e,g,h,k.length),style:function(a){var b=angular.copy(o);return b.fillColor=n(x),angular.isDefined(e.shapeOpacity)&&(b.fillOpacity=e.shapeOpacity),"LineString"===a.geometry.type||"MultiLineString"===a.geometry.type?(b.weight=5,b.color=n(x)):angular.isDefined(e.borderColor)&&(b.color=e.borderColor),b}}),"LineString"!==v.type&&"MultiLineString"!==v.type&&s(e,u,w,null),e.joinContext&&e.hoverField?w.x[0].fields[e.hoverField]?(u.bindLabel(w.x[0].fields[e.hoverField]),e.refineOnClick&&b.bindTooltip(f,u,e,v,null,w.geo_digest,w.x[0].fields[e.hoverField])):e.refineOnClick&&b.bindTooltip(f,u,e,v,null,w.geo_digest):(("COUNT"!==e.func&&b.isAnalyzeEnabledClustering(e)||g!==h)&&u.bindLabel(b.formatNumber(x)),e.refineOnClick&&b.bindTooltip(f,u,e,v,null,w.geo_digest)),m.addLayer(u))}l.resolve(m)}var i,j,k,l=d.defer(),m=new L.LayerGroup;if(e.joinContext){var n=e.localKey,o=e.remoteKey;n&&o||console.error("An aggregation layer with a remote dataset requires a local-key and a remote-key");var p=e.joinContext.dataset.getFieldsForType("geo_shape");p.length||console.error("You can only join an aggregation layer with a dataset that contains a geo_shape field.");var q=p[0].name;i=function(a){return angular.isArray(a.x)&&a.x[0].fields?a.x[0].fields[q]:null},j=function(a){return a.results};var r=q;e.hoverField&&(r+=","+e.hoverField),k=angular.extend({},e.context.parameters,{clusterprecision:f.getZoom(),"geofilter.bbox":ODS.GeoFilter.getBoundsAsBboxParameter(f.getBounds()),"join.agg1.fields":r,"join.agg1.remotedataset":e.joinContext.dataset.datasetid,"join.agg1.remotekey":o,"join.agg1.localkey":n,"agg.agg1.func":"MIN,MAX","agg.agg1.expr":"serie1","y.serie1.expr":e.expr,"y.serie1.func":e.func}),a.records.analyze(e.context,k,g.promise).success(h)}else i=function(a){return a.cluster},j=function(a){return a.clusters},k=angular.extend({},e.context.parameters,{clusterprecision:f.getZoom(),"geofilter.bbox":ODS.GeoFilter.getBoundsAsBboxParameter(f.getBounds())}),"COUNT"!==e.func&&b.isAnalyzeEnabledClustering(e)&&(k["y.serie1.expr"]=e.expr,k["y.serie1.func"]=e.func),a.records.geopolygon(e.context,k,g.promise).success(h);return l.promise}}}])}(),function(){"use strict";angular.module("ods-widgets").service("MapRenderingClustered",["ODSAPI","MapLayerHelper","SVGInliner","PictoHelper","$q",function(a,b,c,d,e){return{render:function(c,d,f,g){var h=e.defer(),i=new L.LayerGroup,j=angular.extend({},c.context.parameters,{clusterdistance:50,clusterprecision:d.getZoom(),"geofilter.bbox":ODS.GeoFilter.getBoundsAsBboxParameter(d.getBounds()),return_polygons:g});return"COUNT"!==c.func&&b.isAnalyzeEnabledClustering(c)&&(j["y.serie1.expr"]=c.expr,j["y.serie1.func"]=c.func),a.records.geo(c.context,j,f.promise).success(function(a){for(var e=a.clusters,f=0;f<e.length;f++){var g=e[f];if(1===g.count&&"polygonforced"!==c.display)b.drawPoint(c,d,g.cluster_center,g,i);else if(null!==b.getClusterValue(g,c)){var j=new L.ClusterMarker(g.cluster_center,{geojson:g.cluster,value:b.getClusterValue(g,c),min:b.getClusterMin(a,c),max:b.getClusterMax(a,c),color:b.getClusterColor(g,c),opacity:c.pointOpacity,numberFormattingFunction:b.formatNumber,minSize:c.minSize,maxSize:c.maxSize,borderOpacity:c.borderOpacity,borderSize:c.borderSize,borderColor:c.borderColor,sizeFunction:c.sizeFunction});b.bindZoomable(d,j,c),i.addLayer(j)}}h.resolve(i)}),h.promise}}}])}(),function(){"use strict";angular.module("ods-widgets").service("MapRenderingHeatmap",["ODSAPI","MapLayerHelper","$q",function(a,b,c){return{render:function(d,e,f){var g=c.defer(),h={};angular.isObject(d.color)&&"gradient"===d.color.type&&d.color.steps&&(h.gradient=d.color.steps);var i=angular.extend({},d.context.parameters,{clustermode:"heatmap",clusterdistance:15,clusterprecision:e.getZoom(),"geofilter.bbox":ODS.GeoFilter.getBoundsAsBboxParameter(e.getBounds())});return"COUNT"!==d.func&&b.isAnalyzeEnabledClustering(d)&&(i["y.serie1.expr"]=d.expr,i["y.serie1.func"]=d.func),a.records.geo(d.context,i,f.promise).success(function(a){var c=a.clusters;h.radius=Math.min(1/a.clusters.length*(d.radius/4*4e3)+20,50);var e=b.getClusterMin(a,d),f=b.getClusterMax(a,d);d._bounds=[e,f];for(var i=[],j=0;j<c.length;j++){var k=c[j],l=b.getClusterValue(k,d);if(null!==l){var m=ODS.CalculationUtils.getValueOnScale(l,e,f,d.sizeFunction);i.push([k.cluster_center[0],k.cluster_center[1],m])}}var n=null;i.length>0&&(n=L.heatLayer(i,h)),g.resolve(n)}),g.promise}}}])}(),function(){"use strict";angular.module("ods-widgets").service("MapRenderingRaw",["ODSAPI","MapLayerHelper","SVGInliner","PictoHelper","$q",function(a,b,c,d,e){return{render:function(c,d,f){var g=e.defer(),h=new L.LayerGroup,i=angular.extend({},c.context.parameters,{rows:1e3,format:"json",geo_simplify:!0,geo_simplify_zoom:d.getZoom(),"geofilter.bbox":ODS.GeoFilter.getBoundsAsBboxParameter(d.getBounds())}),j=c.context.dataset.getFieldsForType("geo_shape"),k=j.length?j[0].name:null,l=[];return k?l.push(k):l.push(c.context.dataset.getFieldsForType("geo_point_2d")[0].name),c.color.field&&l.push(c.color.field),i.fields=l.join(","),a.records.download(c.context,i,f.promise).success(function(a){for(var e=0;e<a.length;e++){var f,i=a[e];if(k){if(!i.fields[k])return;f=i.fields[k],"Point"===f.type&&angular.isDefined(i.geometry)&&(f=i.geometry)}else{if(!i.geometry)return;f=i.geometry}"Point"===f.type?b.drawPoint(c,d,[f.coordinates[1],f.coordinates[0]],i,h):b.drawShape(c,d,f,i,h)}g.resolve(h)}),g.promise}}}])}(),function(){"use strict";angular.module("ods-widgets").service("MapRenderingShapePreview",["ODSAPI","MapLayerHelper","$q",function(a,b,c){return{render:function(d,e,f){var g=c.defer(),h=angular.extend({},d.context.parameters,{rows:1e3,clusterprecision:e.getZoom(),"geofilter.bbox":ODS.GeoFilter.getBoundsAsBboxParameter(e.getBounds())}),i=new L.LayerGroup;return a.records.geopreview(d.context,h,f.promise).success(function(a){for(var c,f=0;f<a.length;f++)c=a[f],"Point"===c.geometry.type?b.drawPoint(d,e,[c.geometry.coordinates[1],c.geometry.coordinates[0]],null,i,c.geo_digest):b.drawShape(d,e,c.geometry,null,i,c.geo_digest);g.resolve(i)}),g.promise}}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.factory("odsTimerangeParser",function(){var a=/([\w-]+):\[(.*) TO (.*)\]/;return function(b){var c=a.exec(decodeURIComponent(b));return c?{field:c[1],from:c[2],to:c[3]}:{}}}),a.factory("odsTimescaleParser",["translate",function(a){var b=/([\w-]+)>=#now\((.*)=-(\w)\)/,c={years:{1:a("Last 12 months")},weeks:{1:a("Last 7 days"),4:a("Last 4 weeks")},days:{1:a("Last 24 hours")}};return function(a){var d=b.exec(decodeURIComponent(a));return d?{field:d[1],scaleLabel:c[d[2]][d[3]]}:{}}}])}(),function(){"use strict";angular.module("ods-widgets").service("Timezones",[function(){return["UTC","Africa/Abidjan","Africa/Accra","Africa/Addis_Ababa","Africa/Algiers","Africa/Asmara","Africa/Bamako","Africa/Bangui","Africa/Banjul","Africa/Bissau","Africa/Blantyre","Africa/Brazzaville","Africa/Bujumbura","Africa/Cairo","Africa/Casablanca","Africa/Ceuta","Africa/Conakry","Africa/Dakar","Africa/Dar_es_Salaam","Africa/Djibouti","Africa/Douala","Africa/El_Aaiun","Africa/Freetown","Africa/Gaborone","Africa/Harare","Africa/Johannesburg","Africa/Juba","Africa/Kampala","Africa/Khartoum","Africa/Kigali","Africa/Kinshasa","Africa/Lagos","Africa/Libreville","Africa/Lome","Africa/Luanda","Africa/Lubumbashi","Africa/Lusaka","Africa/Malabo","Africa/Maputo","Africa/Maseru","Africa/Mbabane","Africa/Mogadishu","Africa/Monrovia","Africa/Nairobi","Africa/Ndjamena","Africa/Niamey","Africa/Nouakchott","Africa/Ouagadougou","Africa/Porto-Novo","Africa/Sao_Tome","Africa/Tripoli","Africa/Tunis","Africa/Windhoek","America/Adak","America/Anchorage","America/Anguilla","America/Antigua","America/Araguaina","America/Argentina/Buenos_Aires","America/Argentina/Catamarca","America/Argentina/Cordoba","America/Argentina/Jujuy","America/Argentina/La_Rioja","America/Argentina/Mendoza","America/Argentina/Rio_Gallegos","America/Argentina/Salta","America/Argentina/San_Juan","America/Argentina/San_Luis","America/Argentina/Tucuman","America/Argentina/Ushuaia","America/Aruba","America/Asuncion","America/Atikokan","America/Bahia","America/Bahia_Banderas","America/Barbados","America/Belem","America/Belize","America/Blanc-Sablon","America/Boa_Vista","America/Bogota","America/Boise","America/Cambridge_Bay","America/Campo_Grande","America/Cancun","America/Caracas","America/Cayenne","America/Cayman","America/Chicago","America/Chihuahua","America/Costa_Rica","America/Creston","America/Cuiaba","America/Curacao","America/Danmarkshavn","America/Dawson","America/Dawson_Creek","America/Denver","America/Detroit","America/Dominica","America/Edmonton","America/Eirunepe","America/El_Salvador","America/Fortaleza","America/Glace_Bay","America/Godthab","America/Goose_Bay","America/Grand_Turk","America/Grenada","America/Guadeloupe","America/Guatemala","America/Guayaquil","America/Guyana","America/Halifax","America/Havana","America/Hermosillo","America/Indiana/Indianapolis","America/Indiana/Knox","America/Indiana/Marengo","America/Indiana/Petersburg","America/Indiana/Tell_City","America/Indiana/Vevay","America/Indiana/Vincennes","America/Indiana/Winamac","America/Inuvik","America/Iqaluit","America/Jamaica","America/Juneau","America/Kentucky/Louisville","America/Kentucky/Monticello","America/Kralendijk","America/La_Paz","America/Lima","America/Los_Angeles","America/Lower_Princes","America/Maceio","America/Managua","America/Manaus","America/Marigot","America/Martinique","America/Matamoros","America/Mazatlan","America/Menominee","America/Merida","America/Metlakatla","America/Mexico_City","America/Miquelon","America/Moncton","America/Monterrey","America/Montevideo","America/Montreal","America/Montserrat","America/Nassau","America/New_York","America/Nipigon","America/Nome","America/Noronha","America/North_Dakota/Beulah","America/North_Dakota/Center","America/North_Dakota/New_Salem","America/Ojinaga","America/Panama","America/Pangnirtung","America/Paramaribo","America/Phoenix","America/Port-au-Prince","America/Port_of_Spain","America/Porto_Velho","America/Puerto_Rico","America/Rainy_River","America/Rankin_Inlet","America/Recife","America/Regina","America/Resolute","America/Rio_Branco","America/Santa_Isabel","America/Santarem","America/Santiago","America/Santo_Domingo","America/Sao_Paulo","America/Scoresbysund","America/Shiprock","America/Sitka","America/St_Barthelemy","America/St_Johns","America/St_Kitts","America/St_Lucia","America/St_Thomas","America/St_Vincent","America/Swift_Current","America/Tegucigalpa","America/Thule","America/Thunder_Bay","America/Tijuana","America/Toronto","America/Tortola","America/Vancouver","America/Whitehorse","America/Winnipeg","America/Yakutat","America/Yellowknife","Antarctica/Casey","Antarctica/Davis","Antarctica/DumontDUrville","Antarctica/Macquarie","Antarctica/Mawson","Antarctica/McMurdo","Antarctica/Palmer","Antarctica/Rothera","Antarctica/South_Pole","Antarctica/Syowa","Antarctica/Vostok","Arctic/Longyearbyen","Asia/Aden","Asia/Almaty","Asia/Amman","Asia/Anadyr","Asia/Aqtau","Asia/Aqtobe","Asia/Ashgabat","Asia/Baghdad","Asia/Bahrain","Asia/Baku","Asia/Bangkok","Asia/Beirut","Asia/Bishkek","Asia/Brunei","Asia/Choibalsan","Asia/Chongqing","Asia/Colombo","Asia/Damascus","Asia/Dhaka","Asia/Dili","Asia/Dubai","Asia/Dushanbe","Asia/Gaza","Asia/Harbin","Asia/Hebron","Asia/Ho_Chi_Minh","Asia/Hong_Kong","Asia/Hovd","Asia/Irkutsk","Asia/Jakarta","Asia/Jayapura","Asia/Jerusalem","Asia/Kabul","Asia/Kamchatka","Asia/Karachi","Asia/Kashgar","Asia/Kathmandu","Asia/Khandyga","Asia/Kolkata","Asia/Krasnoyarsk","Asia/Kuala_Lumpur","Asia/Kuching","Asia/Kuwait","Asia/Macau","Asia/Magadan","Asia/Makassar","Asia/Manila","Asia/Muscat","Asia/Nicosia","Asia/Novokuznetsk","Asia/Novosibirsk","Asia/Omsk","Asia/Oral","Asia/Phnom_Penh","Asia/Pontianak","Asia/Pyongyang","Asia/Qatar","Asia/Qyzylorda","Asia/Rangoon","Asia/Riyadh","Asia/Sakhalin","Asia/Samarkand","Asia/Seoul","Asia/Shanghai","Asia/Singapore","Asia/Taipei","Asia/Tashkent","Asia/Tbilisi","Asia/Tehran","Asia/Thimphu","Asia/Tokyo","Asia/Ulaanbaatar","Asia/Urumqi","Asia/Ust-Nera","Asia/Vientiane","Asia/Vladivostok","Asia/Yakutsk","Asia/Yekaterinburg","Asia/Yerevan","Atlantic/Azores","Atlantic/Bermuda","Atlantic/Canary","Atlantic/Cape_Verde","Atlantic/Faroe","Atlantic/Madeira","Atlantic/Reykjavik","Atlantic/South_Georgia","Atlantic/St_Helena","Atlantic/Stanley","Australia/Adelaide","Australia/Brisbane","Australia/Broken_Hill","Australia/Currie","Australia/Darwin","Australia/Eucla","Australia/Hobart","Australia/Lindeman","Australia/Lord_Howe","Australia/Melbourne","Australia/Perth","Australia/Sydney","Canada/Atlantic","Canada/Central","Canada/Eastern","Canada/Mountain","Canada/Newfoundland","Canada/Pacific","Europe/Amsterdam","Europe/Andorra","Europe/Athens","Europe/Belgrade","Europe/Berlin","Europe/Bratislava","Europe/Brussels","Europe/Bucharest","Europe/Budapest","Europe/Busingen","Europe/Chisinau","Europe/Copenhagen","Europe/Dublin","Europe/Gibraltar","Europe/Guernsey","Europe/Helsinki","Europe/Isle_of_Man","Europe/Istanbul","Europe/Jersey","Europe/Kaliningrad","Europe/Kiev","Europe/Lisbon","Europe/Ljubljana","Europe/London","Europe/Luxembourg","Europe/Madrid","Europe/Malta","Europe/Mariehamn","Europe/Minsk","Europe/Monaco","Europe/Moscow","Europe/Oslo","Europe/Paris","Europe/Podgorica","Europe/Prague","Europe/Riga","Europe/Rome","Europe/Samara","Europe/San_Marino","Europe/Sarajevo","Europe/Simferopol","Europe/Skopje","Europe/Sofia","Europe/Stockholm","Europe/Tallinn","Europe/Tirane","Europe/Uzhgorod","Europe/Vaduz","Europe/Vatican","Europe/Vienna","Europe/Vilnius","Europe/Volgograd","Europe/Warsaw","Europe/Zagreb","Europe/Zaporozhye","Europe/Zurich","Indian/Antananarivo","Indian/Chagos","Indian/Christmas","Indian/Cocos","Indian/Comoro","Indian/Kerguelen","Indian/Mahe","Indian/Maldives","Indian/Mauritius","Indian/Mayotte","Indian/Reunion","Pacific/Apia","Pacific/Auckland","Pacific/Chatham","Pacific/Chuuk","Pacific/Easter","Pacific/Efate","Pacific/Enderbury","Pacific/Fakaofo","Pacific/Fiji","Pacific/Funafuti","Pacific/Galapagos","Pacific/Gambier","Pacific/Guadalcanal","Pacific/Guam","Pacific/Honolulu","Pacific/Johnston","Pacific/Kiritimati","Pacific/Kosrae","Pacific/Kwajalein","Pacific/Majuro","Pacific/Marquesas","Pacific/Midway","Pacific/Nauru","Pacific/Niue","Pacific/Norfolk","Pacific/Noumea","Pacific/Pago_Pago","Pacific/Palau","Pacific/Pitcairn","Pacific/Pohnpei","Pacific/Port_Moresby","Pacific/Rarotonga","Pacific/Saipan","Pacific/Tahiti","Pacific/Tarawa","Pacific/Tongatapu","Pacific/Wake","Pacific/Wallis","US/Alaska","US/Arizona","US/Central","US/Eastern","US/Hawaii","US/Mountain","US/Pacific"]}])}(),function(){"use strict";var a=angular.module("ods-widgets"),b={},c=[];a.provider("ModuleLazyLoader",function(){var a={highcharts:{css:[],js:[["https://code.highcharts.com/5.0.2/highcharts.js"],["https://code.highcharts.com/5.0.2/modules/no-data-to-display.js"],["https://code.highcharts.com/5.0.2/highcharts-more.js"],["https://code.highcharts.com/5.0.2/modules/treemap.js"],["https://code.highcharts.com/5.0.2/modules/funnel.js"]]},leaflet:{css:["https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css","https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v0.0.3/leaflet.fullscreen.css","https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.24.0/L.Control.Locate.css","libs/leaflet-control-geocoder/Control.Geocoder.css","libs/ods-vectormarker/vectormarker.css","libs/ods-clustermarker/clustermarker.css","libs/leaflet-label/leaflet.label.css","libs/leaflet-draw/leaflet.draw.css"],js:[["L@https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"],["L.Control.FullScreen@https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v0.0.3/Leaflet.fullscreen.min.js","L.Control.Locate@https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.24.0/L.Control.Locate.js","L.Label@libs/leaflet-label/leaflet.label.js","L.ODSMap@libs/ods-map/ods-map.js","L.ODSTileLayer@libs/ods-map/ods-tilelayer.js","L.Control.Geocoder@libs/leaflet-control-geocoder/Control.Geocoder.js","L.VectorMarker@libs/ods-vectormarker/vectormarker.js","L.ClusterMarker@libs/ods-clustermarker/clustermarker.js","L.Draw@libs/leaflet-draw/leaflet.draw.js","L.HeatLayer@libs/leaflet-heat/leaflet-heat.js"]]},rome:{css:["libs/rome/rome.css"],js:["libs/rome/rome.standalone.js"]},fullcalendar:{css:["libs/fullcalendar/fullcalendar.min.css"],js:["libs/fullcalendar/fullcalendar.min.js"],language_specific:{ar:{js:["libs/fullcalendar/lang/ar.js"]},ca:{js:["libs/fullcalendar/lang/ca.js"]},de:{js:["libs/fullcalendar/lang/de.js"]},es:{js:["libs/fullcalendar/lang/es.js"]},eu:{js:["libs/fullcalendar/lang/eu.js"]},fr:{js:["libs/fullcalendar/lang/fr.js"]},it:{js:["libs/fullcalendar/lang/it.js"]},nl:{js:["libs/fullcalendar/lang/nl.js"]},pt:{js:["libs/fullcalendar/lang/pt.js"]}}},qtip:{css:["libs/qtip/jquery.qtip.min.css"],js:["libs/qtip/jquery.qtip.min.js"]}};this.getConfig=function(){return a};var d=function(a,b){var c=b.split(".");if(a.hasOwnProperty(c[0])&&angular.isDefined(a[c[0]])){if(1===c.length)return!0;var e=a[c[0]];return c.shift(),d(e,c.join("."))}return!1},e=function(a){return d(window,a)};this.$get=["$q","ODSWidgetsConfig",function(d,f){var g=function(a,e){if(angular.isUndefined(b[e])){var g=d.defer();b[e]=g;var h="/"===e.substring(0,1)||"http://"===e.substring(0,7)||"https://"===e.substring(0,8)?e:f.basePath+e;LazyLoad[a](h,function(){g.resolve(),c.push(e)}),b[e]=g}return b[e]},h=function(a,f,i,j){var k,l=[];if(angular.isUndefined(j)&&(j=0),j>=f.length)i.resolve();else{k=f[j],angular.isArray(k)||(k=[k]);for(var m=0;m<k.length;m++){var n,o=k[m].split("@");if(o.length>1){if(e(o[0]))continue;n=o[1]}else n=o[0];-1===c.indexOf(n)?l.push(g(a,n).promise):l.push(b[n].promise)}d.all(l).then(function(){h(a,f,i,j+1)})}return i.promise};return function(){for(var b=[],c=0;c<arguments.length;c++){var e=a[arguments[c]];e.language_specific&&e.language_specific[f.language]&&angular.forEach(e.language_specific[f.language],function(a,b){e[b]?e[b]=e[b].concat(a):e[b]=a}),e.css&&b.push(h("css",e.css,d.defer())),e.js&&b.push(h("js",e.js,d.defer()))}return d.all(b)}}]}),a.factory("DebugLogger",["$window",function(a){return{log:function(){("#debug"==a.location.hash||a.location.hash.indexOf("debug=")>=0||$(document.body).hasClass("showDebug"))&&console.log.apply(console,arguments)}}}]),a.factory("odsNotificationService",function(){var a=[];return{registerForNotifications:function(b){a.push(b)},sendNotification:function(b){angular.isString(b)&&(b={title:"Error",type:"error",message:b}),angular.forEach(a,function(a){a(b)})},markNotificationAsHandled:function(a){a&&(a.handled=!0)}}}),a.provider("SVGInliner",function(){var a={},b='<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg id="dot-icon" width="19px" height="19px" viewBox="0 0 19 19" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">    <path d="M13,9.50004202 C13,11.4330618 11.4329777,13.000084 9.49995798,13.000084 C7.56693813,13.000084 5.99991595,11.4330618 5.99991595,9.50004202 C5.99991595,7.56702218 7.56693813,6 9.49995798,6 C11.4329777,6 13,7.56702218 13,9.50004202 L13,9.50004202 Z" id="path8568" fill="#000000"></path>    <rect style="opacity: 0" x="0" y="0" width="19" height="19"></rect></svg>',c=function(a,b,c){var d=angular.element(b);c&&(d.css("fill",c),d.find("path, polygon, circle, rect, text, ellipse").css("fill",c)),a.append(d)};this.$get=["$http","$q",function(d,e){var f=function(f,g,h){var i;h&&(i=e.defer());var j=angular.element('<div class="ods-svginliner__svg-container"></div>');if(f)if(-1===f.indexOf(".svg"))j.append(angular.element('<img src="'+f+'"/>')),h&&i.resolve(j);else if(a[f])a[f].code?(c(j,a[f].code,g),h&&i.resolve(j)):a[f].promise.success(function(a){c(j,a,g),h&&i.resolve(j)}).error(function(){c(j,b,g),h&&i.resolve(j)});else{var k=d.get(f);a[f]={promise:k},k.success(function(b){a[f].code=b,c(j,b,g),h&&i.resolve(j)}).error(function(d,e){console.log("WARNING: Unable to fetch SVG image",f,"HTTP status:",e),a[f].code=b,c(j,b,g),h&&i.resolve(j)})}else c(j,b,g),h&&i.resolve(j);return h?i.promise:j};return{getElement:function(a,b){return f(a,b)},getPromise:function(a,b){return f(a,b,!0)}}}]}),a.service("PictoHelper",function(){var a={"ban-circle":"ban","bar-chart":"bar-chart-o",beaker:"flask",bell:"bell-o","bell-alt":"bell","bitbucket-sign":"bitbucket-square","bookmark-empty":"bookmark-o",building:"building-o (4.0.2)","calendar-empty":"calendar-o","check-empty":"square-o","check-minus":"minus-square-o","check-sign":"check-square",check:"check-square-o","chevron-sign-down":"chevron-down","chevron-sign-left":"chevron-left","chevron-sign-right":"chevron-right","chevron-sign-up":"chevron-up","circle-arrow-down":"arrow-circle-down","circle-arrow-left":"arrow-circle-left","circle-arrow-right":"arrow-circle-right","circle-arrow-up":"arrow-circle-up","circle-blank":"circle-o",cny:"rub","collapse-alt":"minus-square-o","collapse-top":"caret-square-o-up",collapse:"caret-square-o-down","comment-alt":"comment-o","comments-alt":"comments-o",copy:"files-o",cut:"scissors",dashboard:"tachometer","double-angle-down":"angle-double-down","double-angle-left":"angle-double-left","double-angle-right":"angle-double-right","double-angle-up":"angle-double-up",download:"arrow-circle-o-down","download-alt":"download","edit-sign":"pencil-square",edit:"pencil-square-o","ellipsis-horizontal":"ellipsis-h (4.0.2)","ellipsis-vertical":"ellipsis-v (4.0.2)","envelope-alt":"envelope-o",euro:"eur","exclamation-sign":"exclamation-circle","expand-alt":"plus-square-o (4.0.2)",expand:"caret-square-o-right","external-link-sign":"external-link-square","eye-close":"eye-slash","eye-open":"eye","facebook-sign":"facebook-square","facetime-video":"video-camera","file-alt":"file-o","file-text-alt":"file-text-o","flag-alt":"flag-o","folder-close-alt":"folder-o","folder-close":"folder","folder-open-alt":"folder-open-o",food:"cutlery",frown:"frown-o",fullscreen:"arrows-alt (4.0.2)","github-sign":"github-square","google-plus-sign":"google-plus-square",group:"users (4.0.2)","h-sign":"h-square","hand-down":"hand-o-down","hand-left":"hand-o-left","hand-right":"hand-o-right","hand-up":"hand-o-up",hdd:"hdd-o (4.0.1)","heart-empty":"heart-o",hospital:"hospital-o (4.0.2)","indent-left":"outdent","indent-right":"indent","info-sign":"info-circle",keyboard:"keyboard-o",legal:"gavel",lemon:"lemon-o",lightbulb:"lightbulb-o","linkedin-sign":"linkedin-square",meh:"meh-o","microphone-off":"microphone-slash","minus-sign-alt":"minus-square","minus-sign":"minus-circle","mobile-phone":"mobile",moon:"moon-o",move:"arrows (4.0.2)",off:"power-off","ok-circle":"check-circle-o","ok-sign":"check-circle",ok:"check","paper-clip":"paperclip",paste:"clipboard","phone-sign":"phone-square",picture:"picture-o","pinterest-sign":"pinterest-square","play-circle":"play-circle-o","play-sign":"play-circle","plus-sign-alt":"plus-square","plus-sign":"plus-circle",pushpin:"thumb-tack","question-sign":"question-circle","remove-circle":"times-circle-o","remove-sign":"times-circle",remove:"times",reorder:"bars (4.0.2)","resize-full":"expand (4.0.2)","resize-horizontal":"arrows-h (4.0.2)","resize-small":"compress (4.0.2)","resize-vertical":"arrows-v (4.0.2)","rss-sign":"rss-square",save:"floppy-o",screenshot:"crosshairs","share-alt":"share","share-sign":"share-square",share:"share-square-o","sign-blank":"square",signin:"sign-in",signout:"sign-out",smile:"smile-o","sort-by-alphabet-alt":"sort-alpha-desc","sort-by-alphabet":"sort-alpha-asc","sort-by-attributes-alt":"sort-amount-desc","sort-by-attributes":"sort-amount-asc","sort-by-order-alt":"sort-numeric-desc","sort-by-order":"sort-numeric-asc","sort-down":"sort-desc","sort-up":"sort-asc",stackexchange:"stack-overflow","star-empty":"star-o","star-half-empty":"star-half-o",sun:"sun-o","thumbs-down-alt":"thumbs-o-down","thumbs-up-alt":"thumbs-o-up",time:"clock-o",trash:"trash-o","tumblr-sign":"tumblr-square","twitter-sign":"twitter-square",unlink:"chain-broken",upload:"arrow-circle-o-up","upload-alt":"upload","warning-sign":"exclamation-triangle","xing-sign":"xing-square","youtube-sign":"youtube-square","zoom-in":"search-plus","zoom-out":"search-minus"};return{mapPictoToURL:function(b,c){if(!b)return null;var d=c&&c.domainUrl||"";if(b.startsWith("icon-")){var e=b.replace("icon-","");a[e]&&(e=a[e]),d+="/static/pictos/img/set-v1/fa/"+e+".svg"}else b.startsWith("pdpicto-")||b.startsWith("odspicto-")?(b=b.replace("pdpicto-","pdpicto/").replace("odspicto-","odspicto/"),d+="/static/pictos/img/set-v1/"+b+".svg"):b.startsWith("ods-")?(b=b.replace("ods-",""),d+="/static/pictos/img/set-v3/pictos/"+b+".svg"):d+="/static/pictos/img/set-v2/"+b+".svg";return d}}}),a.factory("URLSynchronizer",["$location","$document",function(a,b){var c=!1,d=[];b.bind("webkitfullscreenchange mozfullscreenchange ofullscreenchange msfullscreenchange khtmlfullscreenchange",function(){if(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement)c=!0;else{c=!1;for(var a=0;a<d.length;a++)d[a]()}});var e=[];return{addSynchronizedValue:function(b,f,g,h){e.push(f),g&&e.push(g);var i=a.search()[g||f];b.$eval(f+"=newObj",{newObj:i});var j=function(){var c=b.$eval(f);h&&a.replace(),a.search(g||f,c)},k=b.$watch(f,function(a,b){c||j()},!0);d.push(j);var l=b.$watch(function(){return a.search()[g||f]},function(a,c){a&&b.$eval(f+"=newObj",{newObj:a})},!0);return function(){k(),l()}},addJSONSynchronizedObject:function(b,f,g){e.push(g||f);var h=a.search()[g||f];h&&("{"===h[0]?b.$eval(f+"=newObj",{newObj:JSON.parse(h)}):b.$eval(f+"=newObj",{newObj:JSON.parse(b64_to_utf8(h))}));var i,j=function(){var c=b.$eval(f);void 0===c&&(c=""),i=utf8_to_b64(angular.toJson(c)),a.search(g||f,i)};return d.push(j),b.$watch(function(){return[b.$eval(f),a.search()[g||f]]},function(a,d){void 0===a[0]&&(a[0]=""),i===utf8_to_b64(angular.toJson(a[0]))||c?i!==a[1]&&a[1]&&b.$eval(function(b){b[f]=JSON.parse(b64_to_utf8(a[1]))}):j()},!0)},addSynchronizedObject:function(b,f,g){g=g||[];var h=function(){var c=angular.copy(a.search());if(angular.forEach(c,function(a,b){e.indexOf(b)>=0&&delete c[b]}),g.length>0){var d=b.$eval(f);angular.forEach(g,function(a){angular.isDefined(d[a])&&(c[a]=d[a])})}b.$eval(f+"=newVal",{newVal:c})},i=function(){var c=angular.copy(b.$eval(f));angular.forEach(g,function(a){angular.isDefined(c[a])&&delete c[a]}),angular.forEach(a.search(),function(a,b){(e.indexOf(b)>=0||g.indexOf(b)>=0)&&(c[b]=a)}),a.search(c)};h();var j=b.$watch(f,function(a,b){c||i()},!0);d.push(i);var k=b.$watch(function(){return a.search()},h,!0);return function(){j(),k()}}}}])}(),function(){"use strict";angular.module("ods-widgets").service("ValueDisplay",["$filter","translate","ODSWidgetsConfig",function(a,b,c){var d={language:function(b){return a("isocode_to_language")(b)},visualization:function(a){switch(a){case"analyze":return'<i class="odswidget-facet__value-icon fa fa-bar-chart"></i> '+b("Analyze");case"calendar":return'<i class="odswidget-facet__value-icon fa fa-calendar"></i> '+b("Calendar");case"geo":return'<i class="odswidget-facet__value-icon fa fa-globe"></i> '+b("Map");case"image":return'<i class="odswidget-facet__value-icon fa fa-picture-o"></i> '+b("Image");case"api":return'<i class="odswidget-facet__value-icon fa fa-cogs"></i> '+b("API");case"custom_view":return'<i class="odswidget-facet__value-icon fa fa-'+c.defaultCustomViewConfig.icon+'"></i> '+c.defaultCustomViewConfig.title;default:return a}},date:function(a,b){return b.match(/^[0-9]{4}\/[0-9]{2}$/)?ODS.StringUtils.capitalize(moment.months()[parseInt(a,10)-1]):a}};return{format:function(a,b,c){return angular.isDefined(d)?d[b](a,c):(console.log('Warning (ValueDisplay): unknown value formatter "'+b+'"'),a)}}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.filter("nofollow",function(){return function(a){return angular.isString(a)?a.replace(/<a href="/g,'<a target="_blank" rel="nofollow" href="'):a}}),a.filter("prettyText",["$filter",function(a){function b(a){return a.replace(/&/g,"&amp;").replace(d,function(a){return"&#"+a.charCodeAt(0)+";"}).replace(/</g,"&lt;").replace(/>/g,"&gt;")}var c=/[<>]+/,d=/([^\#-~| |!])/g;return function(d){return d&&angular.isString(d)?c.test(d)?b(d):a("linky")(d,"_blank"):d}}]),a.filter("safenewlines",function(){return function(a){return a?a.replace(/\n/g,"<br/>").replace(/&#10;/g,"<br/>"):a}}),a.filter("imagify",["$sce",function(a){var b=/^(http(?:s?):\/\/[^;,]*(?:jpg|jpeg|png|gif)(?:\?[^,;]*)?)(?:$|;|,|&)/i;return function(c){if(angular.isString(c)){c=c.trim();var d=b.exec(c);if(null!==d)return a.trustAsHtml('<img class="odswidget odswidget-imagified" src="'+d[1]+'" />')}return c}}]),a.filter("videoify",["$sce",function(a){var b=/^https?:\/\/(?:(?:youtu.be\/)|(?:(?:www.)?youtube.com\/watch\?v=))([0-9a-z_-]+)$/i,c=/^https?:\/\/(?:(?:dai.ly)|(?:www.dailymotion.com))\/(?:video\/)?([0-9a-z]+)(?:[0-9a-z_-]*)$/i,d=/^https?:\/\/vimeo.com\/([0-9]+)$/i;return function(e){if(angular.isString(e)){var f=b.exec(e.trim());if(null!==f)return a.trustAsHtml('<iframe width="200" height="113" src="//www.youtube.com/embed/'+f[1]+'" frameborder="0" allowfullscreen></iframe>');if(null!==(f=c.exec(e.trim())))return a.trustAsHtml('<iframe frameborder="0" width="200" height="113" src="//www.dailymotion.com/embed/video/'+f[1]+'" allowfullscreen></iframe>');if(null!==(f=d.exec(e.trim())))return a.trustAsHtml('<iframe src="https://player.vimeo.com/video/'+f[1]+'" width="200" height="113" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>')}return e}}]),a.filter("isDefined",function(){return function(a){return angular.isDefined(a)}}),a.filter("keys",function(){return function(a){return Object.keys(a)}}),a.filter("numKeys",function(){return function(a){return Object.keys(a).length}}),a.filter("values",function(){return function(a){var b=[];return angular.forEach(a,function(a){b.push(a)}),b}}),a.filter("isEmpty",function(){return function(a){return 0===Object.keys(a).length}}),a.filter("displayImageValue",function(a){return function(b,c){if(!b)return b;var d="/explore/dataset/"+c+"/files/"+b.id+"/300/";return a.trustAsHtml('<img class="odswidget odswidget-imagified" src="'+d+'" />')}}),a.filter("fieldsForVisualization",function(){var a={table:[],map:["geo_point_2d","geo_shape"],images:["file"],calendar:[]};return function(b,c){if(angular.isUndefined(b))return b;if(angular.isUndefined(a[c]))throw'Unknown visualization type "'+c+"'";return b.filter(function(b){return-1===a[c].indexOf(b.type)})}}),a.filter("formatFieldValue",["$filter","$sce",function(a,b){var c=/^\/(explore\/(embed\/)?dataset|publish)\/([\w_@-]+)\//,d=function(a){if(a.annotations){var b=a.annotations.filter(function(a){return"timeserie_precision"===a.name});if(b.length>0)return b[0].args[0]}return null};return function(e,f){var g=e[f.name];if(null===g||void 0===g)return"";if("int"===f.type||"double"===f.type){var h,i,j="";if(f.annotations)for(var k=0;k<f.annotations.length;k++)"unit"===f.annotations[k].name&&(j=f.annotations[k].args[0]),"double"==f.type&&"decimals"===f.annotations[k].name&&(h=parseInt(f.annotations[k].args[0],10));return i=angular.isDefined(h)?a("number")(g,h):a("number")(g),j&&(i="$"===j?j+i:i+" "+j),i}if("geo_point_2d"===f.type)return g[0]+", "+g[1];if("geo_shape"===f.type)return a("limitTo")(angular.toJson(g),200);if("date"===f.type){var l=d(f);if("year"===l)return g;if("month"===l){var m=moment(g,"YYYY-MM");return a("capitalize")(a("moment")(m,"MMMM YYYY"))}return a("moment")(g,"LL")}if("datetime"===f.type)return 19===g.length&&(g+="Z"),a("moment")(g,"LLL");if("file"===f.type){if(angular.isObject(g)){var n=c.exec(decodeURIComponent(window.location.pathname))[3],o="/explore/dataset/"+n+"/files/"+g.id+"/download/";return b.trustAsHtml('<a target="_self" href="'+o+'">'+(g.filename||e.filename)+"</a>")}return""+g}return a("limitTo")(""+g,1e3)}}]),a.filter("capitalize",[function(){return function(a){return ODS.StringUtils.capitalize(a)}}]),a.filter("truncate",function(){return function(a,b){return a&&angular.isString(a)?(b||(b=200),a.substring(0,b)):a}}),a.filter("fieldsFilter",function(){return function(a,b){if(!a)return a;if(angular.isArray(b)&&b.length){var c=[];return angular.forEach(b,function(b){var d=$.grep(a,function(a){return a.name===b})[0];angular.isDefined(d)&&c.push(d)}),c}return a}}),a.filter("moment",[function(){return function(a,b){if(a)return moment(a).format(b)}}]),a.filter("momentadd",[function(){return function(a,b,c){if(a)return moment(a).add(b,parseInt(c,10)).toISOString().replace(".000Z","Z")}}]),a.filter("timesince",[function(){return function(a){if(a)return moment(a).fromNow()}}]),a.filter("momentdiff",function(){return function(a,b,c){return moment(a).diff(b,c)}}),a.filter("themeSlug",["$filter",function(a){return function(b){return!b||angular.isArray(b)&&0===b.length?b:(angular.isArray(b)&&(b=b[0]),a("slugify")(a("normalize")(b)))}}]),a.filter("slugify",function(){return function(a){return a?ODS.StringUtils.slugify(a):a}}),a.filter("normalize",[function(){return function(a){return ODS.StringUtils.normalize(a)}}]),a.filter("shortSummary",[function(){return function(a,b){if(b=b||400,!a)return"";var c="",d=angular.element("<div>"+a+"</div>");if(0===d.children().length)c=a.indexOf("\n")>-1?a.substring(0,a.indexOf("\n")):a;else{var e=d.contents()[0];if(3==e.nodeType)c=e.textContent;else if(d.find("p").length>0){var f=d.find("p")[0];c=angular.isDefined(f.textContent)?f.textContent:f.innerText}else c=d.text()}return c.length>b&&(c=c.substring(0,b-3)+"…"),c}}]),a.filter("imageUrl",function(){return function(a,b){if(!a||angular.equals(a,{}))return null;if(b||console.log("ERROR : This filter requires a context as second parameter."),!b.dataset)return null;angular.isObject(a)||console.log("ERROR : This field is not an file field.");var c=b.domainUrl;return c+="/api/datasets/1.0/"+b.dataset.datasetid+"/files/"+a.id+"/"}}),a.filter("thumbnailUrl",["imageUrlFilter",function(a){return function(b,c){var d=a(b,c);return d?d+"300/":null}}]),a.filter("firstValue",function(){return function(a){return angular.isArray(a)?a.length>0?a[0]:null:a}}),a.filter("split",function(){return function(a,b){return a?(b||(b=";"),a.split(b)):a}}),a.filter("join",function(){return function(a,b){return a?(b||(b=", "),angular.isArray(a)?a.join(b):a):a}}),a.filter("stringify",function(){return function(a){return angular.isObject(a)?JSON.stringify(a):a}}),a.filter("themeColor",["ODSWidgetsConfig",function(a){return function(b){return b&&a.themes[b]?a.themes[b].color:""}}]),a.filter("isBefore",function(){return function(a,b){return moment(a).isBefore(b)}}),a.filter("isAfter",function(){return function(a,b){return moment(a).isAfter(b)}}),a.filter("propagateAppendedURLParameters",["ODSWidgetsConfig",function(a){return function(b){return b?b.startsWith("http://")||b.startsWith("https://")?b:a.appendedURLQuerystring?(b.indexOf("?")>-1?b+="&":b+="?",b+=a.appendedURLQuerystring):b:b}}]),a.filter("toObject",function(){return function(a,b){return b?a.reduce(function(a,c){return a[c[b]]=c,a},{}):(console.log("ERROR : this filter requires a key as a second parameter."),null)}}),a.filter("min",function(){return function(a,b){return Math.min(a,b)}}),a.filter("max",function(){return function(a,b){return Math.max(a,b)}})}(),function(a){var b=[{base:"A",letters:/[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]/g},{base:"AA",letters:/[\uA732]/g},{base:"AE",letters:/[\u00C6\u01FC\u01E2]/g},{base:"AO",letters:/[\uA734]/g},{base:"AU",letters:/[\uA736]/g},{base:"AV",letters:/[\uA738\uA73A]/g},{base:"AY",letters:/[\uA73C]/g},{base:"B",letters:/[\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]/g},{base:"C",letters:/[\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]/g},{base:"D",letters:/[\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]/g},{base:"DZ",letters:/[\u01F1\u01C4]/g},{base:"Dz",letters:/[\u01F2\u01C5]/g},{base:"E",letters:/[\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]/g},{base:"F",letters:/[\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]/g},{base:"G",letters:/[\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]/g},{base:"H",letters:/[\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]/g},{base:"I",letters:/[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]/g},{base:"J",letters:/[\u004A\u24BF\uFF2A\u0134\u0248]/g},{base:"K",letters:/[\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]/g},{base:"L",letters:/[\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]/g},{base:"LJ",letters:/[\u01C7]/g},{base:"Lj",letters:/[\u01C8]/g},{base:"M",letters:/[\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]/g},{base:"N",letters:/[\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]/g},{base:"NJ",letters:/[\u01CA]/g},{base:"Nj",letters:/[\u01CB]/g},{base:"O",letters:/[\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]/g},{base:"OI",letters:/[\u01A2]/g},{base:"OO",letters:/[\uA74E]/g},{base:"OU",letters:/[\u0222]/g},{base:"P",letters:/[\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]/g},{base:"Q",letters:/[\u0051\u24C6\uFF31\uA756\uA758\u024A]/g},{base:"R",letters:/[\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]/g},{base:"S",letters:/[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]/g},{base:"T",letters:/[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]/g},{base:"TZ",letters:/[\uA728]/g},{base:"U",letters:/[\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]/g},{base:"V",letters:/[\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]/g},{base:"VY",letters:/[\uA760]/g},{base:"W",letters:/[\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]/g},{base:"X",letters:/[\u0058\u24CD\uFF38\u1E8A\u1E8C]/g},{base:"Y",letters:/[\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]/g},{base:"Z",letters:/[\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]/g},{base:"a",letters:/[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]/g},{base:"aa",letters:/[\uA733]/g},{base:"ae",letters:/[\u00E6\u01FD\u01E3]/g},{base:"ao",letters:/[\uA735]/g},{base:"au",letters:/[\uA737]/g},{base:"av",letters:/[\uA739\uA73B]/g},{base:"ay",letters:/[\uA73D]/g},{base:"b",letters:/[\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]/g},{base:"c",letters:/[\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]/g},{base:"d",letters:/[\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]/g},{base:"dz",letters:/[\u01F3\u01C6]/g},{base:"e",letters:/[\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]/g},{base:"f",letters:/[\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]/g},{base:"g",letters:/[\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]/g},{base:"h",letters:/[\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]/g},{base:"hv",letters:/[\u0195]/g},{base:"i",letters:/[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]/g},{base:"j",letters:/[\u006A\u24D9\uFF4A\u0135\u01F0\u0249]/g},{base:"k",letters:/[\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]/g},{base:"l",letters:/[\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]/g},{base:"lj",letters:/[\u01C9]/g},{base:"m",letters:/[\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]/g},{base:"n",letters:/[\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]/g},{base:"nj",letters:/[\u01CC]/g},{base:"o",letters:/[\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]/g},{base:"oi",letters:/[\u01A3]/g},{base:"ou",letters:/[\u0223]/g},{base:"oo",letters:/[\uA74F]/g},{base:"p",letters:/[\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]/g},{base:"q",letters:/[\u0071\u24E0\uFF51\u024B\uA757\uA759]/g},{base:"r",letters:/[\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]/g},{base:"s",letters:/[\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]/g},{base:"t",letters:/[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]/g},{base:"tz",letters:/[\uA729]/g},{base:"u",letters:/[\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]/g},{base:"v",letters:/[\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]/g},{base:"vy",letters:/[\uA761]/g},{base:"w",letters:/[\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]/g},{base:"x",letters:/[\u0078\u24E7\uFF58\u1E8B\u1E8D]/g},{base:"y",letters:/[\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]/g},{base:"z",letters:/[\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]/g}],c={Context:{toggleRefine:function(a,b,c,d){var e="refine."+b,f="/";if(a.dataset){var g=a.dataset.getField(b),h=a.dataset.getFieldAnnotation(g,"hierarchical");void 0!==h&&(f=h.args[0]||f)}if(angular.isDefined(a.parameters[e])){var i=angular.copy(a.parameters[e]);angular.isArray(i)||(i=[i]),i.indexOf(c)>-1?i.splice(i.indexOf(c),1):(angular.forEach(i,function(a,b){c.startsWith(a+f)?i.splice(b,1):a.startsWith(c+f)&&i.splice(b,1)}),angular.isUndefined(d)||!1===d?i.push(c):i=[c]),0===i.length?delete a.parameters[e]:a.parameters[e]=i}else a.parameters[e]=c}},GeoFilter:{getBboxParameterAsBounds:function(a){var b=a.split(",");return[[b[0],b[1]],[b[2],b[3]]]},getBoundsAsBboxParameter:function(a){return angular.isArray(a)?[a[0][0],a[0][1],a[1][0],a[1][1]].join(","):[a.getSouthWest().lat,a.getSouthWest().lng,a.getNorthEast().lat,a.getNorthEast().lng].join(",")},getBoundsAsPolygonParameter:function(a){var b;b=angular.isArray(a)?new L.LatLngBounds(a):a;for(var c=[[b.getNorthWest().lat,b.getNorthWest().lng],[b.getNorthEast().lat,b.getNorthEast().lng],[b.getSouthEast().lat,b.getSouthEast().lng],[b.getSouthWest().lat,b.getSouthWest().lng]],d=[],e=0;e<c.length;e++){var f=c[e];d.push(f.join(","))}return"("+d.join("),(")+")"},getPolygonParameterAsBounds:function(a){for(var b,c,d,e,f=a.replace(/[()]/g,"").split(","),g=0;g<f.length;g+=2){var h=parseFloat(f[g]),i=parseFloat(f[g+1]);(!b||b>h)&&(b=h),(!c||c>i)&&(c=i),(!d||d<h)&&(d=h),(!e||e<i)&&(e=i)}return[[b,c],[d,e]]},getPolygonParameterAsGeoJSON:function(a){for(var b={type:"Polygon",coordinates:[[]]},c=a.replace(/[()]/g,"").split(","),d=0;d<c.length;d+=2){var e=parseFloat(c[d]),f=parseFloat(c[d+1]);b.coordinates[0].push([f,e])}return b},getBboxParameterAsPolygonParameter:function(a){return this.getBoundsAsPolygonParameter(this.getBboxParameterAsBounds(a))},getGeoJSONPolygonAsPolygonParameter:function(a){var b,c=[];if("LineString"===a.type){b=a.coordinates;var d=null,e=null,f=null,g=null;angular.forEach(b,function(a){var b=a[0],c=a[1];d=null===d?b:Math.min(d,b),e=null===e?c:Math.min(e,c),f=null===f?b:Math.max(f,b),g=null===g?c:Math.max(g,c)}),c.push(e+","+d),c.push(e+","+f),c.push(g+","+f),c.push(g+","+d)}else{b=a.coordinates[0],"MultiPolygon"===a.type&&(b=b[0]);for(var h=0;h<b.length;h++){var i=angular.copy(b[h]);i.length>2&&i.splice(2,1),i.reverse(),c.push(i.join(","))}}return"("+c.join("),(")+")"},addGeoFilterFromSpatialObject:function(a,b){angular.isArray(b)?a["geofilter.distance"]=b[0]+","+b[1]:"Point"===b.type?a["geofilter.distance"]=b.coordinates[1]+","+b.coordinates[0]:a["geofilter.polygon"]=this.getGeoJSONPolygonAsPolygonParameter(b)}},StringUtils:{slugify:function(a){return a?a.toLowerCase().replace(/\s+/g,"-").replace(/[^\w-]+/g,"").replace(/-+/g,"-"):a},normalize:function(a){if(!a)return a;for(var c=0;c<b.length;c++)a=a.replace(b[c].letters,b[c].base);return a},capitalize:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},startsWith:function(a,b){return a&&0===a.indexOf(b)},escapeHTML:function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},getRandomUUID:function(a){return a=a||7,a=Math.min(a,36),Math.random().toString(36).substring(a)}},ArrayUtils:{transpose:function(a){return angular.isArray(a)?a.reduce(function(a,b){return a[b]=!0,a},{}):Object.keys(a).reduce(function(b,c){return a[c]&&b.push(c),b},[])},sortNumbers:function(a,b){return a-b}},URLUtils:{cleanupAPIParams:function(a){function b(b,c,d){c.startsWith(b+".")&&(a[b]?angular.isArray(a[b])?a[b].push(d):a[b]=[a[b],d]:a[b]=d,delete a[c])}return a=angular.copy(a),angular.forEach(a,function(a,c){angular.forEach(["q","rq"],function(d){b(d,c,a)})}),a},getAPIQueryString:function(a){var b=[];return a=this.cleanupAPIParams(a),angular.forEach(a,function(a,c){angular.isString(a)?b.push(c+"="+encodeURIComponent(a)):angular.forEach(a,function(a){b.push(c+"="+encodeURIComponent(a))})}),b.join("&")}},DatasetUtils:{isFieldSortable:function(a){if(["int","double","date","datetime"].indexOf(a.type)>=0)return!0;if("text"===a.type&&a.annotations)for(var b=0;b<a.annotations.length;b++){var c=a.annotations[b];if("sortable"===c.name)return!0}return!1}},Dataset:function(a){var b,c,d,e=function(a,b){var c=0;if(a.annotations)for(;c<a.annotations.length;c++)if(a.annotations[c].name===b)return a.annotations[c]},f=function(a,b){return void 0!==e(a,b)},g=function(a){d={facets:[]},b=[],c=0;for(var e=0;e<a.length;e++){var g=a[e];f(g,"facet")&&(c++,d.facets.push(g)),b[g.type]?b[g.type]+=1:b[g.type]=1}};return{datasetid:a.datasetid||"preview",has_records:a.has_records,data_visible:a.data_visible,metas:a.metas||{domain:"preview"},features:a.features,attachments:a.attachments,alternative_exports:a.alternative_exports,fields:a.fields,extra_metas:a.extra_metas,interop_metas:a.interop_metas,setFields:function(a){this.fields=a,g(this.fields)},getUniqueId:function(){return this.metas.domain+"."+this.datasetid},getTypes:function(){return void 0===b&&g(this.fields),b},hasFeature:function(b){return a.features.indexOf(b)>-1},hasFieldType:function(a){for(var b=0;b<this.fields.length;b++)if(this.fields[b].type==a)return!0;return!1},countFieldType:function(a){for(var b=0,c=0;c<this.fields.length;c++)this.fields[c].type==a&&b++;return b},countFieldTypes:function(a){for(var b=0,c=0;c<a.length;c++)b+=this.countFieldType(a[c]);return b},getFacetsCount:function(){return void 0===c&&g(this.fields),c},hasFacet:function(){return void 0===c&&g(this.fields),c>0},getFilterDescription:function(){return void 0===d&&g(this.fields),d},getFacets:function(){return this.getFilterDescription().facets},setMetas:function(a){this.metas=a},getField:function(a){for(var b=0;b<this.fields.length;b++){var c=this.fields[b];if(c.name===a)return c}return null},getFieldLabel:function(a){var b=this.getField(a);return b?b.label:b},getFieldsForType:function(a){for(var b=[],c=0;c<this.fields.length;c++){var d=this.fields[c];d.type===a&&b.push(d)}return b},hasNumericField:function(){for(var a=0;a<this.fields.length;a++){var b=this.fields[a];if("int"===b.type||"double"===b.type)return!0}return!1},hasGeoField:function(){for(var a=0;a<this.fields.length;a++){var b=this.fields[a];if("geo_point_2d"===b.type||"geo_shape"===b.type)return!0}return!1},getExtraMeta:function(a,b){return this.extra_metas&&this.extra_metas[a]&&this.extra_metas[a][b]?this.extra_metas[a][b]:null},isFieldAnnotated:function(a,b){return f(a,b)},getFieldAnnotation:function(a,b){return e(a,b)}}},Record:{getImageUrl:function(a,b,c,d){return format_string("{domainUrl}/explore/dataset/{datasetId}/files/{imageId}/{size}/",{domainUrl:c||"",datasetId:a.datasetid,imageId:a.fields[b].id,size:d||"300"})}},CalculationUtils:{getValueOnScale:function(a,b,c,d){if(b===c)return 1;d=d||"linear";var e,f=c-b,g=a-b;return"linear"===d?e=g/f:"log"===d&&(e=Math.log(g)/Math.log(f))===-1/0&&(e=0),e}},DateFieldUtils:{datePatternBuilder:function(a){var b={highcharts:{Hh:"%Hh",MMM:"%M",YYYY:"%Y",MMMM:"%B",D:"%e",ddd:"%a"},moment:{Hh:"H[h]",MMM:"MMM",YYYY:"YYYY",MMMM:"MMMM",D:"D",ddd:"ddd"}}[a];return function(a){var c="";return angular.isObject(a)&&("year"in a||"month"in a||"day"in a||"hour"in a||"minute"in a||"weekday"in a)&&("year"in a?("day"in a&&(c+=" "+b.D),"month"in a&&(c+=" "+b.MMMM),c+=" "+b.YYYY,"hour"in a&&(c+="minute"in a?" "+b.Hh+b.MMM:" "+b.Hh)):("month"in a&&(c=b.MMMM),"day"in a&&(c="month"in a?b.D+" "+b.MMMM:b.D),"weekday"in a?(c=b.ddd,"hour"in a&&(c+=" "+b.Hh)):"hour"in a&&(c=b.Hh))),c}},getDateFromXObject:function(a,b){var c=b?b.getUTCFullYear():2e3,d=b?b.getUTCMonth():0,e=b?b.getUTCDate():1,f=b?b.getUTCHours():0,g=b?b.getUTCMinutes():0;if(angular.isObject(a)&&("year"in a||"month"in a||"day"in a||"hour"in a||"minute"in a||"weekday"in a||"yearday"in a)){var h=new Date(Date.UTC(a.year||c,a.month-1||0,a.day||1,a.hour||0,a.minute||0));return h.setUTCFullYear(a.year||c),"month"in a||h.setUTCMonth(d),"day"in a||h.setUTCDate(e),"hour"in a||h.setUTCHours(f),"minute"in a||h.setUTCMinutes(g),"year"in a||("weekday"in a&&h.setUTCDate(h.getUTCDate()+7-h.getUTCDay()+a.weekday),"yearday"in a&&h.setUTCDate(0+a.yearday)),"day"in a?29!=a.day||2!=a.month||a.year||(h.setUTCDate(28),h.setUTCMonth(1)):"month"in a&&h.setUTCDate(16),h}},getTimescaleProperties:function(a){var b={year:["year"],month:["year","month"],day:["year","month","day"],hour:["year","month","day","hour"],minute:["year","month","day","hour","minute"],"month month":["month"],"day day":["day"],"day weekday":["weekday"],"hour weekday":["weekday","hour"],"day month":["yearday"],"hour hour":["hour"]};return a in b?b[a]:null},getTimescaleX:function(a,b){var d=[],e=c.DateFieldUtils.getTimescaleProperties(b);return e?angular.forEach(e,function(b){d.push(a+"."+b)}):d.push(a),d},getTimescaleSort:function(a){return a.map(function(a){return"x."+a}).join(",")}}};void 0===a.ODS&&(a.ODS={}),a.ODS=angular.extend(a.ODS,c)}(window),function(){"use strict";angular.module("ods-widgets").directive("odsAggregation",["ODSAPI",function(a){return{restrict:"A",scope:!0,controller:["$scope","$attrs",function(b,c){var d=b.$eval(c.odsAggregationContext),e=c.odsAggregationFunction||"COUNT",f=c.odsAggregationExpression,g=c.odsAggregation||"aggregation";d.wait().then(function(){b.$watch(d.name+".parameters",function(c,h){var i=angular.extend({},c,{"y.serie1.expr":f,"y.serie1.func":e});a.records.analyze(d,i).success(function(a){b[g]=a[0].serie1})},!0)})}]}}])}(),function(){"use strict";var a=function(a,b,c){try{return!!a.$eval(b,{y:c})}catch(a){console.warn("Error while compiling condition with expr",b)}return!1},b=angular.module("ods-widgets");b.directive("odsAnalysis",["ODSAPI",function(a){var b=function(a,b){var c,d=/([A-Z_-]*?)\((.*?)\)/g,e=/([A-Z_-]*?)\(([a-zA-Z0-9\._]+),\s?([0-9\.]+)\)/g,f=b||a;a.compiled_expr=""+a.expr,f.aggregates=[];for(var g={};c=d.exec(a.expr);){var h=e.exec(c[0]);if(h&&4===h.length&&(c=h),c&&(3===c.length||4===c.length))if(0===c[2].indexOf("serie")){var i="operators."+c[1].toLowerCase()+".apply(null, accumulation['"+c[2]+"']";4===c.length&&(i+=", "+c[3]),i+=")",a.compiled_expr=a.compiled_expr.replace(c[0],i),f.aggregates.push(c[2])}else g.func=c[1],g.expr=c[2],c[3]&&(g.subsets=c[3]),a.compiled_expr+=a.compiled_expr.replace(c[0],"y")}return g};return{restrict:"A",priority:1001,controller:["$scope","$attrs",function(c,d){c[d.odsAnalysisContext].wait().then(function(){c.$watch(d.odsAnalysisContext,function(e){var f=d.odsAnalysis||"results",g=angular.extend({},e.parameters,{maxpoints:d.odsAnalysisMax||0}),h={},i={},j=[];d.odsAnalysisSort&&(g.sort=d.odsAnalysisSort),angular.forEach(d,function(a,c){var d,e;if(c.startsWith("odsAnalysisSerie"))if(d=c.replace("odsAnalysisSerie",""),e=!1,d.endsWith("Cumulative")&&d.replace("Cumulative","").length>0&&(d=d.replace("Cumulative",""),e=a),d=d.toLowerCase(),i[d]||(i[d]={}),e)i[d].cumulative=e;else{var f={expr:a};angular.extend(i[d],b(f))}else c.startsWith("odsAnalysisAggregation")?(d=c.replace("odsAnalysisAggregation",""),d=d.toLowerCase(),h[d]||(h[d]={}),h[d].expr=d,h[d].func=a):c.startsWith("odsAnalysisX")&&j.push(a)}),j.length>0&&(g.x=j),angular.forEach(i,function(a,b){g["y."+b+".expr"]=a.expr,g["y."+b+".func"]=a.func,g["y."+b+".cumulative"]=a.cumulative||"false","QUANTILES"===a.func&&(g["y."+b+".subsets"]=a.subsets||"50"),h[b]&&(g["agg."+b+".expr"]=h[b].expr,g["agg."+b+".func"]=h[b].func)}),a.records.analyze(e,g).success(function(a){c[f]={},angular.isArray(a)?c[f]={results:a}:c[f]=a})},!0)})}]}}]),b.directive("odsAnalysisSerie",[function(){return{restrict:"A",scope:!0,controller:["$scope","$attrs",function(a,b){a.condition="",a.field="",a.$watch(b.odsAnalysisSerieCondition,function(c){b.odsAnalysisSerieCondition&&(a.condition=b.odsAnalysisSerieCondition)},!0),a.$watch(b.odsAnalysisSerieName,function(c){b.odsAnalysisSerieName&&(a.name=b.odsAnalysisSerieName)},!0),a.$watch(b.odsAnalysisSerieSeparateOnX,function(c){b.odsAnalysisSerieSeparateOnX&&(a.separateOnX=b.odsAnalysisSerieSeparateOnX)},!0),a.$watch(b.odsAnalysisSerieMode,function(c){b.odsAnalysisSerieMode&&(a.mode=b.odsAnalysisSerieMode)},!0)}],link:function(b,c,d){b.$watch(d.odsAnalysisSerie,function(c,d){var e,f,g,h,i=c,j={};if(b.separateOnX&&(j={}),b.results={},i){for(f={},e=0;e<i.length;e++)g=i[e][b.name],h=b.separateOnX?i[e].x[b.separateOnX]:"global",a(b,b.condition,g)?(j[h]||(j[h]=[]),j[h].push(i[e])):j[h]&&((!f[h]||f[h].length<j[h].length)&&(f[h]=j[h]),j[h]=!1);if(angular.forEach(j,function(a,b){(!f[b]||f[b].length<a.length)&&(f[b]=a)}),"reduce"==b.mode&&b.separateOnX){var k=Object.keys(f),l=[];for(e=0;e<k.length;e++)f[k[e]].length>l.length&&(l=f[k[e]]);angular.copy({global:l},b.results)}else angular.copy(f,b.results)}})}}}]),b.directive("odsSubaggregation",["ModuleLazyLoader",function(a){var b=function(a,b){var c,d=/([A-Z_-]*?)\((.*?)\)/g,e=/([A-Z_-]*?)\(([a-zA-Z0-9\._]+),\s?(.+)\)/g,f=b||a;a.compiled_expr=""+a.expr,f.aggregates=[];for(var g={};c=d.exec(a.expr);){var h=e.exec(c[0]);if(h&&4===h.length&&(c=h),c&&(3===c.length||4===c.length)){g.func=c[1],g.expr=c[2],c[3]&&(g.param=c[3]);var i="operators."+c[1].toLowerCase()+"(accumulation['"+c[2]+"']";4===c.length&&(i+=", "+c[3]),i+=")",g.compiled_expr=a.compiled_expr.replace(c[0],i),g.needed_aggregates=c[2]}}return g},c=function(a,b,c,d){var e;try{e=a.$eval(b,{operators:ss,accumulation:function(a,b){var c={};return angular.forEach(b,function(b){c[b]=a[b]}),c}(c,d),console:console})}catch(a){console.warn("Error while compiling aggregation value with expr",b)}return e};return{restrict:"A",scope:!0,controller:["$scope","$attrs",function(a,c){a.aggregations={};var d=a.$watch(c.odsSubaggregation,function(e){if(e){var f={};angular.forEach(c,function(a,c){var d;if(c.startsWith("odsSubaggregationSerie")){d=c.replace("odsSubaggregationSerie",""),d=d.toLowerCase(),f[d]||(f[d]={});var e={expr:a};angular.extend(f[d],b(e))}}),angular.copy(f,a.aggregations),d()}},!0)}],link:function(b,d,e){a("simple-statistics").then(function(){b.$watch(e.odsSubaggregation,function(a,d){var e,f,g={},h=a;if(b.results=[],h){for(f={},angular.forEach(b.aggregations,function(a,b){g[a.needed_aggregates]=[]}),e=0;e<h.length;e++)angular.forEach(g,function(a,b){void 0!==h[e][b]&&g[b].push(h[e][b])});angular.forEach(b.aggregations,function(a,d){f[d]=c(b,a.compiled_expr,g,[a.needed_aggregates])}),b.results.push(f)}},!0)})}}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsAnalyze",function(a,b,c){return{restrict:"E",template:'<div class="records-analyze">    <div ng-if="fakeMultiChartContext.datasets" no-controls="noControls" advanced-chart-controls chart-context="chartContext" context="fakeMultiChartContext" urlsynchronize></div>    <div ng-if="fakeMultiChartContext.datasets" ods-highcharts-chart colors="colors" context="fakeMultiChartContext" parameters="chartContext.dataChart"></div></div>',scope:{context:"=",autoResize:"@",noControls:"=?"},replace:!0,controller:["$scope",function(a){a.noControls=!!a.noControls,a.fakeMultiChartContext={datasets:!1},a.chartContext={},a.context.wait().then(function(){a.fakeMultiChartContext.datasets={},a.fakeMultiChartContext.datasets[a.context.dataset.datasetid]=a.context})}]}})}(),function(){"use strict";var a=angular.module("ods-widgets"),b=["$timeout","$window",function(a,b){return{restrict:"A",require:["?odsAutoResize","?autoResize"],controller:function(a,b){},link:function(c,d,e,f){var g,h=f[0]||f[1];if("false"!==(e.odsAutoResize||e.autoResize)){var i=function(){var a=Math.max(200,angular.element(b).height()-d.offset().top);d.height(a)};i(),$(window).on("resize",function(){a.cancel(g),g=a(function(){i(),h.onResize&&h.onResize()},50)})}}}}];a.directive("odsAutoResize",b),a.directive("autoResize",b)}(),function(){"use strict";angular.module("ods-widgets").directive("odsBreezometer",function(){return{restrict:"E",replace:!0,template:'<div class="ods-widgets"><div class="breezometer_widget"></div></div>',scope:{key:"@",location:"@"},link:function(a,b,c){function d(a){LazyLoad.js("https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places&weather",a)}function e(a){LazyLoad.css("https://static.breezometer.com/widget/css/breezometer.plugin.min.css"),LazyLoad.js("https://static.breezometer.com/widget/breezometer.plugin.min.js",a)}function f(){angular.isDefined($(document).breezometer)&&$(b).find(".breezometer_widget").breezometer({lang:"en",key:c.key,vertical:!1,location:c.location})}function g(){$.breezometer?f():e(f)}window.google&&window.google.maps?g():d(g)}}})}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsCalendar",["ODSAPI","ModuleLazyLoader","ODSWidgetsConfig","$compile","URLSynchronizer",function(a,b,c,d,e){return{restrict:"E",scope:{context:"=",startField:"@?",endField:"@?",titleField:"@?",tooltipFields:"@?",eventColor:"@?",calendarView:"@?",availableCalendarViews:"@?",syncToUrl:"@"},require:"?refineOnClick",replace:!0,template:'<div class="odswidget-calendar">    <div class="odswidget-calendar__fullcalendar"></div>    <div class="odswidget-calendar__tooltip"></div>    <div class="odswidget-calendar__loading-backdrop">        <ods-spinner class="odswidget-calendar__loading-wheel"></ods-spinner>    </div></div>',controller:function(a){"false"!==a.syncToUrl&&e.addSynchronizedValue(a,"calendarView","calendarview")},link:function(e,f,g,h){var i=function(){var a=e.fullcalendar.fullCalendar("getView");a.name!=e.calendarView&&(e.calendarView=a.name)},j=function(){var a={};if(e.context.dataset&&e.context.dataset.extra_metas&&e.context.dataset.extra_metas.visualization&&(a=e.context.dataset.extra_metas.visualization),angular.isDefined(e.startField)||(e.startField=a.calendar_event_start),angular.isDefined(e.endField)||(e.endField=a.calendar_event_end),angular.isDefined(e.titleField)||(e.titleField=a.calendar_event_title),angular.isDefined(e.eventColor)||(a.calendar_event_color?e.eventColor=a.calendar_event_color:e.eventColor="#C32D1C"),angular.isDefined(e.availableCalendarViews)?e.availableCalendarViews=e.availableCalendarViews.split(/\s*,\s*/):a.calendar_available_views?e.availableCalendarViews=a.calendar_available_views.split(/\s*,\s*/):e.availableCalendarViews=["month","agendaWeek","agendaDay"],angular.isDefined(e.calendarView)?-1===e.availableCalendarViews.indexOf(e.calendarView)&&(e.calendarView=e.availableCalendarViews[0]):a.calendar_default_view&&e.availableCalendarViews.indexOf(a.calendar_default_view)>-1?e.calendarView=a.calendar_default_view:e.calendarView=e.availableCalendarViews[0],angular.isDefined(e.tooltipFields)){var b=[];angular.forEach(e.tooltipFields.split(","),function(a){b.push(a.trim())}),e.tooltipFields=b}else a.calendar_tooltip_fields?e.tooltipFields=a.calendar_tooltip_fields:e.tooltipFields=[];e.tooltip=$(f).children(".odswidget-calendar__tooltip").first().qtip({content:{text:"",button:!0},position:{my:"bottom center",at:"top center",target:"mouse",viewport:$(".odswidget-calendar__fullcalendar"),adjust:{mouse:!1,scroll:!1}},show:!1,hide:!1,style:{classes:"odswidget-calendar__tooltip odswidget-calendar__tooltip--increase-precedence"}}).qtip("api"),$(document).on("click",function(a){$(a.target).parents(".fc-event").length||$(a.target).parents(".odswidget-calendar__tooltip").length||k()}),e.fullcalendar=$(f).children(".odswidget-calendar__fullcalendar").first(),e.fullcalendar.fullCalendar({lazyFetching:!1,header:{left:"prevYear,prev,next,nextYear, today",center:"title",right:e.availableCalendarViews.join(",")},lang:c.language,loading:m,editable:!0,eventLimit:!0,events:n,eventDataTransform:o,eventColor:e.eventColor,defaultView:e.calendarView,eventClick:function(a,b){h&&h.refineOnRecord(a.record),k(),e.tooltip.set({"content.text":a.buildTooltipContent(),"position.target":[b.pageX,b.pageY]}).reposition(b).show(b)}})},k=function(){$(".odswidget-calendar__tooltip").hide()},l=function(){e.fullcalendar.fullCalendar("refetchEvents")},m=function(a){a?$(".odswidget-calendar__loading-backdrop").show():$(".odswidget-calendar__loading-backdrop").hide()},n=function(b,c,d,f){i(),a.records.search(e.context,q(b,c)).success(function(a){f(a.records)})},o=function(a){var b;return b="date"===e.context.dataset.getField(e.endField).type?moment(a.fields[e.endField]).add(1,"day").format("YYYY-MM-DD"):a.fields[e.endField],{title:a.fields[e.titleField],start:a.fields[e.startField],end:b,buildTooltipContent:p(a),editable:!1,record:a}},p=function(a){return function(){var b=e.$new(!0);b.record=a,b.dataset=e.context.dataset;var c;return e.context.dataset.extra_metas.visualization.calendar_tooltip_html_enabled&&e.context.dataset.extra_metas.visualization.calendar_tooltip_html?c=d("<div>"+e.context.dataset.extra_metas.visualization.calendar_tooltip_html+"</div>")(b):(b.titleField=e.titleField,b.tooltipFields=e.tooltipFields,c=d("<ods-calendar-tooltip></ods-calendar-tooltip>")(b)),b.$apply(),c}},q=function(a,b){var c={dataset:e.context.dataset.datasetid,rows:1e3};c=$.extend(c,e.context.parameters);var d=[e.startField+"<"+b.format("YYYY-MM-DD"),e.endField+">="+a.format("YYYY-MM-DD")].join(" AND ");return c=$.extend(c,{"q.calendar_bounds":d})};b("fullcalendar","qtip").then(function(){e.context.wait().then(function(){j(),e.$watch("context.parameters",function(a,b){a!==b&&l()},!0)})})}}}]),a.directive("odsCalendarTooltip",function(){return{restrict:"E",template:'<h2 class="odswidget-calendar__tooltip-title">{{ record.fields[titleField] }}</h2><dl class="odswidget-calendar__tooltip-fields">    <dt ng-repeat-start="field in dataset.fields|fieldsForVisualization:\'calendar\'|fieldsFilter:tooltipFields"        ng-show="record.fields[field.name]|isDefined"        class="odswidget-calendar__tooltip-field-name">        {{ field.label }}    </dt>    <dd ng-repeat-end ng-switch="field.type" ng-show="record.fields[field.name]|isDefined">        <debug data="record.fields[field.name]"></debug>        <span ng-switch-when="geo_point_2d">            <ods-geotooltip width="300" height="300" coords="record.fields[field.name]">                {{ record.fields|formatFieldValue:field }}            </ods-geotooltip>        </span>        <span ng-switch-when="geo_shape">            <ods-geotooltip width="300" height="300" geojson="record.fields[field.name]">                {{ record.fields|formatFieldValue:field }}            </ods-geotooltip>        </span>        <span ng-switch-when="file">            <div ng-if="!dataset.isFieldAnnotated(field, \'has_thumbnails\')"                 ng-bind-html="record.fields|formatFieldValue:field"></div>            <div ng-if="dataset.isFieldAnnotated(field, \'has_thumbnails\')"                 ng-bind-html="record.fields[field.name]|displayImageValue:dataset.datasetid"                 style="text-align: center;"></div>        </span>        <span ng-switch-default               title="{{record.fields|formatFieldValue:field}}"               ng-bind-html="record.fields|formatFieldValue:field|imagify|videoify|prettyText|nofollow">        </span>    </dd></dl>'}})}(),function(){"use strict";angular.module("ods-widgets").directive("odsCatalogContext",["ODSAPI","URLSynchronizer","$interpolate",function(a,b,c){return{restrict:"AE",scope:!0,replace:!0,controller:["$scope","$attrs",function(d,e){for(var f=e.context.split(","),g=0;g<f.length;g++){var h=f[g].trim(),i=e[h+"Domain"];i&&(i=c(i)(d));var j=d.$eval(e[h+"Parameters"])||{};e[h+"Source"]&&(j.source=c(e[h+"Source"])(d));var k=e[h+"Apikey"];k&&(k=c(k)(d)),d[h]={name:h,type:"catalog",domain:i,domainUrl:a.getDomainURL(i),apikey:k,parameters:j,toggleRefine:function(a,b,c){ODS.Context.toggleRefine(this,a,b,c)},getActiveFilters:function(){if(this.parameters){var a=Object.keys(this.parameters),b=this;return a.filter(function(a){return"q"==a&&b.parameters.q&&b.parameters.q.length>0||"q.timerange"==a||"geofilter.polygon"==a||"geofilter.distance"==a||0===a.indexOf("refine.")||"q.geographic_area"==a&&b.parameters["q.geographic_area"]&&b.parameters["q.geographic_area"].length>0})}return[]},clearActiveFilters:function(){for(var a=this.getActiveFilters(),b=0;b<a.length;b++)delete this.parameters[a[b]]}},d.$eval(e[h+"Urlsync"])&&(angular.equals(j,{})||console.log("WARNING : Context "+h+" : There are specific parameters defined, but URL sync is enabled, so the parameters will be ignored."),b.addSynchronizedObject(d,h+".parameters"))}}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsClearAllFilters",function(){return{restrict:"E",replace:!0,scope:{context:"="},template:'<a class="odswidget-clear-all-filters" href="" ng-click="clearAll()">    <i class="fa fa-ban" aria-hidden="true"></i>     <span translate>Clear all</span></a>',controller:["$scope",function(a){a.clearAll=function(){var b=a.context;return angular.isArray(a.context)||(b=[a.context]),angular.forEach(b,function(a){angular.forEach(a.getActiveFilters(),function(b){delete a.parameters[b]})}),!1}}]}})}(),function(){"use strict";angular.module("ods-widgets").directive("odsCrossTable",["ODSAPI","$q","$filter","$timeout",function(a,b,c,d){var e=function(a,b,d,e,g,j,k,l){return this.rowFields=a,this.colField=b,this.schema=e,this.dataset=g,this.series=d,this.rowNumbersIndexes=[],this.colNumbersIndex={},this.table=[],this.repeatRowHeaders=j,this.displayIntermediaryResults=k,this._insertedRowHeaders=[],this.labelBuilder=new f(this.dataset,this.schema,this.rowFields,this.colField),this.numberPrecision=l,this.setData=function(a,b,c){this.resetData(),this.buildColNumbersIndexes(a,!1),this.buildRowNumbersIndexes(b,this.rowFields.length>1),this.buildTableStructure(b),this.buildTableColumnHeaders(a,!1),this.buildTableRowHeaders(b,this.rowFields.length>1),this.buildTableBody(c,!0)},this.resetData=function(){if(this.colNumbersIndex={},this.rowNumbersIndexes=[],this.displayIntermediaryResults)for(var b=0;b<this.rowFields.length;b++)this.rowNumbersIndexes.push(new i(this.rowFields,b+1,this.labelBuilder));else this.rowNumbersIndexes.push(new i(this.rowFields,this.rowFields.length,this.labelBuilder));this._insertedRowHeaders=a.reduce(function(a,b){return a[b]=[],a},{}),this.table=[]},this.buildColNumbersIndexes=function(a,b){for(var c=0;c<a.length;c++){for(var d={},e=0;e<this.series.length;e++)d[this.series[e].name]=c*this.series.length+e;this.colNumbersIndex[this.labelBuilder.buildLabel(a[c],this.colField,b)]=d}},this.buildRowNumbersIndexes=function(a,b){for(var c=a[a.length-1],d=0,e=this.rowNumbersIndexes[0],f=0;f<c.length;f++){var g=c[f];if(this.displayIntermediaryResults)for(var h=0;h<this.rowFields.length;h++)e=this.rowNumbersIndexes[h],void 0===e.getRowNumber(g,b)&&(e.setRowNumber(g,d,b),d++);else void 0===e.getRowNumber(g,b)&&(e.setRowNumber(g,d,b),d++)}},this.buildTableStructure=function(a){var b;for(b=0;b<Math.min(2,this.series.length);b++)this.table.push([]);var c,d=this,e=Object.keys(this.colNumbersIndex).length*this.series.length+this.rowFields.length;if(this.displayIntermediaryResults)for(b=0;b<a.length;b++)c=a[b],angular.forEach(c,function(){d.table.push(new Array(e))});else c=a[0],angular.forEach(c,function(){d.table.push(new Array(e))})},this.buildTableColumnHeaders=function(a,b){var c,d=this,e=this.series.length;if(e>1){c=[],angular.forEach(this.rowFields,function(){c.push(new h("","ods-cross-table__cell--header"))}),angular.forEach(a,function(a){c.push(new h(d.labelBuilder.buildLabel(a,d.colField,b),"ods-cross-table__cell--header",e))}),this.table[0]=c,c=[],angular.forEach(this.rowFields,function(a){c.push(new h(d.schema[a].label,"ods-cross-table__cell--header"))});var f=[];angular.forEach(this.series,function(a){f.push(new h(a.label||a.name,"ods-cross-table__cell--header"))}),angular.forEach(a,function(){c=c.concat(f)}),this.table[1]=c}else c=[],angular.forEach(this.rowFields,function(a){c.push(new h(d.schema[a].label,"ods-cross-table__cell--header"))}),angular.forEach(a,function(a){c.push(new h(d.labelBuilder.buildLabel(a,d.colField,b),"ods-cross-table__cell--header"))}),this.table[0]=c},this.buildTableRowHeaders=function(a,b){var c=this;angular.forEach(a,function(a,d){angular.forEach(a,function(a){for(var e=c.getRowNumber(a,d,b)+Math.min(2,c.series.length),f=c.displayIntermediaryResults?d+1:c.rowFields.length,g=0;g<f;g++){var i=c.rowFields[g],j=c.labelBuilder.buildLabel(a,i,b);(g===c.rowFields.length-1||c.repeatRowHeaders||-1===c._insertedRowHeaders[i].indexOf(j))&&(c.table[e][g]=new h(j,0,"ods-cross-table__cell--header"),c._insertedRowHeaders[i]=[],c._insertedRowHeaders[i].push(j))}})})},this.buildTableBody=function(a,b){var d=this;angular.forEach(a,function(a,e){angular.forEach(a,function(a){angular.forEach(d.series,function(f){var g=d.getRowNumber(a,e,b)+Math.min(2,d.series.length),i=d.getColNumber(a,f.name,b)+d.rowFields.length;d.table[g][i]=new h(c("number")(a[f.name],d.numberPrecision),"ods-cross-table__cell--value")})})})},this.getColNumber=function(a,b,c){return this.colNumbersIndex[this.labelBuilder.buildLabel(a,this.colField,c)][b]},this.getRowNumber=function(a,b,c){return this.rowNumbersIndexes[b].getRowNumber(a,c)},this},f=function(a,b,c,d){return this.dataset=a,this.schema=b,this.rowFields=c,this.colField=d,this.formatXValue=function(a){if(angular.isObject(a)){var b=ODS.DateFieldUtils.datePatternBuilder("moment")(a);return moment(ODS.DateFieldUtils.getDateFromXObject(a)).format(b)}return a},this.buildLabel=function(a,b,c){return c?this.formatXValue(a.x[b]):this.formatXValue(a.x)},this},g=function(a){return this.name=a,this.label=void 0,this.func=void 0,this.expr=void 0,this.update=function(a,b){this[a]=b},this},h=function(a,b,c){return this.label=a,this.colspan=c||0,this.classes=b||"",this},i=function(a,b,c){return this.rowFields=a,this.depth=b,this.labelBuilder=c,this.rowNumbers={},this.getRowNumber=function(a,b){for(var c=this.rowNumbers,d=0;d<this.depth;d++){var e=this.rowFields[d];if(void 0===(c=c[this.labelBuilder.buildLabel(a,e,b)]))return}return c},this.setRowNumber=function(a,b,c){for(var d=this.depth-1;d>=0;d--){var e=this.rowFields[d],f=this.labelBuilder.buildLabel(a,e,c),g={};g[f]=b,b=g}angular.merge(this.rowNumbers,b)},this};return{restrict:"E",scope:{context:"=",column:"@",rows:"@",repeatRowHeaders:"=",displayIntermediaryResults:"=",numberPrecision:"="},template:'<div class="ods-cross-table">    <ods-spinner with-backdrop ng-show="loading"></ods-spinner>    <div class="ods-cross-table__frozen-header-wrapper">        <table class="ods-cross-table__frozen-header">            <tr ng-repeat="row in table | limitTo:nbFrozenRows track by $index" class="ods-cross-table__row">                <td ng-repeat="cell in row | limitTo:nbFrozenCols track by $index"                     colspan="{{ cell.colspan }}"                     class="ods-cross-table__cell {{ cell.classes }}">                    <div class="ods-cross-table__cell-content" ng-bind="cell.label || \'&nbsp;\'"></div>                </td>            </tr>        </table>    </div>    <div class="ods-cross-table__frozen-rows-wrapper">        <table class="ods-cross-table__frozen-rows">            <tr ng-repeat="row in table | limitTo:nbFrozenRows track by $index" class="ods-cross-table__row">                <td ng-repeat="cell in row | limitTo:row.length:nbFrozenCols track by $index"                     colspan="{{ cell.colspan }}"                     class="ods-cross-table__cell {{ cell.classes }}">                    <div class="ods-cross-table__cell-content" ng-bind="cell.label || \'&nbsp;\'"></div>                </td>            </tr>        </table>    </div>    <div class="ods-cross-table__frozen-cols-wrapper">        <table class="ods-cross-table__frozen-cols">            <tr ng-repeat="row in table | limitTo:table.length:nbFrozenRows track by $index" class="ods-cross-table__row">                <td ng-repeat="cell in row | limitTo:nbFrozenCols track by $index"                     colspan="{{ cell.colspan }}"                     class="ods-cross-table__cell {{ cell.classes }}">                    <div class="ods-cross-table__cell-content" ng-bind="cell.label || \'&nbsp;\'"></div>                </td>            </tr>        </table>    </div>    <div class="ods-cross-table__body-wrapper">        <table class="ods-cross-table__body">            <tr ng-repeat="row in table | limitTo:table.length:nbFrozenRows track by $index" class="ods-cross-table__row">                <td ng-repeat="cell in row | limitTo:row.length:nbFrozenCols track by $index"                     colspan="{{ cell.colspan }}"                     class="ods-cross-table__cell {{ cell.classes }}">                    <div class="ods-cross-table__cell-content" ng-bind="cell.label || \'&nbsp;\'"></div>                </td>            </tr>        </table>    </div></div>',link:function(c,f,h){c.table=[],c.nbFrozenRows=0,c.nbFrozenCols=0,c.loading=!1;var i,j=c.rows.split(","),k=$(f),l=k.find(".ods-cross-table__frozen-header-wrapper"),m=k.find(".ods-cross-table__frozen-header"),n=k.find(".ods-cross-table__frozen-cols-wrapper"),o=k.find(".ods-cross-table__frozen-cols"),p=k.find(".ods-cross-table__frozen-rows-wrapper"),q=k.find(".ods-cross-table__frozen-rows"),r=k.find(".ods-cross-table__body-wrapper"),s=k.find(".ods-cross-table__body"),t=function(){var a={};return angular.forEach(h,function(b,c){var d=/serie([0-9A-Z][0-9a-z]*)(Label|Func|Expr)/g,e=d.exec(c);if(e){var f=e[1].toLowerCase(),h=a[f]||new g(f);h.update(e[2].toLowerCase(),b),a[f]=h}}),Object.keys(a).map(function(b){return a[b]})},u=function(){var a={};return angular.forEach(c.context.dataset.fields,function(b){(j.indexOf(b.name)>-1||b.name==c.column)&&(a[b.name]=b)}),a},v=function(a){a=angular.isArray(a)?a:[a];var b=[];return angular.forEach(a,function(a){var d=c.context.dataset.getField(a);if(["date","datetime"].indexOf(d.type)>-1){var e=c.context.dataset.getFieldAnnotation(d,"timeserie_precision").args[0];b=b.concat(ODS.DateFieldUtils.getTimescaleX(a,e))}else b.push(a)}),b},w=function(a){return angular.isArray(a)||(a=[a]),a.map(function(a){return"x."+a}).join(",")},x=function(){c.loading=!0;var e=[],f=v(i.colField),g={x:f,"y.serie1.func":"COUNT",sort:w(f)};e.push(a.records.analyze(c.context,angular.extend({},c.context.parameters,g)));for(var h=[],j=[],k=c.displayIntermediaryResults?0:i.rowFields.length-1;k<i.rowFields.length;k++){var t,u,x=i.rowFields.slice(0,k+1);u=v(x),t=angular.extend({},c.context.parameters,{x:u,"y.serie1.func":"COUNT",sort:w(u)}),h.push(a.records.analyze(c.context,t)),u=v(x.concat(i.colField)),t=angular.extend({},c.context.parameters,{x:u,sort:w(u)}),angular.forEach(i.series,function(a){t["y."+a.name+".expr"]=a.expr,t["y."+a.name+".func"]=a.func}),j.push(a.records.analyze(c.context,t))}e=e.concat(h).concat(j),b.all(e).then(function(a){var b=a[0].data,e=a.slice(1,(a.length-1)/2+1).map(function(a){return a.data}),f=a.slice((a.length-1)/2+1,a.length).map(function(a){return a.data});i.setData(b,e,f),c.table=i.table,c.nbFrozenCols=i.rowFields.length,c.nbFrozenRows=Math.min(2,i.series.length),d(function(){var a=function(a,b){var c=Math.max(b.outerWidth(),a.outerWidth());b.css({width:c}),a.find(".ods-cross-table__cell-content").css({width:c})},b=q.find("tr:last-child .ods-cross-table__cell-content");s.find("tr:first-child td").each(function(c){a($(this),$(b[c]))});var d=m.find("tr:last-child .ods-cross-table__cell-content");o.find("tr:first-child td").each(function(b){a($(this),$(d[b]))}),d=m.find("td:first-child .ods-cross-table__cell-content"),q.find("td:first-child").each(function(a){$(d[a]).css({height:$(this).height()})});var e=n.outerWidth(),f=p.outerHeight();l.css({top:0,left:0,width:e,height:f}),p.css({top:0,left:e}),n.css({top:f,left:0}),r.css({top:f,left:e}),r.on("scroll",function(){o.css({"margin-top":-$(this).scrollTop()}),q.css({"margin-left":-$(this).scrollLeft()})}),n.on("wheel",function(a){r.scrollTop(r.scrollTop()+a.originalEvent.deltaY),a.preventDefault()}),p.on("wheel",function(a){r.scrollLeft(r.scrollLeft()+a.originalEvent.deltaX),a.preventDefault()}),s.find("tr").hover(function(){o.find("tr:nth-child("+($(this).index()+1)+")").addClass("ods-cross-table__row--hover")},function(){o.find("tr:nth-child("+($(this).index()+1)+")").removeClass("ods-cross-table__row--hover")}),o.find("tr").hover(function(){s.find("tr:nth-child("+($(this).index()+1)+")").addClass("ods-cross-table__row--hover")},function(){s.find("tr:nth-child("+($(this).index()+1)+")").removeClass("ods-cross-table__row--hover")}),c.loading=!1})})};c.context.wait().then(function(){angular.isDefined(c.numberPrecision)||(c.numberPrecision=3),i=new e(j,c.column,t(),u(),c.context.dataset,!0===c.repeatRowHeaders,!0===c.displayIntermediaryResults,c.numberPrecision),c.$watch("context.parameters",x)})}}}])}(),function(){"use strict";var a=angular.module("ods-widgets"),b=function(a,b,c){var d=c.find(".dataset-item").first(),e=c.find(".card-container"),f=$(e).outerHeight();"bottom"==b.position?($(d).css("top",0),$(d).css("bottom",f)):($(d).css("top",f),$(d).css("bottom",0)),a(function(a){$(d).html(a)})};a.directive("odsDatasetCard",function(){return{restrict:"E",scope:{context:"="},template:'<div class="odswidget odswidget-dataset-card"><div class="card-container" ng-class="{bottom: position == \'bottom\', expanded: expanded, expandable: isExpandable()}"><h2 class="dataset-title" ng-click="expanded = !expanded" ng-show="!expanded || (expanded && !context.dataset.metas.description)">{{context.dataset.metas.title}}</h2><div ng-click="expanded = !expanded" class="expand-control" title="Show/hide details" translate="title"><span translate>Details</span> <i class="fa fa-chevron-down" ng-show="!expanded" aria-hidden="true"></i><i class="fa fa-chevron-up" aria-hidden="true" ng-hide="!expanded"></i></div><div class="dataset-expanded" ng-click="expanded = !expanded""><h2 class="dataset-title" ng-show="expanded">{{context.dataset.metas.title}}</h2><p class="dataset-description" ng-if="expanded" ng-bind-html="safeHtml(context.dataset.metas.description)"></p></div><div class="dataset-infos"><span class="dataset-infos-text"><a ng-href="{{datasetUrl}}" target="_blank" ng-bind-html="websiteName"></a><span ng-show="context.dataset.metas.license"> - <span translate>License</span> {{context.dataset.metas.license}}</span></span></div></div><div class="dataset-item"></div></div>',replace:!0,transclude:!0,link:function(a,b,c){a.position=c.position||"top"},controller:["$scope","$element","ODSWidgetsConfig","$transclude","$sce","$timeout",function(a,c,d,e,f,g){a.renderContent=b,a.websiteName=d.websiteName,a.expanded=!1,a.safeHtml=function(a){return f.trustAsHtml(a)},a.isExpandable=function(){return!!(a.context&&a.context.dataset&&a.context.dataset.datasetid)&&!!a.context.dataset.metas.description};var h=a.$watch("context",function(b,d){b&&b.dataset&&(g(function(){a.renderContent(e,a,c)},0),a.expanded=!1,a.datasetUrl=a.context.domainUrl+"/explore/dataset/"+a.context.dataset.datasetid+"/",a.websiteName||(a.websiteName=a.context.domainUrl),h())},!0);a.renderContent(e,a,c)}]}}),a.directive("odsMultidatasetsCard",["ODSWidgetsConfig",function(a){return{restrict:"E",scope:{odsTitle:"=",datasets:"=",context:"="},template:'<div class="odswidget-multidatasets-card">  <div class="card-container multidatasets" ng-class="{bottom: (position == \'bottom\'), expanded: expanded, expandable: isExpandable()}">      <h2 ng-show="!expanded" ng-click="tryToggleExpand()">{{ odsTitle }}</h2>      <div ng-click="tryToggleExpand()" class="expand-control" ng-class="{expanded: expanded}" title="Show/hide details"><span translate>Details</span> <i class="fa fa-chevron-down" aria-hidden="true"></i></div>      <h3 class="datasets-counter" ng-click="tryToggleExpand()" ng-show="!expanded">          <span class="count-text" ng-hide="!datasetObjectKeys || datasetObjectKeys.length <= 1">               <span translate translate-n="datasetObjectKeys.length" translate-plural="{{ $count }} datasets">{{ $count }} dataset</span>          </span>      </h3>      <div class="datasets-expanded">          <h2 ng-show="expanded" ng-click="tryToggleExpand()">{{ odsTitle }}</h2>          <h3 class="datasets-counter" ng-click="tryToggleExpand()" ng-show="expanded">              <span class="count-text">                   <span ng-if="datasetObjectKeys.length == 0" translate>no dataset to display</span>                   <span ng-if="datasetObjectKeys.length > 0" translate translate-n="datasetObjectKeys.length" translate-plural="{{ $count }} datasets">{{ $count }} dataset</span>              </span>          </h3>          <ul class="dataset-list"              ng-show="(datasetObjectKeys && datasetObjectKeys.length === 1) || (isExpandable() && expanded)"              ng-class="{\'single-dataset\': datasetObjectKeys.length === 1}">              <li ng-repeat="(key, dataset) in datasets"> <a                  ng-href="{{context.domainUrl}}/explore/dataset/{{dataset.datasetid}}/"                  target="_blank">{{ dataset.metas.title }}</a>                  <span ng-show="dataset.metas.license">- <span translate>License</span> {{ dataset.metas.license }}</span></li>          </ul>      </div>      <div class="dataset-infos"><span class="dataset-infos-text"><a ng-href="/" target="_blank" ng-bind-html="websiteName"></a></span></div>  </div>  <!-- embedded content (chart, map etc.) -->  <div class="dataset-item" ng-transclude></div></div>',replace:!0,transclude:!0,link:function(a,b,c){a.position=c.position||"top"},controller:["$scope","$element","ODSWidgetsConfig","$transclude","$sce","$timeout",function(a,c,d,e,f,g){a.renderContent=b,a.datasetObjectKeys=[],a.websiteName=d.websiteName,a.safeHtml=function(a){return f.trustAsHtml(a)},a.isExpandable=function(){return!(!a.datasetObjectKeys.length||1===a.datasetObjectKeys.length)},a.tryToggleExpand=function(){a.isExpandable()&&(a.expanded=!a.expanded)};var h=a.$watch("datasets",function(b,d){if(b){var f=Object.keys(b);if(0===f.length)return;a.datasetObjectKeys=f,g(function(){a.renderContent(e,a,c)},0),a.expanded=!1,h()}},!0);g(function(){a.renderContent(e,a,c)},0)}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsDatasetContext",["ODSAPI","$q","$interpolate","URLSynchronizer","ContextHelper",function(a,b,c,d,e){var f=function(a,b,c,f,g,h,i,j,k,l){var m;if(angular.equals(h,{}))if(i){var n=c.$watch(i,function(a,b){a&&(j&&(a.parameters.source=j),c[f].parameters=a.parameters,n())});m=null}else m=angular.equals(h,{})?h:{};else m=h,k&&console.log("WARNING : Context "+f+" : There are specific parameters defined, but URL sync is enabled, so the parameters will be ignored.");j&&m&&(m.source=j),c[f]=e.getDatasetContext(f,a,b,m,j,g,l),k&&d.addSynchronizedObject(c,f+".parameters",["basemap","location"])};return{restrict:"AE",scope:!0,replace:!0,controller:["$scope","$attrs",function(a,b){for(var d=b.context.split(","),e=0;e<d.length;e++){var g=d[e].trim();b[g+"Dataset"]||b[g+"DatasetSchema"]||console.log("ERROR : Context "+g+" : Missing dataset parameter");var h,i,j,k,l,m;b[g+"Dataset"]&&(h=c(b[g+"Dataset"])(a)),b[g+"Domain"]&&(i=c(b[g+"Domain"])(a)),b[g+"Apikey"]&&(j=c(b[g+"Apikey"])(a)),b[g+"Sort"]&&(k=c(b[g+"Sort"])(a)),b[g+"Source"]&&(l=c(b[g+"Source"])(a)),b[g+"DatasetSchema"]&&(m=angular.fromJson(b[g+"DatasetSchema"].replace(/\\{/g,"{").replace(/\\}/g,"}")));var n=a.$eval(b[g+"Parameters"])||{},o=b[g+"ParametersFromContext"];k&&(n.sort=k);var p=a.$eval(b[g+"Urlsync"]);f(i,h,a,g,j,n,o,l,p,m)}}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsDatetime",function(){return{restrict:"A",controller:["$scope","$attrs","$q",function(a,b,c){var d=b.odsDatetime||"datetime";a.refreshDatetime=function(){a[d]=moment().format()},a.refreshDatetime()}]}})}(),function(){"use strict";angular.module("ods-widgets").directive("odsDisqus",["ODSWidgetsConfig","$location","$window",function(a,b,c){return{restrict:"E",replace:!0,scope:{shortname:"@",identifier:"@"},template:'<div id="disqus_thread" class="odswidget"></div>',link:function(d){c.disqus_shortname=d.shortname||a.disqusShortname,d.identifier&&(c.disqus_identifier=d.identifier),c.disqus_url=b.absUrl(),c.disqus_config=function(){this.language=a.language};var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+c.disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsDomainStatistics",["ODSAPI",function(a){return{restrict:"AE",scope:!0,controller:["$scope","$attrs",function(b,c){var d=function(a,b,c){return c.name===b&&(a.stats[b]=c.facets.length,!0)},e=b.$watch(c.context,function(b){b.stats={dataset:0,keyword:0,publisher:0,theme:0},a.datasets.search(b,{facet:["keyword","publisher","theme"],rows:0}).success(function(a){if(b.stats.dataset=a.nhits,a.facet_groups)for(var c=0;c<a.facet_groups.length;c++)d(b,"keyword",a.facet_groups[c])||d(b,"publisher",a.facet_groups[c])||d(b,"theme",a.facet_groups[c])}),e()},!0)}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsFacetResults",["ODSAPI",function(a){return{restrict:"A",scope:!0,priority:1001,controller:["$scope","$attrs",function(b,c){b.$watch(c.odsFacetResultsContext,function(d){var e,f=c.odsFacetResultsFacetName,g={};c.odsFacetResultsSort&&(g["facetsort."+f]=c.odsFacetResultsSort);var h=angular.extend({},d.parameters,{rows:0,facet:f},g),i=c.odsFacetResults||"results";if("dataset"===d.type&&d.dataset)e=a.records.search(d,h);else{if("catalog"!==d.type)return;e=a.datasets.search(d,h)}e.success(function(a){if(a.facet_groups){var c=a.facet_groups.filter(function(a){return a.name===f});0===c.length&&(b[i]=[]),b[i]=c[0].facets}else b[i]=[]})},!0)}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsFacets",["$compile","translate",function(a,b){var c=function(b,c,d){var e="";angular.forEach(d,function(a){e+='<ods-facet name="'+a.name+'" title="'+(a.title&&a.title.replace(/"/g,"&quot;")||a.name)+'" sort="'+(a.sort||"")+'" disjunctive="'+(a.disjunctive||"")+'" hide-if-single-category="'+(a.hideIfSingleCategory?"true":"false")+'" hide-category-if="'+(a.hideCategoryIf||"")+'"value-formatter="'+(a.valueFormatter||"")+'">'+(a.template||"")+"</ods-facet>"});var f=angular.element(e);c.append(f),a(f)(b)};return{restrict:"E",replace:!0,scope:{context:"=",facetsConfig:"="},compile:function(a){var d=a.children().length;return function(a,e){var f,g;if(g=function(){var b=a.$watch("context",function(){a.context&&("dataset"===a.context.type?a.context.wait().then(function(){a.init()}):a.init(),b())})},a.facetsConfig)c(a,e,a.facetsConfig),g();else if(0===d){var h;f=a.$watch("context",function(){a.context&&(f(),"catalog"===a.context.type?(h=[{name:"modified",title:b("Modified"),valueFormatter:"date"},{name:"publisher",title:b("Publisher")},{name:"keyword",title:b("Keyword")},{name:"theme",title:b("Theme")}],c(a,e,h),a.init()):a.context.wait().then(function(){h=angular.copy(a.context.dataset.getFacets()),angular.forEach(h,function(a){a.title=a.label,delete a.label,angular.forEach(a.annotations,function(b){"facetsort"===b.name&&b.args.length>0&&(a.sort=b.args[0]),"disjunctive"===b.name&&(a.disjunctive=!0)}),"datetime"!=a.type&&"date"!=a.type||(a.valueFormatter="date")}),c(a,e,h),a.init()}))},!0)}else g()}},controller:["$scope","ODSAPI",function(a,b){var c={};a.facets=[],a.init=function(){a.$watch(function(){var b=angular.copy(a.context.parameters);return b.sort&&delete b.sort,b.start&&delete b.start,b.tab&&delete b.tab,b.dataChart&&delete b.dataChart,"dataset"===a.context.type?[b,a.context.dataset]:b},function(){("catalog"===a.context.type||a.context.dataset)&&(angular.isDefined(a.context.parameters.start)&&delete a.context.parameters.start,a.refreshData())},!0)},a.refreshData=function(){var c=angular.extend({},a.context.parameters,{rows:0,facet:a.facets.map(function(a){return a.name})});a.facets.map(function(a){a.sort&&a.sort.length&&"["!==a.sort[0]&&(c["facetsort."+a.name]=a.sort)});var d;d="dataset"===a.context.type?b.records.search(a.context,c):b.datasets.search(a.context,c),d.success(function(b){a.context.nhits=b.nhits;var c,d,e;angular.forEach(a.facets,function(a){a.categories.splice(0,a.categories.length)}),b.facet_groups&&angular.forEach(b.facet_groups,function(b){if(d=a.facets.filter(function(a){return a.name===b.name}),d.length>0){if(c=d[0].categories,e=[],d[0].sort&&d[0].sort.length&&"["===d[0].sort[0]){var f=a.$eval(d[0].sort);angular.forEach(f,function(a){var c,d;for(c=0;c<b.facets.length;c++)if(d=b.facets[c],d.path===a){e.push(d),b.facets.splice(c,1);break}}),Array.prototype.push.apply(e,b.facets)}else e=b.facets;Array.prototype.push.apply(c,e)}})})},this.registerFacet=function(b,d,e,f){var g=[];return a.facets.push({name:b,categories:g,sort:d}),c[b]=[],e&&(e=angular.isArray(e)?e:[e],angular.forEach(e,function(d){var e=f[d.name+"FacetName"];c[b].push({context:d,facetName:e||b});var g=function(a,c){angular.forEach(a.dataset.fields,function(d){angular.forEach(c.dataset.fields,function(f){d.name===b&&f.name===e&&d.type!=f.type&&console.warn("Error: mapping "+a.name+"'s \""+d.name+'" (type '+d.type+") on "+c.name+"'s \""+f.name+'" (type '+f.type+").")})})};"dataset"===d.type?d.wait().then(function(){g(a.context,d)}):g(a.context,d)})),g},this.setDisjunctive=function(b){a.context.parameters["disjunctive."+b]=!0},this.toggleRefinement=function(b,d){a.context.toggleRefine(b,d),angular.forEach(c[b],function(a){a.context.toggleRefine(a.facetName,d)})}}]}}]),a.directive("odsFacet",function(){return{restrict:"E",replace:!0,scope:{name:"@",title:"@",visibleItems:"@",hideIfSingleCategory:"@",hideCategoryIf:"@",sort:"@",disjunctive:"@",valueSearch:"@",valueFormatter:"@",refineAlso:"=?"},template:function(a){return a.data("facet-template",a.html().trim()),'<div ng-class="{\'odswidget\': true, \'odswidget-facet\': true, \'odswidget-facet--disjunctive\': isDisjunctive()}">    <h3 class="odswidget-facet__facet-title"         ng-if="title && categories.length && visible()">        {{ title }}    </h3>    <ods-facet-category-list ng-if="visible()"                              facet-name="{{ name }}"                              value-search="{{ valueSearch }}"                              hide-category-if="{{ hideCategoryIf }}"                              categories="categories"                              template="{{ customTemplate }}"                              value-formatter="{{valueFormatter}}"></ods-facet-category-list></div>'},require:"^odsFacets",link:function(a,b,c,d){angular.isUndefined(d)&&console.log("ERROR : odsFacet must be used within an odsFacets tag."),a.categories=d.registerFacet(a.name,a.sort,a.refineAlso,c),a.facetsCtrl=d,a.isDisjunctive()&&d.setDisjunctive(a.name)},controller:["$scope","$element",function(a,b){a.isDisjunctive=function(){return angular.isString(a.disjunctive)&&"true"===a.disjunctive.toLowerCase()},a.visibleItemsNumber=a.visibleItems||6,this.toggleRefinement=function(b){a.facetsCtrl.toggleRefinement(a.name,b)},this.getVisibleItemsNumber=function(){return a.visibleItemsNumber},a.visible=function(){return!(angular.isString(a.hideIfSingleCategory)&&"true"===a.hideIfSingleCategory.toLowerCase()&&1===a.categories.length&&"refined"!==a.categories[0].state)},a.customTemplate=b.data("facet-template")}]}}),a.directive("odsFacetCategoryList",function(){return{restrict:"E",replace:!0,scope:{categories:"=",template:"@",facetName:"@",hideCategoryIf:"@",valueSearch:"@",valueFormatter:"@"},require:"^odsFacet",template:'<ul class="odswidget-facet__category-list">   <li class="odswidget-facet__value-search" ng-show="valueSearchEnabled">       <input class="odswidget-facet__value-search-input" ng-model="valueFilter">       <i ng-show="!!valueFilter" class="odswidget-facet__value-search-cancel fa fa-times" ng-click="valueFilter=\'\'"></i>   </li>   <li ng-repeat="category in categories|filter:searchValue(valueFilter)" class="odswidget-facet__category-container">       <ods-facet-category ng-if="!categoryIsHidden(category)" facet-name="{{ facetName }}" category="category" template="{{template}}" value-formatter="{{valueFormatter}}" ng-show="visible($index)"></ods-facet-category>   </li>   <li ng-if="!suggestMode && visibleItems < (filterInvisibleCategories(categories)|filter:searchValue(valueFilter)).length"        class="odswidget-facet__expansion-control">       <a ng-hide="expanded" href="#" ng-click="toggle($event)" class="odswidget-facet__expansion-control-link">           <i class="fa fa-angle-right" aria-hidden="true"></i>           <span translate>More</span>       </a>       <a ng-show="expanded" href="#" ng-click="toggle($event)" class="odswidget-facet__expansion-control-link">           <i class="fa fa-angle-right" aria-hidden="true"></i>           <span translate>Less</span>       </a>   </li></ul>',link:function(a,b,c,d){a.expanded=!1,a.visibleItems=d.getVisibleItemsNumber(),a.visible=function(b){return a.expanded||b<a.visibleItems},a.toggle=function(b){b.preventDefault(),a.expanded=!a.expanded},a.categoryIsHidden=function(b){if(a.suggestMode&&""===a.valueFilter)return!0;if(!a.hideCategoryIf)return!1;var c=a.$new(!1);return c.category=b,c.$eval(a.hideCategoryIf)},a.filterInvisibleCategories=function(b){return b.filter(function(b){return!a.categoryIsHidden(b)})}},controller:["$scope","$filter",function(a,b){a.valueFilter="",a.valueSearchEnabled=!1,a.suggestMode=!1,angular.isString(a.valueSearch)&&("true"===a.valueSearch.toLowerCase()?a.valueSearchEnabled=!0:"suggest"===a.valueSearch.toLowerCase()&&(a.valueSearchEnabled=!0,a.suggestMode=!0)),a.searchValue=function(a){return a?(a=b("normalize")(a).toLowerCase(),function(c){return b("normalize")(c.name).toLowerCase().indexOf(a)>-1}):function(){return!0}},this.emptySearch=function(){a.valueFilter=""}}]}}),a.directive("odsFacetCategory",["$compile",function(a){return{restrict:"E",replace:!0,require:["^odsFacet","^?odsFacetCategoryList"],scope:{category:"=",facetName:"@",template:"@",valueFormatter:"@"},template:'<div class="odswidget odswidget-facet-category">   <a class="odswidget-facet__category"       href="#"       ng-click="toggleRefinement($event, category.path)"       ng-class="{\'odswidget-facet__category--refined\': category.state === \'refined\'}"       title="{{ category.name }}">   </a></div>',link:function(b,c,d,e){var f=e[0],g=e[1];b.toggleRefinement=function(a,b){a.preventDefault(),f.toggleRefinement(b),g.emptySearch()};var h='<span class="odswidget-facet__category-count">{{ category.count|number }}</span> <span class="odswidget-facet__category-name" ng-bind-html="formatCategory(category.name, category.path)"></span>',i=b.template||h;if(c.find("a").append(a(i)(b)),b.category.facets){var j=angular.element('<ods-facet-category-list categories="category.facets" template="{{template}}" value-formatter="{{valueFormatter}}"></ods-facet-category-list>');c.find("a").after(j),a(j)(b)}},controller:["$scope","ValueDisplay",function(a,b){a.formatCategory=function(c){return c=ODS.StringUtils.escapeHTML(c),a.valueFormatter?b.format(c,a.valueFormatter,a.category.path):c}}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsFilterSummary",["odsTimerangeParser","odsTimescaleParser",function(a,b){return{restrict:"E",replace:!0,template:'<ul class="odswidget odswidget-filter-summary">    <li class="odswidget-filter-summary__active-filter"         ng-repeat="refinement in refinements">        <a class="odswidget-filter-summary__active-filter-link"            ng-click="removeRefinement(refinement)">            <span class="odswidget-filter-summary__active-filter-label">{{ refinement.label }}<span ng-if="refinement.contextsLabel && !hideContextsLabels"> ({{ refinement.contextsLabel }})</span></span>            {{ refinement.displayValue || refinement.value }}        </a>    </li>    <li class="odswidget-filter-summary__clear-all" ng-show="clearAllButton && refinements.length > 0">        <ods-clear-all-filters context="context"></ods-clear-all-filters>    </li></ul>',scope:{context:"=",exclude:"@",clearAllButton:"=?",hideContextsLabels:"=?"},controller:["$scope","$attrs","translate",function(c,d,e){Boolean(c.clearAllButton)!==c.clearAllButton&&(c.clearAllButton=!0);var f=c.exclude?c.exclude.split(","):[],g=function(a,b){return a&&a.parameters&&-1===f.indexOf(b)&&a.parameters[b]&&void 0!==a.parameters[b]},h=function(a,b){return"catalog"===a.type?("features"===b&&(b="view"),e(ODS.StringUtils.capitalize(b))):a.dataset.getFieldLabel(b)},i=function(a){for(var b=0;b<a.dataset.fields.length;b++){var c=a.dataset.fields[b];if("geo_point_2d"===c.type||"geo_shape"===c.type)return c.label}return""};c.removeRefinement=function(a){angular.forEach(a.contexts,function(b){if(a.value){var c=b.parameters[a.parameter];angular.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++)if(c[d]===a.value)return c.splice(d,1),void(0===c.length&&delete b.parameters[a.parameter])}else delete b.parameters[a.parameter]})};var j=function(c){var j=[],k=function(a,b,c,d,e){var f=!1;angular.forEach(j,function(e){e.parameter===d&&e.label===b&&e.value===c&&(e.contexts.push(a),f=!0)}),f||j.push({label:b,value:c,displayValue:e,parameter:d,contexts:[a]})};return angular.forEach(c,function(c){if(c&&c.parameters&&("catalog"===c.type||c.dataset)){g(c,"q")&&k(c,e("Text search"),c.parameters.q,"q");var d=["geofilter.distance","geofilter.polygon"];if(angular.forEach(d,function(a){g(c,a)&&k(c,i(c),c.parameters[a],a,e("Drawn area on the map"))}),"catalog"===c.type&&g(c,"q.geographic_area")&&k(c,e("Geographic area"),c.parameters["q.geographic_area"],"q.geographic_area",e("Drawn area on the map")),g(c,"q.timerange")){var j=a(c.parameters["q.timerange"]),l=e("Between {from} and {to}");l=format_string(l,{from:moment(j.from).format("LLL"),to:moment(j.to).format("LLL")}),k(c,c.dataset.getFieldLabel(j.field),c.parameters["q.timerange"],"q.timerange",l)}if(g(c,"q.timescale")){var m=b(c.parameters["q.timescale"]);k(c,c.dataset.getFieldLabel(m.field),c.parameters["q.timescale"],"q.timescale",m.scaleLabel)}g(c,"q.mapfilter")&&k(c,e("Map filter"),c.parameters["q.mapfilter"],"q.mapfilter"),angular.forEach(c.parameters,function(a,b){if("refine."==b.substring(0,7)&&-1===f.indexOf(b)){var d=h(c,b.substring(7));angular.isArray(a)||(a=[a]),angular.forEach(a,function(a){k(c,d,a,b)})}})}}),angular.forEach(j,function(a){a.contexts.length<c.length&&(a.contextsLabel=a.contexts.map(function(a){return d[a.name+"Label"]||a.name}).join(", "))}),j};c.$watch("context",function(a){c.refinements=j(angular.isArray(a)?a:[a])},!0)}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsRedirectIfNotLoggedIn",["ODSWidgetsConfig","config",function(a,b){return{restrict:"A",controller:["$scope","$location",function(a,c){""===b.USER&&c.url("/login")}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsGauge",["$timeout",function(a){return{restrict:"E",replace:!0,scope:{displayMode:"@",value:"=",max:"=?"},template:function(a,b){var c=b.displayMode;-1==["horizontal","bar"].indexOf(c)&&(c="circle");var d;return d="bar"==c?'<svg class="odswidget-gauge__svg">    <line x1="0" y1="5px" x2="100%" y2="5px" class="odswidget-gauge__svg-background"/>    <line x1="0" y1="5px" x2="100%" y2="5px" class="odswidget-gauge__svg-filler" /></svg>':'<svg class="odswidget-gauge__svg" viewBox="0 0 100 100" >    <circle cx="50" cy="50" r="45"             class="odswidget-gauge__svg-background"             vector-effect="non-scaling-stroke"/>    <circle cx="50%" cy="50%" r="45%"             class="odswidget-gauge__svg-filler"            vector-effect="non-scaling-stroke"/> </svg>','<div class="odswidget-gauge odswidget-gauge--'+c+'">    <div class="odswidget-gauge__value">{{ (value/max*100)|number:0 }}%</div>'+d+"</div>"},link:function(b,c){angular.isDefined(b.max)||(b.max=100),-1==["circle","bar"].indexOf(b.displayMode)&&(b.displayMode="circle");var d=c.find(".odswidget-gauge__svg-filler"),e=function(){var e=Math.PI*c.width()*.91;d.css({"stroke-dasharray":e,"stroke-dashoffset":e,transition:"none"}),a(function(){d.css({transition:"stroke-dashoffset 2.5s","stroke-dashoffset":e*(1-b.percentage/100)})})},f=function(){a(function(){var a=Math.PI*c.width()*.91;d.css({"stroke-dashoffset":a*(1-b.percentage/100)})})},g=function(){var e=c.width();d.css({"stroke-dasharray":e,"stroke-dashoffset":e,transition:"none"}),a(function(){d.css({transition:"stroke-dashoffset 2.5s","stroke-dashoffset":e*(1-b.percentage/100)+"px"})})},h=function(){a(function(){var a=c.width();d.css({"stroke-dashoffset":a*(1-b.percentage/100)+"px"})})},i={circle:{setup:e,animate:f},bar:{setup:g,animate:h}},j=function(a){b.percentage=a/b.max*100,b.percentage=Math.max(b.percentage,0),b.percentage=Math.min(b.percentage,100)};j(b.value),i[b.displayMode].setup(),b.$watch("value",function(a,c){a!=c&&(j(a),i[b.displayMode].animate())}),$(window).on("resize",function(){i[b.displayMode].setup()})}}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsGeoSearch",["ModuleLazyLoader","ODSWidgetsConfig","MapHelper",function(a,b,c){return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-geo-search">    <div class="odswidget-geo-search__map"></div></div>',scope:{context:"="},link:function(d,e){var f,g=/.*polygon\(geographic_area,"(.*)"\).*/,h=function(a){var b=a.toGeoJSON();f=ODS.GeoFilter.getGeoJSONPolygonAsPolygonParameter(b.geometry);var c=angular.isArray(d.context)?d.context:[d.context];angular.forEach(c,function(a){a.parameters["q.geographic_area"]='#polygon(geographic_area,"'+f+'")'}),d.$apply()};a("leaflet").then(function(){var a=new L.ODSMap(e.find(".odswidget-geo-search__map")[0],{scrollWheelZoom:!1,basemapsList:[b.basemaps[0]],disableAttribution:!0,maxBounds:[[-90,-180],[90,180]]}),i=new L.FeatureGroup;a.addLayer(i);var j=new L.Control.Draw({edit:{featureGroup:i,edit:!1,remove:!1},draw:{polyline:!1,marker:!1,polygon:!1,circle:!1}});if(a.addControl(j),angular.isDefined(b.defaultMapLocation)){var k=c.getLocationStructure(b.defaultMapLocation);a.setView(k.center,k.zoom)}else a.setView([0,0],0);var l=function(){i.getLayers().length>0&&i.removeLayer(i.getLayers()[0])};a.on("draw:drawstart",function(){l()}),a.on("draw:created",function(a){var b=a.layer;i.addLayer(b),h(b)}),d.$watch("context",function(a){var b=!1,c=angular.isArray(a)?a:[a];if(angular.forEach(c,function(a){if(!b&&a.parameters&&a.parameters["q.geographic_area"]){var c=g.exec(a.parameters["q.geographic_area"]);c.length>0&&(b=c[1])}}),b!==f){if(l(),b){var d=L.geoJson(ODS.GeoFilter.getPolygonParameterAsGeoJSON(b));i.addLayer(d)}f=b}},!0)})}}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsGeotooltip",["$timeout","ModuleLazyLoader","ODSWidgetsConfig",function(a,b,c){var d=angular.element('<div id="odswidget-geotooltip" class="odswidget" style="opacity: 0; transition: opacity 200ms ease-out; position: fixed; z-index: 40000; visibility: hidden;"></div>'),e=null,f=null,g=function(a,b,g,h,i,j){var k,l=!1;b===d.css("width")&&g===d.css("height")||(l=!0),d.css("width",b),d.css("height",g);var m=jQuery(window).height()-(a.offset().top-jQuery(document).scrollTop());d.height()<m?d.css("top",a.height()+a.offset().top-jQuery(document).scrollTop()+5+"px"):d.css("top",a.offset().top-jQuery(document).scrollTop()-5-d.height()+"px");var n=jQuery(window).width()-(a.offset().left-jQuery(document).scrollLeft());d.width()<n?d.css("left",a.offset().left-jQuery(document).scrollLeft()+"px"):d.css("left",a.offset().left-jQuery(document).scrollLeft()-d.width()+"px"),a.after(d),null===e?e=new L.ODSMap(d[0],{zoomControl:!1,basemapsList:[c.basemaps[0]],minZoom:1,maxZoom:16}):l&&e.invalidateSize(),null!==f&&e.removeLayer(f),f=L.layerGroup();var o=new L.LatLngBounds;if(h){angular.isString(h)&&(h=h.split(","));var p=new L.LatLng(h[0],h[1]),q=L.marker(p);f.addLayer(q),o.extend(p)}i&&(angular.isString(i)&&(i=angular.fromJson(i)),k=L.geoJson(i),f.addLayer(k),o.extend(k.getBounds())),j&&angular.isDefined(j.geometry)&&(k=L.geoJson(j.geometry),f.addLayer(k),o.extend(k.getBounds())),f.addTo(e),e.fitBounds(o,{reset:!0}),d.css("opacity","1"),d.css("visibility","visible")},h=function(){d.css("opacity","0"),a(function(){d.css("visibility","hidden")},200)};return{template:'<span ng-transclude style="border-bottom: 1px dotted #000000; cursor: help;" class="geotooltip"></span>',replace:!0,restrict:"E",transclude:!0,scope:{coords:"=",width:"@",height:"@",delay:"@",geojson:"=",record:"="},link:function(c,d,e){b("leaflet").then(function(){var b=(e.width||200)+"px",f=(e.height||200)+"px",i=null,j=e.delay||500;d.bind("mouseenter",function(){0===j?g(d,b,f,c.coords,c.geojson,c.record):i=a(function(){g(d,b,f,c.coords,c.geojson,c.record),i=null},j)}),d.bind("click",function(){g(d,b,f,c.coords,c.geojson,c.record),null!==i&&(a.cancel(i),i=null)}),d.bind("mouseleave",function(){h(),null!==i&&(a.cancel(i),i=null)})})}}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsGist",function(){return{restrict:"E",replace:!0,template:'<div class="odswidget"></div>',scope:{username:"@",id:"@"},link:function(a,b,c){$.ajax({url:"https://gist.github.com/"+c.username+"/"+c.id+".json",dataType:"jsonp",timeout:1e3,success:function(a){$(document.head).append('<link href="'+a.stylesheet+'" rel="stylesheet">'),b.append(a.div)}})}}})}(),function(){"use strict";var a=angular.module("ods-widgets"),b=function(a){return-1===["COUNT","CONSTANT"].indexOf(a)};a.factory("requestData",["ODSAPI","$q","ChartHelper","AggregationHelper",function(a,b,c,d){var e=ODS.DateFieldUtils.getTimescaleX,f=function(a,b,c,d){var f,g,h,i={dataset:a.config.dataset,x:[],sort:a.sort||"",maxpoints:a.maxpoints||""};for(h=e(a.xAxis,a.timescale),f=0;f<h.length;f++)i.x.push(h[f]);if(a.seriesBreakdown)for(g=a.seriesBreakdown,h=e(g,a.seriesBreakdownTimescale),f=0;f<h.length;f++)i.x.push(h[f]);return(b||a.seriesBreakdown)&&(i.sort=ODS.DateFieldUtils.getTimescaleSort(i.x)),i},g=function(a,b,c){var d,e=/([A-Z_-]*?)\((.*?)\)/g,f=/([A-Z_-]*?)\(([a-zA-Z0-9\.]+),\s?([0-9\.]+)\)/g,g=c||a;a.compiled_expr=""+a.expr,g.aggregates=[];var h={};for(d=e.exec(a.expr);d;){var i=f.exec(d[0]);if(i&&4===i.length&&(d=i),d&&(3===d.length||4===d.length))if(0===d[2].indexOf("serie")){var j="operators."+d[1].toLowerCase()+".apply(null, accumulation['"+d[2]+"']";4===d.length&&(j+=", "+d[3]),j+=")",a.compiled_expr=a.compiled_expr.replace(d[0],j),g.aggregates.push(d[2])}else h[b+".func"]=d[1],h[b+".expr"]=d[2],a.compiled_expr+=a.compiled_expr.replace(d[0],"y");d=e.exec(a.expr)}return h},h=function(a,b,c,d){var e={};return"CUSTOM"===a.func?g(a,"y."+b,d):(e["y."+b+".expr"]=a.yAxis||a.expr,e["y."+b+".func"]=a.func,e["y."+b+".cumulative"]=a.cumulative||!1,"QUANTILES"===a.func&&(a.subsets||(a.subsets=50),e["y."+b+".subsets"]=a.subsets||50),"CONSTANT"===a.func&&(e["y."+b+".expr"]=a.yAxis||0,e["y."+b+".func"]="AVG"),angular.isDefined(a.multiplier)&&""!==a.multiplier&&null!==a.multiplier&&(e["y."+b+".expr"]+=" * "+a.multiplier),e)},i=function(a,b,d){var e,f,g=!0;if(b.type&&(c.isRangeChart(b.type)||"boxplot"===b.type)){if(a.sort==="y."+d&&(a.sort=""),"QUANTILES"===b.charts[0].func)for(f=angular.copy(b.charts[0]),e=1;e<b.charts.length;e++)"QUANTILES"!==b.charts[e].func||b.charts[e-1].yAxis!==b.charts[e].yAxis?g=!1:f.subsets=f.subsets+","+b.charts[e].subsets;else g=!1;if(g)i(a,f,d);else for(e=0;e<b.charts.length;e++)b.charts[e].multiplier=b.multiplier,i(a,b.charts[e],d+"-range-"+e)}else angular.extend(a,h(b,d))};return function(c,d,e,g,h,j,k,l){var m=[],n=[],o=j;return d=d||{},1===c.length?-1!==["hour","minute","second"].indexOf(c[0].timescale)&&(d.output_timezone="UTC"):-1!==["hour","minute","second"].indexOf(e)&&(d.output_timezone="UTC"),angular.forEach(c,function(b,c){var p={},q=f(b,e,g,h);angular.forEach(b.charts,function(a,b){var d="serie"+(c+1)+"-"+(b+1);i(q,a,d),p[d]=a}),j=b.config.domain||o,k=b.config.apikey||k;var r={domain:j,domainUrl:a.getDomainURL(j),dataset:{datasetid:q.dataset},apikey:k,parameters:{}};m.push(a.records.analyze(r,angular.extend({},d,b.config.options,q),l.promise)),n.push(p)}),{promise:b.all(m),charts:n}}}]),a.directive("odsHighchartsChart",["colorScale","requestData","translate","ModuleLazyLoader","AggregationHelper","ChartHelper","$rootScope","odsNotificationService","$q",function(a,c,d,e,f,g,h,i,j){function k(a,b,c,e,f){var g=y(c,e);return g&&"datetime"===f?g.getTime():g?a(b,g):void 0===c?void 0:angular.isObject(c)&&c.week?d("Week")+" "+c.week:"linear"===f?c:""+c}function l(a,b){return"QUANTILES"===b.func&&b.subsets?void 0===a[b.subsets+".0"]?null:a[b.subsets+".0"]:void 0===a?null:a}function m(a,b,c,d){var e;try{e=a.$eval(b,{operators:Math,accumulation:function(a,b){var c={};return angular.forEach(b,function(b){c[b]=a[b]}),c}(c,d),console:console})}catch(a){console.warn("Error while compiling aggregation value with expr",b)}return e}var n=d,o=function(a,b){return b?b+"."+a:g.getDatasetUniqueId(a)},p=function(a){var b,c,d,e=a.timescale;if(e||(e=a.queries[0].timescale||!1),e&&0===$.grep(a.queries,function(a){return a.sort}).length){d=e;var f=d.split(" ");b=f[0],c=2==f.length?f[1]:""}else d=!1,b=!1,c=!1;return{precision:b,periodic:c,timeSerieMode:d}},q=function(a,b,c,e,f){e.height(),e.width();if(0===a.queries.length)a.xLabel="";else if(!angular.isDefined(a.xLabel)){var h=o(a.queries[0].config.dataset,f);a.xLabel=g.getXLabel(h,a.queries[0].xAxis,a.timescale)}angular.isUndefined(a.displayLegend)&&(a.displayLegend=!0);var i={chart:{},title:{text:""},credits:{enabled:!1},series:[],xAxis:{title:{text:a.xLabel},labels:{step:1,rotation:-45,align:"right",useHTML:!0},startOfWeek:1,minPadding:0,maxPadding:0,dateTimeLabelFormats:{second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%e %b %y",week:"%e. %b",month:"%b '%y",year:"%Y"}},legend:{enabled:!!a.displayLegend},yAxis:[],plotOptions:{series:{animation:!1},columnrange:{pointPadding:0,groupPadding:0,borderWidth:0,tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.low}</b> - <b>{point.high}</b>'}},boxplot:{tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>:<br>'+d("Maximum:")+" {point.high}<br>"+d("Upper quartile:")+" {point.q3}<br>"+d("Median:")+" {point.median}<br>"+d("Lower quartile:")+" {point.q1}<br>"+d("Minimum:")+" {point.low}<br>"}},arearange:{tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.low}</b> - <b>{point.high}</b>'}},areasplinerange:{tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.low}</b> - <b>{point.high}</b>'}},pie:{tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.y} ({point.percentage:.1f}%)</b>'}},treemap:{tooltip:{headerFormat:"",pointFormat:'<span style="color:{series.color}">{point.name}</span>: {point.value}</b>'},layoutAlgorithm:"squarified",colorByPoint:!0}},tooltip:{valueDecimals:2,headerFormat:"{point.key}<br>",pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b>',formatter:function(a){var b=this.points||angular.isArray(this)?this:[this],c=b[0].series,d=[];return d=[a.tooltipFooterHeaderFormatter(b[0])],angular.forEach(b,function(a){c=a.series;var b=c.tooltipOptions.pointFormatter&&c.tooltipOptions.pointFormatter.bind(a.point)()||a.point.tooltipFormatter(c.tooltipOptions.pointFormat);d.push(b)}),d.push(a.options.footerFormat||""),d.join("")}},noData:{style:{fontFamily:"Open Sans",fontWeight:"normal",fontSize:"1.4em",color:"#333",opacity:"0.5"}},lang:{noData:d("No data available yet")}},j=g.getFieldType(h,a.queries[0].xAxis);if(b?(i.xAxis.type="datetime",i.xAxis.maxZoom=36e5,i.chart.zoomType="xy",c&&(i.xAxis.showFirstLabel=!0)):-1!==["double","int"].indexOf(j)&&""===a.queries[0].sort?i.xAxis.type="linear":(i.xAxis.type="category",i.xAxis.categories=[]),"month"===c?i.xAxis.labels.format="{value: %B}":"weekday"===c?(i.xAxis.labels.format="{value: %A}","hour"===b&&(i.xAxis.labels.format="{value: %A %Hh}")):"day"===c?i.xAxis.labels.format="{value: %d}":"hour"===c&&(i.xAxis.labels.format="{value: %H}"),b?i.xAxis.labels.useHTML=!1:i.xAxis.labels.formatter=function(){return this.value.length>12?'<span title="'+this.value.replace('"',"")+'" alt="'+this.value.replace('"',"")+'">'+this.value.substring(0,9)+"...</span>":this.value},a.singleAxis){var k={color:"#000000",scale:a.singleAxisScale,yRangeMin:a.yRangeMin,yRangeMax:a.yRangeMax,yStep:a.yStep,scientificDisplay:a.scientificDisplay};i.yAxis=[x(a.singleAxisLabel,k,!1)]}for(var l=0;l<a.queries.length;l++)for(var m=0;m<a.queries[l].charts.length;m++)"spiderweb"!==a.queries[l].charts[m].type&&"polar"!==a.queries[l].charts[m].type||(i.chart.polar=!0,i.xAxis.lineWidth=0,i.xAxis.tickmarkPlacement="on",i.xAxis.labels={},i.xAxis.title={}),"polar"===a.queries[l].charts[m].type&&(i.plotOptions.series.pointPlacement="on",i.plotOptions.series.pointPadding=0,i.plotOptions.series.groupPadding=0),"funnel"===a.queries[l].charts[m].type&&(i.chart.type="funnel",i.chart.marginRight=100,i.legend.enabled=!1);return i},r={},s=0,t=function(c,e,f,h,i,j,k){function l(a,b,c){return!1!==b?a=Highcharts.numberFormat(a,b):angular.isNumber(a)&&(a=Highcharts.numberFormat(a).replace(/([,.][0-9]*?)0+$/,"$1").replace(/[,.]$/,"")),c&&(a="$"===c?c+a:a+" "+c),a}function m(a){return"treemap"===a?function(){var a=l(this.value,v,!!h.displayUnits&&u);return'<span style="color:'+this.series.color+'">'+this.series.name+"</span>: <b>"+a+"</b>"}:"arearange"===a||"areasplinerange"===a||"columnrange"===a?function(){var a=l(this.low,v,!!h.displayUnits&&u),b=l(this.high,v,!!h.displayUnits&&u);return'<span style="color:'+this.series.color+'">'+this.series.name+"</span>: <b>"+a+" - "+b+"</b>"}:"pie"===a?function(){var a=l(this.y,v,!!h.displayUnits&&u);return'<span style="color:'+this.series.color+'">'+this.series.name+"</span>: <b>"+a+" ("+Highcharts.numberFormat(this.percentage,1)+"%)</b>"}:"boxplot"===a?function(){var a=function(a){return l(a,v,!!h.displayUnits&&u)};return'<span style="color:'+this.series.color+'">'+this.series.name+"</span>: <b><br>"+d("Maximum:")+" "+a(this.high)+"<br>"+d("Upper quartile:")+" "+a(this.q3)+"<br>"+d("Median:")+" "+a(this.median)+"<br>"+d("Lower quartile:")+" "+a(this.q1)+"<br>"+d("Minimum:")+" "+a(this.low)+"<br>"}:function(){var a=l(this.y,v,!!h.displayUnits&&u);return'<span style="color:'+this.series.color+'">'+this.series.name+"</span>: <b>"+a+"</b>"}}var n,o=g.getDatasetId({dataset:{datasetid:f.config.dataset},domain:j}),p=g.getYLabel(o,h);i||-1!==["pie","treemap"].indexOf(h.type)?-1!==["pie","treemap"].indexOf(h.type)?(h.extras||(h.extras={}),h.innersize&&(h.extras.innerSize=h.innersize),"inside"===h.labelsposition&&(h.extras.dataLabels={distance:-50}),h.extras.colors=a.getColors(h.color)):(r[i+h.color]||(r[i+h.color]=a.getColorAtIndex(h.color,s),s++),n=r[i+h.color]):n=a.getUniqueColor(h.color);var q="line";q="spiderweb"===h.type?"line":"polar"===h.type?"column":h.type;var t=angular.extend({},{name:i||p,color:n,type:q,yAxis:c.singleAxis?0:e[o][p],marker:{enabled:"scatter"===h.type,radius:3},shadow:!1,tooltip:{},data:[],stacking:f.stacked?f.stacked:null},h.extras);t.dataLabels||(t.dataLabels={}),"funnel"===h.type&&(t.neckWidth="30%",t.neckHeight="25%");var u=!1,v=!1;if(b(h.func)&&(u=g.getFieldUnit(o,h.yAxis),v=g.getDecimals(o,h.yAxis)),h.displayValues&&(t.dataLabels.enabled=!0,t.dataLabels.color="black","treemap"!==h.type&&(t.dataLabels.formatter=function(){return v?Highcharts.numberFormat(this.point.y,v):Highcharts.numberFormat(this.point.y).replace(/([,.][0-9]*?)0+$/,"$1").replace(/[,.]$/,"")})),h.displayUnits&&u&&(t.tooltip.valueSuffix=" "+u,h.displayValues&&"treemap"!==h.type)){var w=t.dataLabels.formatter;t.dataLabels.formatter=function(){return"$"===u?u+w.bind(this)(this.point.y):w.bind(this)(this.point.y)+" "+u}}return t.tooltip.pointFormatter=m(h.type),h.refineOnClickCtrl&&(t.point={events:{click:function(a){var b=this.category||this.name;h.refineOnClickCtrl.refineOnValue(b),k.$apply()}}},t.cursor="pointer"),t=angular.extend(t,g.resolvePosition(h.position)),delete t.position,t},u=ODS.DateFieldUtils.datePatternBuilder("highcharts"),v=function(a,b){var c={};return b&&(c.xDateFormat=u(a)),c},w=function(a,b,c){c&&angular.isObject(a)&&("second"in a?b.minTickInterval=Date.UTC(2010,1,1,1,1,2)-Date.UTC(2010,1,1,1,1,1):"minute"in a?b.minTickInterval=Date.UTC(2010,1,1,1,2)-Date.UTC(2010,1,1,1,1):"hour"in a?b.minTickInterval=Date.UTC(2010,1,1,2)-Date.UTC(2010,1,1,1):"weekday"in a?b.minTickInterval=Date.UTC(2010,1,2)-Date.UTC(2010,1,1):"day"in a||"yearday"in a?b.minTickInterval=Date.UTC(2010,1,2)-Date.UTC(2010,1,1):"month"in a?b.minTickInterval=Date.UTC(2010,1,1)-Date.UTC(2010,0,1):"year"in a&&(b.minTickInterval=Date.UTC(2010,0,1)-Date.UTC(2009,0,1)))},x=function(a,b,c,d){var e=void 0!==b.yRangeMin&&""!==b.yRangeMin,f=void 0!==b.yRangeMax&&""!==b.yRangeMax,g={title:{text:a||"",style:{color:b.color}},labels:{style:{color:b.color}},type:b.scale||"linear",min:e?parseFloat(b.yRangeMin):null,max:f?parseFloat(b.yRangeMax):null,tickInterval:b.yStep?parseFloat(b.yStep):null,startOnTick:!e,endOnTick:!f,opposite:c};return b.scientificDisplay||(g.labels.formatter=function(){return angular.isNumber(this.value)?Highcharts.numberFormat(this.value,-1):this.value}),"spiderweb"===b.type?(g.gridLineInterpolation="polygon",g.lineWidth=0,delete g.startOnTick,delete g.endOnTick,delete g.title,delete g.labels):"polar"===b.type&&(g.endOnTick=!1,g.showLastLabel=!0,delete g.title,delete g.labels),d&&(g.stackLabels={enabled:!0,style:{fontWeight:"bold"}}),g},y=ODS.DateFieldUtils.getDateFromXObject;return{restrict:"A",replace:!0,require:["odsHighchartsChart"],scope:{parameters:"=parameters",domain:"=",apikey:"=",colors:"=",contexts:"=?"},template:'<div class="ods-chart">    <div class="ods-chart__loading" ng-show="loading">        <ods-spinner></ods-spinner>    </div>    <div class="chartplaceholder"></div>    <debug data="chartoptions"></debug></div>',controller:["$scope","$element","$attrs",function(b){var e,f,h,r,s,y=this;b.$watch("contexts",function(a,c){if(a&&a.length>0){var d;for(d=0;d<a.length;d++)b[a[d].name]=a[d]}},!0),this.highchartsLoaded=function(z,A){function B(a){if(!h){if(angular.isObject(a)&&("day"in a||"month"in a||"year"in a)){var b=new Date(Date.UTC(a.year,a.month-1||0,a.day||1,a.hour||0,a.minute||0));return z.dateFormat("%Y-%m-%d",b)}return""+a}switch(console.warn("formatRowX on periodic value should not be used anymore"),h){case"month":return[n("Jan"),n("Feb"),n("Mar"),n("Apr"),n("May"),n("Jun"),n("Jul"),n("Aug"),n("Sep"),n("Oct"),n("Nov"),n("Dec")][a.month-1];case"weekday":return[n("Monday"),n("Tuesday"),n("Wednesday"),n("Thursday"),n("Friday"),n("Saturday"),n("Sunday")][a.weekday];case"day":return a.day;default:return""+a}}var C=A.find(".chartplaceholder"),D=j.defer();y.update=function(n){function A(a,b,c,d,e,f,g){var h,i,j,k=!1;if("datetime"===H.xAxis.type||"linear"===H.xAxis.type){if("object"==typeof e){if(j=[d],"logarithmic"===c)for(i=0;i<e.length;i++)e[i]<=0&&(k=!0);if(k)for(i=0;i<e.length;i++)j.push(null);else for(i=0;i<e.length;i++)j.push(e[i]);a.data.push(j)}else if(-1!==["pie","funnel"].indexOf(a.type))"datetime"===H.xAxis.type?a.data.push({name:z.dateFormat(a.tooltip.xDateFormat,new Date(d)),y:e}):a.data.push({name:""+d,y:e});else if("treemap"==a.type)"datetime"===H.xAxis.type?a.data.push({name:z.dateFormat(a.tooltip.xDateFormat,new Date(d)),value:e}):a.data.push({name:""+d,y:e});else if("logarithmic"===c&&e<=0?a.data.push([d,null]):a.data.push([d,e]),g.length>0)for(h=g.length-1;h>=0;h--)if(e>=g[h].value){a.data[a.data.length-1]={x:a.data[a.data.length-1][0],y:a.data[a.data.length-1][1],color:g[h].color};break}}else if(-1!==["pie","funnel"].indexOf(a.type))a.data[b]={name:B(d),y:e};else if("treemap"==a.type)a.data[b]={name:B(d),value:e};else{if("object"==typeof e){if(j=[],"logarithmic"===c)for(i=0;i<e.length;i++)e[i]<=0&&(k=!0);if(k)for(i=0;i<e.length;i++)j.push(null);else for(i=0;i<e.length;i++)j.push(e[i]);a.data[b]=j}else a.data[b]="logarithmic"===c&&e<=0?null:e;if(g.length>0)for(h=g.length-1;h>=0;h--)if(e>=g[h].value){a.data[b]={y:a.data[b],color:g[h].color};break}}}if(void 0===n&&(n=b.parameters),!(n=angular.copy(n))||!n.queries||0===n.queries.length)return void(b.chart&&angular.element(b.chart.container).empty());e=void 0,f=void 0,h=void 0,r={};for(var E=0;E<n.queries.length;E++)try{o(n.queries[E].config.dataset,s)}catch(a){return void g.onLoad(y.update)}var F=p(n);if(e=F.timeSerieMode,f=F.precision,h=F.periodic,f){var G=!1;h&&"hour"===f?G=!0:h||-1!==["year","month","day"].indexOf(f)&&(G=!0),z.setOptions({global:{useUTC:G}})}var H=q(n,f,h,C,s);b.chartoptions=H,angular.forEach(n.queries,function(b){var c=g.getDatasetId({dataset:{datasetid:b.config.dataset},domain:b.config.domain});angular.isUndefined(r[c])&&(r[c]={}),angular.forEach(b.charts,function(b){var d=g.getYLabel(c,b);if(!n.singleAxis&&angular.isUndefined(r[c][d])){var e=x(d,b,!!(H.yAxis.length%2),!!b.displayStackValues);r[c][d]=H.yAxis.push(e)-1}if("bar"==b.type&&(H.xAxis.labels.rotation=0),b.colorScale=a.getScale(b.color),g.allowThresholds(b.type)){if(b.thresholds){for(var f=0;f<b.thresholds.length;f++)angular.isNumber(b.thresholds[f].value)||b.thresholds.splice(f,1);b.thresholds=b.thresholds.sort(function(a,b){return a.value>b.value})}}else delete b.thresholds})}),D.resolve("new request coming, cancelling current one"),D=j.defer(),b.loading=!0;var I=c(n.queries,b.searchoptions,e,f,h,b.domain,b.apikey,D);I.promise.then(function(c){b.loading=!1;var g,h,j=I.charts;if(f)for(var o=0;o<c.length;o++){var p=c[o];for(h=0;h<p.data.length;h++){var q=p.data[h];if(q.x.year&&angular.isNumber(q.x.year)){var x=new Date(Date.UTC(q.x.year,q.x.month-1||0,q.x.day||1,q.x.hour||0,q.x.minute||0));x.setFullYear(q.x.year),(void 0===g||x<g)&&(g=x)}}}var y=[];for(h=0;h<n.queries.length;h++)if(!n.queries[h].seriesBreakdown)for(var B=0;B<n.queries[h].charts.length;B++)y.push("serie"+(h+1)+"-"+(B+1)),H.series.push(!1);var D=function(a,c,d,e,f,g,h,i,j){var k,l=y.indexOf(a);g.colorScale(i).hex();-1===l?(d.series.push(t(c,r,f,g,j,f.config.domain||s,b)),l=y.push(a)-1):d.series[l]||(d.series[l]=t(c,r,f,g,j,f.config.domain||s,b)),"category"===d.xAxis.type&&-1===(k=d.xAxis.categories.indexOf(h))&&(k=d.xAxis.categories.length,d.xAxis.categories.push(h)),angular.extend(d.series[l].tooltip,e),j||"pie"===g.type?A(d.series[l],k,c.singleAxisScale||g.scale,h,i,d.series[l].color,g.thresholds||[]):A(d.series[l],k,c.singleAxisScale||g.scale,h,i,g.colorScale(i).hex(),g.thresholds||[])};angular.forEach(c,function(c,d){var f,h,i,o;if(c.data&&0!==c.data.length&&(c.data.results?(f=c.data.results,h=c.data.aggregations):f=c.data,0!==f.length)){var p=n.queries[d],q=j[d],r=p.xAxis,s=!!p.seriesBreakdown,t=v(s?f[0].x[r]:f[0].x,H,e);w(s?f[0].x[r]:f[0].x,H.xAxis,e),p.defaultValues={},angular.forEach(q,function(a,b){p.defaultValues[b]=null}),h&&angular.forEach(h,function(b,c){var d,e;if(c.endsWith("min"))c=c.replace("min",""),d=b.min,e=h[c+"max"].max;else{if(c.endsWith("max"))return;q[c].charts&&"QUANTILES"===q[c].charts[0].func&&"QUANTILES"===q[c].charts[1].func?(d=b.min[q[c].charts[0].subset+".0"],d=b.max[q[c].charts[1].subset+".0"]):(d=b.min,e=b.max)}q[c].colorScale=a.getScale(q[c].color,d,e)});var x=!1,y=[],A=[],B={},C=n.queries[d].charts.length;for(o=0;o<C;o++){var E=n.queries[d].charts[o];if(E.aggregates)for(var F=0;F<E.aggregates.length;F++){var G=E.aggregates[F];G&&-1===y.indexOf(G)&&(y.push(G),B[G]=[])}E.compiled_expr&&(x=!0)}for(i=0;i<f.length;i++){var I=f[i];angular.extend({},p.defaultValues,I);var J=k(z.dateFormat,t.xDateFormat,s?I.x[r]:I.x,g,H.xAxis.type);o=0,angular.forEach(I,function(a,b){var c,d,e,f,h=!1;if("x"!==b){if((f=b.match(/-range-([0-9])$/))&&2===f.length){if(e=b.replace(/-range-[0-9]$/,""),h=!0,"0"!==f[1])return}else e=b;var i=q[e];if(h)for(d=[],c=0;c<i.charts.length;c++)d.push(l(I[e+"-range-"+c],i.charts[c]));else if(i.charts)for(d=[],c=0;c<i.charts.length;c++)d.push(l(a,i.charts[c]));else d=l(a,i);s?angular.forEach(I.x,function(a,b){b!==r&&(a=k(z.dateFormat,u(a),a,g,!1),D(""+e+b+a,n,H,t,p,i,J,d,a),y.indexOf(e)>=0&&B[e].push(d))}):(D(""+e,n,H,t,p,i,J,d),y.indexOf(e)>=0&&B[e].push(d)),x&&A.push(J),o++}})}if(x)for(A.sort(function(a,b){return a-b}),i=A.length-1;i>0;i--)A[i]==A[i-1]&&A.splice(i,1);for(i=0;i<p.charts.length;i++)if(p.charts[i].aggregates)for(var K=p.charts[i],L=m(b,K.compiled_expr,B,K.aggregates),o=0;o<A.length;o++)D("aggr"+d+"-"+i,n,H,t,p,K,A[o],L)}});var E=H.xAxis.categories;if(E)for(h=0;h<H.series.length;h++)for(var F=0;F<E.length;F++)H.series[h].data&&void 0===H.series[h].data[F]&&(H.series[h].data[F]=null);if(E){if(1===E.length)for(h=0;h<H.series.length;h++)-1!==["line","spline","area","arearange"].indexOf(H.series[h].type)&&(H.series[h].marker=H.series[h].marker||{},H.series[h].marker.enabled=!0)}else for(h=0;h<H.series.length;h++)-1!==["line","spline","area","arearange"].indexOf(H.series[h].type)&&1===H.series[h].data.length&&(H.series[h].marker=H.series[h].marker||{},H.series[h].marker.enabled=!0);b.chart&&H.chart.renderTo&&(b.chart.destroy(),C=$element.find(".chartplaceholder")),H.chart.renderTo=C[0];try{H.series.length>500&&(i.sendNotification(d("There are too many series to be displayed correctly, try to refine your query a bit.")),H.series=H.series.slice(0,10)),b.chart=new z.Chart(H,function(){})}catch(a){a.indexOf&&0===a.indexOf("Highcharts error #19")?(i.sendNotification(d("There was too many points to display, the maximum number of points has been decreased.")),angular.forEach(b.parameters.queries,function(a){a.maxpoints=20})):angular.isString(a)?i.sendNotification(a):i.sendNotification(a.message)}},function(a){b.loading=!1})}}}],link:function(a,b,c,d){var f=d[0];e("highcharts").then(function(){f.highchartsLoaded(Highcharts,b),a.$watch("parameters",function(a,b){f.update(a)},!0)})}}}]),a.directive("odsHighcharts",["colorScale",function(a){var b=a.getColors(a.getDefaultColorSet());return{restrict:"E",scope:{context:"=",fieldX:"@",expressionY:"@",functionY:"@",timescale:"@",chartType:"@",color:"@",chartConfig:"=",labelX:"@",labelY:"@",sort:"@",maxpoints:"@"},replace:!0,template:'<div class="odswidget odswidget-highcharts"><div ods-highcharts-chart parameters="chart" domain="context.domain" apikey="context.apikey"></div></div>',controller:["$scope","ODSWidgetsConfig","ChartHelper",function(a,c,d){var e=c.chartColors||b;a.color&&(e=a.color.split(",").map(function(a){return a.trim()}));var f=a.$watch("context.dataset",function(b){if(b){if("dataset"!==a.context.type&&console.error("ods-highcharts requires a Dataset Context"),d.init(a.context),angular.isUndefined(a.chartConfig)){var c={};"pie"===a.chartType&&(c={colors:e});var g="";g="y"===a.sort?"serie1-1":"-y"===a.sort?"-serie1-1":a.sort;var h=a.labelY||("COUNT"===a.functionY.toUpperCase()?"Count":a.expressionY);a.chart={timescale:a.timescale,xLabel:a.labelX,queries:[{config:{dataset:a.context.dataset.datasetid,options:a.context.parameters,domain:a.context.domain},xAxis:a.fieldX,sort:g,maxpoints:a.maxpoints||50,charts:[{yAxis:a.expressionY,yLabelOverride:h,func:a.functionY,color:e[0],type:a.chartType,extras:c}]}]}}else angular.isString(a.chartConfig)?a.chart=JSON.parse(b64_to_utf8(a.chartConfig)):a.chart=angular.copy(a.chartConfig);a.$broadcast("chartConfigReady",a.chart),a.$watch("chart",function(b){var c,e;if(b){var f=d.getDatasetId(a.context);for(c=0;c<b.queries.length;c++){var g=b.queries[c];for(void 0===g.xAxis&&d.setDefaultQueryValues(f,g,!0),e=0;e<g.charts.length;e++)d.setSerieDefaultValues(f,g.charts[e],g.xAxis,!0);for(d.setDefaultQueryValues(f,g,!0),1===a.chart.queries.length&&d.setChartDefaultValues(f,b,!0),e=0;e<g.charts.length;e++)d.setSerieDefaultColors(g.charts[e],g.seriesBreakdown)}a.$broadcast("chartConfigReady",a.chart)}},!0),f()}})}]}}]),a.directive("odsMultiHighcharts",["ODSAPI","ChartHelper","$q",function(a,b,c){return{restrict:"E",scope:{context:"=",chartConfig:"="},replace:!0,template:'<div class="odswidget odswidget-multihighcharts"><div ods-chart parameters="chart" domain="context.domain" apikey="context.apikey"></div></div>',controller:["$scope",function(d){var e=d.$watch("context",function(f){var g;if(f){"catalog"!==f.type&&console.error("ods-multi-highcharts requires a Catalog Context");var h;h=angular.isString(d.chartConfig)?JSON.parse(b64_to_utf8(d.chartConfig)):d.chartConfig;var i=[];for(g=0;g<h.queries.length;g++){var j=h.queries[g].config.dataset;-1===i.indexOf(j)&&i.push(j)}var k=[],l=function(a){var c=new ODS.Dataset(a);d.context.dataset=c,b.init(d.context)};for(g=0;g<i.length;g++)k.push(a.datasets.get(d.context,i[g],{extrametas:!0}).success(l));c.all(k).then(function(a){d.chart=h}),e()}})}]}}]),a.directive("odsChart",["ODSAPI","ChartHelper","ODSWidgetsConfig",function(a,b,c){return{restrict:"EA",scope:{timescale:"@",labelX:"@",singleYAxis:"@",singleYAxisLabel:"@",singleYAxisScale:"@",min:"@",max:"@",step:"@",scientificDisplay:"@",logarithmic:"@",displayLegend:"@",context:"=?",fieldX:"@",expressionY:"@",functionY:"@",chartType:"@",color:"@",chartConfig:"=?",labelY:"@",sort:"@",maxpoints:"@",chart:"=?parameters"},replace:!0,transclude:!0,template:'<div class="odswidget odswidget-charts"><debug data="chart"></debug><div ods-highcharts-chart parameters="chart" domain="context.domain" apikey="context.apikey" contexts="contexts"></div><div ng-transclude></div></div>',controller:["$scope","$element","$attrs","$transclude",function(a,d,e,f){a.contexts=[],this.pushContext=function(b){a.contexts.push(b)},a.chart||(a.chart={queries:[],xLabel:angular.isDefined(a.labelX)?a.labelX:void 0,timescale:a.timescale||"",singleAxis:!!a.singleYAxis,singleAxisLabel:angular.isDefined(a.singleYAxisLabel)?a.singleYAxisLabel:void 0,singleAxisScale:a.logarithmic?"logarithmic":"",yRangeMin:angular.isDefined(a.min)&&""!==a.min?parseFloat(a.min):void 0,yRangeMax:angular.isDefined(a.max)&&""!==a.max?parseFloat(a.max):void 0,yStep:angular.isDefined(a.step)&&""!==a.step?parseFloat(a.step):void 0,scientificDisplay:!angular.isDefined(a.scientificDisplay)||""===a.scientificDisplay||"true"===a.scientificDisplay,displayLegend:!angular.isDefined(a.displayLegend)||"false"!==a.displayLegend}),angular.forEach(a.chart,function(b,c){void 0===b&&delete a.chart[c]}),e.context?(!function(){var d=c.chartColors||defaultColors;a.color&&(d=a.color.split(",").map(function(a){return a.trim()}));var e=a.$watch("context.dataset",function(c){if(c){if("dataset"!==a.context.type&&console.error("ods-chart requires a Dataset Context"),b.init(a.context),angular.isUndefined(a.chartConfig)){var f={};"pie"===a.chartType&&(f={colors:d});var g="";g="y"===a.sort?"serie1-1":"-y"===a.sort?"-serie1-1":a.sort;var h=a.labelY||("COUNT"===a.functionY.toUpperCase()?"Count":a.expressionY);a.chart={timescale:a.timescale,xLabel:a.labelX,queries:[{config:{dataset:a.context.dataset.datasetid,options:a.context.parameters},xAxis:a.fieldX,sort:g,maxpoints:a.maxpoints||50,charts:[{yAxis:a.expressionY,yLabelOverride:h,func:a.functionY,color:d[0],type:a.chartType,extras:f}]}]}}else angular.isString(a.chartConfig)?a.chart=JSON.parse(b64_to_utf8(a.chartConfig)):a.chart=a.chartConfig;e()}})}(),this.setQuery=function(a,b){console.error("cannot use ods-chart-query when context and chartConfig are declared on ods-chart")}):(this.setQuery=function(c,d){var e,f,g=a.chart.queries.indexOf(c);-1===g?(g=a.chart.queries.length,a.chart.queries.push(c)):a.chart.queries[g]=c,c.sort&&(e=c.sort.match(/^(-?)serie([0-9]+)$/))&&(a.chart.queries[g].sort=e[1]+"serie"+(g+1)+"-"+e[2]);for(var h=!1,i=0;i<a.contexts.length;i++)a.contexts[i].name===d.name&&(h=!0);h||a.contexts.push(d);var j=b.getDatasetId(d);for(void 0===c.xAxis&&b.setDefaultQueryValues(j,c,!0),f=0;f<c.charts.length;f++)b.setSerieDefaultValues(j,c.charts[f],c.xAxis,!0);for(b.setDefaultQueryValues(j,c,!0),1===a.chart.queries.length&&b.setChartDefaultValues(j,a.chart,!0),f=0;f<c.charts.length;f++)b.setSerieDefaultColors(c.charts[f],c.seriesBreakdown)},a.$watch("labelX",function(b,c){a.chart.xLabel=b}))}]}}]),a.directive("odsChartQuery",["ODSAPI","ChartHelper",function(a,b){return{restrict:"E",require:["odsChartQuery","^odsChart"],controller:["$scope",function(a){}],compile:function(){return{pre:function(a,c,d,e){var f=e[0],g=e[1],h={config:{},charts:[],xAxis:d.fieldX,maxpoints:d.maxpoints?parseInt(d.maxpoints,10):void 0,timescale:d.timescale,stacked:d.stacked,seriesBreakdown:d.seriesBreakdown,seriesBreakdownTimescale:d.seriesBreakdownTimescale};h.sort="","y"===d.sort?h.sort="serie1":"-y"===d.sort?h.sort="-serie1":h.sort=d.sort;var i=d.options||{};angular.forEach(h,function(a,b){void 0===a&&delete h[b]}),f.setChart=function(a){-1===h.charts.indexOf(a)&&h.charts.push(a)};var j=function(a){a&&g.setQuery(h,a)};f.pushContext=function(a){g.pushContext(a)};var k=d.context;a[k].wait().then(function(c){b.init(a[k]),h.config.dataset=c.datasetid,h.config.domain=a[k].domain,h.config.apikey=a[k].apikey,h.config.options=angular.extend({},a[k].parameters,i),f.setChart=function(b){-1===h.charts.indexOf(b)&&h.charts.push(b),j(a[k])},j(a[k]),a.$watch(k+".parameters",function(b,c){b&&(h.config.options=angular.extend({},b,i),j(a[k]))},!0)})}}}}}]),a.directive("odsChartSerie",["ODSAPI","ChartHelper","$compile","$parse",function(a,b,c,d){return{restrict:"E",require:["^odsChartQuery","?refineOnClick","?refineOnClickContext"],controller:["$scope","$transclude",function(a,b){}],link:function(a,b,c,d){var e=d[0],f=d[1]||d[2],g={type:c.chartType||void 0,innersize:c.innersize||void 0,labelsposition:c.labelsposition||void 0,func:c.functionY||void 0,yAxis:c.expressionY||void 0,color:c.color||void 0,cumulative:!!c.cumulative||!1,yLabelOverride:angular.isDefined(c.labelY)?c.labelY:void 0,scale:c.logarithmic?"logarithmic":"",yRangeMin:angular.isDefined(c.min)&&""!==c.min?parseFloat(c.min):void 0,yRangeMax:angular.isDefined(c.max)&&""!==c.max?parseFloat(c.max):void 0,yStep:angular.isDefined(c.step)&&""!==c.step?parseFloat(c.step):void 0,displayUnits:"true"===c.displayUnits,displayValues:"true"===c.displayValues,displayStackValues:"true"===c.displayStackValues,multiplier:angular.isDefined(c.multiplier)?parseFloat(c.multiplier):void 0,thresholds:c.colorThresholds?a.$eval(c.colorThresholds):[],subsets:c.subsets,charts:c.subseries?JSON.parse(c.subseries):void 0,refineOnClickCtrl:f,scientificDisplay:"true"===c.scientificDisplay};angular.forEach(g,function(a,b){void 0===a&&delete g[b]}),e.setChart(g),c.$observe("labelY",function(a){g.yLabelOverride=a,e.setChart(g)})}}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsHubspotForm",function(){var a=[];return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-hubspot-form" id="{{uniqueId}}"></div>',scope:{portalId:"@",formId:"@"},link:function(b,c,d){b.uniqueId="hubspotform-"+Math.random().toString(36).substring(7);var e=function(){-1===a.indexOf(b.uniqueId)&&(a.push(b.uniqueId),hbspt.forms.create({portalId:d.portalId,formId:d.formId,target:"#"+b.uniqueId}))};angular.isUndefined(window.hbspt)?LazyLoad.js("//js.hsforms.net/forms/v2.js",e):e()}}})}(),function(){"use strict";angular.module("ods-widgets").directive("odsInfiniteScrollResults",function(){return{template:'<div class="{{listClass}} odswidget-infinite-scroll-results" infinite-scroll="loadMore()" infinite-scroll-distance="2" infinite-scroll-disabled="fetching">   <div class="{{resultClass}}" ng-repeat="item in results" inject>   </div>   <div class="odswidget-infinite-scroll-results__message-container">       <ods-spinner class="odswidget-infinite-scroll-results__spinner" ng-if="fetching"></ods-spinner>       <div class="odswidget-infinite-scroll-results__no-more-results-message" ng-if="!fetching && results.length > 0">{{ noMoreResultsMessage }}</div>       <div class="odswidget-infinite-scroll-results__no-results-message ng-cloak" ng-if="!fetching && results.length == 0 && context.getActiveFilters().length > 0"">{{ noResultsMessage }}</div>       <div class="odswidget-infinite-scroll-results__no-results-message ng-cloak" ng-if="!fetching && results.length == 0 && context.getActiveFilters().length == 0" ng-bind-html="noDataMessage"></div>   </div></div>',scope:{context:"=",resultClass:"@",listClass:"@",noMoreResultsMessage:"@",noResultsMessage:"@",noDataMessage:"@",scrollTopWhenRefresh:"="},transclude:!0,controller:["$scope","$window","$q","ODSAPI",function(a,b,c,d){var e=0,f=!1;a.fetching=!1,a.results=[];var g=c.defer(),h=function(b){if(!f){b?e=0:e+=1;var c=10*e;if(a.fetching=!0,"catalog"===a.context.type)d.datasets.search(a.context,{rows:10,start:c,extrametas:!0,interopmetas:!0}).success(function(a){f=0==a.datasets.length,i(a.datasets,b)});else{var h=angular.extend({},a.context.parameters,{rows:10,start:c});d.records.search(a.context,h).success(function(a){f=0==a.records.length,i(a.records,b),g.resolve()})}}},i=function(c,d){d&&(a.results=[]),a.results=a.results.concat(c),a.fetching=!1,d&&a.scrollTopWhenRefresh&&b.scrollTo(b.scrollX,0),d&&angular.element(b).trigger("scroll")};a.loadMore=function(){"dataset"===a.context.type?g.promise.then(function(){h(!1)}):h(!1)},a.$watch("context.parameters",function(a,b){a!==b&&(f=!1,h(!0))},!0),"dataset"===a.context.type?a.context.wait().then(function(){h(!0)}):h(!0)}]}})}(),function(){"use strict";angular.module("ods-widgets").directive("odsLastDatasetsFeed",["ODSAPI",function(a){return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-last-datasets-feed"><ul class="odswidget-last-datasets-feed__datasets">   <li class="no-data" ng-hide="datasets" translate>No data available yet</li>   <li class="odswidget-last-datasets-feed__dataset" ng-repeat="dataset in datasets" ng-if="datasets">       <ods-theme-picto class="odswidget-last-datasets-feed__theme-picto" theme="{{dataset.metas.theme|firstValue}}"></ods-theme-picto>       <div class="odswidget-last-datasets-feed__dataset-details">           <div class="odswidget-last-datasets-feed__dataset-details-title"><a ng-href="{{context.domainUrl}}/explore/dataset/{{dataset.datasetid}}/" target="_self">{{ dataset.metas.title }}</a></div>           <div class="odswidget-last-datasets-feed__dataset-details-modified"><i class="fa fa-calendar" aria-hidden="true"></i> <span title="{{ dataset.metas.modified|moment:\'LLL\' }}"><span translate>Modified</span> {{ dataset.metas.modified|timesince }}</span></div>       </div>   </li></ul></div>',scope:{context:"=",max:"@"},controller:["$scope",function(b){b.max=b.max||5;var c=function(){a.datasets.search(b.context,{rows:b.max,sort:"modified"}).success(function(a){b.datasets=a.datasets})};b.$watch("context",function(){c()})}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsLastReusesFeed",["ODSAPI",function(a){return{restrict:"E",replace:!0,transclude:!0,template:'<div class="odswidget odswidget-last-reuses-feed"><ul class="odswidget-last-reuses-feed__reuses">   <li class="no-data" ng-hide="reuses" translate>No data available yet</li>   <li class="odswidget-last-reuses-feed__reuse" ng-repeat="reuse in reuses" ng-if="reuses" inject>       <div class="odswidget-last-reuses-feed__reuse-thumbnail">           <span style="display: inline-block; height: 100%; vertical-align: middle;"></span>           <a ng-href="{{reuse.url}}" target="_self"><img class="odswidget-last-reuses-feed__reuse-thumbnail-image" ng-if="reuse.thumbnail" ng-src="{{ reuse.thumbnail }}"></a>       </div>       <div class="odswidget-last-reuses-feed__reuse-details">           <div class="odswidget-last-reuses-feed__reuse-details-title"><a ng-href="{{reuse.url}}" target="_self">{{ reuse.title }}</a></div>           <div class="odswidget-last-reuses-feed__reuse-details-dataset"><a ng-href="{{reuse.datasetUrl}}" target="_self">{{ reuse.dataset.title }}</a></div>           <div class="odswidget-last-reuses-feed__reuse-details-modified"><span title="{{ reuse.created_at|moment:\'LLL\' }}"><i class="fa fa-calendar" aria-hidden="true"></i> {{ reuse.created_at|timesince }}</span></div>       </div>   </li></ul></div>',scope:{context:"=",max:"@",externalLinks:"=?"},controller:["$scope",function(b){b.max=b.max||5;var c=function(){a.reuses(b.context,{rows:b.max}).success(function(a){angular.forEach(a.reuses,function(a){b.externalLinks||(a.url=b.context.domainUrl+"/explore/dataset/"+a.dataset.id+"/information/"),a.datasetUrl=b.context.domainUrl+"/explore/dataset/"+a.dataset.id+"/information/"}),b.reuses=a.reuses})};b.$watch("context",function(){c()})}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsMapDisplayControl",[function(){return{restrict:"E",template:'<div class="odswidget odswidget-map-display-control">   <ul class="odswidget-map-display-control__groups">       <li ng-repeat="group in mapConfig.groups"            ng-click="toggleGroup(group)"            ng-class="{\'odswidget-map-display-control__group\': true, \'odswidget-map-display-control__group--disabled\': !group.displayed}">           <div class="odswidget-map-display-control__group-title" ng-bind="group.title || group.layers[0].title || group.layers[0].context.dataset.metas.title"></div>           <div class="odswidget-map-display-control__group-description" ng-if="getGroupDescription(group)" ng-bind="getGroupDescription(group)"></p>       </li>   </ul></div>',scope:{mapConfig:"=",singleLayer:"="},controller:["$scope","shortSummaryFilter",function(a,b){a.getGroupDescription=function(a){return a.description||b(a.layers[0].description,200)||b(a.layers[0].context.dataset.metas.description,200)},a.toggleGroup=function(b){a.singleLayer?(a.mapConfig.groups.forEach(function(a){a.displayed=!1}),b.displayed=!0):b.displayed=!b.displayed}}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsMapLegacy",["ModuleLazyLoader",function(a){return{restrict:"E",scope:{context:"=",embedMode:"@",autoResize:"@",mapContext:"=?",location:"@",basemap:"@",isStatic:"@",showFilters:"@",itemClickContext:"=",colorBy:"@",colorByField:"@",colorByContext:"=",colorByAggregationKey:"@",colorByKey:"@",colorByExpression:"@",colorByFunction:"@",colorByRanges:"@",colorByRangesColors:"@"},replace:!0,template:function(a){return a.contents().wrapAll("<div>"),a.contents().length>0&&a.contents().html().trim().length>0&&(a.contents().wrapAll("<div>"),a.data("tooltip-template",a.children().html())),'<div class="odswidget odswidget-map"><div class="odswidget-map__map"></div><div class="odswidget-overlay map odswidget-overlay--opaque" ng-show="pendingRequests.length && initialLoading"><ods-spinner></ods-spinner></div></div>'},link:function(b,c){function d(){$(".odswidget-map__map").length>0&&$(".odswidget-map__map").height(Math.max(200,$(window).height()-$(".odswidget-map__map").offset().top))}angular.isUndefined(b.mapContext)&&(b.mapContext={},b.location&&(b.mapContext.location=b.location),b.basemap&&(b.mapContext.basemap=b.basemap)),"true"===b.autoResize&&($(window).on("resize",d),d()),a("leaflet").then(function(){L.Control.FilterByView=L.Control.extend({options:{position:"topright"},onAdd:function(a){var c="leaflet-control-filterview",d=c+" leaflet-bar leaflet-control",e=L.DomUtil.create("div",d),f=L.DomUtil.create("a","leaflet-bar-part",e);return f.href="#",b.mapViewFilter&&(e.className=d+" active"),L.DomEvent.on(f,"click",L.DomEvent.stopPropagation).on(f,"click",L.DomEvent.preventDefault).on(f,"click",function(){return b.$apply(function(a){a.mapViewFilter=!a.mapViewFilter}),b.mapViewFilter?e.className=d+" active":e.className=d,!1}).on(f,"dblclick",L.DomEvent.stopPropagation),b.$watch("mapViewFilter",function(a,b){a!==b&&(e.className=a?d+" active":d)}),e}}),b.initMap=function(a,d,e,f,g,h,i,j,k){var l={basemapsList:e,worldCopyJump:!0,minZoom:2,basemap:h,dragging:!i,zoomControl:!i,prependAttribution:j};i&&(l.doubleClickZoom=!1,l.scrollWheelZoom=!1);var m=new L.ODSMap(c.children()[0],l);if(m.addControl(new L.Control.Scale),g&&!i){var n=L.Control.geocoder({placeholder:f("Find a place..."),errorMessage:f("Nothing found."),geocoder:new L.Control.Geocoder.Nominatim({serviceUrl:"https://nominatim.openstreetmap.org/",geocodingQueryParams:{"accept-language":k||"en",polygon_geojson:!0}})});n.markGeocode=function(a){if(m.fitBounds(a.bbox),a.properties.geojson){var b=L.geoJson(a.properties.geojson,{style:function(){return{opacity:0,fillOpacity:.8,fillColor:"orange",className:"leaflet-geocoder-highlight"}}});m.addLayer(b),$timeout(function(){c.addClass("geocoder-highlight-on")},0),$timeout(function(){c.removeClass("geocoder-highlight-on"),m.removeLayer(b)},2500)}},m.addControl(n)}"true"!==d&&("true"===b.showFilters&&m.addControl(new L.Control.FilterByView),m.addControl(new L.Control.Fullscreen)),i||m.addControl(new L.Control.Locate({maxZoom:18})),m.on("popupclose",function(a){jQuery(a.popup.getContent()).trigger("popupclose")}),b.map=m}})},controller:["$scope","$http","$compile","$q","$filter","$element","translate","ODSAPI","DebugLogger","ODSWidgetsConfig","$attrs",function(a,b,c,d,e,f,g,h,i,j,k){i.log("init map"),a.pendingRequests=b.pendingRequests,a.initialLoading=!0,(a.itemClickMapField&&!a.itemClickContextField||!a.itemClickMapField&&a.itemClickContextField)&&console.log("ERROR: You need to configure both item-click-context-field and item-click-map-field.");var l,m=null,n=null,o={delimiter:",",accuracy:5,formatLatLng:function(a){var b=L.Util.formatNum(a.lat,this.accuracy),c=L.Util.formatNum(a.lng,this.accuracy);return new L.latLng(b,c)},getLocationParameterAsArray:function(a){return a.split(this.delimiter)},getLocationParameterFromMap:function(a){var b=this.formatLatLng(a.getCenter());return a.getZoom()+this.delimiter+b.lat+this.delimiter+b.lng},getCenterFromLocationParameter:function(a){var b=this.getLocationParameterAsArray(a);return new L.latLng(b[1],b[2])},getZoomFromLocationParameter:function(a){return this.getLocationParameterAsArray(a)[0]}},p=function(a,b){ODS.GeoFilter.addGeoFilterFromSpatialObject(a.parameters,b)},q=function(a,b,c,d){angular.isDefined(d.fields[b])&&(a.parameters["refine."+c]=d.fields[b])},r=function(b,c,d,e,f){if(c||d)if(f)a.$apply(function(){q(b,c,d,f)});else{var g={};ODS.GeoFilter.addGeoFilterFromSpatialObject(g,e),jQuery.extend(g,a.staticSearchOptions,a.context.parameters,{rows:1}),h.records.download(a.context,g).success(function(a){q(b,c,d,a[0])})}else a.$apply(function(){p(b,e)})},s=function(b,d,e,g){var h,i,j;if(a.itemClickContext)angular.isArray(a.itemClickContext)?angular.forEach(a.itemClickContext,function(a){i=k["itemClick"+ODS.StringUtils.capitalize(a.name)+"ContextField"],h=k["itemClick"+ODS.StringUtils.capitalize(a.name)+"MapField"],r(a,h,i,d,g)}):(j=a.itemClickContext,i=k["itemClick"+ODS.StringUtils.capitalize(j.name)+"ContextField"]||k.itemClickContextField,h=k["itemClick"+ODS.StringUtils.capitalize(j.name)+"MapField"]||k.itemClickMapField,r(j,h,i,d,g));else{var l=a.$new(!1);e?l.recordid=e:l.shape=d;var m={offset:[0,-30],maxWidth:250,minWidth:250,autoPanPaddingTopLeft:[50,305],autoPan:!a.mapViewFilter&&!a.staticMap},n=f.data("tooltip-template");!angular.isUndefined(n)&&angular.isString(n)&&""!==n.trim()||(n=a.context.dataset.extra_metas&&a.context.dataset.extra_metas.visualization&&a.context.dataset.extra_metas.visualization.map_tooltip_html?a.context.dataset.extra_metas.visualization.map_tooltip_html:""),l.template=n,new L.Popup(m).setLatLng(b).setContent(c('<ods-map-tooltip shape="shape" context="context" recordid="recordid" map="map" template="{{template}}"></ods-map-tooltip>')(l)[0]).openOn(a.map)}},t=function(a){return a=Math.round(100*a)/100,a=e("number")(a)},u=function(b){return function(c,d){if(c.count>1){var e=new L.ClusterMarker(c.cluster_center,{geojson:c.cluster,value:c.count,total:d,numberFormattingFunction:t,color:a.markerColor});a.staticMap||e.on("click",function(b){a.map.getZoom()===a.map.getMaxZoom()?s(marker.getLatLng(),c.cluster):a.$apply(function(){if(c.cluster)if("Point"===c.cluster.type)a.map.fitBounds([[c.cluster.coordinates[1],c.cluster.coordinates[0]],[c.cluster.coordinates[1],c.cluster.coordinates[0]]]);else{var d={},e=ODS.GeoFilter.getBoundsAsPolygonParameter(L.geoJson(c.cluster).getBounds());jQuery.extend(d,a.staticSearchOptions,a.context.parameters,{"geofilter.polygon":e}),h.records.boundingbox(a.context,d).success(function(b){a.map.fitBounds([[b.bbox[1],b.bbox[0]],[b.bbox[3],b.bbox[2]]])})}else a.map.setView(b.latlng,a.map.getZoom()+2)})}),b.addLayer(e)}else{var f=n(c.cluster_center);f.on("click",function(a){s(a.target.getLatLng(),c.cluster)}),b.addLayer(f)}}},v=function(b){var c={"geofilter.polygon":ODS.GeoFilter.getBoundsAsPolygonParameter(a.map.getBounds()),clusterprecision:a.map.getZoom(),clusterdistance:50,return_polygons:b};jQuery.extend(c,a.staticSearchOptions,a.context.parameters),a.currentClusterRequestCanceler&&a.currentClusterRequestCanceler.resolve(),a.currentClusterRequestCanceler=d.defer(),h.records.geo(a.context,c,a.currentClusterRequestCanceler.promise).success(function(b){var c=b.clusters;a.records=c?c.length:0;for(var d=new L.LayerGroup,e=u(d),f=0;f<c.length;f++)e(c[f],b.count.max);d.addTo(a.map),a.layerGroup&&a.map.removeLayer(a.layerGroup),a.layerGroup=d,a.initialLoading=!1,a.currentClusterRequestCanceler=null})},w=function(){var b={"geofilter.polygon":ODS.GeoFilter.getBoundsAsPolygonParameter(a.map.getBounds()),clusterprecision:a.map.getZoom()};jQuery.extend(b,a.staticSearchOptions,a.context.parameters),b.rows=1e3,a.currentClusterRequestCanceler&&a.currentClusterRequestCanceler.resolve(),a.currentClusterRequestCanceler=d.defer(),h.records.geopreview(a.context,b,a.currentClusterRequestCanceler.promise).success(function(b){for(var c=new L.LayerGroup,d=0;d<b.length;d++)x(c,b[d]);c.addTo(a.map),a.layerGroup&&a.map.removeLayer(a.layerGroup),a.layerGroup=c,a.initialLoading=!1,a.currentClusterRequestCanceler=null})},x=function(a,b){var c={radius:3,fillColor:"#0033ff",color:"#0000ff",weight:1,opacity:1,fillOpacity:.5},d=new L.GeoJSON(b.geometry,{pointToLayer:function(a,b){return L.circleMarker(b,c)}});a.addLayer(d),d.on("click",function(a){s(a.latlng,b.geometry,b.id)})},y=function(a){var b;for(b=0;b<l.ranges.length;b++)if(a<l.ranges[b])return l.colors[b];return l.colors[l.colors.length-1]},z=function(){var b=angular.extend({},l.context.parameters,{"join.geo.remotedataset":a.context.dataset.datasetid,"join.geo.localkey":l.localkey,"join.geo.remotekey":l.remotekey,"y.agg.expr":l.expr,"y.agg.func":l.func}),c=new L.LayerGroup,d=new L.LatLngBounds,e=new L.FeatureGroup;h.records.analyze(l.context,b).success(function(b){angular.forEach(b,function(a){var b=a.x,f=a.agg;angular.forEach(b,function(a){B(a,c,d,e,y(f))})}),a.layerGroup&&a.map.removeLayer(a.layerGroup),c.addLayer(e),c.addTo(a.map),a.layerGroup=c,a.initialLoading=!1})},A=function(){var b={};b["geofilter.polygon"]=ODS.GeoFilter.getBoundsAsPolygonParameter(a.map.getBounds()),jQuery.extend(b,a.staticSearchOptions,a.context.parameters),i.log("map -> download"),h.records.download(a.context,b).success(function(b,c,d,e){a.records=b,a.error="",a.nhits=b.length;for(var f=new L.LayerGroup,g=new L.LatLngBounds,h=new L.FeatureGroup,i=0;i<b.length;i++){var j=b[i];B(j,f,g,h)}a.layerGroup&&a.map.removeLayer(a.layerGroup),f.addLayer(h),f.addTo(a.map),a.layerGroup=f,a.initialLoading=!1}).error(function(b,c,d,e){a.error=b.error,a.initialLoading=!1})},B=function(b,c,d,e,f){var g,h=f;if("value"===a.colorBy){var i=b.fields[l.field];i&&(h=y(i))}if(m){if(!b.fields[m])return;g=b.fields[m],"Point"===g.type&&angular.isDefined(b.geometry)&&(g=b.geometry)}else{if(!b.geometry)return;g=b.geometry}if("Point"==g.type){var j=new L.LatLng(g.coordinates[1],g.coordinates[0]),k=n(j,h);k.on("click",function(a){s(a.target.getLatLng(),g,null,b)}),e.addLayer(k),d.extend(j)}else{var o;o=h?new L.GeoJSON(g,{style:function(a){var b={radius:3,weight:1,opacity:.9,fillOpacity:.5,color:h};return b.fillColor=h,"LineString"===a.geometry.type||"MultiLineString"===a.geometry.type?(b.weight=5,b.color=h):b.color="#fff",b}}):new L.GeoJSON(g),o.on("click",function(a){s(L.latLng(b.geometry.coordinates[1],b.geometry.coordinates[0]),g,b.recordid,b)}),c.addLayer(o),d.extend(o.getBounds())}};a.$watch("context.parameters",function(b,c){if(b!==c&&!a.initialLoading)return i.log("map -> searchOptions watch -> refresh records"),!b["geofilter.polygon"]&&c["geofilter.polygon"]?void(a.mapViewFilter=!1):!c["geofilter.polygon"]&&b["geofilter.polygon"]?void(a.mapViewFilter=!0):void C(!a.mapViewFilter)},!0),"aggregation"===a.colorBy&&a.$watch("colorByContext.parameters",function(){a.map&&C(!1)},!0),a.$watch("mapContext.location",function(){a.map&&C(!1)},!0);var C=function(b){var c=200,d=5e5,e=5e5,f=function(b){"aggregation"===a.colorBy?z():"value"===a.colorBy||b.count<c||a.map.getZoom()===a.map.getMaxZoom()?A():b.count<d?b.geometries.Point&&b.geometries.Point>b.count/2?v(b.count<=e):w():v(b.count<=e)},g={without_bbox:!b};b||(g["geofilter.polygon"]=ODS.GeoFilter.getBoundsAsPolygonParameter(a.map.getBounds())),jQuery.extend(g,a.staticSearchOptions,a.context.parameters),h.records.boundingbox(a.context,g).success(function(c){if(b)if(c.bbox.length>0){var d=a.map.getBounds();a.map.fitBounds([[c.bbox[1],c.bbox[0]],[c.bbox[3],c.bbox[2]]]);var e=a.map.getBounds();angular.equals(d,e)&&f(c)}else f(c);else f(c)})},D=function(b){var c=b.getSize();c.x>0&&c.y>0&&(a.mapContext.location=o.getLocationParameterFromMap(b),a.mapViewFilter&&(a.context.parameters["geofilter.polygon"]=ODS.GeoFilter.getBoundsAsPolygonParameter(b.getBounds())))},E=a.$watch("[context.dataset, colorByContext.dataset]",function(b,c){if(b[0]&&b[0].datasetid&&("aggregation"!==a.colorBy||b[1]&&b[1].datasetid)){"aggregation"===a.colorBy?l={context:a.colorByContext,localkey:a.colorByAggregationKey||a.colorByKey,remotekey:a.colorByKey,expr:a.colorByExpression,func:a.colorByFunction,ranges:a.colorByRanges.split(","),colors:a.colorByRangesColors.split(",")}:"value"===a.colorBy&&(l={field:a.colorByField,ranges:a.colorByRanges.split(","),colors:a.colorByRangesColors.split(",")}),b=b[0],a.context.parameters["geofilter.polygon"]?a.mapViewFilter=!0:a.mapViewFilter=!1,a.staticMap="true"===a.isStatic||"true"===a.context.parameters.static;var e=a.$watch("initMap",function(){a.initMap&&(e(),a.initMap(b,a.embedMode,j.basemaps,g,j.mapGeobox,a.mapContext.basemap,a.staticMap,j.mapPrependAttribution,j.language))});E(),a.staticSearchOptions={rows:a.recordLimit,dataset:a.context.dataset.datasetid,format:"json"};for(var f=0;f<b.fields.length;f++){var k=b.fields[f];if("geo_shape"===k.type){m=k.name;break}}var p={};b.extra_metas&&b.extra_metas.visualization&&(p=b.extra_metas.visualization),a.markerColor=p.map_marker_color||"#29398C",n=function(b,c){return new L.VectorMarker(b,{color:c||a.markerColor,icon:angular.element('<div><?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="19px" height="19px" viewBox="0 0 19 19" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">    <path d="M18,9.50004182 C18,14.1944851 14.1944015,18.0000836 9.49995818,18.0000836 C4.80551469,18.0000836 0.99991635,14.1944851 0.99991635,9.50004182 C0.99991635,4.80559834 4.80551469,1 9.49995818,1 C14.1944015,1 18,4.80559834 18,9.50004182 L18,9.50004182 Z" id="path8568" fill="#000000"></path>    <rect style="opacity: 0" x="0" y="0" width="19" height="19"></rect></svg></div>'),size:4,marker:!p.map_marker_hidemarkershape})},i.log("map -> dataset watch -> refresh records");var q=a.$watch("map",function(b,c){if(b){a.$watch("mapViewFilter",function(b,c){b!==c&&(b?a.context.parameters["geofilter.polygon"]=ODS.GeoFilter.getBoundsAsPolygonParameter(a.map.getBounds()):a.context.parameters["geofilter.polygon"]&&delete a.context.parameters["geofilter.polygon"])});var e=function(b){var c=d.defer();if(a.context.parameters.mapviewport)"("===a.context.parameters.mapviewport.substring(0,1)&&(a.context.parameters.mapviewport=ODS.GeoFilter.getBoundsAsBboxParameter(ODS.GeoFilter.getPolygonParameterAsBounds(a.context.parameters.mapviewport))),c.resolve(ODS.GeoFilter.getBboxParameterAsBounds(a.context.parameters.mapviewport));else if(a.context.parameters["geofilter.polygon"])c.resolve(ODS.GeoFilter.getPolygonParameterAsBounds(a.context.parameters["geofilter.polygon"]));else{var e={};jQuery.extend(e,a.staticSearchOptions,a.context.parameters),h.records.boundingbox(a.context,e).success(function(a){a.count>0?c.resolve([[a.bbox[1],a.bbox[0]],[a.bbox[3],a.bbox[2]]]):c.resolve([[-60,-180],[80,180]])})}return c.promise};(function(){var c=d.defer();if(a.mapContext.location){i.log("Location found");var f=o.getCenterFromLocationParameter(a.mapContext.location),g=o.getZoomFromLocationParameter(a.mapContext.location);i.log(f,g),b.setView(f,g),C(!1),c.resolve()}else i.log("Use boundsRetrieval"),e(a.context.dataset).then(function(d){a.context.parameters.mapviewport&&(i.log("Deleted mapviewport"),delete a.context.parameters.mapviewport),i.log(d),b.fitBounds(d),c.resolve()});return c.promise})().then(function(){i.log("First onViewportMove"),D(a.map),a.map.on("moveend",function(b){D(b.target),a.$$phase||a.$root.$$phase||a.$apply()})}),j.basemaps.length>1&&a.map.on("baselayerchange",function(b){a.mapContext.basemap=b.layer.basemapId,a.$$phase||a.$root.$$phase||a.$apply()}),q()}})}},!0)}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsMapLegend",[function(){return{restrict:"E",template:'<div class="odswidget odswidget-map-legend" ng-class="{\'odswidget-map-legend--extended\': extended}" ng-if="layers.length > 0">   <div class="odswidget-map-legend__header">       <div class="odswidget-map-legend__title" ng-class="{\'odswidget-map-legend__title--toggleable\': getCategoriesCount(selectedLayer) > 6}" ng-click="toggle()">           {{ selectedLayer.config.captionTitle || selectedLayer.config.title || selectedLayer.config.context.dataset.metas.title}}           <i ng-show="getCategoriesCount(selectedLayer) > 6 && !extended" class="odswidget-map-legend__title-toggle odsui-top"></i>           <i ng-show="getCategoriesCount(selectedLayer) > 6 && extended" class="odswidget-map-legend__title-toggle odsui-bottom"></i>       </div>       <div ng-show="selectedLayer.properties.legendLabel" ng-bind="selectedLayer.properties.legendLabel" class="odswidget-map-legend__label">       </div>   </div>   <div ng-switch="selectedLayer.config.display">       <div ng-switch-when="categories" class="odswidget-map-legend__categories-container">           <div ng-if="getCategoriesCount(selectedLayer) > 6 && !extended" class="odswidget-map-legend__categories--condensed">              <div ng-repeat="(value, color) in getCategories(selectedLayer, 6)" class="odswidget-map-legend__categories--condensed__item">                  <div style="background-color: {{color}}" class="odswidget-map-legend__categories__color-block"></div>              </div>           </div>           <div ng-if="getCategoriesCount(selectedLayer) <= 6 || extended" class="odswidget-map-legend__categories--extended">               <div ng-repeat="(value, color) in getCategories(selectedLayer)" class="odswidget-map-legend__categories--extended__item">                   <div class="odswidget-map-legend__categories--extended__item-color">                       <div style="background-color: {{color}}" class="odswidget-map-legend__categories__color-block"></div>                   </div>                   <div class="odswidget-map-legend__categories--extended__item-value" ng-bind="value"></div>               </div>               <div ng-show="selectedLayer.config.color.otherCategories" class="odswidget-map-legend__categories--extended__item">                   <div class="odswidget-map-legend__categories--extended__item-color">                       <div style="background-color: {{selectedLayer.config.color.otherCategories}}" class="odswidget-map-legend__categories__color-block"></div>                   </div>                   <div class="odswidget-map-legend__categories--extended__item-value--others">Others</div>               </div>           </div>       </div>       <div ng-switch-when="choropleth" class="odswidget-map-legend__choropleth-container">           <div ng-repeat="bound in selectedLayer.properties.bounds" class="odswidget-map-legend__choropleth__item">               <div class="odswidget-map-legend__choropleth__item-color">                   <div style="background-color: {{ bound.color }}" class="odswidget-map-legend__choropleth__color-block"></div>               </div>               <div class="odswidget-map-legend__choropleth__item-range">                   <div class="odswidget-map-legend__choropleth__item-range__bound">                       {{ bound.lowerBound|number:selectedLayer.properties.floatLength }}                       <i aria-hidden="true" class="fa fa-long-arrow-right odswidget-map-legend__choropleth__item-range__bound-arrow"></i>                   </div>                   <div class="odswidget-map-legend__choropleth__item-range__bound">                       {{ bound.upperBound|number:selectedLayer.properties.floatLength }}                   </div>               </div>           </div>       </div>       <div ng-switch-when="heatmap" class="odswidget-map-legend__simple-container">           <div><span translate ng-bind="layer.func"></div>            <div style="background: {{selectedLayer.properties.gradient}}" class="odswidget-map-legend__simple__color-block"></div>           <div class="odswidget-map-legend__simple__color-block-subtext">               <div class="odswidget-map-legend__simple__color-block-subtext-left" translate>Low</div>               <div class="odswidget-map-legend__simple__color-block-subtext-right" translate>High</div>           </div>       </div>       <div ng-switch-default class="odswidget-map-legend__simple-container">           <div style="background-color: {{selectedLayer.config.color}}" class="odswidget-map-legend__simple__color-block"></div>       </div>   </div>   <div ng-if="layers.length > 1" class="odswidget-map-legend__pagination">       <button title="Previous" translate="title" class="odswidget-map-legend__pagination-button" ng-show="selectedIndex > 0" ng-click="previous()">           <i class="odsui-left" aria-hidden="true"></i>       </button>       {{selectedIndex+1}}/{{layers.length}}       <button title="Next" translate="title" class="odswidget-map-legend__pagination-button" ng-show="selectedIndex < layers.length - 1" ng-click="next()">           <i class="odsui-right"aria-hidden="true"></i>       </button>   </div></div>',scope:{mapConfig:"="},controller:["$scope","MapHelper",function(a,b){a.extended=!1,a.selectedLayer=null,a.selectedIndex=0,a.toggle=function(){if(a.getCategoriesCount(a.selectedLayer)<=6)return void(a.extended=!1);a.extended=!a.extended},a.select=function(b){a.selectedLayer=a.layers[b],a.getCategoriesCount(a.selectedLayer)<=6&&a.extended&&a.toggle()},a.previous=function(){a.selectedIndex-=1,a.select(a.selectedIndex)},a.next=function(){a.selectedIndex+=1,a.select(a.selectedIndex)},a.getCategoriesCount=function(a){if(angular.isUndefined(a.config.color.categories))return 1;var b=Object.keys(a.config.color.categories).length;return a.config.otherCategories&&(b+=1),b},a.getCategories=function(a,b){if(b){var c,d={},e=Object.keys(a.config.color.categories).sort(ODS.ArrayUtils.sortNumbers);for(c=0;c<Math.min(b,e.length);c++){var f=e[c];d[f]=a.config.color.categories[f]}return d}return a.config.color.categories};var c=function(a){var b,c=0;return angular.forEach(a,function(a){angular.forEach(a,function(a,d){"color"!==d&&Math.floor(a)!==a&&(b=a.toString().split(".")[1].length)>c&&(c=b)})}),c>3&&(c=3),c},d=function(a,b,c){return 0!==c?(angular.forEach(b,function(d){d.lowerBound=e(b,a,d.lowerBound,c),d.upperBound=e(b,a,d.upperBound,c,!0)}),b):b},e=function(a,b,c,d,e){c=c.toString();var g;return c===b?c:e&&Math.floor(c)!=c?f(c,d):0===d||Math.floor(c)==c||e?c:(g=c.length-c.split(".")[1].length,c=f(c,d),c=(Number(c.replace(".",""))+1).toString(),g=c.length-(c.length-g)-1,c=[c.slice(0,g),".",c.slice(g)].join(""))},f=function(a,b){var c=a.length-a.split(".")[1].length;return a.split(".")[1].length<b?a+="0".repeat(b-a.split(".")[1].length):a=a.slice(0,c+b),a},g=function(){var e=[];a.mapConfig.groups.forEach(function(a){a.displayed&&a.layers.forEach(function(a){if(a.caption&&(angular.isString(a.color)||"field"!==a.color.type)){var f={};if(e.push({config:a,properties:f}),f.legendLabel=b.getLayerLegendLabel(a),"choropleth"===a.display){var g;b.getDatasetFieldBoundMin(a.context,a.color.field).then(function(e){g=e;var h=Object.keys(a.color.ranges).map(b.boundAsNumber).sort(ODS.ArrayUtils.sortNumbers),i=[];h.forEach(function(c,d){var e=!0;c=b.boundAsNumber(c),angular.forEach(a.color.ranges,function(a,b){c==b&&e&&(0===d?i.push({color:a,lowerBound:g,upperBound:c}):i.push({color:a,lowerBound:h[d-1],upperBound:c}),e=!1)})}),f.floatLength=c(i),i=d(g,i,f.floatLength),f.bounds=i})}else if("heatmap"===a.display){var h=Object.keys(a.color.steps).map(parseFloat).sort(ODS.ArrayUtils.sortNumbers),i=h.map(function(b){return a.color.steps[b]}),j="linear-gradient(to right, "+i.join(",")+")";f.gradient=j}}})}),a.layers=e,0===a.layers.length?(a.selectedIndex=0,a.selectedLayer=null):-1===a.layers.indexOf(a.selectedLayer)&&(a.selectedIndex=0,a.select(0)),null===a.selectedLayer&&e.length>0&&(a.selectedIndex=0,a.select(0))};g(),a.$watchCollection(function(){return a.mapConfig.groups.map(function(a){return a.displayed})},function(b,c){if(angular.isDefined(b)&&angular.isDefined(c)&&!angular.equals(b,c)){var d=null;if(a.selectedLayer&&(d=a.selectedLayer.config._runtimeId),g(),a.layers.length){var e=0;d&&a.layers.forEach(function(b){b.config._runtimeId===d&&(a.selectedIndex=e,a.select(a.selectedIndex)),e++})}}})}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsMapSearchBox",["AlgoliaPlaces","MapHelper",function(a,b){return{restrict:"E",template:'<div class="odswidget odswidget-map-search-box" ng-class="{\'odswidget-map-search-box--datasearch\': dataSearchActive}">   <div class="odswidget-map-search-box__box-wrapper"        ng-class="{\'odswidget-map-search-box__box-wrapper--datasearch\': dataSearchActive}">       <input type="text"               class="odswidget-map-search-box__box"              ng-class="{\'odswidget-map-search-box__box--datasearch\': dataSearchActive}"              ng-model="userQuery"               ng-change="runQuery(userQuery)"               ng-keydown="handleKeyDown($event)">       <button type="button" class="odswidget-map-search-box__box-cancel" ng-click="resetSearch()" ng-show="userQuery || dataSearchActive">           <i class="fa fa-times odswidget-map-search-box__close-search-icon"></i>       </button>   </div>   <ul class="odswidget-map-search-box__suggestions" ng-if="!dataSearchActive && userQuery">       <li ng-show="userQuery"           ng-click="runDataSearch(userQuery)"           ng-class="[\'odswidget-map-search-box__search-suggestion\', {\'odswidget-map-search-box__search-suggestion--selected\': selectedIndex === 0}]">           <i class="fa fa-search"></i> Search {{userQuery}} in displayed data       </li>       <li ng-repeat="suggestion in suggestions"            ng-click="moveToSuggestion(suggestion, $index + 1)"           ng-class="[\'odswidget-map-search-box__suggestion\', {\'odswidget-map-search-box__suggestion--selected\': selectedIndex === $index + 1}]">           <i ng-class="[\'odswidget-map-search-box__suggestion-icon\', getSuggestionIcon(suggestion)]"></i>           <span class="odswidget-map-search-box__suggestion-name" ng-bind-html="suggestion._highlightResult.locale_names[0].value"></span>           <span class="odswidget-map-search-box__suggestion-localization" ng-bind-html="getLocalization(suggestion)"></span>       </li>   </ul>   <div class="odswidget-map-search-box__data-search" ng-if="dataSearchActive">       <ods-spinner ng-if="dataSearchWorking"></ods-spinner>       <ul ng-if="!dataSearchWorking && datasetSearchDatasetsCount > 1" class="odswidget-map-search-box__data-search__datasets">           <li ng-repeat="result in dataSearchResults"                ng-click="selectResult(result)"               class="odswidget-map-search-box__data-search__dataset"               ng-class="{\'odswidget-map-search-box__data-search__dataset--active\': selectedResult === result}">               <div class="odswidget-map-search-box__data-search__dataset-title" ng-bind="::result.context.dataset.metas.title"></div>               <div class="odswidget-map-search-box__data-search__dataset-count">                   {{result.nhits}} items               </div>           </li>       </ul>       <ul ng-if="!dataSearchWorking && datasetSearchDatasetsCount > 0" class="odswidget-map-search-box__data-search__results">           <li ng-repeat="record in currentResults"                class="odswidget-map-search-box__data-search__result"               ods-tooltip               ods-tooltip-template="getResultPreviewTemplate(selectedResult.context.dataset, record)"               ng-click="moveToDataRecord(selectedResult.context.dataset, record)">               <i class="fa fa-map-marker odswidget-map-search-box__data-search__result-icon"></i>               <span class="odswidget-map-search-box__data-search__result-empty" ng-if="getResultTitle(selectedResult.context.dataset, record) === null" translate>Empty</span>               <span ng-if="getResultTitle(selectedResult.context.dataset, record) !== null">{{getResultTitle(selectedResult.context.dataset, record)}}</span>           </li>       </ul>       <div class="odswidget-map-search-box__data-search__no-results" ng-if="!dataSearchWorking && datasetSearchDatasetsCount === 0">           No results found for your search       </div>       <div class="odswidget-map-search-box__data-search__pagination" ng-if="!dataSearchWorking && datasetSearchDatasetsCount > 0">           <div class="odswidget-map-search-box__data-search__pagination-counter">               {{ selectedResult.nhits }} results           </div>           <div class="odswidget-map-search-box__data-search__pagination-pages">               {{currentResultsStartIndex+1}}               -               {{selectedResult.nhits|min:(currentResultsStartIndex+11)}}               <button type="button"                        ng-click="previousResultPage()"                        ng-disabled="currentResultsStartIndex === 0"                       class="odswidget-map-search-box__data-search__pagination-button">                   <i class="fa fa-chevron-left"></i>               </button>               <button type="button"                        ng-click="nextResultPage()"                        ng-disabled="currentResultsStartIndex+10 >= selectedResult.nhits"                       class="odswidget-map-search-box__data-search__pagination-button">                   <i class="fa fa-chevron-right"></i>               </button>           </div>       </div>   </div></div>',require:"^odsMap",scope:{},link:function(c,d,e,f){c.suggestions=[],c.selectedIndex=0,c.runQuery=function(d){var e=b.getLocationStructure(f.getCurrentPosition());a(d,e.center.join(",")).then(function(a){c.selectedIndex=0,c.suggestions=a.data.hits},function(a){})},c.resetSearch=function(){f.resetMapDataFilter()},f.registerResetCallback(function(){c.suggestions=[],c.userQuery="",c.stopDataSearch()}),c.$on("$destroy",c.resetSearch),c.moveToSuggestion=function(a,b){angular.isDefined(b)&&(c.selectedIndex=b);var d;d=a.is_city?14:a.is_country?5:a.is_highway?18:21,f.moveMap(a._geoloc,d)},c.moveToDataRecord=function(a,b){var c,d,e=a.getFieldsForType("geo_shape");e.length?(c=e[0].name,d=!0):(c=a.getFieldsForType("geo_point_2d")[0].name,d=!1),d?console.log("TODO move to data record for shapes"):f.moveMap(b.fields[c],21)},c.runDataSearch=function(a){f.applyMapDataFilter(a),c.startDataSearch(a,f.getActiveContexts())}},controller:["$scope","$q","$compile","ODSAPI",function(a,b,c,d){var e={RETURNKEY:13,ESCAPE:27,UPARROW:38,DOWNARROW:40};a.handleKeyDown=function(b){switch(b.keyCode){case e.UPARROW:a.selectedIndex=Math.max(0,a.selectedIndex-1),b.preventDefault();break;case e.DOWNARROW:a.selectedIndex=Math.min(a.suggestions.length,a.selectedIndex+1),b.preventDefault();break;case e.ESCAPE:a.resetSearch(),b.preventDefault();break;case e.RETURNKEY:0===a.selectedIndex?a.runDataSearch(a.userQuery):a.moveToSuggestion(a.suggestions[a.selectedIndex-1]),b.preventDefault()}},a.dataSearchActive=!1,a.dataSearchWorking=!1;var f;a.startDataSearch=function(c,e){a.currentResults=[],a.dataSearchActive=!0,a.dataSearchWorking=!0;var g=e.slice(0);a.dataSearchResults=g.map(function(a){return{context:a}}).sort(function(a,b){return a.context.dataset.metas.title>b.context.dataset.metas.title});var h=[];angular.isArray(f)&&f.forEach(function(a){a.resolve()}),f=[],a.dataSearchResults.forEach(function(a){var c=a.context,e=b.defer(),f=angular.extend({},c.parameters,{rows:0}),g=d.records.search(c,f,e.promise).then(function(b){var c=b.data;c.parameters.dataset;a.nhits=c.nhits});h.push(g)}),b.all(h).then(function(b){a.dataSearchWorking=!1,a.dataSearchResults=a.dataSearchResults.filter(function(a){return a.nhits>0}),a.datasetSearchDatasetsCount=Object.keys(a.dataSearchResults).length,a.dataSearchResults.length&&a.selectResult(a.dataSearchResults[0])})};var g=null;a.currentResultsStartIndex=0,a.selectResult=function(b){a.selectedResult=b,a.currentResultsStartIndex=0,h(b)};var h=function(c){g&&g.resolve(),g=b.defer();var e=angular.extend({},c.context.parameters,{rows:10,start:a.currentResultsStartIndex});d.records.search(c.context,e,g.promise).then(function(b){g=null,a.currentResults=b.data.records})};a.previousResultPage=function(){a.currentResultsStartIndex-=10,h(a.selectedResult)},a.nextResultPage=function(){a.currentResultsStartIndex+=10,h(a.selectedResult)},a.stopDataSearch=function(){angular.isArray(f)&&f.forEach(function(a){a.resolve()}),f=[],a.dataSearchActive=!1,a.dataSearchWorking=!1},a.getSuggestionIcon=function(a){return a._tags.indexOf("railway")>=0?"fa fa-train":a._tags.indexOf("aeroway")>=0?"fa fa-plane":"fa fa-map-marker"},a.getLocalization=function(a){var b="";return["city","administrative","country"].forEach(function(c){angular.isDefined(a[c])&&(b.length>0&&(b+=", "),b+=a[c])}),b},a.getResultTitle=function(a,b){var c=a.getExtraMeta("explore","map_tooltip_title");if(c&&angular.isDefined(b.fields[c]))return b.fields[c];var d=a.getFieldsForType("text");if(d.length>0&&angular.isDefined(b.fields[d[0].name]))return b.fields[d[0].name];var e;for(e=0;e<a.fields.length;e++)if(angular.isDefined(b.fields[a.fields[e]]))return b.fields[a.fields[e]];return null},a.getResultPreviewTemplate=function(b,d){var e=[];b.fields.forEach(function(a){e.length<3&&["text","int","double","date","datetime"].indexOf(a.type)>=0&&angular.isDefined(d.fields[a.name])&&e.push({label:a.label,value:d.fields[a.name]})});var f=a.$new(!0);f.items=e;var g=c('<ul class="odswidget-map-search-box__data-search__result-preview">   <li ng-repeat="item in items" class="odswidget-map-search-box__data-search__result-preview-line">       <div class="odswidget-map-search-box__data-search__result-preview-label">{{item.label}}</div>       <div class="odswidget-map-search-box__data-search__result-preview-value">{{item.value}}</div>   </li></ul>')(f);return f.$apply(),g.html()}}]}}]),a.service("AlgoliaPlaces",["$http","ODSWidgetsConfig",function(a,b){var c={};return b.algoliaPlacesApplicationId&&(c.headers={"X-Algolia-Application-Id":b.algoliaPlacesApplicationId,"X-Algolia-API-Key":b.algoliaPlacesAPIKey}),function(d,e){var f=angular.extend({},c);return f.params={query:d,aroundLatLngViaIP:!1,language:b.language||"en",hitsPerPage:5},e&&(f.params.aroundLatLng=e),a.get("https://places-dsn.algolia.net/1/places/query",f)}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsMapTooltip",["$compile","$templateCache",function(a,b){return{restrict:"E",transclude:!0,template:'<div class="odswidget-map-tooltip">   <ods-spinner class="odswidget-map-tooltip__spinner" ng-hide="records"></ods-spinner>   <h2 ng-show="records.length > 1" class="odswidget-map-tooltip__scroll-control ng-leaflet-tooltip-cloak">       <i class="odswidget-map-tooltip__scroll-left fa fa-chevron-left" ng-click="moveIndex(-1)"></i>       <span ng-bind="(selectedIndex+1)+\'/\'+records.length" ng-click="moveIndex(1)"></span>       <i class="odswidget-map-tooltip__scroll-right fa fa-chevron-right" ng-click="moveIndex(1)"></i>   </h2>   <div class="ng-leaflet-tooltip-cloak odswidget-map-tooltip__limited-results-warning" ng-show="records && records.length == RECORD_LIMIT" translate>(limited to the first {{RECORD_LIMIT}} records)</div>   <div ng-repeat="record in records" ng-if="$index == selectedIndex" class="odswidget-map-tooltip__record">       <div ng-if="!template" ng-include src="\'default-tooltip\'"></div>       <div ng-if="template" ng-include src="\'custom-tooltip-\'+context.dataset.datasetid"></div>   </div></div>',scope:{shape:"=",context:"=",recordid:"=",map:"=",template:"@",gridData:"=",geoDigest:"@",tooltipSort:"@"},replace:!0,link:function(a,c,d){var e=function(b){b.popup._content===c[0]&&(a.selectedShapeLayer&&a.map.removeLayer(a.selectedShapeLayer),a.map.off("popupclose",e),a.$destroy())};a.map.on("popupclose",e),a.unCloak=function(){jQuery(".ng-leaflet-tooltip-cloak",c).removeClass("ng-leaflet-tooltip-cloak")},d.template&&""!==d.template?b.put("custom-tooltip-"+a.context.dataset.datasetid,d.template):b.put("default-tooltip",'<div class="infoPaneLayout"><h2 class="odswidget-map-tooltip__header" ng-show="!!getTitle(record)" ng-bind="getTitle(record)"></h2><dl class="odswidget-map-tooltip__record-values">    <dt ng-repeat-start="field in context.dataset.fields|fieldsForVisualization:\'map\'|fieldsFilter:context.dataset.extra_metas.visualization.map_tooltip_fields"         ng-show="record.fields[field.name]|isDefined"        class="odswidget-map-tooltip__field-name">        {{ field.label }}    </dt>    <dd ng-repeat-end         ng-switch="field.type"         ng-show="record.fields[field.name]|isDefined"        class="odswidget-map-tooltip__field-value">        <span ng-switch-when="geo_point_2d">            <ods-geotooltip width="300" height="300" coords="record.fields[field.name]">{{ record.fields|formatFieldValue:field }}</ods-geotooltip>        </span>        <span ng-switch-when="geo_shape">            <ods-geotooltip width="300" height="300" geojson="record.fields[field.name]">{{ record.fields|formatFieldValue:field }}</ods-geotooltip>        </span>        <span ng-switch-when="file">            <div ng-if="!context.dataset.isFieldAnnotated(field, \'has_thumbnails\')" ng-bind-html="record.fields|formatFieldValue:field"></div>            <div ng-if="context.dataset.isFieldAnnotated(field, \'has_thumbnails\')" ng-bind-html="record.fields[field.name]|displayImageValue:context.dataset.datasetid" style="text-align: center;"></div>        </span>        <span ng-switch-default title="{{record.fields|formatFieldValue:field}}" ng-bind-html="record.fields|formatFieldValue:field|imagify|videoify|prettyText|nofollow"></span>    </dd></dl></div>')},controller:["$scope","$filter","ODSAPI",function(a,b,c){a.RECORD_LIMIT=100,a.records=[],a.selectedIndex=0;var d=a.tooltipSort;!d&&a.context.dataset.getExtraMeta("visualization","map_tooltip_sort_field")&&(d=(a.context.dataset.getExtraMeta("visualization","map_tooltip_sort_direction")||"")+a.context.dataset.getExtraMeta("visualization","map_tooltip_sort_field")),a.moveIndex=function(b){var c=(a.selectedIndex+b)%a.records.length;c<0&&(c=a.records.length+c),a.selectedIndex=c};var e=function(){function b(b){if(b.length>0){a.selectedIndex=0,a.records=b,a.unCloak();var c,d=a.context.dataset.getFieldsForType("geo_shape");if(d.length&&(c=d[0].name),c&&a.gridData&&("Polygon"===a.gridData["ods:geo_type"]||"LineString"===a.gridData["ods:geo_type"]||"MultiPolygon"===a.gridData["ods:geo_type"]||"MultiLineString"===a.gridData["ods:geo_type"])){var e=b[0];if(e.fields[c]){var f=e.fields[c];"Point"!==f.type&&(a.selectedShapeLayer=L.geoJson(f,{fill:!1,color:"#CC0000",opacity:1,dashArray:[5],weight:2}),a.map.addLayer(a.selectedShapeLayer))}}}else a.map.closePopup()}var e={format:"json",rows:a.RECORD_LIMIT},f=null;a.shape&&(f=a.shape.type),a.recordid&&"Point"!==f?e.q="recordid:'"+a.recordid+"'":a.geoDigest?e.geo_digest=a.geoDigest:a.gridData?null!==a.gridData["ods:geo_grid"]?e.geo_grid=a.gridData["ods:geo_grid"]:e.geo_digest=a.gridData["ods:geo_digest"]:a.shape&&ODS.GeoFilter.addGeoFilterFromSpatialObject(e,a.shape);var g={};angular.extend(g,a.context.parameters,e),d?(g.sort=d,c.records.search(a.context,g).success(function(a){b(a.records)})):c.records.download(a.context,g).success(b)};a.$watch("context.parameters",function(){e()},!0),a.$apply(),a.getTitle=function(b){if(a.context.dataset.extra_metas&&a.context.dataset.extra_metas.visualization&&a.context.dataset.extra_metas.visualization.map_tooltip_title){var c=a.context.dataset.extra_metas.visualization.map_tooltip_title;if(angular.isDefined(b.fields[c])&&""!==b.fields[c])return b.fields[c]}return null},a.fields=angular.copy(a.context.dataset.fields)}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsMap",["URLSynchronizer","MapHelper","ModuleLazyLoader","ODSWidgetsConfig","MapLayerRenderer","translate","$q","$timeout",function(a,b,c,d,e,f,g,h){return{restrict:"EA",scope:{context:"=",syncToUrl:"@",syncToObject:"=",location:"@",basemap:"@",staticMap:"@",noRefit:"@",autoResize:"@",autoGeolocation:"@",toolbarDrawing:"@",toolbarGeolocation:"@",toolbarFullscreen:"@",scrollWheelZoom:"@",minZoom:"@",maxZoom:"@",displayControl:"=?",displayControlSingleLayer:"=?",searchBox:"=?",displayLegend:"=?",mapConfig:"=?",dynamicConfig:"=?"},transclude:!0,template:'<div class="odswidget odswidget-map">    <div class="odswidget odswidget-map__map" ng-class="{\'odswidget-map__map--with-searchbox\': searchBox, \'odswidget-map__map--with-display-control\': displayControl}"></div>    <div class="odswidget-overlay map odswidget-overlay--opaque" ng-show="initialLoading">        <ods-spinner></ods-spinner>    </div>    <div class="odswidget-map__loading" ng-show="loading">        <ods-spinner></ods-spinner>    </div>    <ods-map-display-control ng-if="displayControl && allContextsInitialized" single-layer="displayControlSingleLayer" map-config="mapConfig"></ods-map-display-control>    <ods-map-search-box ng-if="searchBox"></ods-map-search-box>    <ods-map-legend ng-if="displayLegend && allContextsInitialized" map-config="mapConfig"></ods-map-legend>    <div ng-transclude></div></div>',link:function(i,j,k){function l(){var a=$(".odswidget-map__map");if("true"===i.autoResize&&a.length>0){var b=Math.max(200,$(window).height()-a.offset().top);a.height(b)}}function m(){var a=g.defer(),c=b.MapConfiguration.getActiveContextList(i.mapConfig),d=c.map(function(a){return a.wait()});return g.all(d).then(function(){w(),a.resolve()}),a.promise}var n=angular.element(j.children()[0]);k.id&&n.attr("id",k.id),k.style&&n.attr("style",k.style),k.class&&n.addClass(k.class);var o,p,q,r=i.staticMap&&"true"===i.staticMap.toLowerCase(),s=i.noRefit&&"true"===i.noRefit.toLowerCase(),t=!(i.toolbarDrawing&&"false"===i.toolbarDrawing.toLowerCase());if(o=angular.isUndefined(i.toolbarGeolocation)?!angular.isDefined(i.mapConfig.toolbarGeolocation)||!!i.mapConfig.toolbarGeolocation:!(i.toolbarGeolocation&&"false"===i.toolbarGeolocation.toLowerCase()),p=angular.isUndefined(i.toolbarFullscreen)?!angular.isDefined(i.mapConfig.toolbarFullscreen)||!!i.mapConfig.toolbarFullscreen:!(i.toolbarFullscreen&&"false"===i.toolbarFullscreen.toLowerCase()),q=angular.isUndefined(i.autoGeolocation)?!!i.mapConfig.autoGeolocation:i.autoGeolocation&&"true"===i.autoGeolocation.toLowerCase(),angular.isUndefined(i.displayControl)&&(i.displayControl=i.mapConfig.layerSelection),angular.isUndefined(i.displayLegend)&&(i.displayLegend=!0),angular.isUndefined(i.displayControlSingleLayer)&&(i.displayControlSingleLayer=i.mapConfig.singleLayer),angular.isUndefined(i.searchBox)&&(i.searchBox=i.mapConfig.searchBox),i.context){var u=b.MapConfiguration.createLayerGroupConfiguration(),v=b.MapConfiguration.createLayerConfiguration();u.layers.push(v),i.mapConfig.groups.push(u),v.context=i.context,i.context.wait().then(function(a){a&&b.MapConfiguration.setLayerDisplaySettingsFromDefault(v)})}"true"===i.autoResize&&($(window).on("resize",l),l()),i.$on("invalidateMapSize",function(){i.map&&i.map.invalidateSize()}),i.$on("mapFitBounds",function(a,b){i.map.fitBounds(b)}),i.initialLoading=!0,i.syncToObject?i.mapContext=i.syncToObject:i.mapContext={},"true"===i.syncToUrl&&(a.addSynchronizedValue(i,"mapContext.location","location",!0),a.addSynchronizedValue(i,"mapContext.basemap","basemap")),i.location?i.mapContext.location=i.mapContext.location||i.location:i.mapConfig&&i.mapConfig.mapPresets&&i.mapConfig.mapPresets.location&&(i.mapContext.location=i.mapContext.location||i.mapConfig.mapPresets.location),i.basemap?i.mapContext.basemap=i.mapContext.basemap||i.basemap:i.mapConfig&&i.mapConfig.mapPresets&&i.mapConfig.mapPresets.basemap&&(i.mapContext.basemap=i.mapContext.basemap||i.mapConfig.mapPresets.basemap),c("leaflet").then(function(){var a={basemapsList:d.basemaps,worldCopyJump:!0,minZoom:2,basemap:i.mapContext.basemap,dragging:!r,keyboard:!r,prependAttribution:d.mapPrependAttribution,appendAttribution:d.mapAppendAttribution,maxBounds:[[-90,-180],[90,180]],zoomControl:!1,scrollWheelZoom:"false"!==i.scrollWheelZoom};i.minZoom&&(a.minZoom=i.minZoom),i.maxZoom&&(a.maxZoom=i.maxZoom),r&&(a.doubleClickZoom=!1,a.scrollWheelZoom=!1),l();var c=new L.ODSMap(j.children()[0].children[0],a);if(c.addControl(new L.Control.Scale),r||c.addControl(new L.Control.Zoom({position:"topright",zoomInTitle:f("Zoom in"),zoomOutTitle:f("Zoom out")})),p)try{window.self===window.top&&c.addControl(new L.Control.Fullscreen({title:{false:f("View Fullscreen"),true:f("Exit Fullscreen")}}))}catch(a){}if(!window.location.pathname.startsWith("/map2/")&&d.mapGeobox&&!i.searchBox&&!r){var k=L.Control.geocoder({placeholder:f("Find a place..."),errorMessage:f("Nothing found."),geocoder:new L.Control.Geocoder.Nominatim({serviceUrl:"https://nominatim.openstreetmap.org/",geocodingQueryParams:{"accept-language":d.language||"en",polygon_geojson:!0}})});k.markGeocode=function(a){if(c.fitBounds(a.bbox),a.properties.geojson){var b=L.geoJson(a.properties.geojson,{style:function(){return{opacity:0,fillOpacity:.8,fillColor:"orange",className:"leaflet-geocoder-highlight"}}});c.addLayer(b),h(function(){j.addClass("geocoder-highlight-on")},0),h(function(){j.removeClass("geocoder-highlight-on"),c.removeLayer(b)},2500)}},c.addControl(k)}if(o&&!r){var n=new L.Control.Locate({position:"topright",maxZoom:18,strings:{title:f("Show me where I am"),popup:f("You are within {distance} {unit} from this point"),outsideMapBoundsMsg:f("You seem located outside the boundaries of the map")}});c.addControl(n)}if(i.drawnItems=new L.FeatureGroup,c.addLayer(i.drawnItems),t&&!r){L.drawLocal.draw.toolbar.buttons.circle=f("Draw a circle to filter on"),L.drawLocal.draw.toolbar.buttons.polygon=f("Draw a polygon to filter on"),L.drawLocal.draw.toolbar.buttons.rectangle=f("Draw a rectangle to filter on"),L.drawLocal.draw.toolbar.actions={title:f("Cancel area filter"),text:f("Cancel")},L.drawLocal.draw.toolbar.undo={title:f("Delete last point"),text:f("Delete last point")},L.drawLocal.edit.toolbar.buttons={edit:f("Edit area filter."),editDisabled:f("No area filter to edit."),remove:f("Delete area filter."),removeDisabled:f("No area filter to delete.")},L.drawLocal.edit.toolbar.actions={save:{title:f("Apply"),text:f("Apply")},cancel:{title:f("Cancel editing, discards all changes."),text:f("Cancel")}},L.drawLocal.draw.handlers={circle:{tooltip:{start:f("Click and drag to draw circle")},radius:f("Radius")},marker:{tooltip:{start:f("Click map to place marker")}},polygon:{tooltip:{start:f("Click to start drawing shape"),cont:f("Click to continue drawing shape"),end:f("Click first point to close this shape")}},polyline:{error:"<strong>"+f("Error:")+"</strong> "+f("shape edges cannot cross!"),tooltip:{start:f("Click to start drawing line"),cont:f("Click to continue drawing line"),end:f("Click last point to finish line")}},rectangle:{tooltip:{start:f("Click and drag to draw rectangle")}},simpleshape:{tooltip:{end:f("Release mouse to finish drawing")}}},L.drawLocal.edit.handlers={edit:{tooltip:{text:f("Drag handles to edit shape, then apply")+"<br><em>"+f("Click cancel to undo changes")+"</em>"}},remove:{tooltip:{text:f("Click on a shape to delete it, then apply")}}};var u=new L.Control.Draw({edit:{featureGroup:i.drawnItems},draw:{polyline:!1,marker:!1,circle:{showRadius:!0,metric:!0,feet:!1}}});c.options.drawControlTooltips=!0,c.addControl(u)}i.map=c,function(a){var c=g.defer();if(a){var e=b.getLocationStructure(a);i.map.setView(e.center,e.zoom),m().then(function(){B(!1)}),c.resolve(),q&&n&&n.locate()}else m().then(function(){b.retrieveBounds(b.MapConfiguration.getActiveContextList(i.mapConfig,{geoOnly:!0,skipExcludedFromRefit:!0})).then(function(a){if(a)i.map.fitBounds(a);else{var e=b.getLocationStructure(d.defaultMapLocation);i.map.setView(e.center,e.zoom)}B(!1),c.resolve(),q&&n&&n.locate()})});return c.promise}(i.mapContext.location).then(function(){i.initialLoading=!1,z(i.map),r||m().then(C),i.map.on("moveend",function(a){i.$applyAsync?i.$applyAsync(function(){z(a.target)}):h(function(){z(a.target)})}),i.$watch("mapContext.location",function(a,b){a!==b&&B(!1,!0)}),i.allContextsInitialized=!1,m().then(function(){i.allContextsInitialized=!0}),i.$watch(function(){var a=0;return angular.forEach(i.mapConfig.groups,function(b){angular.forEach(b.layers,function(b){b._loading&&a++})}),a},function(a){i.loading=!!a}),i.$watch(function(){var a=[],c=[];return angular.forEach(b.MapConfiguration.getActiveContextList(i.mapConfig),function(b){a.push([b.name,b.parameters])}),angular.forEach(b.MapConfiguration.getActiveContextList(i.mapConfig,{skipExcludedFromRefit:!0}),function(a){c.push([a.name,a.parameters])}),[a,c,b.MapConfiguration.getVisibleLayerIds(i.mapConfig)]},function(a,b){a!==b&&(w(),B(!angular.equals(a[1],b[1])))},!0)});var v,x=function(){v=i.$watch(function(){return JSON.stringify(i.mapConfig,function(a,b){if("function"!=typeof b&&"$$"!==a.substring(0,2)&&"_"!==a[0]){if("context"===a)return{datasetId:b.dataset.datasetid,parameters:b.parameters};if(!(["mapPresets","singleLayer","toolbarGeolocation","toolbarFullscreen","autoGeolocation","layerSelection","searchBox","title","description","caption","captionTitle"].indexOf(a)>-1))return b}})},function(){B()})},y=function(){v&&v()};i.$watch("dynamicConfig",function(a,b){angular.isDefined(a)&&(a?x():y())}),d.basemaps.length>1&&i.map.on("baselayerchange",function(a){i.$evalAsync('mapContext.basemap = "'+a.layer.basemapId+'"'),angular.forEach(i.mapConfig.groups,function(b){b.displayed&&angular.forEach(b.layers,function(b){"tiles"===b.display&&b._rendered&&(b._rendered.setMinZoom(a.layer.options.minZoom),b._rendered.setMaxZoom(a.layer.options.maxZoom))})})});var z=function(a){var c=a.getSize();c.x>0&&c.y>0&&(i.mapContext.location=b.getLocationParameter(a.getCenter(),a.getZoom()))},A={},B=function(a,c){a=!s&&a;var d=function(a){var b=[],c={};angular.forEach(i.mapConfig.groups,function(d){if(!d.displayed)return void angular.forEach(d.layers,function(a){a._currentRequestTimeout&&a._currentRequestTimeout.resolve(),a._rendered&&(i.map.removeLayer(a._rendered),a._rendered=null)});angular.forEach(d.layers,function(d){d.showZoomMin&&d.showZoomMin>i.map.getZoom()||d.showZoomMax&&d.showZoomMax<i.map.getZoom()||a&&!e.doesLayerRefreshOnLocationChange(d)||(b.push(e.updateDataLayer(d,i.map)),c[d._runtimeId]=d)})}),Object.keys(A).forEach(function(a){if(angular.isUndefined(c[a])){var b=A[a];b._currentRequestTimeout&&b._currentRequestTimeout.resolve(),b._rendered&&(i.map.removeLayer(b._rendered),b._rendered=null)}}),A=c,g.all(b).then(function(){})};a?b.retrieveBounds(b.MapConfiguration.getActiveContextList(i.mapConfig,{geoOnly:!0,skipExcludedFromRefit:!0})).then(function(a){a&&a!==b.WORLD_BOUNDS?h(function(){var b=i.map.getBounds().toBBoxString();i.map.fitBounds(a),b===i.map.getBounds().toBBoxString()&&B(!1,!0)},0):d(c)}):d()},C=function(){i.map.on("draw:drawstart draw:editstart",function(){i.map.isDrawing=!0}),i.map.on("draw:drawstop draw:editstop",function(){i.map.isDrawing=!1});var a=function(a){a._path.setAttribute("style","cursor: pointer; pointer-events: auto;")},c=function(a){a._path.setAttribute("style","cursor: auto; pointer-events: none;")};i.map.on("draw:deletestart",function(){a(i.drawnItems.getLayers()[0])}),i.map.on("draw:deleteend",function(){c(i.drawnItems.getLayers()[0])}),i.map.on("draw:created",function(a){var b=a.layer;i.drawnItems.getLayers().length>0&&i.drawnItems.removeLayer(i.drawnItems.getLayers()[0]),i.drawnItems.addLayer(b),d(b,a.layerType),i.$apply()}),i.map.on("draw:edited",function(a){var b=a.layers.getLayers()[0],c=e(b);d(b,c),i.$apply()}),i.map.on("draw:deleted",function(){delete i.mapConfig.drawnArea,i.$apply()});var d=function(a,b){if("circle"===b){var c=a.getRadius(),d=a.getLatLng();i.mapConfig.drawnArea={shape:"circle",coordinates:d.lat+","+d.lng+","+c}}else{var e=a.toGeoJSON(),f=ODS.GeoFilter.getGeoJSONPolygonAsPolygonParameter(e.geometry);i.mapConfig.drawnArea={shape:"polygon",coordinates:f}}},e=function(a){return angular.isDefined(a.getRadius)?"circle":"polygon"},f={color:"#2ca25f",fillOpacity:.2,opacity:.8,clickable:!0};i.$watch("mapConfig.drawnArea",function(a){i.drawnItems.getLayers().length>0&&i.drawnItems.removeLayer(i.drawnItems.getLayers()[0]);var d;if(a){if("polygon"===a.shape){var e=ODS.GeoFilter.getPolygonParameterAsGeoJSON(a.coordinates),g=e.coordinates[0];g.splice(e.coordinates[0].length-1,1);var h,j,k;for(h=0;h<g.length;h++)j=g[h],k=j[0],j[0]=j[1],j[1]=k;d=4===g.length&&g[0][0]===g[3][0]&&g[1][0]===g[2][0]&&g[0][1]===g[1][1]&&g[2][1]===g[3][1]?new L.Rectangle(g,f):new L.Polygon(g,f)}else if("circle"===a.shape){var l=a.coordinates.split(","),m=l[0],n=l[1],o=l[2]||0;d=new L.Circle([m,n],o,f)}d&&(i.drawnItems.addLayer(d),c(i.drawnItems.getLayers()[0]))}angular.forEach(b.MapConfiguration.getActiveContextList(i.mapConfig,{geoOnly:!0}),function(b){a?"circle"===a.shape?(b.parameters["geofilter.distance"]=a.coordinates,delete b.parameters["geofilter.polygon"]):"polygon"===a.shape&&(b.parameters["geofilter.polygon"]=a.coordinates,delete b.parameters["geofilter.distance"]):(delete b.parameters["geofilter.polygon"],delete b.parameters["geofilter.distance"])})},!0)}});var w=function(){var a,c;angular.forEach(b.MapConfiguration.getActiveContextList(i.mapConfig,{geoOnly:!0}),function(b){angular.isUndefined(a)&&angular.isUndefined(a)?(a=b.parameters["geofilter.polygon"],c=b.parameters["geofilter.distance"]):(a!==b.parameters["geofilter.polygon"]&&(a=null),c!==b.parameters["geofilter.distance"]&&(c=null))}),i.mapConfig.drawnArea=a?{shape:"polygon",coordinates:a}:c?{shape:"circle",coordinates:c}:{}}},controller:["$scope",function(a){angular.isUndefined(a.mapConfig)?a.mapConfig={singleLayer:!1,layerSelection:!1,groups:[]}:a.mapConfig.groups.forEach(function(a){a.layers.forEach(function(a){a.context.wait().then(function(){b.MapConfiguration.setLayerDisplaySettingsFromDefault(a)})})}),window.mapConfig=a.mapConfig,this.registerLayer=function(c){var d=b.MapConfiguration.createLayerGroupConfiguration();return d.layers.push(c),a.mapConfig.groups.push(d),d},this.registerLayerGroup=function(b){a.mapConfig.groups.push(b)},this.getCurrentPosition=function(){return a.mapContext.location},this.moveMap=function(b,c){a.map.setView(b,c)},this.resetMapDataFilter=function(){b.MapConfiguration.getContextList(a.mapConfig).forEach(function(a){delete a.parameters["q.mapfilter"]}),c&&c()},this.applyMapDataFilter=function(c){b.MapConfiguration.getContextList(a.mapConfig).forEach(function(a){a.parameters["q.mapfilter"]=c})},this.getActiveContexts=function(){return b.MapConfiguration.getActiveContextList(a.mapConfig)};var c;this.registerResetCallback=function(a){c=a};a.$watch(function(){return b.MapConfiguration.getContextList(a.mapConfig).reduce(function(a,b){return a&&!b.parameters["q.mapfilter"]},!0)},function(a,b){a&&!b&&c&&c()},!0)}]}}]),a.directive("odsMapLayerGroup",["MapHelper",function(a){return{restrict:"EA",scope:{title:"@",description:"@",color:"@",picto:"@"},require:"^odsMap",link:function(a,b,c,d){d.registerLayerGroup(a.group)},controller:["$scope",function(b){b.group=a.MapConfiguration.createLayerGroupConfiguration(),angular.extend(b.group,{title:b.title,description:b.description,color:b.color,picto:b.picto}),this.registerLayer=function(a){return b.group.layers.push(a),b.group}}]}}]),a.directive("odsMapLayer",["MapHelper",function(a){return{restrict:"EA",scope:{context:"=",showIf:"=",showZoomMin:"@",showZoomMax:"@",color:"@",borderColor:"@",opacity:"@",shapeOpacity:"@",pointOpacity:"@",colorScale:"@",colorRanges:"@",colorCategories:"=",colorCategoriesOther:"@",colorNumericRanges:"=",colorGradient:"=",colorByField:"@",colorFunction:"@",radius:"@",size:"@",sizeMin:"@",sizeMax:"@",sizeFunction:"@",picto:"@",showMarker:"@",display:"@",function:"@",expression:"@",tooltipSort:"@",hoverField:"@",refineOnClickContext:"=",joinContext:"=",localKey:"@",remoteKey:"@",caption:"=?",captionTitle:"@",excludeFromRefit:"=?"},template:function(a){var b="";return a.contents().wrapAll("<div>"),a.contents().length>0&&a.contents().html().trim().length>0&&(a.contents().wrapAll("<div>"),b=a.children().html()),'<div tooltiptemplate="'+b.replace(/"/g,"&quot;")+'"></div>'},require:["?^odsMapLayerGroup","^odsMap"],link:function(b,c,d,e){var f,g=e[0],h=e[1],i=angular.element(c.children()[0]),j=i.attr("tooltiptemplate");if(b.color)f=b.color;else if(b.colorScale)f={type:"scale",scale:b.colorScale};else if(b.colorRanges){var k=b.colorRanges.split(";"),l=k.filter(function(a,b){return b%2==1}),m=k.filter(function(a,b){return b%2==0});f={type:"range",ranges:l,colors:m,field:b.colorByField}}else b.colorCategories?(b.colorByField||console.error("odsMapLayer: using colorCategories requires specifying a field to use, using colorByField"),f={type:"categories",field:b.colorByField,categories:b.colorCategories},b.colorCategoriesOther&&(f.otherCategories=b.colorCategoriesOther)):b.colorGradient?f={type:"gradient",steps:b.colorGradient}:b.colorNumericRanges?(b.colorByField||console.error("odsMapLayer: using colorNumericRanges requires specifying a field to use, using colorByField"),f={type:"choropleth",field:b.colorByField,ranges:b.colorNumericRanges}):b.colorByField&&(f={type:"field",field:b.colorByField});var n,o={color:f,colorFunction:b.colorFunction,borderColor:b.borderColor,shapeOpacity:angular.isDefined(b.shapeOpacity)&&b.shapeOpacity||b.opacity,pointOpacity:angular.isDefined(b.pointOpacity)&&b.pointOpacity||b.opacity,picto:b.picto,display:b.display,function:b.function,expression:b.expression,localKey:b.localKey,remoteKey:b.remoteKey,tooltipSort:b.tooltipSort,hoverField:b.hoverField,excludeFromRefit:b.excludeFromRefit,caption:!!b.caption,captionTitle:b.captionTitle,showZoomMin:b.showZoomMin,showZoomMax:b.showZoomMax,radius:b.radius,size:b.size,minSize:b.sizeMin,maxSize:b.sizeMax,sizeFunction:b.sizeFunction},p=a.MapConfiguration.createLayerConfiguration(j,o);n=g?g.registerLayer(p):h.registerLayer(p),d.showIf&&b.$watch("showIf",function(a,b){n.displayed=a});var q=b.$watch("context",function(c){c&&(p.context=c,c.wait().then(function(){b.showMarker&&(p.marker="true"===b.showMarker.toLowerCase()),a.MapConfiguration.setLayerDisplaySettingsFromDefault(p)}),q())}),r=b.$watch("joinContext",function(a){a&&(p.joinContext=a,r())}),s=b.$watch("refineOnClickContext",function(a){if(angular.isArray(a)){var b=!0;if(angular.forEach(a,function(a){b=b&&angular.isDefined(a)}),!b)return}else if(!a)return;p.refineOnClick=[];var c=angular.isArray(a)&&a||[a];angular.forEach(c,function(a){var b=!1,c="refineOnClick"+ODS.StringUtils.capitalize(a.name);angular.isDefined(d[c+"ReplaceRefine"])?"false"!==d[c+"ReplaceRefine"]&&(b=!0):angular.isDefined(d.refineOnClickReplaceRefine)&&"false"!==d.refineOnClickReplaceRefine&&(b=!0),p.refineOnClick.push({context:a,mapField:d[c+"MapField"]||d.refineOnClickMapField,contextField:d[c+"ContextField"]||d.refineOnClickContextField,replaceRefine:b}),s()})})},controller:["$scope",function(a){}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsMediaGallery",["$timeout","$q","ODSAPI",function(b,c,d){var e;return{restrict:"E",scope:{context:"=",displayedFields:"@",imageFields:"@?",displayMode:"@?"},replace:!0,template:'<div class="odswidget odswidget-media-gallery"> <div class="odswidget-media-gallery__container" >     <div style="vertical-align: top;" class="odswidget-images__internal-table" infinite-scroll="loadMore()" infinite-scroll-distance="1" infinite-scroll-disabled="fetching">        <div class="odswidget-media-gallery__media-line" ng-repeat="line in lines track by $index">            <div ng-class="{\'odswidget-media-gallery__media-container--selected\': image.selected}" class="odswidget-media-gallery__media-container" style="vertical-align: top; display: inline-block" ng-repeat="image in line.images track by $index" ng-click="onClick($event, image, line)" data-index="{{ image.index + 1 }}">                <div style="overflow: hidden" ng-style="{width: image.width, height: image.height, marginTop: image.marginTop, marginBottom: image.marginBottom, marginRight: image.marginRight, marginLeft: image.marginLeft }">                    <ods-record-image record="image.record" field="{{ image.fieldname }}" domain-url="{{context.domainUrl}}"></ods-record-image>                    <div ng-if="getRecordTitle(image.record)" class="odswidget-media-gallery__media-container__title-container">{{ getRecordTitle(image.record) }}</div>                    <ods-spinner ng-show="image.fetching" class="ods-media-gallery__image-spinner-overlay"></ods-spinner>                </div>            </div>        </div>     </div>     <ods-spinner ng-if="!init && fetching"></ods-spinner> </div> <div class="odswidget-media-gallery__details"></div> <div class="odswidget-overlay" ng-if="done && !records"><span class="odswidget-overlay__message" translate>No results</span></div> <div class="odswidget-overlay" ng-if="fetching && !records"><ods-spinner></ods-spinner></div></div>',require:["odsMediaGallery","?odsWidgetTooltip","?odsAutoResize","?refineOnClick"],controller:["$scope","$element","$window","DebugLogger","$filter",function(a,b,f,g,h){a.page=0,a.resultsPerPage=40,a.fetching=!0,a.staticSearchOptions={rows:a.resultsPerPage},a.records=[],a.images=[],a.done=!1,a.init=!0,a.nextImage=0,void 0===a.imageFields&&(a.imageFields=[]);var i=[],j=function(){a.fetching=!0;var b,e={};a.init?(b=0,i.length&&(i.forEach(function(a){a.resolve()}),i.splice(0,i.length))):(a.page++,b=a.page*a.resultsPerPage),angular.extend(e,a.staticSearchOptions,a.context.parameters,{start:b});var f=a.imageFields||[];a.context.dataset.extra_metas&&a.context.dataset.extra_metas.visualization&&a.context.dataset.extra_metas.visualization.image_title&&(f=f.concat(a.context.dataset.extra_metas.visualization.image_title)),f.length>0&&angular.extend(e,{fields:f.join(",")});var g=c.defer();i.push(g),angular.isDefined(e.q)?e.q=[e.q]:e.q=[];var h=[];angular.forEach(a.imageFields,function(a){h.push("NOT #null("+a+")")}),e.q.push(h.join(" OR ")),d.records.search(a.context,e,g.promise).success(function(b,c,d,e){a.records=a.records.concat(b.records);var f,h,j,k,l;for(f=0;f<b.records.length;f++)for(h=0;h<a.imageFields.length;h++)b.records[f].fields[a.imageFields[h]]&&(k=b.records[f].fields[a.imageFields[h]],k.url?(j=k.url,l=!1):k.placeholder?(j=null,l=!0):(j=a.context.domainUrl+"/explore/dataset/"+b.records[f].datasetid+"/files/"+k.id+"/300/",l=!1),a.images.push({record:b.records[f],fieldname:a.imageFields[h],thumbnail_url:j,download_url:j.replace("/300/","/download/"),id:k.id,index:a.images.length,placeholder:l,realwidth:k.width,realheight:k.height,allFieldsInitialized:!1,fetching:!1}));a.renderImages(),a.error="",a.fetching=!1,a.done=(a.page+1)*a.resultsPerPage>=b.nhits,a.init=!1,i.splice(i.indexOf(g),1)}).error(function(b,c,d,e){b&&(a.error=b.error),i.splice(i.indexOf(g),1),a.fetching=!1})};this.getDefaultsFromContext=function(){var b,c,d=a.context.dataset,f=[];if(e=a.context.dataset.extra_metas.visualization&&a.context.dataset.extra_metas.visualization.image_tooltip_html?"<div>"+a.context.dataset.extra_metas.visualization.image_tooltip_html+"</div>":'<div><div class="ods-media-gallery__tooltip__image-container" width="{{ image.realwidth }}px" height="{{ image.realheight }}px">   <img class="ods-media-gallery__tooltip__image" ng-src="{{ image.thumbnail_url }}"></div><div class="ods-media-gallery__tooltip__fields"><h2 ng-if="getRecordTitle(record)">   {{ getRecordTitle(record) }}</h2><dl>   <dt ng-repeat-start="field in displayedFields"           ng-show="record.fields[field.name]|isDefined"           class="ods-dataset-images__infopane-field-name">       {{ field.label }}   </dt>   <dd ng-repeat-end ng-switch="field.type"           ng-show="record.fields[field.name]|isDefined">       <span ng-switch-when="geo_point_2d">           <ods-geotooltip width="300" height="300"                   coords="record.fields[field.name]">{{ record.fields|formatFieldValue:field }}</ods-geotooltip>       </span>       <span ng-switch-when="geo_shape">            <ods-geotooltip width="300" height="300"                   geojson="record.fields[field.name]">{{ record.fields|formatFieldValue:field }}</ods-geotooltip>        </span>        <span ng-switch-when="double">{{ record.fields|formatFieldValue:field }}</span>        <span ng-switch-when="int">{{ record.fields|formatFieldValue:field }}</span>        <span ng-switch-when="date">{{ record.fields|formatFieldValue:field }}</span>        <span ng-switch-when="datetime">{{ record.fields|formatFieldValue:field }}</span>        <span ng-switch-when="file">            <div ng-bind-html="record.fields|formatFieldValue:field"></div>        </span>       <span ng-switch-default ng-bind-html="record.fields[field.name]|prettyText|nofollow|safenewlines"></span>   </dd></dl><a href="{{ image.download_url }}"       target="_self"       ods-resource-download-conditions       class="ods-button">   <i class="fa fa-download" aria-hidden="true"></i>   <span translate>Download image</span></a></div></div>',a.detailsTemplate=e,a.context.dataset.extra_metas.visualization&&a.context.dataset.extra_metas.visualization.media_gallery_fields)a.imageFields=a.context.dataset.extra_metas.visualization.media_gallery_fields;else{for(b=0;b<d.fields.length;b++)if("file"==d.fields[b].type)for(c=0;c<d.fields[b].annotations.length;c++)"has_thumbnails"==d.fields[b].annotations[c].name&&(0===a.imageFields.length||a.imageFields.indexOf(d.fields[b].name)>-1)&&f.push(d.fields[b].name);a.imageFields=f}j()},this.watchContext=function(){a.$watch("context.parameters",function(b,c){b!==c&&(a.done=!1,a.lines.splice(0,a.lines.length),a.images.splice(0,a.images.length),a.records.splice(0,a.records.length),a.nextImage=0,a.init=!0,a.page=0,a.layout.resetImages(),j())},!0)},a.loadMore=function(){a.fetching||a.done||!a.staticSearchOptions||j()},a.detailsDisplayed=!1,a.getRecordTitle=function(b){if(a.context.dataset.extra_metas&&a.context.dataset.extra_metas.visualization&&a.context.dataset.extra_metas.visualization.image_title){var c=a.context.dataset.extra_metas.visualization.image_title;if(angular.isDefined(b.fields[c])&&""!==b.fields[c])return h("formatFieldValue")(b.fields,a.context.dataset.getField(c))}return null}}],link:function(b,e,f,g){var h=g[0],i=g[1],j=g[2],k=g[3];j&&(j.onResize=function(){b.lines.splice(0,b.lines.length),b.layout.reset(),b.layout.render(b.lines,e.children()[0].getBoundingClientRect().width,b.images.length)}),angular.isString(b.displayedFields)&&(b.displayedFields=b.displayedFields.split(",")),b.context.wait().then(function(){if(h.getDefaultsFromContext(),h.watchContext(),null!==i){var a;a=b.displayedFields?b.context.dataset.fields.filter(function(a){return-1!==b.displayedFields.indexOf(a.name)}):b.context.dataset.extra_metas.visualization&&b.context.dataset.extra_metas.visualization.image_fields?b.context.dataset.fields.filter(function(a){return-1!==b.context.dataset.extra_metas.visualization.image_fields.indexOf(a.name)}):b.context.dataset.fields,i.configure({defaultTemplate:b.detailsTemplate,displayedFields:a,fields:b.context.dataset.fields})}});var l=e.find(".odswidget-media-gallery__details");void 0===b.displayMode?b.displayMode="compact":a[b.displayMode+"Layout"]||(console.warn("ods-media-gallery "+b.displayMode+" displayMode is not valid."),b.displayMode="compact"),b.max_height=400;var m,n;l=l.remove(),b.onClick=function(a,e,f){var g;if(e.allFieldsInitialized)g=c.resolve();else{var h=angular.copy(b.context.parameters);jQuery.extend(h,{q:["recordid="+e.record.recordid]}),e.fetching=!0,g=d.records.search(b.context,h,c.defer()).success(function(a,b,c,d){e.record=a.records[0],e.allFieldsInitialized=!0,e.fetching=!1})}g.then(function(){if(null!==k)k.refineOnRecord(e.record);else if(null!==i){if(m&&m.$destroy(),n&&(n.selected=!1),n===e)return n=null,void(l=l.remove());n=e,e.selected=!0,l.html(i.render(e.record,{image:angular.copy(e),getRecordTitle:b.getRecordTitle},e.fieldname)),l=l.remove(),l.insertAfter(angular.element(a.currentTarget).parent(".odswidget-media-gallery__media-line"))}})},b.lines=[],b.layout=a()[b.displayMode+"Layout"](),b.layout.resetImages(),b.renderImages=function(){var a,c;for(a=b.nextImage;a<b.images.length;a++)c=b.images[a],b.layout.addImage(c,b.images.length);b.nextImage=a,b.layout.render(b.lines,e.children()[0].getBoundingClientRect().width,b.images.length)}}}}]);var a=function(){function a(a,b){return Object.keys(b).forEach(function(c){a[c]=b[c]}),a}var b=0,c=250,d=1,e=0,f=[],g=-1,h=!1,i={reset:function(){b=0,e=0,g=-1},resetImages:function(){f.splice(0,f.length),this.reset()},addImage:function(a){var b=angular.copy(a);f.push(b)}};return{largeLayout:function(){return a({render:function(b,d,e){if(!h){h=!0;var i,j,k,l,m;for(0===b.length&&b.push({images:[],height:c,offset:0,cumulated_width:0}),i=g+1;i<f.length;i++)j=f[i],m=b[b.length-1],j.realheight>c-20?(k=Math.floor(j.realwidth*(c-20)/j.realheight),l=c-20):(k=j.realwidth,l=j.realheight),k>d&&(l=Math.floor(l*d/k),k=d),m.cumulated_width+k<d?(m.images.push(a({width:k,height:l},j)),m.cumulated_width+=k):(angular.forEach(m.images,function(a,b){a.marginTop=a.marginBottom=(m.height-a.height)/2,a.marginLeft=a.marginRight=Math.floor((d-m.cumulated_width)/(2*m.images.length))}),b.push({images:[],height:c,offset:0,cumulated_width:0}),b[b.length-1].images.push(a({width:k,height:l},j)),b[b.length-1].cumulated_width=k),g+=1;g===e-1&&(m=b[b.length-1],angular.forEach(m.images,function(a,b){a.marginTop=a.marginBottom=(m.height-a.height)/2,a.marginLeft=a.marginRight=Math.floor((d-m.cumulated_width)/(2*m.images.length))})),h=!1}}},i)},compactLayout:function(){return a({render:function(a,i,j){if(!h){h=!0;var k,l;for(0===a.length&&a.push({images:[],height:c,offset:0,max_height:0}),k=g+1;k<f.length;k++){l=f[k];var m=l.realwidth/l.realheight,n=a[a.length-1];if(n.images.push(l),n.max_height=Math.min(c,Math.max(n.max_height,l.realheight)),b+=m,n.height=Math.min(Math.floor((i-d*(n.images.length-1))/b),n.max_height),n.height<n.max_height||l.index===j-1){var o=0;for($.each(n.images,function(a,b){b.height=n.height,b.width=Math.floor(b.realwidth*b.height/b.realheight),b.marginTop=b.marginBottom=b.marginRight=b.marginLeft=d+"px",o+=b.width+2*d}),n.offset=e+n.max_height;o>i;)angular.forEach(n.images,function(a,b){o>i&&(a.width-=1,o-=1)})}n.height<n.max_height&&(e+=n.height,a.push({images:[],height:c,offset:0,max_height:0}),b=0),g+=1}h=!1}}},i)}}}}(),function(){"use strict";angular.module("ods-widgets").directive("odsMostPopularDatasets",["ODSAPI",function(a){return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-most-popular-datasets"><ul class="odswidget-most-popular-datasets__datasets">   <li class="no-data" ng-hide="datasets" translate>No data available yet</li>   <li class="odswidget-most-popular-datasets__dataset" ng-repeat="dataset in datasets" ng-if="datasets">       <ods-theme-picto class="odswidget-most-popular-datasets__theme-picto" theme="{{dataset.metas.theme|firstValue}}"></ods-theme-picto>       <div class="odswidget-most-popular-datasets__dataset-details">           <div class="odswidget-most-popular-datasets__dataset-details-title"><a ng-href="{{context.domainUrl}}/explore/dataset/{{dataset.datasetid}}/" target="_self">{{ dataset.metas.title }}</a></div>           <div class="odswidget-most-popular-datasets__dataset-details-count"><i class="fa fa-download" aria-hidden="true"></i> <span translate translate-n="dataset.extra_metas.explore.download_count" translate-plural="{{$count}} downloads">{{$count}} download</span></div>       </div>   </li></ul></div>',scope:{context:"=",max:"@"},controller:["$scope",function(b){b.max=b.max||5;var c=function(){a.datasets.search(b.context,{rows:b.max,sort:"explore.download_count",extrametas:!0}).success(function(a){b.datasets=a.datasets})};b.$watch("context",function(){c()})}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsMostUsedThemes",["ODSAPI",function(a){return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-most-used-themes"><ul class="odswidget-most-used-themes__themes">   <li class="no-data" ng-hide="themes" translate>No data available yet</li>   <li class="odswidget-most-used-themes__theme" ng-repeat="theme in themes" ng-if="themes">       <div class="odswidget-most-used-themes__theme-details">           <div class="odswidget-most-used-themes__theme-details-name"><a ng-href="{{ context.domainUrl }}/explore/?refine.theme={{ theme.path }}" target="_self">{{ theme.name }}</a></div>           <div class="odswidget-most-used-themes__theme-details-count"><i class="fa fa-table" aria-hidden="true"></i> <span translate translate-n="theme.count" translate-plural="Used by {{$count}} datasets">Used by {{$count}} dataset</span></div>       </div>   </li></ul></div>',scope:{context:"="},controller:["$scope",function(b){var c=function(){a.datasets.facets(b.context,"theme").success(function(a){a.facet_groups&&(b.themes=a.facet_groups[0].facets.slice(0,5))})};b.$watch("context",function(){c()})}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsPaginationBlock",["$location",function(a){return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-pagination" ng-show="pages.length > 1">    <ul class="odswidget-pagination__page-list">        <li class="odswidget-pagination__page" ng-repeat="page in pages">            <a class="odswidget-pagination__page-link"                ng-class="{\'odswidget-pagination__page-link--active\': page.start == (context.parameters.start||0)}"                ng-attr-rel="{{nofollow?\'nofollow\':\'\'}}"               ng-click="click($event, page.start)"                href="?start={{ page.start }}"                rel="nofollow">{{ page.label }}</a>        </li>    </ul></div>',scope:{context:"=",perPage:"@",nofollow:"@",containerIdentifier:"@"},controller:["$scope","$anchorScroll",function(b,c){b.location=a,b.pages=[],b.perPage=b.perPage||10,b.click=function(a,c){a.preventDefault(),b.context.parameters.start=c};var d,e=function(){if(0===b.context.nhits)return void(b.pages=[]);var a,c=Math.max(1,Math.floor((b.context.nhits-1)/b.perPage)+1),d=[];if(c<=8)for(a=1;a<=c;a++)d.push({label:a,start:(a-1)*b.perPage});else{var e;if((e=b.context.parameters.start?Math.floor(b.context.parameters.start/b.perPage)+1:1)<=5){for(a=1;a<=8;a++)d.push({label:a,start:(a-1)*b.perPage});d.push({label:">>",start:(c-1)*b.perPage})}else if(e>=c-4)for(d.push({label:"<<",start:0}),a=c-7;a<=c;a++)d.push({label:a,start:(a-1)*b.perPage});else{for(d.push({label:"<<",start:0}),a=e-3;a<=e+3;a++)d.push({label:a,start:(a-1)*b.perPage});d.push({label:">>",start:(c-1)*b.perPage})}}b.pages=d};b.containerIdentifier&&(d=document.getElementById(b.containerIdentifier));var f=b.$watch("context",function(a,g){a&&(b.$watch("context.nhits",function(a,c){void 0!==b.context.nhits&&b.perPage&&e()}),b.$watch("perPage",function(a,c){b.context.nhits&&b.perPage&&e()}),b.$watch("context.parameters.start",function(a,f){b.context.nhits&&b.perPage&&e(),(angular.isDefined(a)||angular.isDefined(f))&&(d?d.scrollTop=0:c())}),f())})}]}}])}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("odsPicto",["SVGInliner","$http","$document",function(a,b,c){return{restrict:"E",replace:!0,scope:{url:"=",color:"=",classes:"="},template:'<div class="odswidget odswidget-picto {{ classes }}"></div>',link:function(b,c){var d;b.$watch("[url, color]",function(e){if(e[0]){if(Modernizr&&!Modernizr.svg)return;d&&c.empty(),d=a.getElement(b.url,b.color),b.color||d.addClass("ods-svginliner__svg-container--colorless"),c.append(d)}},!0)}}}]),a.directive("odsThemePicto",["ODSWidgetsConfig","$compile",function(a,b){return{restrict:"E",replace:!0,scope:{theme:"@"},template:"",link:function(c,d){c.originalClasses=d.attr("class").replace("ng-isolate-scope","").trim();var e=!1;a.themes[c.theme]&&a.themes[c.theme].url?c.themeConfig=a.themes[c.theme]:(c.themeConfig=a.themes.default,e=!0),c.getTheme=function(){return e?"default":c.theme},c.themeConfig&&d.replaceWith(angular.element(b('<ods-picto url="themeConfig.url" color="themeConfig.color" classes="originalClasses + \' odswidget-theme-picto theme-\' + (getTheme()|themeSlug) "></ods-picto>')(c)))}}}]),a.directive("odsMapPicto",["ODSWidgetsConfig","PictoHelper","$compile",function(a,b,c){return{restrict:"E",replace:!0,scope:{name:"@",color:"@"},template:"",link:function(a,d){a.originalClasses=d.attr("class").replace("ng-isolate-scope","").trim(),a.$watch("[name, color]",function(){a.pictoUrl=b.mapPictoToURL(a.name),a.pictoUrl&&d.replaceWith(angular.element(c('<ods-picto url="pictoUrl" color="color" classes="originalClasses + \' odswidget-map-picto\'"></ods-picto>')(a)))},!0)}}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsPlumeAirQuality",function(){return{restrict:"E",replace:!0,template:'<div class="odswidget"></div>',scope:{city:"@",lang:"@"},link:function(a,b,c){var d='<a id="plumelabs-wjs-cfg" data-w="320" data-h="200" data-city="'+c.city+'" data-lng="'+(c.lang||"en_us")+'" data-type="l">Air Quality</a><script>window.plmlbs=function(e,t,s){var l,m=e.getElementsByTagName(t)[0],n=window.plmlbs||{},a=/^http:/.test(e.location)?"http":"https";return e.getElementById(s)?n:(l=e.createElement(t),l.id=s,l.src=a+"://static.plumelabs.com/embed/embed.js",m.parentNode.insertBefore(l,m),n)}(document,"script","plumelabs-wjs");</script>';b.append(d)}}})}(),function(){"use strict";angular.module("ods-widgets").directive("odsRangeInput",[function(){return{restrict:"E",replace:!0,scope:{min:"=",selectableMin:"=",max:"=",step:"=",editableValue:"=",ngModel:"=",iconMin:"@",iconMax:"@"},require:"ngModel",template:'<div class="ods-range-input">    <i class="ods-range-input__icon ods-range-input__icon--min" ng-if="iconMin" ng-class="iconMin"></i>    <input type="range"           min="{{ actualMin }}"           max="{{ max }}"           step="{{ step }}"           class="ods-range-input__range-input"           ng-change="onRangeChange()"           ng-model="values.internalRange">    <i class="ods-range-input__icon ods-range-input__icon--max" ng-if="iconMax" ng-class="iconMax"></i>   <input class="ods-range-input__value-input" ng-change="onValueChange()" ng-if="editableValue" type="number" ng-model="values.internalValue" min="{{ actualMin }}" max="{{ max }}" step="{{ step }}"></div>',link:function(a,b,c,d){var e=b.find(".ods-range-input__input");a.values={},angular.isDefined(a.selectableMin)?a.actualMin=a.selectableMin:a.actualMin=a.min,a.onRangeChange=function(){var b=parseFloat(a.values.internalRange,10);a.values.internalValue=b,d.$setViewValue(b)},a.onValueChange=function(){a.values.internalRange=a.values.internalValue.toString(),d.$setViewValue(a.values.internalValue)},d.$render=function(){a.values.internalValue=d.$modelValue,a.values.internalRange=d.$modelValue.toString()},a.$watch("selectableMin",function(b,c){b!=c&&(e.css({width:(a.max-b)/(a.max-a.min)*100+"%"}),a.actualMin=b,b>=a.ngModel&&(a.ngModel=b))})}}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsRecordImage",function(){return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-record-image">   <img class="odswidget-record-image__image" ng-if="imageUrl" ng-src="{{ imageUrl }}">   <div class="odswidget-record-image__image odswidget-record-image__image--placeholder" ng-if="placeholder"></div>',scope:{record:"=",field:"@",domainUrl:"@?"},link:function(a){a.imageUrl=null;var b=function(){var b=a.record.fields[a.field];b.url?(a.imageUrl=b.url,a.placeholder=!1):b.placeholder?(a.imageUrl=null,a.placeholder=!0):(a.imageUrl=ODS.Record.getImageUrl(a.record,a.field,a.domainUrl),a.placeholder=!1)};a.$watch("[record, field]",function(a,c){b()},!0)}}})}(),function(){"use strict";var a=angular.module("ods-widgets"),b=function(){return{restrict:"A",controller:function(a,b,c){var d=[];this.refineOnRecord=function(a){angular.forEach(d,function(b){b.context.toggleRefine(b.contextField,a.fields[b.recordField],b.replaceRefine)})},this.refineOnValue=function(a){angular.forEach(d,function(b){b.context.toggleRefine(b.contextField,a,b.replaceRefine)})};var e=a.$watch(function(){return c.refineOnClickContext},function(b){var f=b.split(","),g=[],h=!0;angular.forEach(f,function(b){var c=a[b];h=h&&angular.isDefined(c),g.push(c)}),h&&angular.forEach(g,function(a){var b="refineOnClick"+ODS.StringUtils.capitalize(a.name);d.push({context:a,recordField:c[b+"RecordField"]||c.refineOnClickRecordField,contextField:c[b+"ContextField"]||c.refineOnClickContextField,replaceRefine:"true"===c[b+"ReplaceRefine"]||"true"===c.refineOnClickReplaceRefine}),e()})})}}};a.directive("refineOnClick",b),a.directive("refineOnClickContext",b)}(),function(){"use strict";angular.module("ods-widgets").directive("odsResultEnumerator",["ODSAPI",function(a){return{restrict:"E",replace:!0,transclude:!0,scope:{context:"=",max:"@?",showHitsCounter:"@?",showPagination:"@?"},template:'<div class="odswidget odswidget-result-enumerator">    <div ods-results="items" ods-results-context="context" ods-results-max="{{maxHits}}" class="odswidget-result-enumerator__results">        <div ng-if="loading"><ods-spinner class="odswidget-spinner--large"></ods-spinner></div>        <div ng-if="!loading && !items.length" class="odswidget-result-enumerator__no-results-message" translate>No results</div>        <div ng-if="!loading && items.length && hitsCounter" class="odswidget-result-enumerator__results-count">{{context.nhits}} <span translate>results</span></div>        <div ng-repeat="item in items" inject class="odswidget-result-enumerator__item"></div>    </div>    <ods-pagination-block ng-if="pagination" context="context" per-page="{{maxHits}}" container-identifier="{{localId}}"></ods-pagination-block></div>',link:function(a,b){a.localId="odsResultEnumerator-"+ODS.StringUtils.getRandomUUID(),b.children()[0].id=a.localId},controller:["$scope",function(a){a.maxHits=a.max||10,a.hitsCounter=angular.isString(a.showHitsCounter)&&"true"===a.showHitsCounter.toLowerCase(),a.pagination=angular.isString(a.showPagination)&&"true"===a.showPagination.toLowerCase()}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsResults",["ODSAPI",function(a){return{restrict:"A",scope:!0,priority:1001,controller:["$scope","$attrs",function(b,c){var d=function(d){var e=angular.extend({},d.parameters,{rows:c.odsResultsMax}),f=c.odsResults||"results";b.loading=!0,"catalog"===d.type?(angular.extend(e,{extrametas:"true",interopmetas:"true"}),a.datasets.search(d,e).success(function(a){b[f]=a.datasets,d.nhits=a.nhits,b.loading=!1}).error(function(){b.loading=!1})):"dataset"===d.type&&d.dataset&&a.records.search(d,e).success(function(a){b[f]=a.records,d.nhits=a.nhits,b.loading=!1}).error(function(){b.loading=!1})},e=!0;b.$watch(c.odsResultsContext,function(a,b){!("catalog"===a.type||"dataset"===a.type&&a.dataset)||angular.equals(a.parameters,b.parameters)&&!e||(e=!1,d(a))},!0)}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsReuses",["ODSAPI",function(a){return{restrict:"E",replace:!0,transclude:!0,template:'<div class="odswidget odswidget-reuses">  <div infinite-scroll="loadMore()" infinite-scroll-distance="1">      <div class="odswidget-reuses__reuse" ng-repeat="reuse in reuses" ods-full-click inject>          <h2 class="odswidget-reuses__reuse-title">{{ reuse.title }}             <a href="/explore/dataset/{{ reuse.dataset.id }}/?tab=metas" class="odswidget-reuses__reuse-dataset-link" target="_self"><span translate>From dataset:</span> {{ reuse.dataset.title }}</a>          </h2>          <div class="odswidget-reuses__reuse-infos">              <div class="odswidget-reuses__reuse-thumbnail" ng-class="{\'odswidget-reuses__reuse-thumbnail--no-thumbnail\': !reuse.thumbnail}">                  <a ng-show="reuse.thumbnail" href="{{ reuse.url }}" ods-main-click title="{{ reuse.title }}" target="_blank"><img class="odswidget-reuses__reuse-thumbnail-image" ng-src="{{ reuse.thumbnail }}" /></a>                  <i ng-hide="reuse.thumbnail" class="fa fa-ban odswidget-reuses__reuse-thumbnail-image--no-thumbnail"></i>              </div>              <div class="odswidget-reuses__reuse-description" ng-bind-html="reuse.description|prettyText|safenewlines"></div>          </div>          <div class="odswidget-reuses__reuse-author">              <strong ng-if="reuse.user.first_name || reuse.user.last_name">{{ reuse.user.first_name }} {{ reuse.user.last_name }}</strong>              <strong ng-if="!reuse.user.first_name && !reuse.user.last_name">{{ reuse.user.username }}</strong>              <i class="fa fa-calendar odswidget-reuses__creation-icon" aria-hidden="true"></i> {{ reuse.created_at|moment:\'LLL\' }}          </div>      </div> </div></div>',scope:{context:"="},controller:["$scope",function(b){var c=!1,d=!1,e=0,f=1,g=20;b.reuses=[],b.loadMore=function(){if(b.reuses.length&&!c&&!d){d=!0;var h=f*g;a.reuses(b.context,{rows:g,start:h}).success(function(a){b.reuses=b.reuses.concat(a.reuses),c=(f+1)*g>=e,f++,d=!1}).error(function(){d=!1})}};var h=function(){d=!0,a.reuses(b.context,{rows:g}).success(function(a){b.reuses=a.reuses,c=g>=a.nhits,e=a.nhits,d=!1}).error(function(a){d=!1})};b.$watch("context",function(){h()})}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsSearchbox",function(){return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-searchbox"><form method="GET" action="{{ actionUrl }}" ng-show="actionUrl"><input class="odswidget-searchbox__box" name="q" type="text" placeholder="{{placeholder|translate}}"></form></div>',scope:{placeholder:"@",context:"="},link:function(a,b,c){"autofocus"in c&&$(b).find("input").focus()},controller:["$scope","$sce",function(a,b){a.actionUrl="/explore/";var c=a.$watch("context",function(d){d&&(a.actionUrl=b.trustAsResourceUrl(a.context.domainUrl+a.actionUrl),c())})}]}})}(),function(){"use strict";angular.module("ods-widgets").directive("odsSlideshow",["ODSAPI","$timeout",function(a,b){return{restrict:"E",transclude:!0,replace:!0,scope:{context:"=",imageField:"@?",titleFields:"@",domainUrl:"@?"},template:'<div class="ods-slideshow"      ng-keydown="onKeyDown($event)"      tabindex="0"      aria-label="Slideshow"     translate="aria-label">    <div class="ods-slideshow__image-wrapper">        <button class="ods-slideshow__previous-button"                ng-click="loadPreviousImage()"                ng-disabled="currentIndex <= 1"                aria-label="View previous image"                translate="aria-label">            <i class="fa fa-angle-left ods-slideshow__previous-icon" aria-hidden="true"></i>        </button>        <ods-spinner ng-show="loading"></ods-spinner>        <img src="{{ imageUrl}}"              alt="{{ imageTitle }}"              class="ods-slideshow__image"             width="{{ imageWidth }}"             height="{{ imageHeight }}"             ng-show="imageThumbnail"  >        <div class="ods-slideshow__tooltip-wrapper"             ng-show="tooltip">            <div class="ods-slideshow__tooltip"                  inject>                <dl>                   <dt ng-repeat-start="field in context.dataset.fields"                           ng-show="record.fields[field.name]|isDefined">                       {{ field.label }}                   </dt>                   <dd ng-repeat-end ng-switch="field.type"                           ng-show="record.fields[field.name]|isDefined">                       <span ng-switch-when="geo_point_2d">                           <ods-geotooltip width="300" height="300"                                   coords="record.fields[field.name]">{{ record.fields|formatFieldValue:field }}</ods-geotooltip>                       </span>                       <span ng-switch-when="geo_shape">                            <ods-geotooltip width="300" height="300"                                   geojson="record.fields[field.name]">{{ record.fields|formatFieldValue:field }}</ods-geotooltip>                        </span>                        <span ng-switch-when="double">{{ record.fields|formatFieldValue:field }}</span>                        <span ng-switch-when="int">{{ record.fields|formatFieldValue:field }}</span>                        <span ng-switch-when="date">{{ record.fields|formatFieldValue:field }}</span>                        <span ng-switch-when="datetime">{{ record.fields|formatFieldValue:field }}</span>                        <span ng-switch-when="file">                            <div ng-bind-html="record.fields|formatFieldValue:field"></div>                        </span>                       <span ng-switch-default ng-bind-html="record.fields[field.name]|prettyText|nofollow|safenewlines"></span>                   </dd>                </dl>            </div>        </div>        <div class="ods-slideshow__cannot-display"              ng-hide="imageThumbnail">            <i class="fa fa-eye-slash ods-slideshow__cannot-display-icon"></i>            <div class="ods-slideshow__cannot-display-message" translate>Sorry, this file cannot be displayed</div>        </div>        <button class="ods-slideshow__next-button"                ng-click="loadNextImage()"                aria-label="View next image"                translate="aria-label"                ng-disabled="currentIndex >= lastIndex">            <i class="fa fa-angle-right ods-slideshow__next-icon" aria-hidden="true"></i>        </button>    </div>    <div class="ods-slideshow__image-legend">        <div class="ods-slideshow__image-index">{{ currentIndex|number:0 }}/{{ lastIndex|number:0 }}</div>        <div class="ods-slideshow__image-title" title="{{ imageTitle }}" ng-bind="imageTitle"></div>        <div class="ods-slideshow__toggles">            <button class="ods-slideshow__tooltip-toggle"                    aria-label="Toggle tooltip"                    translate="aria-label"                    ng-click="toggleTooltip()">                <i class="fa fa-question-circle" aria-hidden="true"></i>            </button>            <button class="ods-slideshow__fullscreen-toggle"                    aria-label="Toggle fullscreen"                    translate="aria-label"                    ng-click="toggleFullscreen()">                <i class="fa fa-arrows-alt" ng-hide="fullscreen" aria-hidden="true"></i>                <i class="fa fa-compress" ng-show="fullscreen" aria-hidden="true"></i>            </button>        </div>    </div></div>',link:function(c,d){c.loading=!1,c.currentIndex=0,c.lastIndex=0,c.imageUrl="",c.imageTitle="",c.imageWidth=0,c.imageHeight=0,c.imageThumbnail=!0,c.fullscreen=!1,c.tooltip=!1;var e;angular.isDefined(c.titleFields)&&(e=c.titleFields.split(","));var f,g=$(d).children(".ods-slideshow__image-wrapper"),h=$(d).find(".ods-slideshow__image-index"),i=$(d).find(".ods-slideshow__image"),j=function(){if(f){var a=Math.min(g.width()/f.width,g.height()/f.height,1);c.imageWidth=a*f.width,c.imageHeight=a*f.height,c.$apply()}},k=function(d){var g=angular.extend({},c.context.parameters,{rows:1,start:d-1,q:"NOT #null("+c.imageField+")"});c.loading=!0,a.records.search(c.context,g).success(function(a){if(c.lastIndex?(c.lastIndex=a.nhits,c.currentIndex=d):(c.currentIndex=a.nhits,c.lastIndex=a.nhits,b(function(){h.css({width:"auto"}),b(function(){h.css({width:h.outerWidth()}),c.lastIndex=a.nhits,c.currentIndex=d})})),a.records.length){var g=a.records[0];f=g.fields[c.imageField],c.imageThumbnail=f.thumbnail,f.thumbnail?c.imageUrl=ODS.Record.getImageUrl(g,c.imageField,c.context.domainUrl):c.imageUrl="",e.length&&(c.imageTitle=e.filter(function(a){return g.fields[a]}).map(function(a){return g.fields[a]}).join(", ")),c.record=g}c.loading=!1}).error(function(){c.loading=!1})};c.loadPreviousImage=function(){c.currentIndex>1&&k(c.currentIndex-1)},c.loadNextImage=function(){c.currentIndex<c.lastIndex&&k(c.currentIndex+1)},c.toggleFullscreen=function(){var a=d[0];document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement?document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():a.requestFullscreen?a.requestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullscreen&&a.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)},c.toggleTooltip=function(){c.tooltip=!c.tooltip},c.onKeyDown=function(a){if(!c.loading)return 39==a.keyCode?void c.loadNextImage():37==a.keyCode?void c.loadPreviousImage():void 0},$(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",function(a){a.target==d[0]&&(c.fullscreen=!c.fullscreen,b(j))}),i.on("load",j);var l=c.$watch("context.dataset",function(a){if(a){var b,d;if(!e)for(b=0;b<c.context.dataset.fields.length;b++)if(d=c.context.dataset.fields[b],"text"===d.type){e=[d.name];break}if(!c.imageField)for(b=0;b<c.context.dataset.fields.length;b++)if(d=c.context.dataset.fields[b],"file"===d.type){c.imageField=d.name;break}k(1),l(),c.$watch("context.parameters",function(a,b){angular.equals(a,b)||(c.currentIndex=0,c.lastIndex=0,k(1))},!0)}},!0)}}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsSocialButtons",[function(){return{restrict:"E",scope:{addthisPubid:"@",buttons:"@?"},replace:!0,template:'<div class="odswidget-social-buttons"      ng-init="displayButtons=false"     ng-mouseenter="displayButtons=true" ng-mouseleave="displayButtons=false">    <div class="odswidget-social-buttons__header">        <span translate>Share</span>        <i class="fa fa-angle-down" aria-hidden="true"></i>    </div>    <div class="odswidget-social-buttons__buttons"          ng-class="{\'odswidget-social-buttons__buttons--open\': displayButtons}">        <div class="addthis_toolbox addthis_counter_style">            <a ng-if="selectedButtons.indexOf(\'facebook\') > -1"                class="addthis_button_facebook_like" fb:like:layout="box_count"></a>            <a ng-if="selectedButtons.indexOf(\'twitter\') > -1"                class="addthis_button_tweet" tw:count="vertical"></a>            <a ng-if="selectedButtons.indexOf(\'google-plus\') > -1"                class="addthis_button_google_plusone" g:plusone:size="tall"></a>        </div>    </div>    <script type="text/javascript">        var addthis_config = addthis_config || {};        addthis_config.pubid = "{{ addthisPubid }}";    </script>    <script type="text/javascript" src=""></script></div>',link:function(a){var b=["google-plus","facebook","twitter"];if(a.selectedButtons=b,angular.isDefined(a.buttons)){var c=a.buttons.split(",").map(function(a){return a.trim()});a.selectedButtons=[],angular.forEach(c,function(c){b.indexOf(c)>-1&&a.selectedButtons.push(c)})}var d=document.createElement("script");d.type="text/javascript",d.async=!0,d.src="//s7.addthis.com/js/300/addthis_widget.js#domready=1",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(d)}}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsSpinner",["ODSWidgetsConfig",function(a){return{restrict:"E",replace:!0,template:function(b,c){var d;return d=Modernizr&&Modernizr.cssanimations&&Modernizr.svg?'<img src="'+a.basePath+'src/img/spinner.gif"      class="odswidget-spinner odswidget-spinner--gif"/>':'<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" version="1.1"     class="odswidget-spinner odswidget-spinner--svg">    <rect x="0" y="0" width="30" height="30" class="odswidget-spinner__cell-11"></rect>    <rect x="35" y="0" width="30" height="30" class="odswidget-spinner__cell-12"></rect>    <rect x="70" y="0" width="30" height="30" class="odswidget-spinner__cell-13"></rect>    <rect x="0" y="35" width="30" height="30" class="odswidget-spinner__cell-21"></rect>    <rect x="35" y="35" width="30" height="30" class="odswidget-spinner__cell-22"></rect>    <rect x="70" y="35" width="30" height="30" class="odswidget-spinner__cell-23"></rect>    <rect x="0" y="70" width="30" height="30" class="odswidget-spinner__cell-31"></rect>    <rect x="35" y="70" width="30" height="30" class="odswidget-spinner__cell-32"></rect>    <rect x="70" y="70" width="30" height="30" class="odswidget-spinner__cell-33"></rect></svg>',"withBackdrop"in c&&(d='<div class="odswidget-spinner__backdrop">'+d+"</div>"),d}}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsTable",["ODSWidgetsConfig","$sce",function(a,b){return{restrict:"E",scope:{context:"=",displayedFields:"@",sort:"@",datasetFeedback:"@"},replace:!0,transclude:!0,require:["odsTable","?odsAutoResize","?autoResize"],template:'<div class="records records-table odswidget odswidget-table"> <div class="odswidget-table__header" ng-show="records.length">     <table class="odswidget-table__internal-table">         <thead class="odswidget-table__internal-header-table-header">         <tr>             <th class="odswidget-table__header-cell odswidget-table__header-cell--spinner"><div class="odswidget-table__cell-container"><ods-spinner ng-show="fetching" class="odswidget-spinner--large"></ods-spinner></div></th>             <th class="odswidget-table__header-cell" ng-repeat="field in context.dataset.fields|fieldsForVisualization:\'table\'|fieldsFilter:displayedFieldsArray"                 title="{{ field.description || field.label }}"                 ng-click="toggleSort(field)"                 >                 <div class="odswidget-table__header-cell-container">                     <div class="odswidget-table__label" ng-bind="field.label"></div>                     <div ng-class="{\'odswidget-table__sort-icons\': true, \'odswidget-table__sort-icons--active\': field.name == context.parameters.sort || \'-\'+field.name == context.parameters.sort}" ng-show="isFieldSortable(field)" title="sort" translate="title">                         <i class="fa fa-chevron-up odswidget-table__sort-icons__up" aria-hidden="true" ng-class="{\'odswidget-table__sort-icons__up--active\': isDescendingSorted(field)}"></i>                         <i class="fa fa-chevron-down odswidget-table__sort-icons__down" aria-hidden="true" ng-class="{\'odswidget-table__sort-icons__down--active\': isAscendingSorted(field)}"></i>                     </div>                 </div>             </th>         </tr>         </thead>     </table> </div> <div class="odswidget-table__records">     <table class="odswidget-table__internal-table" infinite-scroll="loadMore()" infinite-scroll-distance="1" infinite-scroll-disabled="fetching">         <thead class="odswidget-table__internal-table-header">             <tr>                 <th class="odswidget-table__header-cell odswidget-table__header-cell--spinner"><div class="odswidget-table__cell-container"><ods-spinner ng-show="fetching" class="odswidget-spinner--large"></ods-spinner></div></th>                 <th class="odswidget-table__header-cell" ng-repeat="field in context.dataset.fields|fieldsForVisualization:\'table\'|fieldsFilter:displayedFieldsArray"                     title="{{ field.name }}">                     <div class="odswidget-table__cell-container">                         <span ng-bind="field.label"></span>                         <div class="odswidget-table__sort-icons" ng-show="isFieldSortable(field)" title="sort" translate="title">                             <i class="fa fa-chevron-up odswidget-table__sort-icons__up" aria-hidden="true"></i>                             <i class="fa fa-chevron-down odswidget-table__sort-icons__down" aria-hidden="true"></i>                         </div>                     </div>                 </th>             </tr>         </thead>         <tbody class="odswidget-table__records-tbody">         </tbody>     </table> </div> <div ng-if="displayDatasetFeedback" class="table-feedback-new"><a ods-dataset-feedback ods-dataset-feedback-dataset="context.dataset"><i class="fa fa-comment" aria-hidden="true"></i> <span translate>Suggest a new record</span></a></div> <div class="odswidget-overlay" ng-hide="fetching || records"><span class="odswidget-overlay__message" translate>No results</span></div> <div class="odswidget-overlay" ng-hide="(!fetching || records) && !working"><ods-spinner></ods-spinner></div></div>',controller:["$scope","$element","$timeout","$document","$window","ODSAPI","DebugLogger","$filter","$http","$compile","$transclude","$q",function(a,b,c,d,e,f,g,h,i,j,k,l){var m=this;a.displayedFieldsArray=null,a.displayDatasetFeedback=!1,a.page=0,a.resultsPerPage=40,a.fetching=!1,a.records=[],a.working=!0,a.layout=[],a.done=!1;var n,o,p=b.find(".odswidget-table__header"),q=b.find(".odswidget-table__records-tbody"),r=p.offset().left,s=0,t=0,u=!1,v=0,w=0,x=100,y=0,z=0,A=Math.random().toString(36).substring(7),B="table-"+A,C="stylesheet-"+A,D=[],E=null,F={},G=function(b){function d(d,e){d.records.length||(a.working=!1),a.records=b?d.records:a.records.concat(d.records),a.nhits=d.nhits,a.error="",a.fetching=!1,a.done=(a.page+1)*a.resultsPerPage>=d.nhits,D.splice(D.indexOf(i),1),E=e,c(function(){if(angular.isDefined(F[e+1])){var a=F[e+1];delete F[e+1],a.callback(a.data,e+1)}})}a.fetching=!0;var e,g={};if(b?(a.done=!1,a.page=0,a.records=[],e=0,D.length&&(D.forEach(function(a){a.resolve()}),D.splice(0,D.length)),F={},E=null):(a.page++,e=a.page*a.resultsPerPage),jQuery.extend(g,a.staticSearchOptions,a.context.parameters,{start:e}),a.displayedFieldsArray&&a.context.dataset.fields.length>a.displayedFieldsArray.length&&jQuery.extend(g,{fields:a.displayedFieldsArray.join(",")}),g.sort){var h=g.sort.replace("-","");a.context.dataset.getField(h)||delete g.sort}var i=l.defer();D.push(i),f.records.search(a.context,g,i.promise).success(function(a,b,c,e){var f=a.parameters.start/a.parameters.rows;null===E&&0===f||angular.isNumber(E)&&f===E+1?d(a,f):F[f]={callback:d,data:a}}).error(function(b,c,d,e){b&&(a.error=b.error),D.splice(D.indexOf(i),1),a.fetching=!1})};a.loadMore=function(){a.fetching||a.done||!a.staticSearchOptions||G(!1)},a.isFieldSortable=function(a){return ODS.DatasetUtils.isFieldSortable(a)},a.isAscendingSorted=function(b){return"text"===b.type?b.name===a.context.parameters.sort:"-"+b.name===a.context.parameters.sort},a.isDescendingSorted=function(b){return"text"===b.type?"-"+b.name===a.context.parameters.sort:b.name===a.context.parameters.sort},a.toggleSort=function(b){if(a.isFieldSortable(b)){if(a.context.parameters.sort==b.name)return void(a.context.parameters.sort="-"+b.name);if(a.context.parameters.sort=="-"+b.name)return void(a.context.parameters.sort=b.name);a.context.parameters.sort="text"===b.type?b.name:"-"+b.name}else delete a.context.parameters.sort};var H=!1;k(function(a){a.contents().wrapAll("<div>"),H=a.contents().length>0&&a.contents().html().trim().length>0});var I=function(c,d,e){var f,g,i=d[c];if(f=document.createElement("tr"),f.className="odswidget-table__internal-table-row record-"+c,"end"===e){var l=b.find(".js-placeholder-bottom")[0];l.parentNode.insertBefore(f,l)}else{var m=b.find(".js-placeholder-top")[0];m.parentNode.insertBefore(f,m.nextSibling)}g=document.createElement("td"),g.className="odswidget-table__cell";var o=document.createElement("div");if(o.className="odswidget-table__cell-container",a.displayDatasetFeedback){var p=a.$new(!0);p.record=i,p.dataset=a.context.dataset,o.appendChild(j('<i class="fa fa-comment table-feedback-icon" aria-hidden="true" ods-dataset-feedback ods-dataset-feedback-record="record" ods-dataset-feedback-dataset="dataset" ods-tooltip="Suggest changes for this record" translate="ods-tooltip"></i>')(p)[0])}o.appendChild(document.createTextNode(c+1)),g.appendChild(o),f.appendChild(g);for(var q=0;q<n.length;q++){var r=n[q],s=h("formatFieldValue")(i.fields,r);g=document.createElement("td"),g.className="odswidget-table__cell",f.appendChild(g),o=document.createElement("div"),o.className="odswidget-table__cell-container","int"!==r.type&&"double"!==r.type||(o.className+=" odswidget-table__cell-container__right-aligned"),g.appendChild(o);var t,u;if(H)t=a.$new(!0),t.record=i,t.currentField=r.name,t.currentValue=i.fields[r.name],t.currentFormattedValue=s,u=j("<div inject></div>",k)(t)[0];else if(t=a.$new(!1),t.recordFields=i.fields[r.name],r&&"geo_point_2d"===r.type)t.fieldValue=s,u=j('<ods-geotooltip width="300" height="300" coords="recordFields">'+s+"</ods-geotooltip>")(t)[0];else if(r&&"geo_shape"===r.type)t.fieldValue=h("truncate")(s),u=j('<ods-geotooltip width="300" height="300" geojson="recordFields">'+s+"</ods-geotooltip>")(t)[0];else if(r&&"file"===r.type){var v=h("nofollow")(h("prettyText")(s)).toString();v=v.replace(/<a /,"<a ods-resource-download-conditions "),v?(u=j(v)(t)[0],u.title=i.fields[r.name]?i.fields[r.name].filename:""):u=document.createElement("span")}else u=document.createElement("span"),u.title=s,u.innerHTML=h("nofollow")(h("prettyText")(s));o.appendChild(u)}return f},J=function(a){var c=b[0].getElementsByClassName("record-"+a)[0];c&&c.parentNode.removeChild(c)},K=function(a){var b;return angular.forEach(a.classList,function(a){a.startsWith("record-")&&(b=parseInt(a.substr(7),10))}),b},L=function(){var c=b.find(".odswidget-table__records")[0].offsetHeight,d=b.find(".odswidget-table__records")[0].scrollTop,e=q.find("tr").eq(1).height(),f=b.find(".js-placeholder-top")[0],g=b.find(".js-placeholder-bottom")[0];e?(y=Math.max(Math.floor((d-x*e)/e),0),z=Math.min(Math.ceil((d+c+x*e)/e),a.records.length)):(y=0,z=a.records.length),y=y&&y%2?y+1:y;var h=y-v>0||z-w>0;if(y!==v||z!==w){var i,j,k,l,m,n;if(f||(i=document.createElement("tr"),i.className="js-placeholder-top",i.style.height="0px",q[0].appendChild(i),f=b.find(".js-placeholder-top")[0]),g||(i=document.createElement("tr"),i.className="js-placeholder-bottom",i.style.height="0px",q[0].appendChild(i),g=b.find(".js-placeholder-bottom")[0]),!a.layout.length&&a.records.length){var o=Math.min(a.records.length,a.resultsPerPage);for(m=0;m<o;m++)I(m,a.records,"end")}else if(h){for(m=0;m<y;m++)J(m);f.style.height=y*e+"px",j=b[0].getElementsByTagName("tbody")[0].getElementsByTagName("tr"),k=j.length>2;var p=k?K(j[j.length-2]):y;for(l=0,m=p+1;m<z;m++)I(m,a.records,"end"),l++;n=k?$(g).height()-l*e:(a.records.length-z)*e,n=n>0?n:0,g.style.height=n+"px"}else{for(l=0,m=z+1;m<a.records.length;m++)J(m),l++;var r=a.records.length-(z+1);r=r>=0?r:0,g.style.height=r*e+"px",j=b[0].getElementsByTagName("tbody")[0].getElementsByTagName("tr"),k=j.length>2;var s=k?K(j[1]):z;for(l=0,m=s-1;m>=y;m--)I(m,a.records,"begin"),l++;n=k?$(f).height()-l*e:y*e,n=n>0?n:0,f.style.height=n+"px"}v=y,w=z}};a.$watchCollection("records",function(c,d){c!==d&&(L(),a.computeLayout(),o||(o=b.find("[infinite-scroll]")),b.height()>o.height()&&a.loadMore())}),a.context.wait().then(function(){if(a.displayedFields?a.displayedFieldsArray=a.displayedFields.split(",").map(function(a){return a.trim()}):a.context.dataset.extra_metas&&a.context.dataset.extra_metas.visualization&&angular.isArray(a.context.dataset.extra_metas.visualization.table_fields)&&a.context.dataset.extra_metas.visualization.table_fields.length>0?a.displayedFieldsArray=a.context.dataset.extra_metas.visualization.table_fields:a.displayedFieldsArray=null,!a.context.parameters.sort&&a.context.dataset.extra_metas&&a.context.dataset.extra_metas.visualization&&a.context.dataset.extra_metas.visualization.table_default_sort_field){var c=a.context.dataset.extra_metas.visualization.table_default_sort_field;"-"===a.context.dataset.extra_metas.visualization.table_default_sort_direction&&(c="-"+c),a.context.parameters.sort=c}a.displayDatasetFeedback="true"===a.datasetFeedback&&a.context.dataset.getExtraMeta("explore","feedback_enabled"),a.staticSearchOptions={rows:a.resultsPerPage},g.log("table -> dataset watch -> refresh records");var d=h("fieldsForVisualization")(a.context.dataset.fields,"table");n=h("fieldsFilter")(d,a.displayedFieldsArray),G(!0),a.$watch("context.parameters",function(c,d){g.log("table -> searchOptions watch -> refresh records"),a.layout=[],a.working=!0,t=b.find(".odswidget-table__records")[0].scrollLeft,u=!0,q.empty(),G(!0)},!0)}),m.resetScroll=function(){b.find(".odswidget-table__records").scrollLeft(0),p.css({left:"auto"}),r=b.find(".odswidget-table__header").offset().left};var M=0;b.find(".odswidget-table__records").on("scroll",function(){if(this.scrollLeft!==s)p.offset({left:r-this.scrollLeft}),s=this.scrollLeft;else{u=!1;var a=Math.max(Math.floor(b.find(".odswidget-table__records")[0].scrollTop/q.find("tr").eq(1).height()),0);if(Math.abs(a-M)<x&&a>y)return;M=a,L()}});var N=function(b,c){for(var d="",e=0;e<a.layout.length;e++){var f=e+1,g=c?"max-width: none; ":"";d+="#"+b+" .odswidget-table__header tr th:nth-child("+f+") > div, #"+b+" .odswidget-table__records tr td:nth-child("+f+") > div { width: "+a.layout[e]+"px; "+g+"} "}return d};a.computeLayout=function(){var d,e=b.find(".odswidget-table__internal-table-row");if(!a.layout.length&&a.records.length){b.attr("id")||b.attr("id",B),b.hasClass("odswidget-table--embedded")?(d=$(window).height()-b.offset().top,b.height(d)):d=b.height();var f=0;a.displayDatasetFeedback&&(f=b.find(".table-feedback-new").height()+5),b.find(".odswidget-table__records").height(d-25-f);var g=(q.find("tr").eq(1).height(),e.length,document.getElementById(C));g&&g.parentNode&&g.parentNode.removeChild(g),b.find(".odswidget-table__internal-header-table-header").hide(),b.find(".odswidget-table__internal-table-header").show();var h=0;angular.forEach(b.find(".odswidget-table__internal-table-header .odswidget-table__cell-container"),function(b,c){a.layout[c]=$(b).width()+8,h+=a.layout[c]}),a.layout[0]=30;var i=document.createElement("style"),j=N(B,!1);i.id=C,i.type="text/css",i.styleSheet?i.styleSheet.cssText=j:i.appendChild(document.createTextNode(j)),b[0].appendChild(i),b.find(".odswidget-table__internal-table-header").hide(),b.find(".odswidget-table__internal-header-table-header").show(),u||c(function(){m.resetScroll()},0)}u&&(t||p.css({left:"auto"}),b.find(".odswidget-table__records")[0].scrollLeft=t),a.layout.length&&(a.working=!1)}}],link:function(a,b,c,d){var e=d[0],f=d[1]||d[2];angular.isDefined(f)&&null!==f&&(f.onResize=function(){e.resetScroll(),a.layout=[],a.computeLayout()})}}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsTagCloud",["ODSAPI","$location",function(a,b){function c(a){var b=Math.floor(a.length/2);return a.length%2?a[b].count:(a[b-1].count+a[b].count)/2}function d(a,b){var c=$.grep(a,function(a){return a.count>=b}),d=$.grep(a,function(a){return a.count<=b}),e=[{count:c.length,min:c[c.length-1].count,max:c[0].count},{count:d.length,min:d[d.length-1].count,max:d[0].count}];return e[0].delta=e[0].max-e[0].min,e[1].delta=e[1].max-e[1].min,e}function e(a,b,c,d){var e,f=(a.count>=b?c[0].delta:c[1].delta)/2;return e=a.count>=2*f?1:a.count>=f&&a.count<2*f?2:3,e=a.count>=b?e:e+3,a={count:a.count,name:a.name,opacity:((7-e+4)/10+.05).toFixed(2),size:((7-e)/3).toFixed(1),weight:e},a.size=6!==e?a.size:parseFloat(a.size)+.3,a}function f(a,b,c){var d=a.parameters["refine."+b];return angular.isDefined(d)&&(angular.isArray(d)&&d.indexOf(c)>-1||d===c)}function g(a){for(var b=a.length-1;b>0;b--){var c=Math.floor(Math.random()*(b+1)),d=a[b];a[b]=a[c],a[c]=d}return a}return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-tag-cloud">    <ul class="odswidget-tag-cloud__tag-list">        <li class="odswidget-tag-cloud__no-data-label" ng-hide="tags" translate>No data available yet</li>        <li ng-repeat="tag in tags"             class="odswidget-tag-cloud__tag"             ng-class="{\'odswidget-tag-cloud__tag--selected\': tag.selected}"            ng-style="{\'font-size\': tag.size + \'em\', \'opacity\': tag.opacity}">            <a ng-click="refine(tag.name)" href="">                {{ tag.name }}            </a>        </li>    </ul></div>',scope:{context:"=",facetName:"@",max:"@?",redirectTo:"@?",contextToRefine:"=?"},controller:["$scope",function(b){b.refine=function(a){if(b.redirectTo){var c="refine."+b.facetName+"="+a,d=b.redirectTo.indexOf("?")>-1?"&":"?";window.location=b.redirectTo+d+c}else b.contextToRefine?b.contextToRefine.toggleRefine(b.facetName,a):b.context.toggleRefine(b.facetName,a)};var h=function(){var h,i={rows:0,facet:b.facetName};"catalog"===b.context.type?h=a.datasets.search(b.context,i):(i=$.extend({},b.context.parameters,i),h=a.records.search(b.context,i)),h.success(function(a){if(a.facet_groups){b.tags=a.facet_groups[0].facets,b.max&&(b.tags=b.tags.slice(0,b.max));for(var h=c(b.tags),i=0;i<b.tags.length;i++)b.tags[i]=e(b.tags[i],h,d(b.tags,h),b.context.domainUrl),b.tags[i].selected=f(b.contextToRefine?b.contextToRefine:b.context,b.facetName,b.tags[i].name);b.tags=g(b.tags)}})};b.$watch("context",function(a,c){("catalog"===b.context.type||"dataset"===b.context.type&&b.context.dataset)&&h()},!0)}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsTextSearch",function(){return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-text-search">    <form ng-submit="applySearch()" class="odswidget-text-search__form">        <input class="odswidget-text-search__search-box" name="q" type="text" ng-model="searchExpression" placeholder="{{ translatedPlaceholder }}">        <button type="submit" class="odswidget-text-search__submit" title="{{ translatedPlaceholder}}"><i class="fa fa-search" aria-hidden="true"></i></button>    </form></div>',scope:{placeholder:"@?",button:"@?",context:"=",field:"@?"},link:function(a,b,c){"autofocus"in c&&$(b).find("input").focus()},controller:["$scope","$attrs","translate",function(a,b,c){var d=[],e={};angular.isArray(a.context)?d=a.context:d.push(a.context);var f=a.$watch("context",function(c,g){var h=function(a,b){var c=a.parameters.q;if(c){var d=/([\w-_]+):"(.*)"/,f=c.match(d);return f&&e[a.name]===f[1]?f[2]:b?c:void 0}};c&&(angular.isArray(c)||(c=[c]),angular.forEach(c,function(c){e[c.name]=b[c.name+"Field"]||a.field}),angular.forEach(c,function(b){a.searchExpression=a.searchExpression||h(b)}),a.searchExpression||angular.forEach(c,function(b){a.searchExpression=a.searchExpression||b.parameters.q}),f(),a.$watch(function(){return d.map(function(a){return a.parameters.q})},function(b,c){if(!angular.equals(b,c)){for(var e=!0,f=h(d[0],!0),g=1;g<d.length;g++)if(f!=h(d[g],!0)){e=!1;break}e&&(a.searchExpression=f)}},!0))}),g=a.$watch("placeholder",function(b,d){b&&(a.translatedPlaceholder=c(a.placeholder),g())});a.applySearch=function(){angular.forEach(d,function(b){e[b.name]&&a.searchExpression?b.parameters.q=e[b.name]+':"'+a.searchExpression+'"':b.parameters.q=a.searchExpression})}}]}})}(),function(){"use strict";angular.module("ods-widgets").directive("odsThemeBoxes",function(){return{restrict:"E",replace:!1,template:'<div class="odswidget odswidget-theme-boxes">   <div ng-repeat="item in items" class="odswidget-theme-boxes__box" ods-facet-results="items" ods-facet-results-context="context" ods-facet-results-facet-name="theme">       <a ng-href="{{context.domainUrl}}/explore/?refine.theme={{encode(item.path)}}" target="_self" translate="ods-tooltip" translate-n="item.count" translate-plural="{{item.name}} ({{$count}} datasets)" ods-tooltip="{{item.name}} ({{$count}} dataset)" ods-tooltip-direction="bottom" style="display: block;">           <ods-theme-picto class="odswidget-theme-boxes__picto" theme="{{item.name}}"></ods-theme-picto>       </a>   </div></div>',scope:{context:"="},controller:["$scope",function(a){a.encode=encodeURIComponent}]}})}(),function(){"use strict";angular.module("ods-widgets").directive("odsTimerange",["ModuleLazyLoader","translate","odsTimerangeParser",function(a,b,c){var d={styles:{container:"rd-container odswidgets-rd-container"},weekStart:1},e=function(a){return"yesterday"===a?moment().subtract("days",1):"now"===a?moment():angular.isString(a)?moment(a):null},f=function(a){return a?moment(a).milliseconds(0).toISOString().replace(".000Z","Z"):null},g=function(a,b,c,d){return"string"==typeof a&&(a=moment(a,b)),"false"!==c&&!1!==c||("from"===d&&(a.milliseconds(0),-1===b.indexOf("H")&&-1===b.indexOf("h")&&-1===b.indexOf("LLL")&&-1===b.indexOf("LT")&&a.hours(0),-1===b.indexOf("m")&&-1===b.indexOf("LLL")&&-1===b.indexOf("LT")&&a.minutes(0),-1===b.indexOf("s")&&-1===b.indexOf("LTS")&&a.seconds(0)),"to"===d&&(a.milliseconds(999),-1===b.indexOf("H")&&-1===b.indexOf("h")&&-1===b.indexOf("LLL")&&-1===b.indexOf("LT")&&a.hours(23),-1===b.indexOf("m")&&-1===b.indexOf("LLL")&&-1===b.indexOf("LT")&&a.minutes(59),-1===b.indexOf("s")&&-1===b.indexOf("LTS")&&a.seconds(59))),a};return{restrict:"E",replace:!0,scope:{context:"=",timeField:"@?",defaultFrom:"@?",defaultTo:"@?",displayTime:"@?",dateFormat:"@?",to:"=?",from:"=?",labelFrom:"@?",labelTo:"@?",placeholderFrom:"@?",placeholderTo:"@?"},template:'<div class="odswidget odswidget-timerange">    <div class="odswidget-timerange__from">        <span ng-bind="labelFrom"></span>         <input type="text" placeholder="{{ placeholderFrom }}">    </div>    <div class="odswidget-timerange__to">        <span ng-bind="labelTo"></span>         <input type="text" placeholder="{{ placeholderTo }}">    </div></div>',link:function(h,i,j){h.labelFrom=angular.isDefined(h.labelFrom)?h.labelFrom:b("From"),h.labelTo=angular.isDefined(h.labelTo)?h.labelTo:b("to");var k=i.find("input"),l="YYYY-MM-DD HH:mm";angular.isDefined(h.displayTime)&&"false"===h.displayTime&&(l="YYYY-MM-DD"),h.dateFormat=h.dateFormat||l;var m,n=function(a){var b=j[a.name+"ParameterName"]||"q";return["q","rq"].indexOf(b)>-1&&(b+=".timerange"),b};if(m=angular.isArray(h.context)?h.context[0].parameters[n(h.context[0])]:h.context.parameters[n(h.context)],angular.isDefined(m)){var o=c(m);o.field===h.timeField&&(h.defaultFrom=o.from,h.defaultTo=o.to)}if(angular.isDefined(h.defaultFrom)){var p=g(e(h.defaultFrom),h.dateFormat,h.displayTime,"from");k[0].value=p.format(h.dateFormat),h.from=f(p)}if(angular.isDefined(h.defaultTo)){var q=g(e(h.defaultTo),h.dateFormat,h.displayTime,"to");k[1].value=q.format(h.dateFormat),h.to=f(q)}a("rome").then(function(){void 0===h.displayTime?h.displayTime=!0:h.displayTime="true"===h.displayTime;var a=rome(k[0],angular.extend({},d,{time:h.displayTime,dateValidator:rome.val.beforeEq(k[1]),initialValue:h.defaultFrom,inputFormat:h.dateFormat}));a.on("data",function(b){h.$apply(function(){var c=g(moment(b,h.dateFormat),h.dateFormat,h.displayTime,"from");$(k[0]).val(c.format(h.dateFormat)),a.setValue(c),h.from=f(c)})});var b=rome(k[1],angular.extend({},d,{time:h.displayTime,dateValidator:rome.val.afterEq(k[0]),initialValue:h.defaultTo,inputFormat:h.dateFormat}));b.on("data",function(a){h.$apply(function(){var c=g(moment(a,h.dateFormat),h.dateFormat,h.displayTime,"to");b.setValue(c),h.to=f(c)})});var c=function(){return(angular.isArray(h.context)?h.context:[h.context]).reduce(function(a,b){return a&&!b.parameters[n(b)]},!0)};h.$watch(c,function(a,b){a&&!b&&k.val(null)},!0)})},controller:["$scope","$attrs","$q","$compile","$rootScope","$parse",function(a,b,c,d,e,f){var g=[],h={},i=function(a){if(a){var b=a.fields.filter(function(a){return"date"===a.type||"datetime"===a.type});return b.length>1&&console.log('Warning: the dataset "'+a.getUniqueId()+'" has more than one date or datetime field, the first date or datetime field will be used. You can specify the field to use using the "time-field" parameter.'),0===b.length&&console.log('Error: the dataset "'+a.getUniqueId()+"\" doesn't have any date or datetime field, which is required for the Timerange widget."),b[0].name}return null};angular.isArray(a.context)?g=a.context:(g.push(a.context),h[a.context.name]={},a.timeField&&(h[a.context.name].timeField=a.timeField)),angular.forEach(g,function(c){h[c.name]={timefield:h[a.context.name]&&h[a.context.name].timeField?h[a.context.name].timeField:null,formatter:f("$field + ':[' + $from + ' TO ' + $to + ']'"),parameter:"q"},angular.isDefined(b[c.name+"ParameterFormatter"])&&(h[c.name].formatter=f(b[c.name+"ParameterFormatter"])),angular.isDefined(b[c.name+"ParameterName"])&&(h[c.name].parameter=b[c.name+"ParameterName"]),angular.isDefined(b[c.name+"TimeField"])&&(h[c.name].timefield=b[c.name+"TimeField"])});var j=function(b,c){a.$watch("[from, to]",function(d){d[0]&&d[1]&&angular.forEach(b,function(b){var d=c[b.name].parameter,e={};e.$to=a.to,e.$from=a.from,e.$field=c[b.name].timefield,["q","rq"].indexOf(d)>-1&&(d+=".timerange"),b.parameters[d]=c[b.name].formatter(e)})},!0)};1==g.length&&"catalog"==g[0].type?j(g,h):c.all(g.map(function(a){return a.wait().then(function(b){null===h[a.name].timefield&&(h[a.name].timefield=i(b))})})).then(function(){j(g,h)})}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsTimescale",function(){return{restrict:"E",replace:!0,scope:{context:"=",timeField:"@",defaultValue:"@"},template:'<div class="odswidget odswidget-timescale">   <ul class="odswidget-timescale__scale-list">       <li class="odswidget-timescale__scale" ng-class="{\'odswidget-timescale__scale--active\': scale == \'everything\' || !scale}"> <a class="odswidget-timescale__scale-link" href="#" ng-click="scale = \'everything\'; $event.preventDefault();" translate>Everything</a></li>       <li class="odswidget-timescale__scale" ng-class="{\'odswidget-timescale__scale--active\': scale == \'year\'}">                 <a class="odswidget-timescale__scale-link" href="#" ng-click="scale = \'year\'; $event.preventDefault();" translate>Last 12 months</a></li>       <li class="odswidget-timescale__scale" ng-class="{\'odswidget-timescale__scale--active\': scale == \'month\'}">                <a class="odswidget-timescale__scale-link" href="#" ng-click="scale = \'month\'; $event.preventDefault();" translate>Last 4 weeks</a></li>       <li class="odswidget-timescale__scale" ng-class="{\'odswidget-timescale__scale--active\': scale == \'week\'}">                 <a class="odswidget-timescale__scale-link" href="#" ng-click="scale = \'week\'; $event.preventDefault();" translate>Last 7 days</a></li>       <li class="odswidget-timescale__scale" ng-class="{\'odswidget-timescale__scale--active\': scale == \'day\'}">                  <a class="odswidget-timescale__scale-link" href="#" ng-click="scale = \'day\'; $event.preventDefault();" translate>Last 24 hours</a></li>   </ul></div>',controller:["$scope","$attrs","$q",function(a,b,c){var d=[],e={},f="q.timescale",g=function(a){if(a){var b=a.fields.filter(function(a){return"date"===a.type||"datetime"===a.type});b.length>1&&console.log('Warning: the dataset "'+a.getUniqueId()+'" has more than one date or datetime field, the first date or datetime field will be used. You can specify the field to use using the "time-field" parameter.'),0===b.length&&console.log('Error: the dataset "'+a.getUniqueId()+"\" doesn't have any date or datetime field, which is required for the Timerange widget."),e[a.getUniqueId()]=b[0].name}};angular.isArray(a.context)?d=a.context:d.push(a.context),c.all(d.map(function(c){return c.wait().then(function(d){angular.isDefined(b[c.name+"TimeField"])?e[c.dataset.getUniqueId()]=b[c.name+"TimeField"]:a.timeField?e[c.dataset.getUniqueId()]=a.timeField:g(d)})})).then(function(){h(d,e);var b=function(){return d.reduce(function(a,b){return a&&!b.parameters[f]},!0)};a.$watch(b,function(b,c){b&&!c&&(a.scale="everything")},!0)});var h=function(b,c){a.scale=a.defaultValue||"everything",a.$watch("scale",function(a){if("everything"===a)return void angular.forEach(b,function(a){delete a.parameters[f]});var d=null;"day"===a?d="#now(days=-1)":"week"===a?d="#now(weeks=-1)":"month"===a?d="#now(weeks=-4)":"year"===a&&(d="#now(years=-1)"),angular.forEach(b,function(a){a.parameters[f]=c[a.dataset.getUniqueId()]+">="+d})},!0)}}]}})}(),function(){"use strict";angular.module("ods-widgets").directive("odsToggleModel",function(){var a=function(a,b,c){a[b]?angular.isArray(a[b])?a[b].indexOf(c)<0&&a[b].push(c):angular.equals(a[b],c)||(a[b]=[a[b],c]):a[b]=c},b=function(a,b,c){a[b]&&(angular.isArray(a[b])?a[b].indexOf(c)>=0&&(1===a[b].length?delete a[b]:a[b].splice(a[b].indexOf(c),1)):angular.equals(a[b],c)&&delete a[b])},c=function(a,b){"string"==typeof a[b]&&(a[b]=a[b].split(","))},d=function(a,b,c){"csv"==c&&angular.isArray(a[b])&&(a[b]=a[b].join(","))};return{restrict:"A",scope:{odsToggleModel:"=",odsToggleKey:"@",odsToggleValue:"@",odsStoreAs:"@?"},link:function(e,f,g){angular.isDefined(e.odsStoreAs)&&-1!=["array","csv"].indexOf(e.odsStoreAs)||(e.odsStoreAs="array"),f.on("change",function(f){f.currentTarget.checked?e.$apply(function(){c(e.odsToggleModel,e.odsToggleKey),a(e.odsToggleModel,e.odsToggleKey,e.odsToggleValue),d(e.odsToggleModel,e.odsToggleKey,e.odsStoreAs)}):e.$apply(function(){c(e.odsToggleModel,e.odsToggleKey),b(e.odsToggleModel,e.odsToggleKey,e.odsToggleValue),d(e.odsToggleModel,e.odsToggleKey,e.odsStoreAs)})}),e.$watch("odsToggleModel[odsToggleKey]",function(a){a?angular.isArray(a)&&a.indexOf(e.odsToggleValue)>=0||!angular.isArray(a)&&a.split(",").indexOf(e.odsToggleValue)>=0?f.prop("checked",!0):angular.equals(a,e.odsToggleValue)?f.prop("checked",!0):f.prop("checked",!1):f.prop("checked",!1)},!0)}}})}(),function(){"use strict";angular.module("ods-widgets").directive("odsTopPublishers",["ODSAPI",function(a){return{restrict:"E",replace:!0,template:'<div class="odswidget odswidget-top-publishers"><ul class="odswidget-top-publishers__publishers">   <li class="no-data" ng-hide="publishers" translate>No data available yet</li>   <li class="odswidget-top-publishers__publisher" ng-repeat="publisher in publishers" ng-if="publishers">       <div class="odswidget-top-publishers__publisher-details">           <div class="odswidget-top-publishers__publisher-details-name"><a ng-href="{{ context.domainUrl }}/explore/?refine.publisher={{ publisher.path }}" target="_self">{{ publisher.name }}</a></div>           <div class="odswidget-top-publishers__publisher-details-count"><i class="fa fa-table" aria-hidden="true"></i> <span translate translate-n="publisher.count" translate-plural="Used by {{$count}} datasets">Used by {{$count}} dataset</span></div>       </div>   </li></ul></div>',scope:{context:"="},controller:["$scope",function(b){var c=function(){a.datasets.facets(b.context,"publisher").success(function(a){b.publishers=a.facet_groups[0].facets.slice(0,5)})};b.$watch("context",function(){c()})}]}}])}(),function(){"use strict";angular.module("ods-widgets").directive("odsTwitterTimeline",function(){return{restrict:"E",replace:!0,template:'<div class="odswidget"></div>',scope:{widgetId:"@"},link:function(a,b,c){var d='<a class="twitter-timeline"    href="https://twitter.com/twitterapi"    data-widget-id="'+c.widgetId+'"';c.height&&(d+='   height="'+c.height+'"'),c.width&&(d+='   width="'+c.width+'"'),d+='   >Tweets</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>',b.append(d)}}})}(),function(){"use strict";var a=angular.module("ods-widgets");a.directive("inject",function(){return{link:function(a,b,c,d,e){var f=a.$new();if(!e)return void console.warn("inject directive used on an element with no transcluded directives",b);e(f,function(a){var c=a.clone();c.contents().wrapAll("<div>"),c.contents().length>0&&c.contents().html().trim().length>0&&(b.empty(),b.append(a),b.on("$destroy",function(){f.$destroy()}))})}}}),a.directive("odsFullClick",function(){return{restrict:"A",link:function(a,b,c){c.odsFullClick&&b.find("[ods-main-click]").attr("href",c.odsFullClick),b.click(function(a){if(!$(a.target).is("a,button,[ng-click]")&&0===$(a.target).parents("a,button,[ng-click]").length&&b.find("[ods-main-click]").length)if(document.createEvent){var c=document.createEvent("MouseEvents"),d=a.originalEvent;c.initMouseEvent(d.type,d.bubbles,d.cancelable,window,d.detail,d.screenX,d.screenY,d.clientX,d.clientY,d.ctrlKey,d.altKey,d.shiftKey,d.metaKey,d.button,d.relatedTarget),b.find("[ods-main-click]")[0].dispatchEvent(c)}else document.createEventObject&&(window.location=b.find("[ods-main-click]")[0].href)})}}})}(),function(){"use strict";angular.module("ods-widgets").directive("odsWidgetTooltip",["$rootScope","$compile",function(a,b){return{restrict:"A",priority:100,transclude:!0,controller:["$scope","$element","$attrs","$transclude",function(c,d,e,f){var g,h,i,j=this;this.configure=function(a){g=a.defaultTemplate||"",h=a.displayedFields||[],i=a.fields||[]},this.render=function(c,d,e){var k=a.$new(!0);return k.record=angular.copy(c),k.displayedFields=angular.copy(h),k.fields=angular.copy(i),e&&(k.displayedFields=k.displayedFields.filter(function(a){return e!==a.name})),angular.merge(k,d||{}),g||f(a.$new(!0),function(a,b){g=a.length>0?a:j.defaultTemplate}),b(g)(k)}}]}}])}();